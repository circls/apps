define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s={name:"demo",css:["app"],i18n:{"en-US":{customCss:!1}},load:function(e){var t=this;t.initApp(function(){e&&e(t)})},initApp:function(e){var t=this;r.pub("auth.initApp",{app:t,callback:e})},render:function(e){var n=this,e=e||t("#monster-content");n.listDevices(function(i){var s=t(r.template(n,"layout",{devices:i}));n.bindUIEvents(s),n.bindSocketsEvents(s,i),e.empty().append(s)})},bindUIEvents:function(e){var n=this;e.find("#clearEvents").on("click",function(){e.find(".table tbody tr:not(.no-events)").remove()}),e.find(".device-item").on("click",function(){var n=!t(this).hasClass("active");e.find(".device-item").removeClass("active"),e.find("table tbody tr").removeClass("inactive");if(n){var r=t(this).data("id");r!==""&&(t(this).addClass("active"),e.find('table tbody tr:not([data-deviceid="'+r+'"])').addClass("inactive"))}})},bindSocketsEvents:function(e,t){var n=this,i=function(t){var i=n.formatEvent(t),s=r.template(n,"event",i);i.extra.hasOwnProperty("deviceId")&&r.ui.highlight(e.find('.device-item[data-id="'+i.extra.deviceId+'"]')),e.find(".list-events tbody").prepend(s)};r.socket.emit("subscribe",{account_id:n.accountId,auth_token:n.authToken,binding:"call.CHANNEL_CREATE.*"}),r.socket.emit("subscribe",{account_id:n.accountId,auth_token:n.authToken,binding:"call.CHANNEL_ANSWER.*"}),r.socket.emit("subscribe",{account_id:n.accountId,auth_token:n.authToken,binding:"call.CHANNEL_DESTROY.*"}),r.socket.on("CHANNEL_CREATE",function(e){i(e)}),r.socket.on("CHANNEL_ANSWER",function(e){i(e)}),r.socket.on("CHANNEL_DESTROY",function(e){i(e)})},formatEvent:function(e){var t=this,n=e;return n.extra={},n.extra.to=e.To.substr(0,e.To.indexOf("@")),n.extra.friendlyEvent=t.i18n.active().demo.events[e["Event-Name"]],n.extra.classEvent=e["Event-Name"]==="CHANNEL_CREATE"?"info":e["Event-Name"]==="CHANNEL_ANSWER"?"success":"error","Custom-Channel-Vars"in e&&"Authorizing-Type"in e["Custom-Channel-Vars"]&&e["Custom-Channel-Vars"]["Authorizing-Type"]==="device"&&(n.extra.deviceId=e["Custom-Channel-Vars"]["Authorizing-ID"]),n},listDevices:function(e){var t=this;t.callApi({resource:"device.list",data:{accountId:t.accountId},success:function(t){e(t.data)}})}};return s});