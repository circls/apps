define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{"common.chooseModel.getProvisionerData":{apiRoot:r.config.api.provisioner,url:"phones",verb:"GET"}},subscribe:{"common.chooseModel.render":"chooseModelRender"},chooseModelRender:function(e){var t=this;r.request({resource:"common.chooseModel.getProvisionerData",data:{},success:function(n){var r=t.chooseModelFormatProvisionerData(n.data);r.show_not_listed_links=e.callbackMissingBrand?!0:!1,t.chooseModelRenderProvisioner(r,e.callback,e.callbackMissingBrand)}})},chooseModelFormatProvisionerData:function(e){var t={brands:[]},r,i;return n.each(e,function(e,s){r=[],n.each(e.families,function(e,t){i=[],n.each(e.models,function(e,t){i.push({id:t.toLowerCase(),name:e.name})}),r.push({id:t.toLowerCase(),name:e.name,models:i})}),t.brands.push({id:s.toLowerCase(),name:e.name,families:r})}),t},chooseModelRenderProvisioner:function(e,n,i){var s=this,o,u,a,f=t(r.template(s,"chooseModel-provisioner",e));r.ui.validate(f.find("#device_form"),{rules:{name:{required:!0},mac_address:{required:!0,mac:!0}}}),f.find("#mac_address").mask("hh:hh:hh:hh:hh:hh",{placeholder:" "}),f.find(".brand-box").on("click",function(){var e=t(this),n=e.data("brand");o=n,!e.hasClass("unselected")&&!e.hasClass("selected")?(e.addClass("selected"),t.each(e.siblings(),function(e,n){t(n).addClass("unselected")}),f.find('.models-brand[data-brand="'+n+'"]').show(0,function(){f.find(".block-model").slideDown()})):e.hasClass("unselected")&&f.find('.models-brand[data-brand="'+f.find(".brand-box.selected").data("brand")+'"]').fadeOut("fast",function(){f.find(".brand-box.selected").removeClass("selected").addClass("unselected"),e.removeClass("unselected").addClass("selected"),f.find('.models-brand[data-brand="'+n+'"]').fadeIn("fast")})}),f.find(".model-box").on("click",function(){var e=t(this);a=e.data("model"),u=e.data("family"),f.find(".model-box").removeClass("selected"),e.addClass("selected"),f.find(".actions .selection").text(r.template(s,"!"+s.i18n.active().chooseModel.deviceSelected,{brand:o,model:a})),f.find(".block-footer").slideDown(function(){t("html, body").animate({scrollTop:f.find("div.block-device-info div.title-bar").offset().top},function(){f.find("#name").focus()})})}),f.find(".missing-brand").on("click",function(){l.dialog("close").remove(),i&&i()}),f.find(".action-device").on("click",function(){if(r.ui.valid(f.find("#device_form"))){var e=r.ui.getFormData("device_form"),t={device_type:"sip_device",enabled:!0,mac_address:e.mac_address,name:e.name,provision:{endpoint_brand:o,endpoint_family:u,endpoint_model:a},sip:{password:r.util.randomString(12),realm:r.apps.auth.currentAccount.realm,username:"user_"+r.util.randomString(10)},suppress_unregister_notifications:!1},i=function(){l.dialog("close").remove()};n&&n(t,i)}});var l=r.ui.dialog(f,{position:["center",20],title:s.i18n.active().chooseModel.title})}};return i});