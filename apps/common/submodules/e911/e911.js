define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s={requests:{},subscribe:{"common.e911.renderPopup":"e911Edit"},e911Render:function(e,s){var o=this,u=t(r.template(o,"e911-dialog",e.dash_e911||{})),a;u.find("#postal_code").blur(function(){t.getJSON("http://www.geonames.org/postalCodeLookupJSON?&country=US&callback=?",{postalcode:t(this).val()},function(e){e&&e.postalcodes.length&&e.postalcodes[0].placeName&&(u.find("#locality").val(e.postalcodes[0].placeName),u.find("#region").val(e.postalcodes[0].adminName1))})}),u.find(".inline_field > input").keydown(function(){a.find(".gmap_link_div").hide()}),u.find("#submit_btn").on("click",function(u){u.preventDefault();var f=r.ui.getFormData("e911");n.extend(e,{dash_e911:f});var l=function(t){var n=r.util.formatPhoneNumber(t.data.id),u=r.template(o,"!"+o.i18n.active().e911.successE911,{phoneNumber:n});i.success(u),a.dialog("destroy").remove(),s.success&&s.success(t)};o.e911UpdateNumber(e.id,e,{success:function(e){l(e)},multipleChoices:function(i){var s=t(r.template(o,"e911-addressesDialog",i)),u;s.find(".address-option").on("click",function(){s.find(".address-option.active").removeClass("active"),t(this).addClass("active"),s.find(".save-address").removeClass("disabled")}),s.find(".cancel-link").on("click",function(){u.dialog("destroy").remove()}),s.find(".save-address").on("click",function(){if(s.find(".address-option").hasClass("active")){var t=s.find(".address-option.active").data("id"),r=i.details[t];n.extend(e,{dash_e911:r}),o.e911UpdateNumber(e.id,e,{success:function(e){u.dialog("destroy").remove(),l(e)}})}}),u=r.ui.dialog(s,{title:o.i18n.active().e911.chooseAddressPopup.title})},invalidAddress:function(e){r.ui.alert("error",o.i18n.active().e911.invalidAddress)}})}),u.find("#remove_e911_btn").on("click",function(t){t.preventDefault(),o.callApi({resource:"numbers.list",data:{accountId:o.accountId},success:function(t,u){var f=n.countBy(t.data.numbers,function(e){return"features"in e&&e.features.indexOf("dash_e911")>=0}).true;f>1?(delete e.dash_e911,o.e911UpdateNumber(e.id,e,{success:function(e){var t=r.util.formatPhoneNumber(e.data.id),n=r.template(o,"!"+o.i18n.active().e911.successE911,{phoneNumber:t});i.success(n),a.dialog("destroy").remove(),s.success&&s.success(e)}})):r.ui.alert(o.i18n.active().e911.lastE911Error)}})}),a=r.ui.dialog(u,{title:o.i18n.active().e911.dialogTitle});var f=a.find("#e911_rotated_text"),l=f.width()/2;f.css({top:40+l+"px",left:25-l+"px"})},e911Edit:function(e){var t=this;t.e911GetNumber(e.phoneNumber,function(n){t.e911Render(n.data,e.callbacks)})},e911GetNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.get",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){typeof t=="function"&&t(e)},error:function(e,t){typeof n=="function"&&n(e)}})},e911UpdateNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.update",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e),data:t,generateError:!1},success:function(e,t){n.success&&n.success(e)},error:function(e,r,i){e.error==="400"?t.message==="multiple_choice"?n.multipleChoices&&n.multipleChoices(e.data.multiple_choice.dash_e911):n.invalidAddress&&n.invalidAddress(e.data.address.invalid):i(e,{generateError:!0})}})}};return s});