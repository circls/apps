define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s={requests:{},subscribe:{"common.numbers.dialogSpare":"numbersDialogSpare","common.numbers.render":"numbersRender","common.numbers.getListFeatures":"numbersGetFeatures"},numbersRender:function(e){var n=this,i=e||{},s=i.container||t("#monster-content"),o=i.callbackAfterRender,u=i.viewType||"manager";n.numbersGetData(u,function(e){e.viewType=u,e=n.numbersFormatData(e);var i=t(r.template(n,"numbers-layout",e)),a=r.template(n,"numbers-spare",e),f=r.template(n,"numbers-used",e);i.find('.list-numbers[data-type="spare"]').append(a),i.find('.list-numbers[data-type="used"]').append(f),n.numbersBindEvents(i,e),s.empty().append(i),setTimeout(function(){var e=s.find(".half-box.selected").data("type");s.find('.list-numbers[data-type="'+e+'"] .search-custom input').focus()}),o&&o(s)})},numbersFormatNumber:function(e){var t=this;return e.viewFeatures=t.numbersGetFeatures(),"locality"in e&&(e.isoCountry=e.locality.country||"",e.friendlyLocality="city"in e.locality?e.locality.city+("state"in e.locality?", "+e.locality.state:""):""),n.each(e.features,function(t){t in e.viewFeatures&&(e.viewFeatures[t].active="active")}),"used_by"in e&&(e.friendlyUsedBy=t.i18n.active().numbers[e.used_by]),e.isLocal=e.features.indexOf("local")>-1,e},numbersGetFeatures:function(e){var t=this,n={mobile:{icon:"monster-grey fa fa-mobile-phone",help:t.i18n.active().numbers.mobileIconHelp},failover:{icon:"monster-green fa fa-thumbs-down feature-failover",help:t.i18n.active().numbers.failoverIconHelp},local:{icon:"monster-purple fa fa-rocket feature-local",help:t.i18n.active().numbers.localIconHelp},port:{icon:"fa fa-phone monster-yellow feature-port"},prepend:{icon:"monster-orange fa fa-file-text-o feature-prepend",help:t.i18n.active().numbers.prependIconHelp}};r.util.isNumberFeatureEnabled("e911")&&(n.dash_e911={icon:"monster-red fa fa-ambulance feature-dash_e911",help:t.i18n.active().numbers.e911IconHelp}),r.util.isNumberFeatureEnabled("cnam")&&(n.outbound_cnam={icon:"monster-blue fa fa-user feature-outbound_cnam",help:t.i18n.active().numbers.cnamOutboundIconHelp},n.inbound_cnam={icon:"monster-green fa fa-user feature-inbound_cnam",help:t.i18n.active().numbers.cnamInboundIconHelp});if(!e)return n;e&&e(n)},numbersFormatData:function(e){var t=this,i={},s={spareNumbers:[],usedNumbers:[]},o={hidePort:r.config.whitelabel.hasOwnProperty("hide_port")?r.config.whitelabel.hide_port:!1,viewType:e.viewType,canAddExternalNumbers:r.util.canAddExternalNumbers(),listAccounts:[]},u=n.extend(r.apps.auth.currentAccount,s);e.viewType!=="pbx"&&n.each(e.accounts,function(e){i[e.id]=e}),n.each(e.numbers.numbers,function(n,r){n.phoneNumber=r,n=t.numbersFormatNumber(n),n.used_by?e.viewType!=="pbx"?u.usedNumbers.push(n):(n.used_by==="callflow"||n.used_by==="mobile")&&u.usedNumbers.push(n):u.spareNumbers.push(n)}),u.countUsedNumbers=u.usedNumbers.length,u.countSpareNumbers=u.spareNumbers.length,u.open="open",i[t.accountId]=u;var a=function(e,t){return e.updated>t.updated?-1:1},f=function(e,t){return e.phoneNumber>t.phoneNumber};return n.each(i,function(e){e.id!==t.accountId?o.listAccounts.push(e):(e.spareNumbers.sort(f),e.usedNumbers.sort(f))}),o.listAccounts.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1}),o.listAccounts.unshift(i[t.accountId]),o.isE911Enabled=r.util.isNumberFeatureEnabled("e911"),o.isCnamEnabled=r.util.isNumberFeatureEnabled("cnam"),o},numbersBindEvents:function(e,s){function c(e){o.numbersSyncUsedBy(e,function(t){l(e,function(e){i.success(o.i18n.active().numbers.sync.success)},!0)})}var o=this,u=s.viewType&&s.viewType==="manager"?"full":"partial",a=[o.accountId],f=function(){e.find(".number-box.selected").size()>0?e.find("#trigger_links").show():e.find("#trigger_links").hide()},l=function(t,i,f){var l=n.indexOf(a,t)>=0,f=f||!1;!l||f?o.numbersList(t,function(f){var c=[],h=[],p=function(e,t){return e.phoneNumber>t.phoneNumber};l||a.push(t),n.each(f.numbers,function(e,t){t!=="id"&&t!=="quantity"&&(e.phoneNumber=t,e=o.numbersFormatNumber(e),e.used_by?u==="full"?h.push(e):(e.used_by==="callflow"||e.used_by==="mobile")&&h.push(e):c.push(e))}),n.each(s.listAccounts,function(n){if(n.id===t)return n.spareNumbers=c.sort(p),n.usedNumbers=h.sort(p),n.countSpareNumbers=c.length,n.countUsedNumbers=h.length,e.find('.list-numbers[data-type="spare"] .account-section[data-id="'+t+'"] .numbers-wrapper').empty().append(r.template(o,"numbers-spareAccount",{viewType:s.viewType,spareNumbers:c})).parent().find(".count").html("("+c.length+")"),e.find('.list-numbers[data-type="used"] .account-section[data-id="'+t+'"] .numbers-wrapper').empty().append(r.template(o,"numbers-usedAccount",{viewType:s.viewType,usedNumbers:h,isCnamEnabled:r.util.isNumberFeatureEnabled("cnam"),isE911Enabled:r.util.isNumberFeatureEnabled("e911")})).parent().find(".count").html("("+h.length+")"),!1}),i&&i()},u):i&&i()};r.ui.tooltips(e),s.viewType==="pbx"?(e.find('.list-numbers[data-type="spare"]').hide(),e.find('.half-box[data-type="used"]').addClass("selected")):(e.find('.list-numbers[data-type="used"]').hide(),e.find('.half-box[data-type="spare"]').addClass("selected")),e.find(".half-box").on("click",function(){var n=t(this),r=n.data("type");n.hasClass("selected")||(e.find(".half-box").removeClass("selected"),e.find(".list-numbers").hide(),setTimeout(function(){e.find('.list-numbers[data-type="'+r+'"] .search-custom input').focus()}),n.addClass("selected"),e.find('.list-numbers[data-type="'+r+'"]').show())}),e.on("click",'.account-header input[type="checkbox"]',function(e){var n=t(this).parents(".account-section").first().find('.number-box input[type="checkbox"]'),r=t(this).prop("checked");n.prop("checked",r),r?n.parent().addClass("selected"):n.parent().removeClass("selected"),f()}),e.on("click",".expandable",function(e){var r=t(this).parents(".account-section"),i=r.data("id"),o=function(){r.toggleClass("open"),r.hasClass("open")||(r.find('input[type="checkbox"]:checked').prop("checked",!1),r.find(".number-box.selected").removeClass("selected")),n.each(s.listAccounts,function(e){e.id===i&&(e.open=r.hasClass("open")?"open":"")})};l(i,function(){o()}),f()}),e.on("click",".account-header .buy-numbers-link",function(n){var i=t(this).parents(".account-section").data("id");r.pub("common.buyNumbers",{accountId:i,searchType:t(this).data("type"),callbacks:{success:function(t){l(i,function(t){e.find('.account-section[data-id="'+i+'"]').addClass("open")},!0)}}})}),e.on("click",".actions-wrapper .buy-numbers-dropdown .buy-numbers-link",function(e){var n=o.accountId;r.pub("common.buyNumbers",{accountId:o.accountId,searchType:t(this).data("type"),callbacks:{success:function(e){l(o.accountId,function(e){},!0)}}})}),e.on("click",".account-header .action-number.port",function(n){var i=t(this).parents(".account-section").data("id");r.pub("common.port.render",{accountId:i,callbacks:{success:function(t){l(i,function(t){e.find('.account-section[data-id="'+i+'"]').addClass("open")},!0)}}})}),e.on("click",".actions-wrapper .action-number.port",function(e){var n=o.accountId;r.pub("common.port.render",{accountId:n,searchType:t(this).data("type"),callbacks:{success:function(e){l(n,function(e){},!0)}}})}),e.on("click",".account-header .action-number.add-external",function(e){o.numbersAddExternalNumbers(t(this).parents(".account-section").data("id"),function(){o.numbersRender({container:t("#number_manager")})})}),e.on("click",".account-header .action-number.sync",function(e){c(t(this).parents(".account-section").data("id"))}),e.on("click",".actions-wrapper .action-number.sync",function(e){c(o.accountId)}),e.on("click",".number-box:not(.disabled)",function(e){var n=t(this);if(!n.hasClass("no-data")){var r=n.parents(".account-section").first(),i=r.find('.account-header input[type="checkbox"]');n.toggleClass("selected");if(!t(e.target).is("input:checkbox")){var s=n.find('input[type="checkbox"]'),o=s.prop("checked");s.prop("checked",!o)}r.find('.numbers-wrapper input[type="checkbox"]:checked').size()===r.find('.numbers-wrapper input[type="checkbox"]').size()?i.prop("checked",!0):i.prop("checked",!1)}f()}),e.on("click","#delete_numbers",function(i){var u=[],a={},f={"delete":!0,accountList:[]};e911ErrorMessage="",e.find(".number-box.selected").each(function(e,n){var r=t(n),i=r.data("phonenumber");accountId=r.parents(".account-section").data("id"),accountName=r.parents(".account-section").data("name").toString(),accountId in a||(a[accountId]={},f.accountList.push({accountName:accountName}));for(var s in f.accountList)typeof f.accountList[s].numbers=="undefined"&&(f.accountList[s].numbers=new Array),f.accountList[s].accountName==accountName&&f.accountList[s].numbers.push(i);a[accountId][i]=!0,u.push(i)}),f.numberCount=u.length,n.each(f.accountList,function(e){var t=n.find(s.listAccounts,function(t){return t.name===e.accountName}),r=n.filter(t.spareNumbers,function(e){return e.features.indexOf("dash_e911")>=0}).concat(n.filter(t.usedNumbers,function(e){return e.features.indexOf("dash_e911")>=0})),i=[];r.length>0&&(n.each(r,function(t){e.numbers.indexOf(t.phoneNumber)>=0&&i.push(t.phoneNumber)}),r.length===i.length&&(e911ErrorMessage||(e911ErrorMessage=o.i18n.active().numbers.deleteE911Error.message),e911ErrorMessage+="<br><br>"+o.i18n.active().numbers.deleteE911Error.account+" "+e.accountName,e911ErrorMessage+="<br>"+o.i18n.active().numbers.deleteE911Error.numbers+" "+i.join(", ")))});if(e911ErrorMessage)r.ui.alert("error",e911ErrorMessage);else{var l=t(r.template(o,"numbers-actionsConfirmation",f)),c={numbers:u,accountId:o.accountId},h=r.ui.dialog(l,{width:"540px",title:"Delete Numbers - Confirmation"});l.on("click",".remove-number",function(){for(var e in c.numbers){if(t(this).parent().data("number")==c.numbers[e]){var n=t(this).parent().parent().parent(),r=n[0].childElementCount,i=l.find("h4").find(".monster-blue");c.numbers.splice(e,1),t(this).parent().parent().remove(),r==1&&(n[0].previousElementSibling.remove(),n.remove()),i.text(i.text()-1)}c.numbers.length==0&&l.parent().parent().remove()}}),l.on("click",".cancel-link",function(){h.remove()}),l.on("click","#delete_action",function(){o.numbersDelete(c,function(t){var r=0;n.each(s.listAccounts,function(e,i){if(e.id in a){var o=[];n.each(e.spareNumbers,function(e,n){!!t.hasOwnProperty("success")&&e.phoneNumber in t.success?r++:o.push(e)}),s.listAccounts[i].spareNumbers=o,s.listAccounts[i].countSpareNumbers=o.length}}),h.remove(),o.numbersShowDeletedNumbers(t),o.numbersPaintSpare(e,s,function(){})})})}});var h=function(u,f){var l=[],c=u,h=-1,p={},d={destinationAccountName:f,move:!0,accountList:[]};e.find(".number-box.selected").each(function(e,n){var r=t(n),i=r.data("phonenumber");u=r.parents(".account-section").data("id"),f=r.parents(".account-section").data("name"),u in p||(p[u]={},d.accountList.push({accountName:f}));for(var s in d.accountList)typeof d.accountList[s].numbers=="undefined"&&(d.accountList[s].numbers=new Array),d.accountList[s].accountName==f&&d.accountList[s].numbers.push(i);p[u][i]=!0,l.push(i)}),d.numberCount=l.length;var v=t(r.template(o,"numbers-actionsConfirmation",d)),m={numbers:l,accountId:c};r.ui.dialog(v,{width:"540px",title:"Move Numbers - Confirmation"}),v.on("click",".remove-number",function(){for(var e in m.numbers){if(t(this).parent().data("number")==m.numbers[e]){var n=t(this).parent().parent().parent(),r=n[0].childElementCount,i=v.find("h4").find(".monster-blue:first-child");m.numbers.splice(e,1),t(this).parent().parent().remove(),r==1&&(n[0].previousElementSibling.remove(),n.remove()),i.text(i.text()-1)}m.numbers.length==0&&v.parent().parent().remove()}}),v.on("click",".cancel-link",function(){v.parent().parent().remove()}),v.on("click","#move_action",function(){o.numbersMove(m,function(t){var u=0;n.each(s.listAccounts,function(e,r){e.id===c&&(h=r);if(e.id in p){var i=[];n.each(e.spareNumbers,function(e,n){e.phoneNumber in t.success?(t.success[e.phoneNumber]=e,u++):i.push(e)}),s.listAccounts[r].spareNumbers=i,s.listAccounts[r].countSpareNumbers=i.length}}),n.indexOf(a,c)>-1&&(n.each(t.success,function(e,t){s.listAccounts[h].spareNumbers.push(e)}),s.listAccounts[h].countSpareNumbers=s.listAccounts[h].spareNumbers.length),o.numbersPaintSpare(e,s,function(){var e={count:u,accountName:s.listAccounts[h].name},t=r.template(o,"!"+o.i18n.active().numbers.successMove,e);v.parent().parent().remove(),i.success(t)})})})};e.on("click","#move_numbers",function(){r.pub("common.accountBrowser.render",{container:e.find('.list-numbers[data-type="spare"] .accounts-dropdown'),customClass:"ab-dropdown",addCurrentAccount:!0,addBackButton:!0,onAccountClick:function(t,n){h(t,n),e.find('.list-numbers[data-type="spare"] .dropdown-move').removeClass("open")}})}),r.util.isNumberFeatureEnabled("cnam")&&e.on("click",".cnam-number",function(){var e=t(this).parents(".number-box"),n=e.first(),i=n.data("phonenumber");if(i){var s={phoneNumber:i,callbacks:{success:function(t){r.ui.highlight(e),"cnam"in t.data&&t.data.cnam.display_name?n.find(".features i.feature-outbound_cnam").addClass("active"):n.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in t.data&&t.data.cnam.inbound_lookup?n.find(".features i.feature-inbound_cnam").addClass("active"):n.find(".features i.feature-inbound_cnam").removeClass("active")}}};r.pub("common.callerId.renderPopup",s)}}),r.util.isNumberFeatureEnabled("e911")&&e.on("click",".e911-number",function(){var e=t(this).parents(".number-box"),n=e.first(),i=n.data("phonenumber");if(i){var s={phoneNumber:i,callbacks:{success:function(i){r.ui.highlight(e),t.isEmptyObject(i.data.dash_e911)?n.find(".features i.feature-dash_e911").removeClass("active"):n.find(".features i.feature-dash_e911").addClass("active")}}};r.pub("common.e911.renderPopup",s)}}),e.on("click",".failover-number",function(){var e=t(this).parents(".number-box"),n=e.first(),i=n.data("phonenumber");if(i){var s={phoneNumber:i,callbacks:{success:function(i){r.ui.highlight(e),t.isEmptyObject(i.data.failover)?n.find(".features i.feature-failover").removeClass("active"):n.find(".features i.feature-failover").addClass("active")}}};r.pub("common.failover.renderPopup",s)}}),e.on("click",".prepend-number",function(){var e=t(this).parents(".number-box"),n=e.first(),i=n.data("phonenumber");if(i){var s={phoneNumber:i,callbacks:{success:function(t){r.ui.highlight(e),"prepend"in t.data&&t.data.prepend.enabled?n.find(".features i.feature-prepend").addClass("active"):n.find(".features i.feature-prepend").removeClass("active")}}};r.pub("common.numberPrepend.renderPopup",s)}});var p=function(e,t){var u=t;e=r.util.unformatPhoneNumber(e),o.numbersSearchAccount(e,function(a){a.account_id&&(n.find(s.listAccounts,function(e){return e.id===a.account_id})?l(a.account_id,function(){var e=u.find('[data-id="'+a.account_id+'"]'),n=e.find('[data-phonenumber="'+a.number+'"]');if(n.size()>0)e.addClass("open"),r.ui.highlight(n,{timer:5e3});else{var s=t.attr("data-type")==="spare"?"notSpareNumber":"notUsedNumber",f=r.template(o,"!"+o.i18n.active().numbers[s],{number:a.number,accountName:e.data("name")});i.warning(f)}}):o.numbersRenderNumberPopup(e,a.account_id))})};e.on("click",'.list-numbers[data-type="spare"] button.search-numbers',function(t){var n=e.find('.list-numbers[data-type="spare"]'),r=n.find('.search-custom input[type="text"]').val().toLowerCase();p(r,n)}),e.on("keyup",'.list-numbers[data-type="spare"] .search-custom input[type="text"]',function(t){if(t.keyCode===13){var n=t.target.value.toLowerCase(),r=e.find('.list-numbers[data-type="spare"]');n&&p(n,r)}}),e.on("click",'.list-numbers[data-type="used"] button.search-numbers',function(t){var n=e.find('.list-numbers[data-type="used"]'),r=n.find('.search-custom input[type="text"]').val().toLowerCase();p(r,n)}),e.on("keyup",'.list-numbers[data-type="used"] .search-custom input[type="text"]',function(t){if(t.keyCode===13){var n=t.target.value.toLowerCase(),r=e.find('.list-numbers[data-type="used"]');n&&p(n,r)}})},numbersAddIndividualNumber:function(e,t,n,i){var s=this;r.util.canAddExternalNumbers()?s.numbersCreateNumber(e,t,function(){s.numbersActivateNumber(e,t,function(){n&&n()},i)},i):i()},numbersAddFreeformNumbers:function(e,t,i){var s=this,o={};n.each(e,function(e){o[e]=function(n){s.numbersAddIndividualNumber(e,t,function(e){n(null,e)},function(e){n(null,{})})}}),r.parallel(o,function(e,t){i&&i(t)})},numbersAddExternalNumbers:function(e,i){var s=this,o=t(r.template(s,"numbers-addExternal"));o.on("click",".cancel-link",function(){u.remove()}),o.on("click","#add_numbers",function(t){t.preventDefault();var a=o.find(".list-numbers").val(),f=[],l;a=a.replace(/[\s-\(\)\.]/g,"").split(","),n.each(a,function(e){l=e.match(/^\+(.*)$/),l&&l[1]&&f.push(e)}),f.length>0?s.numbersAddFreeformNumbers(f,e,function(){u.dialog("close"),i&&i()}):r.ui.alert(s.i18n.active().numbers.addExternal.dialog.invalidNumbers)});var u=r.ui.dialog(o,{title:s.i18n.active().numbers.addExternal.dialog.title})},numbersRenderNumberPopup:function(e,n){var i=this;i.numbersGetNumberPopupData({number:e,accountId:n,callback:function(e){var n=t(r.template(i,"numbers-searchResult",{parents:e.parentAccounts.concat({id:e.account.id,name:e.account.name,isAccountFound:!0}),ownedBy:e.account.name,usedBy:e.number.used_by?i.i18n.active().numbers[e.number.used_by]:undefined})),s=r.ui.dialog(n,{title:r.util.formatPhoneNumber(e.number.id)});r.ui.tooltips(n),i.numbersBindNumberPopupEvents({popup:s,template:n,data:e})}})},numbersGetNumberPopupData:function(e){var t=this,n=e.number,i=e.accountId,s=e.callback;r.parallel({number:function(e){t.callApi({resource:"numbers.get",data:{accountId:i,phoneNumber:n},success:function(t,n){e(null,t.data)}})},account:function(e){t.callApi({resource:"account.get",data:{accountId:i},success:function(t,n){e(null,t.data)}})},parentAccounts:function(e){t.callApi({resource:"account.listParents",data:{accountId:i},success:function(t,n){e(null,t.data)}})}},function(e,t){s&&s(t)})},numbersBindNumberPopupEvents:function(e){var t=this,n=e.popup,i=e.template,s=e.data;i.find(".account-name.masqueradable").on("click",function(){r.pub("core.triggerMasquerading",{account:s.account,callback:function(){var e=r.apps.getActiveApp();e in r.apps&&(r.apps[e].render(),n.dialog("close"))}})})},numbersShowDeletedNumbers:function(e){var i=this,s=t(r.template(i,"numbers-deleteConfirmation")),o={errors:[],successes:[],countTotal:0};n.each(e.error,function(e,t){o.errors.push({id:t,value:r.util.formatPhoneNumber(t)})}),n.each(e.success,function(e,t){o.successes.push({id:t,value:r.util.formatPhoneNumber(t)})}),o.countTotal=o.successes.length+o.errors.length,s.find(".results-wrapper").append(r.ui.results(o)),s.find("#continue").on("click",function(){u.remove()});var u=r.ui.dialog(s,{title:i.i18n.active().numbers.deleteRecapDialog.title})},numbersPaintSpare:function(e,t,n){var i=this,s=r.template(i,"numbers-spare",t);e.find('.list-numbers[data-type="spare"]').empty().append(s),n&&n()},numbersGetData:function(e,t){var n=this,i=e&&e==="manager"?"full":"partial";r.parallel({numbers:function(e){n.numbersList(n.accountId,function(t){e(null,t)},i)},accounts:function(e){n.numbersListAccounts(function(t){e(null,t)})}},function(e,n){t(n)})},numbersMove:function(e,t){var n=this;n.callApi({resource:"numbers.activateBlock",data:{accountId:e.accountId,data:{numbers:e.numbers}},success:function(e,n){t&&t(e.data)}})},numbersSearchAccount:function(e,t,n){var r=this;r.callApi({resource:"numbers.identify",data:{accountId:r.accountId,phoneNumber:e,generateError:!1},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n(e),i.error(r.i18n.active().numbers.numberNotFound)}})},numbersDelete:function(e,t){var n=this;n.callApi({resource:"numbers.deleteBlock",data:{accountId:e.accountId,data:{numbers:e.numbers}},success:function(e,n){t&&t(e.data)}})},numbersCreateNumber:function(e,t,n,r){var i=this;i.callApi({resource:"numbers.create",data:{accountId:t,phoneNumber:encodeURIComponent(e)},success:function(e){n&&n(e.data)},error:function(e){r&&r(e)}})},numbersActivateNumber:function(e,t,n,r){var i=this;i.callApi({resource:"numbers.activate",data:{accountId:t,phoneNumber:encodeURIComponent(e)},success:function(e){n&&n(e.data)},error:function(e){r&&r(e)}})},numbersFormatDialogSpare:function(e,r,i,s){var o=this,u={accountName:e.accountName,numbers:{}},a=function(e,t){t.phoneNumber=e,t=o.numbersFormatNumber(t),u.numbers[e]=t};return n.each(e.numbers,function(e,n){i.indexOf(n)>=0?a(n,e):e.used_by===""&&r.indexOf(n)===-1&&(!s||s.length===0?a(n,e):t.each(s,function(t,r){if(e.features&&e.features.indexOf(r)>=0)return a(n,e),!1}))}),u},numbersDialogSpare:function(e){var t=this,n=e.accountId,i=e.accountName||"",s=e.ignoreNumbers||[],o=e.extraNumbers||[],u=e.featureFilters||[],a=e.singleSelect||!1,f=e.callback;t.numbersList(n,function(n){n.accountName=i;var f=t.numbersFormatDialogSpare(n,s,o,u);r.pub("common.monsterListing.render",{dataList:f.numbers,dataType:"numbers",labels:{title:t.i18n.active().numbers.dialogSpare.title,headline:f.accountName?t.i18n.active().numbers.dialogSpare.headline+" "+f.accountName:t.i18n.active().numbers.dialogSpare.headlineNoAccount,okButton:t.i18n.active().numbers.dialogSpare.proceed},singleSelect:a,okCallback:e.callback})})},numbersList:function(e,t,n){var i=this;r.parallel({callflows:function(t){i.numbersListCallflows(e,function(e){t&&t(null,e)})},devices:function(t){i.numbersListMobileDevices(e,function(e){t&&t(null,e)})},groups:function(t){i.numbersListGroups(e,function(e){t&&t(null,e)})},users:function(t){i.numbersListUsers(e,function(e){t&&t(null,e)})},numbers:function(t){i.numbersListNumbers(e,function(e){t&&t(null,e)},n)}},function(n,r){i.numbersFormatList(e,r),t&&t(r.numbers)})},numbersFormatList:function(e,r){var i=this,s={},o={};return n.each(r.users,function(e){s[e.id]=e}),n.each(r.groups,function(e){o[e.id]=e}),n.each(r.callflows,function(e){n.each(e.numbers,function(t){if(t in r.numbers.numbers)if(e.owner_id&&e.owner_id in s){var n=s[e.owner_id];r.numbers.numbers[t].owner=n.first_name+" "+n.last_name,r.numbers.numbers[t].ownerType="user"}else e.group_id?(r.numbers.numbers[t].owner=o[e.group_id].name,r.numbers.numbers[t].ownerType="group"):e.type&&e.type==="main"?(r.numbers.numbers[t].owner=i.i18n.active().numbers.mainNumber,r.numbers.numbers[t].ownerType="main"):e.type&&e.type==="conference"?(r.numbers.numbers[t].owner=i.i18n.active().numbers.conferenceNumber,r.numbers.numbers[t].ownerType="conference"):(r.numbers.numbers[t].owner=i.i18n.active().numbers.callflows,r.numbers.numbers[t].ownerType="callflows")})}),n.each(r.devices,function(n,o){r.numbers.numbers[n.mobile.mdn]={assigned_to:e,features:["mobile"],isLocal:!1,phoneNumber:n.mobile.mdn,state:"in_service",used_by:"mobile"};var u={};n.hasOwnProperty("owner_id")?u={owner_id:n.owner_id,ownerType:"mobileUser",owner:s[n.owner_id].first_name+" "+s[n.owner_id].last_name}:u={owner:i.i18n.active().numbers.unassigned},t.extend(!0,r.numbers.numbers[n.mobile.mdn],u)}),console.log(r.numbers.numbers),r},numbersSyncUsedBy:function(e,t){var n=this;n.callApi({resource:"numbers.sync",data:{accountId:e},success:function(e){t&&t(e.data)}})},numbersListUsers:function(e,t){var n=this;n.callApi({resource:"user.list",data:{accountId:e,filters:{paginate:!1}},success:function(e,n){t&&t(e.data)}})},numbersListCallflows:function(e,t){var n=this;n.callApi({resource:"callflow.list",data:{accountId:e,filters:{paginate:!1}},success:function(e,n){t&&t(e.data)}})},numbersListGroups:function(e,t){var n=this;n.callApi({resource:"group.list",data:{accountId:e,filters:{paginate:!1}},success:function(e,n){t&&t(e.data)}})},numbersListNumbers:function(e,t,n){var r=this,i=n||"partial",s=i==="partial"?"numbers.list":"numbers.listAll";r.callApi({resource:s,data:{accountId:e,filters:{paginate:!1}},success:function(e,n){t&&t(e.data)}})},numbersListAccounts:function(e){var t=this;t.callApi({resource:"account.listChildren",data:{accountId:t.accountId},success:function(t,n){e&&e(t.data)}})},numbersListMobileDevices:function(e,t){var n=this;n.callApi({resource:"device.list",data:{accountId:e,filters:{filter_device_type:"mobile",has_key:"mobile"}},success:function(e,n){t&&t(e.data)}})}};return s});