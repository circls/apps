define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"common.accountBrowser.render":"accountBrowserRender","common.accountBrowser.getBreadcrumbsList":"accountBrowserGetBreadcrumbsList"},accountBrowserRender:function(e){var n=this,i=e.container,s=e.breadcrumbsContainer,o=e.breadcrumbsList,u=e.parentId,a=e.selectedId,f=e.onAccountClick,l=e.onChildrenClick,c=e.onBreadcrumbClick,h=e.onNewAccountClick,p=e.addCurrentAccount||!1,d=e.addBackButton||!1,v=e.allowBackOnMasquerading||!1,m=e.callback,g=t(r.template(n,"accountBrowser-layout",{customClass:e.customClass||"ab-sidebar",addAccountEnabled:typeof h=="function"})),y=g.find(".account-search-link").remove();if(!i)throw new ReferenceError('The "container" arg is required to load the account browser.');i.empty().append(g),n.accountBrowserRenderList({container:g.find(".account-list-container"),parentId:u,selectedId:a,addCurrentAccount:p,addBackButton:d,allowBackOnMasquerading:v,callback:m});if(s)if(o&&o.length){var b=t(r.template(n,"accountBrowser-breadcrumbs",{id:o[0].id,name:o[0].name}));for(var w=1;w<o.length;w++)b.append(r.template(n,"accountBrowser-breadcrumb",{id:o[w].id,name:o[w].name,parentId:o[w].parentId}));s.empty().append(b)}else{var b=t(r.template(n,"accountBrowser-breadcrumbs",{id:n.accountId,name:r.apps.auth.currentAccount.name}));u&&u!==n.accountId&&b.append(r.template(n,"accountBrowser-breadcrumb",{})),s.empty().append(b)}n.accountBrowserBindEvents({template:g,breadcrumbsTemplate:s,onAccountClick:f,onChildrenClick:l,onBreadcrumbClick:c,onNewAccountClick:h,addCurrentAccount:p,addBackButton:d,allowBackOnMasquerading:v,searchLink:y})},accountBrowserGetBreadcrumbsList:function(e){var n=e.container||e,r=t.map(n.find(".account-browser-breadcrumb a"),function(e){var n=t(e);return{id:n.data("id"),name:n.text(),parentId:n.data("parent")}});return e.callback&&e.callback(r),r},accountBrowserBindEvents:function(e){var i=this,s=e.template,o=e.breadcrumbsTemplate,u=e.onAccountClick,a=e.onChildrenClick,f=e.onBreadcrumbClick,l=e.onNewAccountClick,c=e.searchLink,h=e.addCurrentAccount,p=e.addBackButton,d=e.allowBackOnMasquerading,v=s.find(".account-list"),m=!1,g=t('<li class="content-centered account-list-loader"> <i class="fa fa-spinner fa-spin"></i></li>');setTimeout(function(){s.find(".search-query").focus()}),s.on("click",function(e){e.stopPropagation()}),s.find(".account-list-add").on("click",function(){var e=v.data("current"),t=i.accountBrowserGetBreadcrumbsList(o);l&&l(e,t)});var y=function(e,t){var r=!1;return n.each(t,function(t){t.toLowerCase().indexOf(e.toLowerCase())>=0&&(r=!0)}),r};s.find(".account-browser-search").on("keyup",function(e){var n=t(this),r=n.val();c.find(".account-search-value").text(r),e.which==13&&s.find(".account-list-element:visible").length===0?s.find(".account-search-link").click():r?(t.each(s.find(".account-list-element"),function(){var e=t(this),n=e.data();y(r,n)?e.show():e.hide()}),v.prepend(c)):(s.find(".account-list-element").show(),c.remove())}),v.on("click",".account-link",function(){var e=t(this).parents(".account-list-element");s.find(".account-list-element").removeClass("active"),e.addClass("active"),u&&u(e.data("id"),e.data("name"))}),v.on("click",".account-children-link:not(.disabled)",function(){var e=t(this),u=e.parents(".account-list-element"),f=u.data("id"),l=u.data("name"),c=v.data("current"),m=v.data("search-value");e.addClass("disabled"),s.find(".account-browser-search").prop("disabled",!1).val(""),i.accountBrowserRenderList({container:s.find(".account-list-container"),parentId:f,slide:!0,addCurrentAccount:h,addBackButton:p,allowBackOnMasquerading:d,callback:function(){if(o){var e=function(e,t,n){var s=r.template(i,"accountBrowser-breadcrumb",{id:e,name:t,parentId:n});o.find(".account-browser-breadcrumbs").append(s)};if(m){var t=o.find(".account-browser-breadcrumb").first(),s=t.find("a").data("id");t.nextAll().remove(),i.callApi({resource:"account.listParents",data:{accountId:f},success:function(t,r){var i=null;n.each(t.data,function(t){t.id===s?i=t.id:i&&(e(t.id,t.name,i),i=t.id)}),e(f,l,i||s)}})}else e(f,l,c)}a&&a(f)}})}),v.on("click",".account-search-link",function(){if(c.hasClass("active"))v.data("search-value",null),c.removeClass("active").remove(),s.find(".account-browser-search").prop("disabled",!1).val(""),o&&o.find(".account-browser-breadcrumb:not(:first-child)").remove(),i.accountBrowserRenderList({container:s.find(".account-list-container"),addBackButton:p,allowBackOnMasquerading:d,addCurrentAccount:h});else{var e=c.find(".account-search-value").text();c.addClass("active").remove(),i.accountBrowserRenderList({container:s.find(".account-list-container"),searchValue:e,slide:!1,addCurrentAccount:h,addBackButton:p,allowBackOnMasquerading:d,callback:function(){s.find(".account-browser-search").prop("disabled",!0),v.prepend(c);if(o){var t=r.template(i,"accountBrowser-breadcrumb",{search:r.template(i,"!"+i.i18n.active().accountBrowser.breadcrumbSearchResults,{searchValue:e})});o.find(".account-browser-breadcrumb").first().nextAll().remove(),o.find(".account-browser-breadcrumbs").append(t)}}})}}),v.on("scroll",function(){if(!m&&v.data("next-key")&&v.scrollTop()>=v[0].scrollHeight-v.innerHeight()-100){m=!0,v.append(g);var e=v.data("search-value"),n=e?"account.searchByName":"account.listChildren",s=e?{accountName:e}:{accountId:v.data("current")},o=v.data("next-key");i.callApi({resource:n,data:t.extend(!0,s,{filters:{start_key:encodeURIComponent(o)}}),success:function(e,n){var s=e.next_start_key,o=t(r.template(i,"accountBrowser-list",{accounts:r.util.sort(e.data)}));g.remove(),v.append(o),v.data("next-key",s||null),m=!1}})}}),o&&o.on("click",".account-browser-breadcrumb a",function(){var e=t(this),n=e.data("id"),r=e.data("parent");r?o.find('a[data-id="'+r+'"]').parents(".account-browser-breadcrumb").nextAll().remove():e.parents(".account-browser-breadcrumb").nextAll().remove(),s.find(".account-browser-search").prop("disabled",!1).val(""),i.accountBrowserRenderList({container:s.find(".account-list-container"),parentId:r||n,selectedId:r?n:null,addCurrentAccount:h,addBackButton:p,allowBackOnMasquerading:d,callback:function(){f&&f(n,r)}})}),p&&v.on("click",".account-previous-link",function(){var e=v.data("current")||i.accountId,t=d?r.apps.auth.originalAccount.id:i.accountId;e!==t&&i.callApi({resource:"account.listParents",data:{accountId:e},success:function(e,t){if(e.data&&e.data.length>0){var n=e.data[e.data.length-1].id;o&&o.find('a[data-id="'+n+'"]').parents(".account-browser-breadcrumb").nextAll().remove(),s.find(".account-browser-search").prop("disabled",!1).val(""),i.accountBrowserRenderList({container:s.find(".account-list-container"),parentId:n,addCurrentAccount:h,addBackButton:p,allowBackOnMasquerading:d})}}})})},accountBrowserRenderList:function(e){var n=this,i=e.container,s=e.parentId||n.accountId,o=e.selectedId,u=e.slide,a=e.searchValue,f=e.addCurrentAccount,l=e.addBackButton,c=e.allowBackOnMasquerading,h=e.callback,p=c?r.apps.auth.originalAccount.id:n.accountId;s===p&&(l=!1),n.accountBrowserGetData(a,s,function(e){var c=e.next_start_key,p=i.find(".account-list-slider"),d=i.find(".account-list"),v={accounts:r.util.sort(e.data),selectedId:o,addBackButton:l};f&&(v.currentAccount=r.apps.auth.currentAccount);var m=t(r.template(n,"accountBrowser-list",v));u?(p.empty().append(m),d.animate({marginLeft:-d.outerWidth()},400,"swing",function(){d.empty().append(p.html()).css("marginLeft","0px"),p.empty()})):d.empty().append(m),d.data("next-key",c||null),d.data("current",s),d.data("search-value",a||null),h&&h()})},accountBrowserGetData:function(e,t,n){var r=this,i=e?"account.searchAll":"account.listChildren",s=e?{searchValue:e}:{accountId:t};r.callApi({resource:i,data:s,success:function(e){var t=r.accountBrowserFormatGetData(e);n&&n(t)}})},accountBrowserFormatGetData:function(e){var t=this,r={data:[]};if(n.isArray(e.data))r=e;else{var i={},s=function(e){n.each(e,function(e){i.hasOwnProperty(e.id)||(r.data.push(e),i[e.id]=!0)})};n.each(e.data,function(e){s(e)})}return r}};return i});