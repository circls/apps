define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"common.servicePlanDetails.render":"servicePlanDetailsRender","common.servicePlanDetails.getServicePlanTemplate":"servicePlanCustomizeGetTemplate","common.servicePlanDetails.customizeSave":"servicePlanCustomizeSave"},servicePlanDetailsRender:function(e){var t=this,n=e.container,r=e.servicePlan||null,i=e.useOwnPlans||!1,s=e.callback,o=e.accountId||t.accountId;if(!n)throw"You must provide a container!";typeof r=="string"?t.callApi({resource:i?"servicePlan.get":"servicePlan.getAvailable",data:{accountId:o,planId:r},success:function(e,r){t.renderServicePlanDetails(n,e.data,s)}}):t.renderServicePlanDetails(n,r,s)},servicePlanDetailsFormatData:function(e){var t=this,n={servicePlan:{}};return e.hasOwnProperty("items")&&!e.hasOwnProperty("plan")&&(e.plan=e.items),n.servicePlan=e,n},renderServicePlanDetails:function(e,n,i){var s=this,o=s.servicePlanDetailsFormatData(n),u=t(r.template(s,"servicePlanDetails-layout",o));r.ui.tooltips(u),e.empty().append(u),i&&i({template:u,data:n})},servicePlanCustomizeGetOverrideDefault:function(){var e=this,t={number_services:{_all:{rate:{},activation_charge:{},minimum:{},exceptions:{},as:{}},port:{rate:{},activation_charge:{},minimum:{}},cnam:{rate:{},activation_charge:{},minimum:{}},e911:{rate:{},activation_charge:{},minimum:{}}},devices:{_all:{rate:{},activation_charge:{},minimum:{},exceptions:{},as:{}},ata:{rate:{},activation_charge:{},minimum:{}},cellphone:{rate:{},activation_charge:{},minimum:{}},fax:{rate:{},activation_charge:{},minimum:{}},landline:{rate:{},activation_charge:{},minimum:{}},mobile:{rate:{},activation_charge:{},minimum:{}},sip_device:{rate:{},activation_charge:{},minimum:{}},sip_uri:{rate:{},activation_charge:{},minimum:{}},smartphone:{rate:{},activation_charge:{},minimum:{}},softphone:{rate:{},activation_charge:{},minimum:{}}},limits:{_all:{rate:{},activation_charge:{},minimum:{},exceptions:{},as:{}},outbound_trunks:{rate:{},activation_charge:{},minimum:{}},inbound_trunks:{rate:{},activation_charge:{},minimum:{}},twoway_trunks:{rate:{},activation_charge:{},minimum:{}}},phone_numbers:{_all:{rate:{},activation_charge:{},minimum:{},exceptions:{},as:{}},tollfree_us:{rate:{},activation_charge:{},minimum:{}},toll_us:{rate:{},activation_charge:{},minimum:{}},emergency:{rate:{},activation_charge:{},minimum:{}},caribbean:{rate:{},activation_charge:{},minimum:{}},did_us:{rate:{},activation_charge:{},minimum:{}},international:{rate:{},activation_charge:{},minimum:{}},unknown:{rate:{},activation_charge:{},minimum:{}}},users:{_all:{rate:{},activation_charge:{},minimum:{},exceptions:{},as:{}},user:{rate:{},activation_charge:{},minimum:{}},admin:{rate:{},activation_charge:{},minimum:{}}},ui_apps:{accounts:{},branding:{},callflows:{},carriers:{},cluster:{},debug:{},migration:{},mobile:{},numbers:{},pbxs:{},pivot:{},port:{},provisioner:{},reporting:{},userportal:{},voip:{},webhooks:{}}};return n.each(t,function(e){n.each(e,function(e){e.hasOptions=!n.isEmpty(e)})}),t},servicePlanCustomizeGetTemplate:function(e){var i=this,s=e,o=e.mode||"edit",u=e.useOwnPlans||!1,a=s.accountId||i.accountId;r.parallel({current:function(e){o==="new"?e(null,{}):i.servicePlanDetailsGetCurrentSP(a,function(t){var s={details:t,selectedPlans:{}};if(t&&t.plans&&!n.isEmpty(t.plans)){var o={};n.each(t.plans,function(e,t){o[t]=function(e){i.servicePlanDetailsGetSP(t,a,!1,function(t){e&&e(null,t)},function(t){e(null,t)})}}),r.parallel(o,function(t,r){n.each(r,function(e,t){n.isEmpty(e)&&delete r[t]}),s.selectedPlans=r,e&&e(null,s)})}else e(null,s)})},listAvailable:function(e){i.servicePlanDetailsListSP(a,u,function(t){e(null,t)})}},function(e,o){var f=i.servicePlanCustomizeFormatData(o),l=t(r.template(i,"servicePlanDetails-customizeView",f)),c,h;n.each(f.selectedPlans,function(e,t){c=l.find('[value="'+t+'"]:selected').parents(".customize-details-wrapper").find(".details-selected-service-plan"),i.servicePlanDetailsRender({accountId:a,servicePlan:e,container:c})}),n.each(f.categories,function(e,t){h=l.find('select[name="'+t+'"]').parents(".customize-details-wrapper").find(".customize-override-wrapper"),i.servicePlanDetailsRenderOverride(h,e.overrides)}),l.find(".service-plan-selector").on("change",function(){var e=t(this),n=e.val(),r=e.parents(".customize-details-wrapper").find(".details-selected-service-plan");r.empty(),n!=="none"?(e.parents(".category-wrapper").addClass("has-selected"),i.servicePlanDetailsGetSP(n,a,u,function(e){i.servicePlanDetailsRender({accountId:a,servicePlan:e,container:r})})):e.parents(".category-wrapper").removeClass("has-selected")}),s.afterRender&&s.afterRender(l,f)})},servicePlanCustomizeFormatData:function(e){var t=this,r={},i={};return n.each(e.listAvailable,function(t){i.hasOwnProperty(t.category)||(i[t.category]={friendlierName:t.category,plans:[]}),r={id:t.id,name:t.name},e.current&&e.current.details&&e.current.details.hasOwnProperty("plans")&&e.current.details.plans.hasOwnProperty(t.id)&&(r.selected=!0,i[t.category].hasSelected=!0,i[t.category].overrides=e.current.details.plans[t.id].overrides,e.current.details.plans[t.id].overrides&&(i[t.category].overrides=e.current.details.plans[t.id].overrides)),i[t.category].plans.push(r)}),{categories:i,selectedPlans:e.current.selectedPlans,allowedOverrides:t.servicePlanCustomizeGetOverrideDefault()}},servicePlanDetailsGetDataToSave:function(e,i,s){var o=this,u={},a={accountId:e,plansToDelete:[],plansToAdd:[],overrides:{}};return n.each(s,function(e,t){u[t]=!0}),i.find("select.service-plan-selector").each(function(){var e=t(this).val();e!=="none"&&(u.hasOwnProperty(e)?delete u[e]:a.plansToAdd.push(e))}),n.each(u,function(e,t){a.plansToDelete.push(t)}),i.find(".details-overrides [data-key]").each(function(){var e=t(this),n=e.parents(".category-wrapper").find(":selected").val(),i=e.parents("[data-category]").data("category"),s=e.data("key"),o=e.find("[data-field]").length>0;n!=="none"&&(a.overrides[n]=a.overrides[n]||{},a.overrides[n][i]=a.overrides[n][i]||{},a.overrides[n][i][s]=a.overrides[n][i][s]||{},i==="ui_apps"&&(a.overrides[n][i][s]={enabled:!0,app_id:r.appsStore[s].id,name:r.appsStore[s].i18n["en-US"].label,account_id:r.apps.auth.originalAccount.id}));if(o){var u,f;e.find("[data-field]").each(function(e){var r=t(this);u=r.data("field"),f=r.find(".input-value").val(),u==="exceptions"&&(f=f.split(",")),a.overrides[n][i][s][u]=f})}}),a},servicePlanCustomizeInternalSaveData:function(e,t){var n=this,r={};n.servicePlanDetailsUpdateSP(e.plansToDelete,e.plansToAdd,e.accountId,function(){n.servicePlanDetailsAddManyOverrideSP(e.overrides,e.accountId,function(){n.servicePlanDetailsGetCurrentSP(e.accountId,function(e){t&&t(e)})})})},servicePlanDetailsFormatOverride:function(e){var t=this,r=t.servicePlanCustomizeGetOverrideDefault(),i={overrides:e,allowedOverrides:{}},s={};return n.each(r,function(e,t){s[t]=[],n.each(e,function(e,n){n!=="_all"&&s[t].push(n)})}),n.each(e,function(t,i){n.each(t,function(t,o){i==="ui_apps"?(delete r[i][o],e.ui_apps[o]={}):n.each(t,function(e,n){r.hasOwnProperty(i)&&r[i].hasOwnProperty(o)&&(n==="as"&&(t.asCategories=s[i]),delete r[i][o][n])})})}),i.allowedOverrides=r,i},servicePlanDetailsRenderOverride:function(e,i,s){var o=this,u=s||"",a=i||{},f=o.servicePlanDetailsFormatOverride(a),l=t(r.template(o,"servicePlanDetails-overrideView",f)),c=function(){var e={};return l.find(".details-overrides [data-key]").each(function(){var n=t(this),r=n.parents("[data-category]").data("category"),i=n.data("key"),s=n.find("[data-field]").length>0;e[r]=e[r]||{},e[r][i]=e[r][i]||{};if(s){var o,u;n.find("[data-field]").each(function(n){var s=t(this);o=s.data("field"),u=s.find(".input-value").val(),e[r][i][o]=u})}}),e};l.find(".remove-line").on("click",function(){var r=c(),i=t(this),s=i.parents("[data-field]").length===0,u=i.parents("[data-category]").data("category"),a=i.parents("[data-key]").data("key"),f=s?"":i.parents("[data-field]").data("field");s?delete r[u][a]:(delete r[u][a][f],n.isEmpty(r[u][a])&&delete r[u][a]),n.isEmpty(r[u])&&delete r[u],o.servicePlanDetailsRenderOverride(e,r)}),l.find(".select-field-override .selectable").on("click",function(){var n=t(this),r=typeof n.attr("data-key")!="undefined",i=c(),s=n.parents("[data-category]").data("category"),a=r?n.data("key"):n.parents("[data-key]").data("key"),f=r?"":n.data("field");i[s]=i[s]||{},i[s][a]=i[s][a]||{},f&&(i[s][a][f]=i[s][a][f]||{},i[s][a][f]=""),u='[data-category="'+s+'"] [data-key="'+a+'"] [data-field="'+f+'"] input',o.servicePlanDetailsRenderOverride(e,i,u)}),e.empty().append(l),u&&l.find(u).focus()},servicePlanCustomizeSave:function(e){var t=this,n=e,r=n.accountId||t.accountId,i=n.previousPlans||{},s=n.divResult||undefined,o=n.container,u=t.servicePlanDetailsGetDataToSave(r,o,i);t.servicePlanCustomizeInternalSaveData(u,function(e){s&&t.servicePlanDetailsRender({accountId:r,servicePlan:e,container:s}),n.callback&&n.callback(e)})},servicePlanDetailsListSP:function(e,t,n){var r=this;r.callApi({resource:t?"servicePlan.list":"servicePlan.listAvailable",data:{accountId:e},success:function(e){n&&n(e.data)}})},servicePlanDetailsGetSP:function(e,t,n,r,i){var s=this;s.callApi({resource:n?"servicePlan.get":"servicePlan.getAvailable",data:{planId:e,accountId:t,generateError:!1},success:function(e){r&&r(e.data)},error:function(e,t,n){e&&e.data&&e.data.hasOwnProperty("message")&&e.data.message==="bad identifier"?i&&i({}):n(e,{generateError:!0})}})},servicePlanDetailsGetCurrentSP:function(e,t){var n=this;n.callApi({resource:"servicePlan.listCurrent",data:{accountId:e},success:function(e){t&&t(e.data)}})},servicePlanDetailsAddManySP:function(e,t,n){var r=this;e.length?r.callApi({resource:"servicePlan.addMany",data:{accountId:t,data:{plans:e}},success:function(e){n&&n(e.data)}}):n&&n({})},servicePlanDetailsRemoveSP:function(e,t,n){var r=this;r.callApi({resource:"servicePlan.remove",data:{planId:e,accountId:t},success:function(e){n&&n(e.data)}})},servicePlanDetailsRemoveManySP:function(e,t,n){var r=this;r.callApi({resource:"servicePlan.removeMany",data:{accountId:t,data:{plans:e}},success:function(e){n&&n(e.data)}})},servicePlanDetailsAddManyOverrideSP:function(e,t,n){var r=this;r.callApi({resource:"servicePlan.addManyOverrides",data:{accountId:t,data:{overrides:e}},success:function(e){n&&n(e.data)}})},servicePlanDetailsUpdateSP:function(e,t,n,r){var i=this;t.length+e.length?i.callApi({resource:"servicePlan.update",data:{accountId:n,data:{add:t,"delete":e}},success:function(e){r&&r(e.data)}}):r&&r()}};return i});