define(["require","jquery","underscore","fileupload","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("fileupload"),i=e("monster"),s=e("toastr"),o={requests:{"common.numbers.metadata":{apiRoot:i.config.api.phonebook,url:"locality/metadata?lerg_lookup=true",verb:"POST"}},subscribe:{"common.port.render":"portRender"},isLaunchedInAppMode:!0,defaultStateToDisplay:"submitted",states:[{value:"unconfirmed",next:[1,6]},{value:"submitted",next:[2,4,6]},{value:"pending",next:[3,4,5,6]},{value:"scheduled",next:[4,5,6]},{value:"rejected",next:[1,5,6]},{value:"completed",next:[]},{value:"canceled",next:[]}],portRender:function(e){var t=this,e=e||{},r=e.accountId||t.accountId,s={width:"940px",position:["center",20],title:t.i18n.active().port.dialogTitle,autoOpen:!1,dialogClass:"port-container-dialog"},o=e.hasOwnProperty("parent")?e.parent:i.ui.dialog("",s);n.each(t.states,function(e,n){e.text=t.i18n.active().port.state[e.value]}),e.hasOwnProperty("accountId")?t.isLaunchedInAppMode=!1:t.isLaunchedInAppMode=!0,t.portRenderPendingOrder(o,r)},portFormatPendingOrderData:function(e){return e=e.filter(function(e){return e.port_requests.length>0}),e.forEach(function(e,t){e.port_requests.sort(function(e,t){return e.updated<t.updated?1:-1})}),e},portRenderPendingOrder:function(e,n){var r=this,s=t(i.template(r,"port-pendingOrders",{states:r.states,defaultStateToDisplay:r.defaultStateToDisplay,isLaunchedInAppMode:r.isLaunchedInAppMode}));e.empty().append(s),r.portBindPendingOrderEvents(e,n),r.portRenderPendingOrderListing(e,n,r.defaultStateToDisplay),e.hasClass("ui-dialog-content")&&e.dialog("open")},portToggleRequestsDisplay:function(e,n,r,i){var s=e.find(".accounts-list > .requests-wrapper"),o=s.hasClass("empty"),u=e.find(".account-section");if(r==="accounts"){if(!o){var a={};s.addClass("empty"),s.find(".request-box").each(function(n,r){var i=t(r),s=i.data("account_id");a.hasOwnProperty(s)?a[s].push(i):a[s]=[i],e.find('.account-section[data-id="'+s+'"] .requests-wrapper').append(i)});for(var n in a)e.find('.account-section[data-id="'+n+'"] .requests-wrapper').append(a[n].sort(function(e,n){return t(e).data("updated_date")<n.data("updated_date")?1:-1}))}i?u.show():u.fadeIn(400)}else if(r==="requests"&&o){var f=function(){s.append(e.find(".request-box").sort(function(e,n){return t(e).data("updated_date")<t(n).data("updated_date")?1:-1})),s.removeClass("empty")};i?(u.hide(),f()):u.fadeOut(400,f)}},portBindPendingOrderEvents:function(e,n,r){var o=this,u=e.find("#orders_list");o.portPositionDialogBox(),u.find("span.pull-right a").on("click",function(){o.portRenderAddNumber(e,n)}),u.find(".search-numbers").on("click",function(){var t=u.find("#search_input").val();/(\+1|1)?([0-9]{10})/.test(t)?o.portSearchNumber({data:{accountId:n,number:t},success:function(r){u.find(".filter-options").hide(),u.find("#number_searched").text(i.util.formatPhoneNumber(t)),u.find("#search_indicator").removeClass("hidden"),o.portRenderPendingOrderListing(e,n,undefined,r)}}):s.error(o.i18n.active().port.toastr.error.number)}),u.find("#search_indicator").on("click",function(){t(this).addClass("hidden"),u.find("#search_input").val(""),u.find(".filter-options").show(),u.find(".filter-select").val(o.defaultStateToDisplay),o.portRenderPendingOrderListing(e,n,o.defaultStateToDisplay)}),u.find(".filter-options .btn-group:first-child .btn").on("click",function(){var e=t(this);e.hasClass("active")||(e.siblings().removeClass("active"),e.addClass("active"),o.portToggleRequestsDisplay(u,n,e.data("value")))}),u.find(".filter-options .btn-group:last-child .filter-select").on("change",function(){o.portRenderPendingOrderListing(e,n,t(this).val())})},portRenderPendingOrderListing:function(e,n,r,s){var o=this,u=e.find(".accounts-list"),a=function(r){var a={data:o.portFormatPendingOrderData(r)},f=t(i.template(o,"port-pendingOrdersList",a));u.empty().append(f),(!o.isLaunchedInAppMode||s)&&o.portToggleRequestsDisplay(u,n,"requests",!0),o.portRenderDynamicCells(e,r),o.portBindPendingOrderListingEvents(e,n,r)};s?a(s):o.portListRequests(n,r,function(e){a(e)})},portBindPendingOrderListingEvents:function(e,n,r){var o=this,u=e.find(".accounts-list");u.find(".account-header").on("click",function(){var e=t(this).parents(".account-section");e.hasClass("active")?e.find(".requests-wrapper").slideUp(function(){e.find(".left-part i").removeClass("fa-chevron-down monster-white").addClass("fa-chevron-right"),e.removeClass("active")}):(e.addClass("animate"),e.find(".requests-wrapper").slideDown(function(){e.find(".left-part i").removeClass("fa-chevron-right").addClass("fa-chevron-down monster-white"),e.removeClass("animate"),e.addClass("active")}))}),u.find(".request-box .request-state").on("change",".switch-state",function(n){var i=t(this),a=i.parents(".request-box"),f=a.data("account_id"),l=a.data("id"),c=o.portGetRequest(f,l,r),h=i.val();h==="rejected"?o.portRequestChangeState(f,l,h,function(e){delete e.scheduled_date,o.portRequestUpdate(f,l,e,function(e){o.portUpdateData(f,e,r),o.portRenderDynamicCells(u,e),s.success(o.i18n.active().port.toastr.success.request.update)})}):h==="scheduled"?o.portRenderScheduledDatePopup(e,{callbackSave:function(e){o.portRequestChangeState(f,l,h,function(t){t.scheduled_date=e,o.portRequestUpdate(f,l,t,function(e){o.portUpdateData(f,e,r),o.portRenderDynamicCells(u,e),s.success(o.i18n.active().port.toastr.success.request.update)})},function(){s.error(o.i18n.active().port.toastr.error.request.update)})},callbackCancel:function(){o.portRenderDynamicCells(u,c)}}):o.portRequestChangeState(f,l,h,function(e){o.portUpdateData(f,e,r),o.portRenderDynamicCells(u,e),a.find(".continue-request, .delete-request").remove(),s.success(o.i18n.active().port.toastr.success.request.update)},function(){s.error(o.i18n.active().port.toastr.error.request.update)},function(){o.portRenderDynamicCells(u,c)})}),u.find(".request-box .scheduled-date .edit").on("click",function(){var n=t(this),s=n.parents(".request-box").data("account_id"),u=n.parents(".request-box").data("id"),a=o.portGetRequest(s,u,r),f=a.scheduled_date;o.portRenderScheduledDatePopup(e,{scheduledDate:f,callbackSave:function(e){t.extend(!0,a,{scheduled_date:e}),o.portRequestUpdate(s,u,a,function(e){o.portUpdateData(s,e,r),n.text(i.util.toFriendlyDate(i.util.gregorianToDate(e.scheduled_date),"shortdatetime"))})}})}),u.find(".request-box .actions li").on("click",function(){var n=t(this),u=n.parents(".request-box").data("account_id"),a=n.parents(".request-box").data("id"),f=o.portGetRequest(u,a,r),l;if(n.hasClass("continue-request")){var c={orders:[f]};l=i.template(o,"port-submitDocuments",f),e.empty().append(l),o.portRenderSubmitDocuments(e,u,c)}else if(n.hasClass("info-request")){var h={width:"560px",position:["center",20],title:o.i18n.active().port.infoPopup.title};l=i.template(o,"port-requestInfo",f),i.ui.dialog(l,h)}else n.hasClass("delete-request")?o.portRequestDelete(u,a,function(){n.parents(".request-box").remove(),s.success(o.i18n.active().port.toastr.success.request.delete)}):n.hasClass("comments-request")&&o.portRenderComments(e,u,a)})},portRenderScheduledDatePopup:function(e,n){var r=this,s=n.hasOwnProperty("scheduledDate")?{scheduledDate:n.scheduledDate}:{},o=t(i.template(r,"port-editScheduledDate",s)),u=i.ui.dialog(o,{title:r.i18n.active().port.pendingOrders.scheduledDatePopup.title,beforeClose:function(e,t){n.hasOwnProperty("callbackCancel")&&n.callbackCancel()}});r.portBindScheduledDatePopupEvents(e,u,n)},portBindScheduledDatePopupEvents:function(e,n,r){var s=this,o=n.find("#scheduled_time"),u=n.find("#scheduled_date"),a={minDate:new Date,beforeShowDay:t.datepicker.noWeekends};i.ui.timepicker(o),i.ui.datepicker(u,a),n.find(".save-link").on("click",function(){var e=o.timepicker("getSecondsFromMidnight")*1e3,t=u.datepicker("getDate").getTime(),s=i.util.dateToGregorian(new Date(t+e));n.dialog("close"),r.hasOwnProperty("callbackSave")&&r.callbackSave(s)}),n.find(".cancel-link").on("click",function(){n.dialog("close")})},portRenderComments:function(e,r,s){var o=this;o.portRequestGet(r,s,function(e){var s=t(i.template(o,"port-commentsPopup",{isAdmin:i.apps.auth.originalAccount.superduper_admin})),u=e.hasOwnProperty("comments")?e.comments:[],a=function(){var t={width:"960px",position:["center",20],title:o.i18n.active().port.commentsPopup.title},n=i.ui.dialog(s,t);o.portBindCommentsEvents(n,r,e,u)};n.isEmpty(u)?(s.find(".comments").hide(),a()):o.portRequestListUsers(r,function(e){e=function(t){var n={};return t.forEach(function(e,t){n[e.id]=e.first_name.concat(" ",e.last_name)}),n}(e),u.forEach(function(t,n){t.author=e[t.user_id],t.isAdmin=i.apps.auth.originalAccount.superduper_admin;if(t.superduper_comment?i.apps.auth.originalAccount.superduper_admin:!0)s.find(".comments").append(i.template(o,"port-comment",t)),s.find(".comments .comment:last-child .comment-body").html(t.content)}),a()})})},portBindCommentsEvents:function(e,r,o,u){var a=this;i.ui.wysiwyg(e.find(".wysiwyg-container")),e.find(".comments").on("click",".delete-comment",function(){var f=t(this),l=f.parents(".comment"),c=f.data("id"),h=n.findIndex(u,function(e){return e.timestamp===c});i.ui.confirm(a.i18n.active().port.infoPopup.confirm.deleteComment,function(){a.portRequestDeleteComment(r,o.id,h,function(n){u=n,l.fadeOut("400",function(){t(this).remove(),e.find(".comment").length===0&&e.find(".comments").slideUp(),s.success(a.i18n.active().port.toastr.success.comment.delete)})})})}),e.find(".actions .add-comment").on("click",function(){var n=i.apps.auth.currentUser,s={user_id:a.userId,timestamp:i.util.dateToGregorian(new Date),content:e.find(".wysiwyg-editor").html(),superduper_comment:e.find("#superduper_comment").is(":checked")};a.portRequestAddComment(r,o.id,s,function(r){u=r,s.author=n.first_name.concat(" ",n.last_name),s.isAdmin=i.apps.auth.originalAccount.superduper_admin,e.find(".comments").show().append(t(i.template(a,"port-comment",s))),e.find(".comments .comment:last-child .comment-body").html(s.content),e.find(".comments").animate({scrollTop:e.find(".comments").scrollTop()+e.find(".comments .comment:last-child").position().top},300,function(){i.ui.highlight(t(this).find(".comment:last-child"))}),e.find(".wysiwyg-editor").empty()})})},portRequestAddComment:function(e,t,r,i){var s=this,o={comments:n.isArray(r)?r:[r]};s.callApi({resource:"port.addComment",data:{accountId:e,portRequestId:t,data:o},success:function(e,t){i&&i(e.data&&e.data.comments)}})},portRequestDeleteComment:function(e,t,n,r){var i=this;i.callApi({resource:"port.deleteComment",data:{accountId:e,portRequestId:t,commentId:n},success:function(e,t){r&&r(e.data&&e.data.comments)}})},portRenderAddNumber:function(e,t){var n=this,r=i.template(n,"port-addNumbers");e.empty().append(r),n.portBindAddNumberEvents(e,t)},portBindAddNumberEvents:function(e,t){var n=this,r=e.find("div#add_numbers");n.portPositionDialogBox(),n.portComingSoon(r,[".help-links li:not(.separator) a"]),r.find("#add_numbers_link").on("click",function(i){var o=r.find("input").val().split(" ");o.forEach(function(e,t,n){/^(\+1|1[0-9]{10})/.test(e)&&(n[t]=e.replace(/(\+1|1)?([0-9]{10})/,"$2"))}),o=o.filter(function(e,t,n){return e&&/^[0-9]{10}$/.test(e)}),o.length===0?(s.error(n.i18n.active().port.toastr.error.numbers),r.find("div.row-fluid").addClass("error")):n.portFormatNumbers(o,function(i){i.orders.length>0?(r.find("div.row-fluid").removeClass("error"),r.find("#numbers_list")[0].value="",r.find("button").unbind("click"),n.portRenderManagerOrders(e,t,i)):r.find("#numbers_list")[0].value=""})})},portRenderManagerOrders:function(e,n,r){var s=this,o=t(i.template(s,"port-manageOrders",r));o.insertAfter(e.find("#add_numbers")),s.portBindManageOrdersEvents(e,n,r)},portBindManageOrdersEvents:function(e,r,o){var u=this,a=e.find("#port_container");u.portPositionDialogBox(),u.portCancelOrder(e,r,a),u.portComingSoon(a,["#footer .help-links li:not(.separator) a"]),a.find("#add_numbers_link").on("click",function(){var e=a.find("div#add_numbers").find("input").val().split(" "),r=[];a.find("#manage_orders li").each(function(){r.push(t(this).data("value").toString())}),e.forEach(function(e){/^(\+1|1[0-9]{10})/.test(e)&&(e=e.replace(/^(\+1|1)?([0-9]{10})$/,"$2"))}),e=e.filter(function(e){return e&&/^[0-9]{10}$/.test(e)&&r.indexOf(e)<0}),e.length===0?(s.error(u.i18n.active().port.toastr.error.numbers),a.find("div#add_numbers").find("div.row-fluid").addClass("error")):u.portFormatNumbers(e,function(e){a.find("#numbers_list")[0].value="",a.find("div#add_numbers").find("div.row-fluid").removeClass("error"),n.each(e.orders,function(r,s){a.find("#manage_orders .order").each(function(){var o=t(this),u=o.data("carrier");u===r.carrier&&(n.each(r.numbers,function(e){o.find("ul").append('<li data-value="'+e+'" data-carrier="'+u+'">'+'<i class="fa fa-exclamation-triangle"></i>'+i.util.formatPhoneNumber(e)+'<i class="fa fa-times-circle pull-right"></i>'+"</li>")}),e.orders.splice(s,1))}),e.orders.length!==0&&a.find("#manage_orders").find(".row-fluid:last-child").append(t(i.template(u,"port-order",e.orders[s])))})})}),a.on("click","#manage_orders li .remove-number",function(){var n=t(this),i=n.parent().parent();n.parent().remove(),i.is(":empty")&&i.parent().parent().remove(),a.find("div#manage_orders").find(".row-fluid:last-child").is(":empty")&&(a.find("div#manage_orders").find(".row-fluid:last-child").animate({height:"0px"},500),u.portRenderAddNumber(e,r))}),a.find("#manage_orders_next_link").on("click",function(){var n=a.find("#eula form");i.ui.validate(n,{messages:{"conditions[]":{required:u.i18n.active().port.requiredConditions,minlength:u.i18n.active().port.requiredConditions}},errorPlacement:function(e,t){e.insertAfter(a.find("#eula form .control-group:last-child"))}});if(i.ui.valid(n)){var s={orders:[]};a.find("div#manage_orders").find("div.order").each(function(){var e=t(this),n={},r=[];t.each(e.find("li"),function(e,n){r.push(t(n).data("value"))}),n.carrier=e.find("li:first-child").data("carrier"),n.numbers=r,s.orders.push(n)}),o.orders.forEach(function(e,n){for(var r=0,i=s.orders.length;r<i;r++)if(s.orders[r].carrier===e.carrier){t.extend(!0,s.orders[r],e);break}}),u[s.orders.length===1?"portRenderSubmitDocuments":"portRenderResumeOrders"](e,r,s)}else a.find("div#eula").find("input").each(function(){t(this).is(":checked")?t(this).parents(".control-group").removeClass("error"):t(this).parents(".control-group").addClass("error")})})},portRenderResumeOrders:function(e,n,r){var s=this,o=t(i.template(s,"port-resumeOrders",r));t.each(o.find(".row-fluid"),function(e,n){n=t(n),n.find(".order-key").text((parseInt(n.find(".order-key").text(),10)+1).toString())}),e.empty().append(o),s.portBindResumeOrdersEvents(e,n,r)},portBindResumeOrdersEvents:function(e,n,r){var i=this,s=e.find("#resume_orders");i.portPositionDialogBox(),s.find(".resume-order-btn").on("click",function(){var s=t(this).data("index");i.portRenderSubmitDocuments(e,n,r,s)})},portRenderSubmitDocuments:function(e,n,r,s){var o=this,s=s||0,u=t(i.template(o,"port-submitDocuments",r.orders[s]));e.empty().append(u),o.portBindSubmitDocumentsEvents(e,n,r,s)},portBindSubmitDocumentsEvents:function(e,n,r,o){var u=this,a=e.find("#port_container");u.portPositionDialogBox(),u.portCancelOrder(e,n,a,r,o),u.portComingSoon(a,["#upload_bill .row-fluid.info a","#loa h4 a","#loa p a:not(#sign_doc)","#footer .help-links li:not(.separator) a"]),a.find(".file-upload-container input").each(function(e,i){var a=t(i),f=a.data("name"),l={btnText:u.i18n.active().port.submitDocuments.changeButton,mimeTypes:["application/pdf"],wrapperClass:"input-append",success:function(e){r.orders[o].hasOwnProperty("id")?r.orders[o].hasOwnProperty(f.concat(".pdf"))?u.portRequestUpdateAttachment(n,r.orders[o].id,f.concat(".pdf"),e[0].file,function(){r.orders[o][f.concat("_attachment")]=e[0].file}):u.portRequestAddAttachment(n,r.orders[o].id,f.concat(".pdf"),e[0].file,function(){r.orders[o][f.concat("_attachment")]=e[0].file}):r.orders[o][f.concat("_attachment")]=e[0].file},error:function(e){for(var t in e)e[t].length>0&&s.error(u.i18n.active().port.toastr.error[t].concat(e[t].join(", ")))}};r.orders[o].hasOwnProperty("uploads")&&r.orders[o].uploads.hasOwnProperty(f.concat(".pdf"))&&(l.filesList=[f.concat(".pdf")]),f==="bill"?(l.bigBtnClass="btn btn-success span12",l.bigBtnText=u.i18n.active().port.submitDocuments.uploadBillButton,l.btnClass="btn btn-success"):f==="loa"&&(l.bigBtnClass="btn span10",l.bigBtnText=u.i18n.active().port.submitDocuments.loaUploadStep,l.btnClass="btn"),a.fileUpload(l)}),a.find("#upload_bill .remove-number").on("click",function(){var i=t(this).parent(),s=i.parent(),a=i.data("value"),f=r.orders[o].numbers.indexOf(a);f>=0&&(r.orders[o].numbers.slice(f,1),i.remove()),s.is(":empty")&&(r.orders.length>1?(r.orders.splice(o,1),u.portRenderResumeOrders(e,n,r)):u.portReloadApp(e,n))}),a.find("#submit_documents_add_numbers_link").on("click",function(){e.empty().append(i.template(u,"port-addNumbers")),u.portRenderManagerOrders(e,n,r)}),a.find("#submit_documents_save_link").on("click",function(){var s=a.find("#transfer_name_form");i.ui.validate(s);if(i.ui.valid(s)){var f=i.ui.getFormData("transfer_name_form",".",!0),l=i.ui.getFormData("bill_form",".",!0);t.extend(!0,r.orders[o],l,f),u.portSaveOrder(e,n,r,o)}else a.find(".monster-invalid").length>0&&t("html, body").animate({scrollTop:a.find(".monster-invalid").first().offset().top-10},300)}),a.find("#submit_documents_next_link").on("click",function(){var s=r.orders[o],f=s.hasOwnProperty("bill_attachment")||s.hasOwnProperty("uploads")&&s.uploads.hasOwnProperty("bill.pdf")?!0:!1,l=s.hasOwnProperty("loa_attachment")||s.hasOwnProperty("uploads")&&s.uploads.hasOwnProperty("loa.pdf")?!0:!1,c=a.find("#transfer_name_form"),h=a.find("#bill_form"),p=!0;i.ui.validate(c),i.ui.validate(h),i.ui.valid(c)||(p=!1),i.ui.valid(h)||(p=!1);if(!f||!l)p=!1,i.ui.alert("error",u.i18n.active().port.toastr.error.submit.document);if(p){var d=i.ui.getFormData("transfer_name_form"),v=i.ui.getFormData("bill_form");s.hasOwnProperty("id")&&(delete s.bill_attachment,delete s.loa_attachment),t.extend(!0,s,v,d),u.portRenderConfirmOrder(e,n,r,o)}else a.find(".monster-invalid").length>0&&t("html, body").animate({scrollTop:a.find(".monster-invalid").first().offset().top-10},300)})},portRenderConfirmOrder:function(e,n,r,s){var o=this,u=r.orders[s],a=new Date,f=i.util.getBusinessDate(4),l=u.hasOwnProperty("created")?u.created:a,c=u.hasOwnProperty("transfer_date")?i.util.gregorianToDate(u.transfer_date):f,h=f.getTime()>=c.getTime(),p=t.extend(!0,{},u,{total:u.numbers.length,transfer_date:h?f:c,created:l}),d=t(i.template(o,"port-confirmOrder",p));e.empty().append(d),o.portBindConfirmOrderEvents(e,n,r,s)},portBindConfirmOrderEvents:function(e,n,r,s){var o=this,u=e.find("#port_container"),a=u.find("input.date-input"),f=r.orders[s];o.portPositionDialogBox(),o.portCancelOrder(e,n,u,r,s),o.portComingSoon(u,["#footer .help-links li:not(.separator) a"]),i.ui.datepicker(a,{minDate:i.util.getBusinessDate(4),beforeShowDay:t.datepicker.noWeekends,onSelect:function(e,t){var n=u.find("#transfer_schedule_date"),r=n.css("color"),i=200;n.animate({color:n.css("backgroundColor")},i,function(){n.text(e),n.animate({color:r},i)})}}),u.find("#numbers_to_buy option").last().prop("selected","selected"),u.find("#numbers_to_buy option").each(function(e,n){var r=t(n);r.val(parseInt(r.val(),10)+1).text(r.val())}),u.find("#confirm_order_save_link").on("click",function(){var u=i.ui.getFormData("notification_email_form",".",!0),a=i.ui.getFormData("transfer_date_form");t.extend(!0,f,u,a),f.transfer_date=i.util.dateToGregorian(new Date(f.transfer_date)),o.portSaveOrder(e,n,r,s)}),u.find("#confirm_order_add_numbers_link").on("click",function(){e.empty().append(i.template(o,"port-addNumbers")),o.portRenderManagerOrders(e,n,r)}),u.find("#confirm_order_submit_link").on("click",function(){var a=u.find("#notification_email_form");i.ui.validate(a);if(i.ui.valid(a)){var l=i.ui.getFormData("notification_email_form"),c=i.ui.getFormData("transfer_date_form");t.extend(!0,f,l,c),f.transfer_date=i.util.dateToGregorian(new Date(f.transfer_date)),f.hasOwnProperty("id")?o.portRequestUpdate(n,f.id,f,function(){f.hasOwnProperty("port_sate")?o.portReloadApp(e,n):o.portRequestChangeState(n,f.id,"submitted",function(){o.portReloadApp(e,n)})}):o.portRequestAdd(n,f,function(t){r.orders.splice(s,1),o.portRequestChangeState(n,t,"submitted",function(){r.orders.length>0?o.portRenderResumeOrders(e,n,r):o.portReloadApp(e,n)},function(){},function(){o.portRequestDelete(n,t)})})}else u.find(".monster-invalid").length>0&&t("html, body").animate({scrollTop:u.find(".monster-invalid").first().offset().top-10},300)})},portSearchNumber:function(e){var t=this,r=e.data.accountId,s=e.data.number;i.parallel({account:function(e){t.portRequestSearchNumber(r,s,function(t){e(null,t)})},descendants:function(e){t.isLaunchedInAppMode?t.portRequestSearchNumberByDescendants(r,s,function(t){e(null,t)}):e(null,[])}},function(r,i){var s=i.account.concat(i.descendants);s.length>1&&(s=n.uniq(s,function(e,t){return e.id})),s.length===1?t.portRequestGetAccount(s[0].account_id,function(t){e.success([{account_id:s[0].account_id,account_name:t.name,port_requests:s}])}):e.success([])})},portListRequests:function(e,t,n){var r=this;i.parallel({requests:function(n){r.portRequestList(e,r.isLaunchedInAppMode?t:"all",function(e){n(null,e)})},descendants:function(n){r.isLaunchedInAppMode?r.portRequestListByDescendants(e,t,function(e){n(null,e)}):n(null,[])}},function(t,r){var s=r.descendants.sort(function(e,t){return e.account_name.toLowerCase()>t.account_name.toLowerCase()?1:-1});r.requests.length&&s.unshift({account_id:e,account_name:i.apps.auth.currentAccount.name,port_requests:r.requests});for(var o=0,u=s.length;o<u;o++)s[o].amount=s[o].port_requests.length;n(s)})},portRenderDynamicCells:function(e,r){var s=this,o=function(e){var t=s.states,r=[];return e=n.find(t,function(t,n){return t.value===e}),n.each(e.next,function(e,n){r.push(t[e])}),r.unshift(e),r},u=function(r){var u=e.find('.request-box[data-id="'+r.id+'"]'),a=i.apps.auth.originalAccount.superduper_admin,f=u.find(".scheduled-date"),l=u.find(".request-state"),c=r.port_state;u.data({state:c,scheduled_date:r.hasOwnProperty("scheduled_date")?r.scheduled_date:"",updated_date:r.updated});if(a)if(c==="completed")l.empty().text(s.i18n.active().port.state[c]),f.empty();else{var h;l.empty().append(t(i.template(s,"port-selectStates",{states:o(c)}))),c==="scheduled"?(r.hasOwnProperty("scheduled_date")&&(h={scheduledDate:r.scheduled_date}),f.empty().append(t(i.template(s,"port-scheduledDateCell",h)))):f.empty().text(s.i18n.active().port.noScheduledDate)}else l.empty().text(s.i18n.active().port.state[c]),c==="scheduled"?f.empty().text(i.util.toFriendlyDate(r.scheduled_date,"shortdatetime")):f.empty().text(s.i18n.active().port.noScheduledDate)};r instanceof Array?n.each(r,function(e,t){n.each(e.port_requests,function(e,t){u(e)})}):u(r)},portPositionDialogBox:function(){t("html, body").animate({scrollTop:"0"},100),t("body").height()-(t(".ui-dialog").height()+80)<=0?t(".ui-dialog").animate({top:"80"},200):t(".ui-dialog").animate({top:t("body").height()/2-t(".ui-dialog").height()/2},200)},portObjectsToArray:function(e){if(typeof e.length!="undefined")for(var t in e){var n=new Array;for(var r in e[t].numbers)n.push(r);delete e[t].numbers,e[t].numbers=n}else{var n=new Array;for(var r in e.numbers)n.push(r);delete e.numbers,e.numbers=n}return e},portArrayToObjects:function(e){if(Array.isArray(e.numbers)){var t=e.numbers;delete e.numbers,e.numbers=new Object;for(var n in t)e.numbers[t[n]]=new Object}return e},portReloadApp:function(e,n){var r=this,i={};e.hasClass("ui-dialog-content")?(e.dialog("close"),i.accountId=n):(e.empty(),i.parent=t("#monster-content")),r.portRender(i)},portComingSoon:function(e,n){var r=this;n.forEach(function(n,s){e.find(n).on("click",function(e){e.preventDefault();var n=t(this).data("type");if(n==="faq"){var s=i.ui.dialog(i.template(r,"port-faqPopup"),{title:"Porting Manager FAQ",width:"800px"}),o=s.find(".accordion-toggle");o.on("click",function(){o.removeClass("in"),t(this).addClass("in")})}else i.ui.alert(r.i18n.active().port.comingSoon)})})},portFormatNumbers:function(e,t){var r=this,s={orders:[]},o=function(){var n={carrier:r.i18n.active().port.unknownCarrier,numbers:e};s.orders.push(n),t&&t(s)};i.config.api.hasOwnProperty("phonebook")?i.request({resource:"common.numbers.metadata",data:{data:e,country:"US"},success:function(e){var i={orders:[]},s={},o=function(e,t){var n=-1;if(s.hasOwnProperty(e))i.orders[s[e]].numbers.push(t);else{var r=i.orders.length;i.orders.push({carrier:e,numbers:[t]}),s[e]=r}};n.each(e.data,function(e,t){e.hasOwnProperty("lrn")&&e.lrn.hasOwnProperty("lerg")&&e.lrn.lerg.hasOwnProperty("company")&&e.lrn.lerg.company?o(e.lrn.lerg.company,t):e.hasOwnProperty("lrn")&&e.lrn.hasOwnProperty("carrier")&&e.lrn.carrier.hasOwnProperty("dba")&&e.lrn.carrier.dba?o(e.lrn.carrier.dba,t):e.hasOwnProperty("carrier")&&e.carrier.hasOwnProperty("dba")&&e.carrier.dba?o(e.carrier.dba,t):o(r.i18n.active().port.unknownCarrier,t)}),t(i)},error:o}):o()},portSaveOrder:function(e,t,n,r){var i=this,s=n.orders[r].hasOwnProperty("id");s?i.portRequestUpdate(t,n.orders[r].id,n.orders[r],function(){i.portReloadApp(e,t)}):i.portRequestAdd(t,n.orders[r],function(){n.orders.length>1?(n.orders.splice(r,1),i.portRenderResumeOrders(e,t,n)):i.portReloadApp(e,t)})},portCancelOrder:function(e,t,n,r,s){var o=this,r=r||undefined,s=s||0;n.find("div#footer").find("button.btn-danger").on("click",function(){typeof r=="undefined"?o.portReloadApp(e,t):i.ui.confirm(o.i18n.active().port.cancelOrderPopup,function(){r.orders[s].hasOwnProperty("id")?o.portRequestDelete(t,r.orders[s].id,function(){o.portReloadApp(e,t)}):r.orders.length>1?(r.orders.splice(s,1),o.portRenderResumeOrders(e,t,r)):o.portReloadApp(e,t)})})},portGetRequest:function(e,t,n){return n.filter(function(t,n){return t.account_id===e})[0].port_requests.filter(function(e,n){return e.id===t})[0]},portUpdateData:function(e,t,n){for(var r in n){if(n[r].account_id===e)for(var i in n[r].port_requests){n[r].port_requests[i].id===t.id&&(n[r].port_requests[i]=t);break}break}},portRequestAdd:function(e,n,r,i){var s=this,o={};n.hasOwnProperty("bill_attachment")&&(o.bill=n.bill_attachment,delete n.bill_attachment),n.hasOwnProperty("loa_attachment")&&(o.loa=n.loa_attachment,delete n.loa_attachment),n=t.extend(!0,n,{port_state:"unconfirmed"}),n=s.portArrayToObjects(n),s.callApi({resource:"port.create",data:{accountId:e,data:n},success:function(t,n){var i=t.data.id;o.hasOwnProperty("bill")?s.portRequestAddAttachment(e,i,"bill.pdf",o.bill,function(t){o.hasOwnProperty("loa")?s.portRequestAddAttachment(e,i,"loa.pdf",o.loa,function(e){r&&r(i)}):r&&r(i)}):o.hasOwnProperty("loa")?s.portRequestAddAttachment(e,i,"loa.pdf",o.loa,function(e){r&&r(i)}):r&&r(i)},error:function(e,t){i&&i()}})},portRequestUpdate:function(e,t,n,r,i){var s=this;n=s.portArrayToObjects(n),n.hasOwnProperty("bill_attachment")&&delete n.bill_attachment,n.hasOwnProperty("loa_attachment")&&delete n.loa_attachment,s.callApi({resource:"port.update",data:{accountId:e,portRequestId:t,data:n},success:function(e,t){r&&r(e.data)},error:function(e,t){i&&i()}})},portRequestDelete:function(e,t,n,r){var i=this;i.callApi({resource:"port.delete",data:{accountId:e,portRequestId:t,data:{}},success:function(e,t){n&&n()},error:function(e,t){r&&r()}})},portRequestList:function(e,t,n,r){var i=this,s=t==="all"?"port.list":"port.listByState",o={accountId:e,filters:{paginate:!1}};t!=="all"&&(o.state=t||"submitted"),i.callApi({resource:s,data:o,success:function(e,t){var r=e.data.length===1&&"port_requests"in e.data[0]?e.data[0].port_requests:e.data;n&&n(i.portObjectsToArray(r))},error:function(e,t){r&&r()}})},portRequestListByDescendants:function(e,t,n,r){var i=this;i.callApi({resource:"port.listDescendantsByState",data:{accountId:e,state:t||"submitted",filters:{paginate:!1}},success:function(e,t){var e=e.data;for(var r in e)e[r].port_requests=i.portObjectsToArray(e[r].port_requests);n&&n(e)},error:function(e,t){r&&r()}})},portRequestGet:function(e,t,n,r){var i=this;i.callApi({resource:"port.get",data:{accountId:e,portRequestId:t,data:{}},success:function(e,t){n&&n(i.portObjectsToArray(e.data))},error:function(e,t){r&&r()}})},portRequestGetDescendants:function(e,t,n){var r=this;r.callApi({resource:"port.listDescendants",data:{accountId:e,data:{}},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})},portRequestListAttachments:function(e,t,n,r){var i=this;i.callApi({resource:"port.listAttachments",data:{accountId:e,portRequestId:t,data:{}},success:function(e,t){n&&n(e.data)},error:function(e,t){r&&r()}})},portRequestAddAttachment:function(e,t,n,r,i,s){var o=this;o.callApi({resource:"port.createAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:r},success:function(e,t){i&&i(e.data)},error:function(e,t){s&&s()}})},portRequestUpdateAttachment:function(e,t,n,r,i,s){var o=this;o.callApi({resource:"port.updateAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:r},success:function(e,t){i&&i()},error:function(e,t){s&&s()}})},portRequestDeleteAttachment:function(e,t,n){var r=this;r.callApi({resource:"port.deleteAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:{}},success:function(e,t){callbackSuccess&&callbackSuccess()},error:function(e,t){callbackError&&callbackError()}})},portRequestGetAttachment:function(e,t,n,r,i){var s=this;s.callApi({resource:"port.getAttachment",data:{accountId:e,portRequestId:t,documentName:n,data:{}},success:function(e,t){r&&r(e.data)},error:function(e,t){i&&i()}})},portRequestChangeState:function(e,t,n,r,i,s){var o=this;o.callApi({resource:"port.changeState",data:{accountId:e,portRequestId:t,state:n},success:function(e,t){r&&r(e.data)},error:function(e,t){parseInt(e.error,10)!==402&&i&&i()},onChargesCancelled:function(){s&&s()}})},portRequestReadyState:function(e,t,n,r,i){var s=this;n.port_state="submitted",s.callApi({resource:"port.update",data:{accountId:e,portRequestId:t,data:n},success:function(e,t){r&&r()},error:function(e,t){i&&i()}})},portRequestListUsers:function(e,t,n){var r=this;r.callApi({resource:"user.list",data:{accountId:e},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})},portRequestSearchNumber:function(e,t,n,r){var i=this;i.callApi({resource:"port.searchNumber",data:{accountId:e,number:t},success:function(e,t){n&&n(e.data)},error:function(e,t){r&&r()}})},portRequestSearchNumberByDescendants:function(e,t,n,r){var i=this;i.callApi({resource:"port.searchNumberByDescendants",data:{accountId:e,number:t},success:function(e,t){n&&n(e.data)},error:function(e,t){r&&r()}})},portRequestGetAccount:function(e,t,n){var r=this;r.callApi({resource:"account.get",data:{accountId:e},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})}};return o});