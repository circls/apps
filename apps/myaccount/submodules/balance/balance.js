define(["require","jquery","underscore","monster","datatables","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("datatables"),s=e("toastr"),o={requests:{},subscribe:{"myaccount.balance.renderContent":"_balanceRenderContent","myaccount.balance.addCreditDialog":"_balanceRenderAddCredit","myaccount.refreshBadges":"_balanceRefreshBadge"},balanceRange:"monthly",_balanceRefreshBadge:function(e){var t=this;(!e.hasOwnProperty("except")||e.except!=="balance")&&t.balanceGet(function(n){var i={module:"balance",data:t.i18n.active().currencyUsed+parseFloat(n.data.balance).toFixed(2),callback:e.callback};r.pub("myaccount.updateMenu",i)})},_balanceRenderContent:function(e){var n=this,i=e.callback,s={fieldData:{accounts:{}}};r.parallel({accounts:function(e){n.balanceGetAccounts(function(n){t.each(n.data,function(e,t){s.fieldData.accounts[t.id]=t}),e(null,s)})},balance:function(e){n.balanceGet(function(t){s.amount=parseFloat(t.data.balance).toFixed(2),e(null,t)})},transactions:function(e){n.balanceGetTransactions(function(t){e(null,t)})}},function(e,o){r.pub("myaccount.UIRestrictionsCompatibility",{restrictions:r.apps.auth.originalAccount.ui_restrictions,callback:function(e){var u=t.extend(!0,{},s,n.balanceFormatTableData(o.transactions.data,s.fieldData.accounts),{uiRestrictions:e});u.uiRestrictions.balance.show_header=u.uiRestrictions.balance.show_credit===!1&&u.uiRestrictions.balance.show_minutes===!1?!1:!0;var a=t(r.template(n,"balance-layout",u)),f={module:"balance",data:n.i18n.active().currencyUsed+u.amount};n.balanceBindEvents(a),r.pub("myaccount.updateMenu",f),r.pub("myaccount.renderSubmodule",a),n.balanceInitTable(a),t.fn.dataTableExt.afnFiltering.pop(),a.find("div.table-custom-actions").html(r.template(n,"balance-tableActionBar"));var l={container:a,range:n.balanceRange};r.ui.initRangeDatepicker(l);var c=new Date(a.find("#startDate").val()),h=new Date(a.find("#endDate").val());a.find(".refresh-filter").on("click",function(){n._balanceRenderContent(f)}),a.find(".filter-transactions").on("click",function(){r.ui.table.balance.find("tbody tr").remove(),r.ui.table.balance.fnClearTable(),c=a.find("#startDate").datepicker("getDate"),h=a.find("#endDate").datepicker("getDate"),n.balanceRefreshTransactionsTable(a,c,h,s.fieldData.accounts)}),a.find(".download-transactions").on("click",function(){var e=r.util.dateToBeginningOfGregorianDay(c),t=r.util.dateToEndOfGregorianDay(h);window.location.href=n.apiUrl+"accounts/"+n.accountId+"/transactions?created_from="+e+"&created_to="+t+"&depth=1&reason=only_calls&accept=csv&auth_token="+n.authToken}),r.ui.table.balance.fnAddData(u.tabData),a.find(".popup-marker").clickover(),typeof i=="function"&&i(a)}})})},balanceGetDialogData:function(e){var t=this;r.parallel({account:function(e){t.callApi({resource:"account.get",data:{accountId:t.accountId},success:function(t){e(null,t.data)}})},balance:function(e){t.callApi({resource:"balance.get",data:{accountId:t.accountId},success:function(t){e(null,t.data)}})}},function(n,r){var i=t.balanceFormatDialogData(r);e&&e(i)})},balanceFormatDialogData:function(e){var n=this,r=e.balance.balance.toFixed(2)||"0.00",i={enabled:!1},s={enabled:!1};e.account.hasOwnProperty("threshold")&&(i.enabled=!0,t.extend(!0,i,e.account.threshold)),e.account.hasOwnProperty("topup")&&(s.enabled=!0,t.extend(!0,s,e.account.topup));var o={amount:r,threshold:i,topup:s};return o},_balanceRenderAddCredit:function(e){var n=this,i;n.balanceGetDialogData(function(s){var o=t(r.template(n,"balance-addCreditDialog",t.extend({disableBraintree:r.config.disableBraintree},s))),u={module:n.name,data:parseFloat(s.amount).toFixed(2)};r.pub("myaccount.updateMenu",u),i=r.ui.dialog(o,{title:n.i18n.active().balance.addCreditDialogTitle});var a={parent:i,data:s,callback:e.callback};n.balanceBindEventsDialog(a)})},balanceRefreshTransactionsTable:function(e,t,n,i){var s=this,o={from:t,to:n};s.balanceGetTransactions(o,function(t){var n=s.balanceFormatTableData(t.data,i);r.ui.table.balance.addData(n.tabData),e.find("#call_charges").html(n.totalCharges),e.find("#minutes_used").html(n.totalMinutes)})},balanceFormatTableData:function(e,n){var i=this,s={tabData:[],totalMinutes:0,totalCharges:0};return e.length>0&&(t.each(e,function(e,t){t.metadata=t.metadata||{to:"-",from:"-"},t.metadata.call={direction:t.metadata.direction||"inbound",call_id:t.call_id};var o=i.i18n.active().balance.active_call,u=r.util.toFriendlyDate(t.created),a="-",f=i.i18n.active().currencyUsed+parseFloat(t.amount).toFixed(3),l=r.util.formatPhoneNumber(t.metadata.from||"").replace(/@.*/,""),c=r.util.formatPhoneNumber(t.metadata.to||"").replace(/@.*/,"");"duration"in t.metadata&&(o=Math.ceil(parseInt(t.metadata.duration)/60),s.totalMinutes+=o),t.hasOwnProperty("sub_account_name")?a=t.sub_account_name:t.hasOwnProperty("sub_account_id")&&(a=n.hasOwnProperty(t.sub_account_id)?n[t.sub_account_id].name:"-"),s.totalCharges+=parseFloat(t.amount),s.tabData.push([t.created||"-",t.call_id||"-",t.metadata.call||"-",u||"-",l||"-",c||"-",a||"-",o||"-",f||"-"])}),s.totalCharges=s.totalCharges.toFixed(3)),s},balanceInitTable:function(e){var t=this;r.pub("myaccount.UIRestrictionsCompatibility",{restrictions:r.apps.auth.originalAccount.ui_restrictions,callback:function(n){var i=n.balance&&n.balance.show_credit==0?!1:!0,s=[{sTitle:"timestamp",bVisible:!1},{sTitle:"call_id",bVisible:!1},{sTitle:t.i18n.active().balance.directionColumn,fnRender:function(e){var t='<i class="fa fa-arrow-left monster-orange popup-marker" data-placement="right" data-original-title="Call ID" data-content="'+e.aData[e.iDataColumn].call_id+'"></i>';return e.aData[e.iDataColumn].direction==="inbound"&&(t='<i class="fa fa-arrow-right monster-green popup-marker" data-placement="right" data-original-title="Call ID" data-content="'+e.aData[e.iDataColumn].call_id+'"></i>'),t},sWidth:"5%"},{sTitle:t.i18n.active().balance.dateColumn,sWidth:"20%"},{sTitle:t.i18n.active().balance.fromColumn,sWidth:"20%"},{sTitle:t.i18n.active().balance.toColumn,sWidth:"20%"},{sTitle:t.i18n.active().balance.accountColumn,sWidth:"25%"},{sTitle:t.i18n.active().balance.durationColumn,sWidth:"10%"}];i&&(s[7].sWidth="5%",s.push({sTitle:t.i18n.active().balance.amountColumn,sWidth:"5%"})),r.ui.table.create("balance",e.find("#transactions_grid"),s,{},{bScrollInfinite:!0,bScrollCollapse:!0,sScrollY:"300px",sDom:'<"table-custom-actions">frtlip',aaSorting:[[0,"desc"]]})}})},balanceCleanFormData:function(e,t){return delete t.extra,t},balanceFormatData:function(e){return e},balanceBindEventsDialog:function(e){var n=this,i=e.parent,o=e.data,u=o.threshold.enabled,a=o.topup.enabled||!1,f=!1,l=i.find("#threshold_alerts_content"),c=i.find("#threshold_alerts_switch"),h=i.find("#auto_recharge_content"),p=i.find("#auto_recharge_switch");i.find(".navbar-menu-item-link").on("click",function(e){e.preventDefault();var s=t(this),o=function(){f||(f=!0,i.find(".add-credits-content-wrapper.active").fadeOut(function(){i.find(".navbar-menu-item-link.active").removeClass("active"),s.addClass("active"),t(this).removeClass("active"),i.find(e.toElement.hash).fadeIn(function(){t(this).addClass("active"),f=!1})}))};if(i.find('.add-credits-content-wrapper.active input[type="checkbox"]').is(":checked")){var u=i.find(".add-credits-content-wrapper.active form").prop("id"),a=!1,l=r.ui.getFormData(u);for(var c in l)if(l[c]===""){a=!0;break}a?r.ui.alert("warning",n.i18n.active().balance.addCreditPopup.alerts.missingValue[u],function(){},{title:n.i18n.active().balance.addCreditPopup.alerts.missingValue.title}):o()}else o()}),i.find("#add_credit").on("click",function(t){t.preventDefault();var o=parseFloat(i.find("#amount").val().replace(",","."));o?n.balanceAddCredits(o,function(){var t={amount:n.i18n.active().currencyUsed+o};s.success(r.template(n,"!"+n.i18n.active().balance.creditsAdded,t)),typeof e.callback=="function"?n.balanceGet(function(t){e.callback(t.data.balance),i.dialog("close")}):i.dialog("close")}):r.ui.alert(n.i18n.active().balance.invalidAmount)}),c.on("change",function(){t(this).is(":checked")?l.slideDown():(u&&n.balanceTurnOffThreshold(function(){l.slideUp(function(){u=!1,s.success(n.i18n.active().balance.thresholdAlertsCancelled)})}),l.slideUp())}),c.prop("checked",u),l.toggle(u),i.find("#save_threshold").on("click",function(e){e.preventDefault();var t=r.ui.getFormData("threshold_alerts_content"),o={threshold:parseFloat(t.threshold_alerts_amount.replace(",","."))};o.threshold?o.threshold?n.balanceUpdateThreshold(o,function(){i.dialog("close"),s.success(n.i18n.active().balance.thresholdAlertsEnabled)}):r.ui.alert(n.i18n.active().balance.invalidAmount):r.ui.alert(n.i18n.active().balance.invalidAmount)}),p.on("change",function(){t(this).is(":checked")?h.slideDown():a?n.balanceTurnOffTopup(function(){h.slideUp(function(){a=!1,s.success(n.i18n.active().balance.autoRechargeCancelled)})}):h.slideUp()}),p.prop("checked",a),h.toggle(a),i.find("#confirm_recharge").on("click",function(e){e.preventDefault();var t=r.ui.getFormData("auto_recharge_content"),o={threshold:parseFloat(t.auto_recharge_threshold.replace(",",".")),amount:parseFloat(t.auto_recharge_amount.replace(",","."))};o.threshold&&o.amount?o.threshold&&o.amount?n.balanceUpdateTopUp(o,function(){i.dialog("close"),s.success(n.i18n.active().balance.autoRechargeEnabled)}):r.ui.alert(n.i18n.active().balance.invalidAmount):r.ui.alert(n.i18n.active().balance.invalidAmount)})},balanceBindEvents:function(e){var t=this;setTimeout(function(){e.find(".search-query").focus()}),e.find("#add_credits").on("click",function(){var n={callback:function(n){var i=parseFloat(n).toFixed(2),s=t.i18n.active().currencyUsed+i,o={module:"balance",data:s};r.pub("myaccount.updateMenu",o),e.find("#amount").html(i)}};t._balanceRenderAddCredit(n)})},balanceTurnOffThreshold:function(e){var t=this;t.callApi({resource:"account.get",data:{accountId:t.accountId},success:function(n,r){n.data.hasOwnProperty("threshold")&&(delete n.data.threshold,t.callApi({resource:"account.update",data:{accountId:t.accountId,data:n.data},success:function(t){e&&e(t)}}))}})},balanceUpdateThreshold:function(e,t){var n=this;n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(r,i){r.data.threshold=e,n.callApi({resource:"account.update",data:{accountId:n.accountId,data:r.data},success:function(e){t&&t(e)}})}})},balanceTurnOffTopup:function(e){var t=this;t.callApi({resource:"account.get",data:{accountId:t.accountId},success:function(n){n.data.hasOwnProperty("topup")&&(delete n.data.topup,t.callApi({resource:"account.update",data:{accountId:t.accountId,data:n.data},success:function(t){e&&e(t)}}))}})},balanceUpdateTopUp:function(e,t){var n=this;n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(r){r.data.topup=e,n.callApi({resource:"account.update",data:{accountId:n.accountId,data:r.data},success:function(e){t&&t(e)}})}})},balanceGetAccounts:function(e,t){var n=this;n.callApi({resource:"account.listDescendants",data:{accountId:n.accountId},success:function(t,n){e&&e(t,n)},error:function(e,n){t&&t(e,n)}})},balanceGetLimits:function(e,t){var n=this;n.callApi({resource:"limits.get",data:{accountId:n.accountId},success:function(t,n){e&&e(t,n)},error:function(e,n){t&&t(e,n)}})},balanceGetTransactions:function(e,t,n){var i=this;if(typeof e=="function"){t=e,n=t;var s=r.util.getDefaultRangeDates(i.balanceRange),e={};e.to=s.to,e.from=s.from}var o=r.util.dateToBeginningOfGregorianDay(e.from),u=r.util.dateToEndOfGregorianDay(e.to);i.callApi({resource:"balance.filtered",data:{accountId:i.accountId,from:o,to:u,reason:"only_calls"},success:function(e,n){t&&t(e,n)},error:function(e,t){n&&n(e,t)}})},balanceUpdateLimits:function(e,t,n){var r=this;r.callApi({resource:"limits.update",data:{accountId:r.accountId,data:e},success:function(e,n){t&&t(e,n)},error:function(e,t){n&&n(e,t)}})},balanceGet:function(e,t){var n=this;n.callApi({resource:"balance.get",data:{accountId:n.accountId},success:function(t,n){e&&e(t,n)},error:function(e,n){t&&t(e,n)}})},balanceAddCredits:function(e,t,n){var r=this,i={amount:e};r.balanceUpdateRecharge(i,t,n)},balanceUpdateRecharge:function(e,t,n){var r=this;r.callApi({resource:"balance.add",data:{accountId:r.accountId,data:e},success:function(e,n){t&&t(e,n)},error:function(e,t){n&&n(e,t)}})}};return o});