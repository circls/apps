define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"myaccount.servicePlan.renderContent":"_servicePlanRenderContent"},_servicePlanRenderContent:function(e){var n=this,i={hasServicePlan:!1,hasSubscriptions:!1,totalAmount:0,servicePlanArray:[]},s=i;r.parallel({servicePlan:function(e){n.servicePlanGet(function(o){var u=[],a=0,f;s.hasServicePlan=!0,"items"in o.data&&t.each(o.data.items,function(e,i){t.each(i,function(e,t){var i=t.single_discount_rate+t.cumulative_discount_rate*t.cumulative_discount,s=parseFloat(t.rate*t.quantity-i||0);s>0&&(f=n.i18n.active().servicePlan.titles.hasOwnProperty(e)?n.i18n.active().servicePlan.titles[e]:r.util.formatVariableToDisplay(e),u.push({service:f,rate:t.rate||0,quantity:t.quantity||0,discount:i>0?"-"+n.i18n.active().currencyUsed+r.util.formatPrice(i,2):"",monthlyCharges:s}),a+=s)})});var l=function(e,t){return parseFloat(e.monthlyCharges)>=parseFloat(t.monthlyCharges)?-1:1};u.sort(l),s.servicePlanArray=u,s.totalAmount=a,e(null,o)},function(n){e(null,{})})},subscription:function(e){n.servicePlanGetSubscription(function(n){s.hasSubscriptions=!0,s.dueDate="?",n.data.length>0&&n.data.forEach(function(e){if(e.status==="Active")return s.dueDate=r.util.toFriendlyDate(e.next_bill_date,"short"),!1}),e(null,n)},function(n){e(null,{})})}},function(i,o){var u=t(r.template(n,"servicePlan-layout",s));n.servicePlanBindEvents(u),r.pub("myaccount.renderSubmodule",u),typeof e.callback=="function"&&e.callback(u)})},servicePlanCleanFormData:function(e,t){return delete t.extra,t},servicePlanBindEvents:function(e){var t=this;r.ui.tooltips(e),e.find(".action-number#download").on("click",function(){window.location.href=t.apiUrl+"accounts/"+t.accountId+"/service_plans/current?depth=4&identifier=items&accept=csv&auth_token="+t.authToken})},servicePlanDownloadCsv:function(e,t){var n=this;n.callApi({resource:"servicePlan.getCsv",data:{accountId:n.accountId},success:function(t,n){e&&e(t,n)},error:function(e,n){t&&t(e,n)}})},servicePlanGet:function(e,t){var n=this;n.callApi({resource:"servicePlan.listCurrent",data:{accountId:n.accountId,generateError:!1},success:function(t,n){e&&e(t,n)},error:function(e,n){t&&t(e,n)}})},servicePlanGetSubscription:function(e,t){var n=this;n.callApi({resource:"balance.getSubscriptions",data:{accountId:n.accountId,generateError:!1},success:function(t,n){e&&e(t,n)},error:function(e,n){t&&t(e,n)}})}};return i});