define(["require","jquery","underscore","monster","card"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("card"),s={subscribe:{"myaccount.billing.renderContent":"_billingRenderContent"},_billingRenderContent:function(e){var n=this;r.parallel({account:function(e){n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(t,n){e(null,t.data)}})},billing:function(e){n.callApi({resource:"billing.get",data:{accountId:n.accountId,generateError:!1},success:function(t,n){e(null,t.data)},error:function(t,n){e(null,{})}})}},function(i,s){n.billingFormatData(s,function(i){var s=t(r.template(n,"billing-layout",i));n.billingBindEvents(s,i),r.pub("myaccount.renderSubmodule",s),s.find("#form_credit_card").card({container:".credit-card-container",nameInput:"#first_name, #last_name",numberInput:"#credit_card_number",expiryInput:"#expiration_date_month, #expiration_date_year",cvcInput:"#security_code",values:{number:"•••• •••• •••• "+(i.billing.credit_card.last_four||"••••")}}),typeof e.callback=="function"&&e.callback(s)})})},billingFormatData:function(e,t){n.isEmpty(e.billing)||(e.billing.credit_card=e.billing.credit_cards[0]||{},e.billing.credit_card.last_four&&(e.billing.credit_card.fake_number="************"+e.billing.credit_card.last_four,e.billing.credit_card.fake_cvv="***",e.billing.credit_card.type=e.billing.credit_card.card_type.toLowerCase())),t(e)},billingBindEvents:function(e,n){var i=this,s=function(e){var t=new RegExp("^4[0-9]{12}(?:[0-9]{3})?$"),n=new RegExp("^5[1-5][0-9]{14}$"),r=new RegExp("^3[47][0-9]{13}$"),i=new RegExp("^6(?:011|5[0-9]{2})[0-9]{12}$");return t.test(e)?"visa":n.test(e)?"mastercard":r.test(e)?"amex":i.test(e)?"discover":!1},o=function(t){var n=s(t);n===!1?(e.find(".edition .card-type").hide(),e.find(".add-on i").show()):e.find(".card-type."+n).is(":visible")||(e.find(".edition .card-type").hide(),e.find(".add-on i").hide(),e.find(".edition .card-type."+n).css("display","inline-block"))};e.find(".edit-credit-card").on("click",function(t){t.preventDefault(),e.find(".edition").show(),e.find(".uneditable").hide(),o("")}),e.find("#credit_card_number").on("keyup",function(e){o(t(this).val())}),e.find("#credit_card_number").on("paste",function(e){var n=t(this);setTimeout(function(){o(n.val())},0)}),e.find('.settings-item[data-name="credit_card"] .settings-link').on("click",function(){var e=t(this).parents(".settings-item");e.hasClass("open")||e.find("input").keyup()}),r.pub("myaccount.events",{template:e,data:n})}};return s});