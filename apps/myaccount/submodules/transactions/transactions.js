define(["require","jquery","underscore","toastr","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("toastr"),i=e("monster"),s={requests:{},subscribe:{"myaccount.transactions.renderContent":"_transactionsRenderContent"},transactionsRange:"monthly",_transactionsRenderContent:function(e){var n=this;n.listTransactions(function(r){var s=t(i.template(n,"transactions-layout",r)),o=i.template(n,"transactions-list",r),u={container:s,range:n.transactionsRange};s.find(".list-transactions").append(o),i.ui.initRangeDatepicker(u),n.transactionsBindEvents(s),i.pub("myaccount.renderSubmodule",s),typeof e.callback=="function"&&e.callback(s)})},transactionsFormatData:function(e){var t=this;return e.amount=parseFloat(e.amount).toFixed(2),e.listTransactions.sort(function(e,t){return e.created<t.created?1:-1}),e},transactionsBindEvents:function(e,n){var r=this;e.find(".expandable").hide(),e.on("click",".expand-box:not(.disabled)",function(){var e=t(this),n=e.parents(".transaction-box"),r=n.first().find(".expandable");e.find(".fa-stack-content").toggleClass("fa-plus fa-minus"),n.toggleClass("open"),r.slideToggle("fast")}),e.find("#filter_transactions").on("click",function(){var t=i.util.parseDateString(e.find("#startDate").val()),n=i.util.parseDateString(e.find("#endDate").val());r.listTransactions(t,n,function(t){var n=e.find(".list-transactions").empty();n.append(i.template(r,"transactions-list",t)),e.find(".expandable").hide(),e.find(".start-date .value").html(t.billingStartDate),e.find(".end-date .value").html(t.billingEndDate),e.find(".total-amount .value").html(r.i18n.active().currencyUsed+t.amount)})})},listTransactions:function(e,n,r){var s=this;if(typeof e=="function"){r=e;var o=i.util.getDefaultRangeDates(s.balanceRange);e=o.from,n=o.to}e=i.util.dateToBeginningOfGregorianDay(e),n=i.util.dateToEndOfGregorianDay(n);var u={amount:0,billingStartDate:i.util.toFriendlyDate(e,"short"),billingEndDate:i.util.toFriendlyDate(n,"short")};i.parallel({charges:function(r){s.transactionsGetCharges(e,n,function(e){var n=[];t.each(e.data,function(e,t){t.code!==4e3&&(t=i.util.formatTransaction(t,s),n.push(t),t.approved&&(t.type==="credit"?u.amount-=parseFloat(t.amount):u.amount+=parseFloat(t.amount)))}),r(null,n)})}},function(e,t){var n=u;n.listTransactions=t.charges,n=s.transactionsFormatData(n),r(n)})},transactionsGetCharges:function(e,t,n,r){var i=this;i.callApi({resource:"balance.getCharges",data:{accountId:i.accountId,from:e,to:t,reason:"no_calls"},success:function(e,t){n&&n(e,t)},error:function(e,t){r&&r(e,t)}})}};return s});