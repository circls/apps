define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s={name:"webhooks",css:["app"],i18n:{"en-US":{customCss:!1},"ru-RU":{customCss:!1},"es-ES":{customCss:!1}},requests:{},subscribe:{},load:function(e){var t=this;t.initApp(function(){e&&e(t)})},initApp:function(e){var t=this;r.pub("auth.initApp",{app:t,callback:e})},render:function(e){var i=this,e=e||{},s=e.container,o=e.webhookId||"";i.getWebhooks(function(e){var u=i.formatWebhooksData(e),a=t(r.template(i,"webhooks-layout",u)),f=n.isEmpty(s)?t("#monster-content"):s;i.bindEvents(a),f.empty().append(a);if(o){var l=f.find(".grid-row[data-id="+o+"]");r.ui.highlight(l)}})},formatWebhooksData:function(e){var t=this,i={isEmpty:e.length===0,groupedWebhooks:[],ungroupedWebhooks:[],counters:n.countBy(e,function(e){return e.enabled?"active":e.disable_reason?"error":"disabled"})},s={};return n.each(e,function(e){e.group?(s.hasOwnProperty(e.group)||(s[e.group]={groupName:e.group,webhooks:[]}),s[e.group].webhooks.push(e)):i.ungroupedWebhooks.push(e)}),i.groupedWebhooks=n.map(s,function(e,t){return r.util.sort(e.webhooks,"name"),e}),r.util.sort(i.ungroupedWebhooks,"name"),r.util.sort(i.groupedWebhooks,"groupName"),i},bindEvents:function(e){var s=this;setTimeout(function(){e.find(".search-query").focus()}),r.ui.tooltips(e),e.find(".new-webhook").on("click",function(t){s.renderWebhookEdit(e)}),e.find(".reenable-button").on("click",function(){s.enableAllWebhooks(function(){s.render()})}),e.find(".edit").on("click",function(n){var r=t(this).data("id");s.renderWebhookEdit(e,r)}),e.find(".history").on("click",function(n){var r=t(this).parents(".grid-row");s.renderAttemptsHistory(e,r.data("id"),r.hasClass("error"))}),e.find(".delete").on("click",function(e){t(this).parents(".grid-row").find(".grid-row-delete").fadeIn()}),e.find(".confirm-delete").on("click",function(e){var n=t(this).parents(".grid-row").data("id");s.deleteWebhook(n,function(e){s.render(),i.success(r.template(s,"!"+s.i18n.active().webhooks.toastr.deleteSuccess+e.name))})}),e.find(".cancel-delete").on("click",function(e){t(this).parents(".grid-row-delete").fadeOut()}),e.find(".search-query").on("keyup",function(){var r=t(this).val().toLowerCase(),i=e.find(".webhooks-grid .grid-row:not(.title)"),s=e.find(".webhooks-grid .empty-search-row").toggleClass(".show");n.each(i,function(e){var n=t(e),i=n.parents(".grid-row-group");n.data("search").toLowerCase().indexOf(r)<0?(n.hide(),i.length>0&&i.find(".grid-row:not(.title):visible").length===0&&i.hide()):(n.show(),i.length>0&&i.show())}),i.size()>0&&(i.is(":visible")?s.hide():s.show())}),e.find(".webhook-toggle").on("change",function(){var n=t(this),r=n.data("id"),i=n.is(":checked");s.getWebhookDetails(r,function(t){t.enabled=i,s.updateWebhook(r,t,function(){var t=e.find(".counter-active .count"),r=e.find(".counter-disabled .count"),s=e.find(".counter-errors .count");i?(t.html(parseInt(t.html())+1),r.html(parseInt(r.html())-1)):(r.html(parseInt(r.html())+1),t.html(parseInt(t.html())-1)),n.parents(".grid-row").toggleClass("disabled")})})})},renderWebhookEdit:function(e,i){var s=this,o=function(e,t){r.parallel({webhookList:function(e){s.getAvailableWebhooks(function(t){e&&e(null,t)})},webhookDetails:function(t){e?s.getWebhookDetails(e,function(e){t&&t(null,e)}):t&&t(null,{})}},function(e,n){t&&t(n)})};o(i,function(i){var o=s.i18n.active().webhooks.webhookList,u=r.util.sort(n.map(i.webhookList,function(e){return{id:e.id,name:e.id in o?o[e.id].name:e.name,description:e.id in o?o[e.id].description:e.description}})).concat({id:"all",name:o.all.name,description:o.all.description}),a=t(r.template(s,"webhooks-edit",{webhookList:u,webhook:i.webhookDetails,groups:Object.keys(s.uiFlags.account.get("groups")||{}).sort()}));i.webhookDetails.custom_data&&n.each(i.webhookDetails.custom_data,function(e,t){var n=r.template(s,"webhooks-customDataRow",{key:t,value:e});a.find(".custom-data-container").append(n)}),r.ui.validate(a.find("#webhook_edition_form"),{rules:{uri:{url:!0}}}),s.bindWebhookEditEvents(a,i.webhookDetails),e.find(".webhooks-container").empty().append(a)})},bindWebhookEditEvents:function(e,s){var o=this,u=o.uiFlags.account.get("groups")||{};e.find(".select-group").on("change",function(){t(this).val()==="new"?e.find(".new-group-container").show():e.find(".new-group-container").hide()}),e.find(".custom-data-link").on("click",function(){e.find(".custom-data-container").append(r.template(o,"webhooks-customDataRow"))}),e.find(".custom-data-container").on("click",".delete-custom-data",function(){t(this).parent().remove()}),e.find(".action-bar .cancel").on("click",function(){o.render()}),e.find(".action-bar .save").on("click",function(){r.ui.valid(e.find("#webhook_edition_form"))&&o.getFormData(e,function(e){n.isEmpty(s)?o.addWebhook(e,function(t){e.group?(u[e.group]=(u[e.group]||0)+1,o.updateWebhookGroups(u,function(){o.render({webhookId:t.id})})):o.render({webhookId:t.id}),i.success(r.template(o,"!"+o.i18n.active().webhooks.toastr.addSuccess+t.name))}):o.updateWebhook(s.id,e,function(t){e.group&&(e.group!==s.group?(u[e.group]=(u[e.group]||0)+1,u[s.group]=(u[s.group]||0)-1,u[s.group]<=0&&delete u[s.group],o.updateWebhookGroups(u,function(){o.render({webhookId:t.id})})):o.render({webhookId:t.id})),s.group?(u[s.group]=(u[s.group]||0)-1,u[s.group]<=0&&delete u[s.group],o.updateWebhookGroups(u,function(){o.render({webhookId:t.id})})):o.render({webhookId:t.id}),i.success(r.template(o,"!"+o.i18n.active().webhooks.toastr.editSuccess+t.name))})})})},renderAttemptsHistory:function(e,n,i){var s=this;r.parallel({webhook:function(e){s.getWebhookDetails(n,function(t){e&&e(null,t)})},attempts:function(e){s.getWebhookHistory(n,function(t){e&&e(null,t)})}},function(n,o){var u=s.formatAttemptsHistoryData(o,i),a=t(r.template(s,"webhooks-attempts",u));s.bindAttemptsHistoryEvents(a,o.webhook),e.find(".webhooks-container").empty().append(a)})},formatAttemptsHistoryData:function(e,t){var i=this,s={name:e.webhook.name?r.template(i,"!"+i.i18n.active().webhooks.webhookAttempts.header,{webhookName:e.webhook.name}):"",url:e.webhook.uri,isError:t};return s.attempts=n.map(e.attempts,function(t){var n=r.util.toFriendlyDate(t.timestamp).split(" - ");return{date:n[0],time:n[1],sent:e.webhook.http_verb.toUpperCase(),received:t.reason,attempts:parseInt(e.webhook.retries)-t.retries_left,error:t.result==="failure"}}),s},bindAttemptsHistoryEvents:function(e,t){var n=this;e.find(".top-action-bar .back-button").on("click",function(){n.render()}),e.find(".top-action-bar .enable-button").on("click",function(){n.enableWebhook(t.id,function(){n.render()})})},getFormData:function(e,n){var i=this,s={},o=!0,u=e.find(".select-group").val(),a=e.find(".new-group").val();e.find(".custom-data-row").each(function(e){var n=t(this).find(".custom-data-key").val(),r=t(this).find(".custom-data-value").val();if(s.hasOwnProperty(n))return o=!1,!1;s[n]=r});if(o){var f=r.ui.getFormData("webhook_edition_form");f.custom_data=s,delete f.extra,u==="new"?f.group=a:u!=="none"&&(f.group=u.replace("group_","")),n&&n(f)}else r.ui.alert("warning",i.i18n.active().webhooks.warning)},getWebhooks:function(e){var t=this;t.callApi({resource:"webhooks.list",data:{accountId:t.accountId},success:function(t){e(t.data)}})},getAvailableWebhooks:function(e){var t=this;t.callApi({resource:"webhooks.listAvailable",data:{},success:function(t){e(t.data)}})},getWebhookDetails:function(e,t){var n=this;n.callApi({resource:"webhooks.get",data:{accountId:n.accountId,webhookId:e},success:function(e){t&&t(e.data)}})},getWebhookHistory:function(e,t){var n=this;n.callApi({resource:"webhooks.listAttempts",data:{accountId:n.accountId,webhookId:e},success:function(e){t&&t(e.data)}})},addWebhook:function(e,t){var n=this;n.callApi({resource:"webhooks.create",data:{accountId:n.accountId,data:e},success:function(e){t(e.data)}})},updateWebhook:function(e,t,n){var r=this;r.callApi({resource:"webhooks.update",data:{accountId:r.accountId,webhookId:e,data:t},success:function(e){n&&n(e.data)}})},deleteWebhook:function(e,t){var n=this;n.callApi({resource:"webhooks.delete",data:{accountId:n.accountId,webhookId:e,data:{}},success:function(e){t&&t(e.data)}})},enableWebhook:function(e,t){var n=this;n.callApi({resource:"webhooks.patch",data:{accountId:n.accountId,webhookId:e,data:{enabled:!0}},success:function(e){t&&t(e.data)}})},enableAllWebhooks:function(e){var t=this;t.callApi({resource:"webhooks.patchAll",data:{accountId:t.accountId,data:{"re-enable":!0}},success:function(t){e&&e(t.data)}})},updateWebhookGroups:function(e,t){var n=this,r=n.uiFlags.account.set("groups",e);n.callApi({resource:"account.update",data:{accountId:r.id,data:r},success:function(e,n){t(e.data)}})}};return s});