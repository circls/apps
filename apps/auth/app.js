define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s={name:"auth",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1}},appFlags:{mainContainer:undefined,isAuthentified:!1},requests:{"auth.upgradeTrial":{apiRoot:r.config.api.screwdriver,url:"upgrade",verb:"POST"}},subscribe:{"auth.logout":"_logout","auth.clickLogout":"_clickLogout","auth.initApp":"_initApp","auth.afterAuthenticate":"_afterSuccessfulAuth","auth.showTrialInfo":"showTrialInfo"},load:function(e){var t=this;e&&e(t)},render:function(e){var t=this;t.appFlags.mainContainer=e,t.triggerLoginMechanism()},triggerLoginMechanism:function(){var e=this,n=r.util.getUrlVars(),i=function(t){e._afterSuccessfulAuth(t)};if("authentication"in r.config.whitelabel){e.customAuth=r.config.whitelabel.authentication;var s={sourceUrl:e.customAuth.source_url,apiUrl:e.customAuth.api_url};r.apps.load(e.customAuth.name,function(t){t.render(e.appFlags.mainContainer)},s)}else if(t.cookie("monster-auth")){var o=t.parseJSON(t.cookie("monster-auth"));e.authenticateAuthToken(o.accountId,o.authToken,i)}else n.hasOwnProperty("t")&&n.hasOwnProperty("a")&&n.t.length===32&&n.a.length===32?e.authenticateAuthToken(n.a,n.t,i):e.renderLoginPage(e.appFlags.mainContainer)},authenticateAuthToken:function(e,t,n){var r=this;r.authToken=t,r.getAuth(e,t,function(e){n&&n(e)},function(){delete r.authToken,r.renderLoginPage(r.appFlags.mainContainer)})},_afterSuccessfulAuth:function(e){var n=this;n.accountId=e.data.account_id,n.authToken=e.auth_token,n.userId=e.data.owner_id,n.isReseller=e.data.is_reseller,n.resellerId=e.data.reseller_id,n.appFlags.isAuthentified=!0,"apps"in e.data?n.installedApps=e.data.apps:(n.installedApps=[],i.error(n.i18n.active().toastrMessages.appListError));var s={language:e.data.language,authToken:n.authToken,accountId:n.accountId};t.cookie("monster-auth",JSON.stringify(s)),n.appFlags.mainContainer.addClass("monster-content"),t("#main .footer-wrapper").append(n.appFlags.mainContainer.find(".powered-by-block .powered-by")),n.appFlags.mainContainer.empty(),r.apps.core.authToken=e.auth_token,n.afterLoggedIn()},_clickLogout:function(){var e=this;r.ui.confirm(e.i18n.active().confirmLogout,function(){e._logout()})},afterLoggedIn:function(){var e=this;t("#main_topbar_apploader").show(),e.loadAccount()},loadAccount:function(){var e=this;r.parallel({appsStore:function(t){e.getAppsStore(function(e){t(null,e)})},account:function(t){e.getAccount(e.accountId,function(e){t(null,e.data)},function(e){t("error account",e)})},user:function(t){e.getUser(function(e){t(null,e.data)},function(e){t("error user",e)})}},function(i,s){var o;if(i)r.util.logoutAndReload();else{s.user.hasOwnProperty("require_password_update")&&s.user.require_password_update&&e.newPassword(s.user),r.util.autoLogout(),t("#main_topbar_signout").show(),s.user.account_name=s.account.name,s.user.apps=s.user.apps||{},s.account.apps=s.account.apps||{};var u=function(){var i=n.indexBy(e.installedApps,"id"),u=n.find(s.user.appList||[],function(e){return i.hasOwnProperty(e)});u?o=i[u].name:e.installedApps.length>0&&(o=e.installedApps[0].name),r.appsStore=n.indexBy(s.appsStore,"name"),e.currentUser=s.user,e.originalAccount=s.account,e.currentAccount=t.extend(!0,{},e.originalAccount),e.defaultApp=o,e.showAnnouncement(e.originalAccount.announcement),"ui_flags"in s.user&&s.user.ui_flags.colorblind&&t("body").addClass("colorblind"),r.util.isAdmin()&&t("#main_topbar_account_toggle_link").addClass("visible"),r.pub("core.loadApps",{defaultApp:o})},a=function(t,n){t!==r.config.whitelabel.language&&t!==r.apps.defaultLanguage?r.apps.loadLocale(r.apps.core,t,function(){r.apps.loadLocale(e,t,function(){r.config.whitelabel.language=t,n&&n()})}):(r.config.whitelabel.language=t,n&&n())};"language"in s.user?a(s.user.language,u):"language"in s.account?a(s.account.language,u):u&&u()}})},showAnnouncement:function(){var e=this,t=e.originalAccount.announcement||r.config.whitelabel.announcement;t&&r.ui.alert("info",t,null,{title:e.i18n.active().announcementTitle})},showTrialInfo:function(e){var n=this,i=e>0?Math.ceil(e/86400):-1,s=n.uiFlags.user.get("hasLoggedIn")?!0:!1,o=t(r.template(n,"trial-message",{daysLeft:i}));o.find(".links").on("click",function(){n.showTrialPopup(i)}),t("#main_topbar_nav").prepend(o),s?n.showTrialPopup(i):n.showFirstTrialGreetings()},showFirstTrialGreetings:function(){var e=this,n=function(t){var n=e.uiFlags.user.set("hasLoggedIn",!0);e.updateUser(n,function(e){t&&t(e)}),r.pub("auth.continueTrial")},i=t(r.template(e,"trial-greetingsDialog"));i.find("#acknowledge").on("click",function(){s.dialog("close").remove(),n&&n()});var s=r.ui.dialog(i,{title:e.i18n.active().trialGreetingsDialog.title});s.siblings().find(".ui-dialog-titlebar-close").on("click",function(){n&&n()})},updateUser:function(e,t){var n=this;n.callApi({resource:"user.update",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},showTrialPopup:function(e){var t=this,n,i=t.uiFlags.account.get("trial_upgraded");i?r.ui.alert("info",t.i18n.active().trialPopup.alreadyUpgraded):e>=0?r.ui.confirm("",function(){t.handleUpgradeClick()},function(){r.pub("auth.continueTrial")},{title:r.template(t,"!"+t.i18n.active().trialPopup.mainMessage,{variable:e}),cancelButtonText:t.i18n.active().trialPopup.closeButton,confirmButtonText:t.i18n.active().trialPopup.upgradeButton,confirmButtonClass:"monster-button-primary",type:"warning"}):r.ui.alert("error","",function(){t.handleUpgradeClick()},{closeOnEscape:!1,title:t.i18n.active().trialPopup.trialExpired,closeButtonText:t.i18n.active().trialPopup.upgradeButton,closeButtonClass:"monster-button-primary"})},handleUpgradeClick:function(){var e=this;r.pub("myaccount.hasCreditCards",function(t){t?e.upgradeAccount(e.accountId,function(){r.ui.alert("info",e.i18n.active().trial.successUpgrade.content,null,{title:e.i18n.active().trial.successUpgrade.title})}):(r.pub("myaccount.showCreditCardTab"),i.error(e.i18n.active().trial.noCreditCard))})},upgradeAccount:function(e,t){var n=this;n.sendUpgradeTrialRequest(e,function(){n.setUpgradeFlagAccount(e,function(e){t&&t(e)})})},sendUpgradeTrialRequest:function(e,t){var n=this;r.request({resource:"auth.upgradeTrial",data:{envelopeKeys:{id:e}},success:function(e,n){t&&t(e)}})},setUpgradeFlagAccount:function(e,t){var n=this;n.getAccount(e,function(e){var r=n.uiFlags.account.set("trial_upgraded",!0,e.data);n.callApi({resource:"account.update",data:{accountId:n.accountId,data:r},success:function(e){t&&t(e.data)}})})},renderLoginPage:function(e){var n=this,i="",s="",o=t.parseJSON(t.cookie("monster-login"))||{},u={username:o.login||"",requestAccountName:s||i?!1:!0,accountName:o.accountName||"",rememberMe:o.login||o.accountName?!0:!1,showRegister:r.config.hide_registration||!1,hidePasswordRecovery:r.config.whitelabel.hidePasswordRecovery||!1},a=t(r.template(n,"app",u)),f=function(){r.config.whitelabel.custom_welcome&&a.find(".welcome-message").empty().html((r.config.whitelabel.custom_welcome_message||"").replace(/\r?\n/g,"<br />")),e.append(a),n.bindLoginBlock(u),a.find(".powered-by-block").append(t("#main .footer-wrapper .powered-by")),n.appFlags.mainContainer.removeClass("monster-content")},l=window.location.hostname;n.callApi({resource:"whitelabel.getLogoByDomain",data:{domain:l,generateError:!1,dataType:"*"},success:function(e){a.find(".logo-block").css("background-image","url("+r.config.api.default+"whitelabel/"+l+"/logo?_="+(new Date).getTime()+")"),f()},error:function(e){a.find(".logo-block").css("background-image",'url("apps/auth/style/static/images/logo.svg")'),f()}})},bindLoginBlock:function(e){var s=this,o=t("#auth_container");o.find(e.username!==""?"#password":"#login").focus(),o.find(".btn-submit.login").on("click",function(e){e.preventDefault(),s.loginClick()}),o.find('.input-wrap input[type="text"], input[type="password"], input[type="email"]').val()!==""&&o.find(".placeholder-shift").addClass("fixed"),o.find('.input-wrap input[type="text"], input[type="password"], input[type="email"]').on("change",function(){this.value!==""?t(this).next(".placeholder-shift").addClass("fixed"):t(this).next(".placeholder-shift").removeClass("fixed")}),o.find(".form-toggle").on("click",function(){var e=t(this).data("form");o.find(".form-container").toggleClass("hidden"),o.find('.form-container[data-form="'+e+'"]').addClass("fadeInDown"),o.find(".form-content").removeClass("hidden"),o.find(".reset-notification").addClass("hidden")});var u=o.find("#form_password_recovery");r.ui.validate(u),o.find(".recover-password").on("click",function(){if(r.ui.valid(u)){var e=r.ui.getFormData("form_password_recovery",".",!0);e.ui_url=window.location.href,e.hasOwnProperty("account_name")||e.hasOwnProperty("phone_number")?s.callApi({resource:"auth.recovery",data:{data:e,generateError:!1},success:function(e,t){o.find(".form-content").addClass("hidden"),o.find(".reset-notification").addClass("animated fadeIn").removeClass("hidden")},error:function(e,t){t.status===400&&n.keys(e.data).forEach(function(t){s.i18n.active().recoverPassword.toastr.error.reset.hasOwnProperty(t)?i.error(s.i18n.active().recoverPassword.toastr.error.reset[t]):e.data[t].hasOwnProperty("not_found")&&i.error(e.data[t].not_found)})}}):i.error(s.i18n.active().recoverPassword.toastr.error.missing)}})},loginClick:function(e){var n=this,r=t("#login").val(),i=t("#password").val(),s=t("#account_name").val(),o=t.md5(r+":"+i),u={credentials:o,account_name:s};n.putAuth(u,function(e){if(t("#remember_me").is(":checked")){var i={login:r,accountName:s};t.cookie("monster-login",JSON.stringify(i),{expires:30})}else t.cookie("monster-login",null);n._afterSuccessfulAuth(e)})},_logout:function(){var e=this;r.util.logoutAndReload()},newPassword:function(e){var n=this,s=t(r.template(n,"dialogPasswordUpdate")),o=s.find("#form_password_update"),u=r.ui.dialog(s,{title:n.i18n.active().passwordUpdate.title});r.ui.validate(o),s.find(".update-password").on("click",function(){if(r.ui.valid(o)){var s=r.ui.getFormData("form_password_update");if(s.new_password===s.new_password_confirmation){var a={password:s.new_password,require_password_update:!1},f=t.extend(!0,{},e,a);n.callApi({resource:"user.update",data:{accountId:n.accountId,userId:n.userId,data:f},success:function(e,t){u.dialog("close").remove(),i.success(n.i18n.active().passwordUpdate.toastr.success.update)}})}else i.error(n.i18n.active().passwordUpdate.toastr.error.password)}}),s.find(".cancel-link").on("click",function(){u.dialog("close").remove()})},conferenceLogin:function(){var e=this,t=r.ui.getFormData("user_login_form");n.each(t.update,function(e,n){e||delete t.update[n]}),e.callApi({resource:"auth.pinAuth",data:{data:t},success:function(n,i){e.accountId=n.data.account_id,e.authToken=n.auth_token,e.userId=null,e.isReseller=n.data.is_reseller,e.resellerId=n.data.reseller_id,e.appFlags.mainContainer.empty(),r.apps.load("conferences",function(r){r.userType="unregistered",r.user=t,r.isModerator=n.data.is_moderator,r.conferenceId=n.data.conference_id,r.render(e.appFlags.mainContainer)})},error:function(t,n){var i=e.i18n.active().errors.generic;n.status in e.i18n.active().errors?i=e.i18n.active().errors[n.status]:t.message&&(i+="<br/><br/>"+e.i18n.active().errors.genericLabel+": "+t.message),r.ui.alert("error",i)}})},putAuth:function(e,t){var n=this;n.callApi({resource:"auth.userAuth",data:{data:e,generateError:!1},success:function(e,n){t&&t(e)},error:function(e,t,i){if(t.status===423&&e.data.hasOwnProperty("account")&&e.data.account.hasOwnProperty("expired")){var s=r.util.toFriendlyDate(r.util.gregorianToDate(e.data.account.expired.cause),"short"),o=r.template(n,"!"+n.i18n.active().expiredTrial,{date:s});r.ui.alert("warning",o)}else t.status===423?r.ui.alert("error",n.i18n.active().disabledAccount):i(e,{generateError:!0})}})},getAuth:function(e,t,n,r){var i=this;i.callApi({resource:"auth.get",data:{accountId:e,token:t,generateError:!1},success:function(e){n&&n(e)},error:function(e){r&&r()}})},getAccount:function(e,t,n){var r=this;r.callApi({resource:"account.get",data:{accountId:e},success:function(e){typeof t=="function"&&t(e)},error:function(e){typeof n=="function"&&n(e)}})},getAppsStore:function(e){var t=this;t.callApi({resource:"appsStore.list",data:{accountId:t.accountId},success:function(t){e&&e(t.data)}})},getUser:function(e,t){var n=this;n.callApi({resource:"user.get",data:{accountId:n.accountId,userId:n.userId},success:function(t){typeof e=="function"&&e(t)},error:function(e){typeof t=="function"&&t(e)}})},_initApp:function(e){var t=this,i={data:{realm:t.realm,accountId:t.accountId,shared_token:t.authToken}},s=function(n){n.isMasqueradable=n.hasOwnProperty("isMasqueradable")?n.isMasqueradable:r.appsStore.hasOwnProperty(n.name)?r.appsStore[n.name].masqueradable:!0,n.accountId=n.isMasqueradable&&t.currentAccount?t.currentAccount.id:t.accountId,n.userId=t.userId,e.callback&&e.callback()},o=n.find(t.installedApps,function(t){return t.name===e.app.name});o&&o.api_url&&(e.app.apiUrl=o.api_url,e.app.apiUrl.substr(e.app.apiUrl.length-1)!=="/"&&(e.app.apiUrl+="/")),e.app.authToken=this.authToken,s(e.app)}};return s});