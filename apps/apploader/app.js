define(["require","jquery","underscore","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s={name:"apploader",isMasqueradable:!1,css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1}},requests:{},subscribe:{"apploader.show":"render","apploader.hide":"_hide","apploader.toggle":"_toggle","apploader.current":"_currentApp"},load:function(e){var t=this;t.initApp(function(){e&&e(t)})},initApp:function(e){var t=this;t.isMasqueradable=!1,r.pub("auth.initApp",{app:t,callback:e})},_render:function(){var e=this},isRendered:function(){return t("#apploader").length!==0},render:function(){var e=this;e.isRendered()?e.show():e.getUserApps(function(n){var i=t(r.template(e,"app",{allowAppstore:r.apps.auth.currentUser.priv_level==="admin",defaultApp:n[0],apps:n}));t("#main_topbar").after(i),e.bindEvents(i,n),e.show()})},bindEvents:function(e,s){var o=this,u=e.find(".app-default"),a=function(n){var r=s.filter(function(e,t){return n===e.id})[0];e.find(".app-description").find("h4").text(r.label).addBack().find("p").text(r.description)};setTimeout(function(){e.find(".search-query").focus()}),e.find(".app-container").sortable({cancel:".ui-sortable-disabled",receive:function(n,r){var i=t(r.item),s=i.data("id");i.addClass("ui-sortable-disabled"),t.each(e.find(".left-div .app-element"),function(e,n){t(n).data("id")!==s&&t(n).remove()}),a(s),t(r.sender).data("copied",!0)},over:function(){e.find(".left-div .app-element.ui-sortable-disabled").hide()},out:function(){e.find(".left-div .app-element.ui-sortable-disabled").show()}}),e.find(".app-list").sortable({delay:100,appendTo:e.find(".app-container"),connectWith:".app-container",sort:function(){e.find(".app-container").addClass("dragging")},helper:function(e,n){return this.copyHelper=n.clone().css("opacity","0.2").insertAfter(n),t(this).data("copied",!1),n.clone()},stop:function(){var n=t(this).data("copied");t(this.copyHelper).css("opacity","1"),n||this.copyHelper.remove(),this.copyHelper=null,e.find(".app-container").removeClass("dragging")},over:function(t,n){e.find(".right-div .ui-sortable-placeholder").hide()}}),e.find(".search-query").on("keyup",function(){var r=t(this).val().toLowerCase(),i=e.find(".right-div .app-element");n.each(i,function(e){var n=t(e);n.data("search").toLowerCase().indexOf(r)<0?n.hide():n.show()})}),e.find(".search-query").on("blur",function(){t(this).val(""),e.find(".right-div .app-element").show()}),e.find(".right-div").on("mouseenter",".app-element",function(){a(t(this).data("id"))}),e.find(".right-div").on("mouseleave",".app-element",function(){a(e.find(".left-div .app-element").data("id"))}),e.on("click",".right-div .app-element, #launch_appstore, .default-app .app-element",function(){var n=t(this),u=n.data("name");u&&(u==="appstore"||!r.util.isMasquerading()||r.appsStore[u].masqueradable!==!1?(r.routing.goTo("apps/"+u),e.find(".right-div .app-element.active").removeClass("active"),u!=="appstore"&&n.addClass("active"),o.appListUpdate(e,s,function(e){s=e})):i.error(o.i18n.active().noMasqueradingError))}),e.find("#close_app").on("click",function(){o.appListUpdate(e,s,function(t){s=t,o._hide(e)})}),t(document).on("keydown",function(n){if(e.is(":visible")&&n.keyCode===27){var r=t(n.target);r.hasClass("search-query")?r.val(""):o.appListUpdate(e,s,function(t){s=t,o._hide(e)})}})},show:function(){var e=this,n=t("#apploader");n.hasClass("active")||(r.pub("myaccount.hide"),n.addClass("active").fadeIn(250,function(){t("#monster-content").hide()}))},_hide:function(){var e=this,n=t("#apploader");n.hasClass("active")&&(t("#monster-content").show(),n.removeClass("active").fadeOut(250,function(){if(e!==n.find(".right-div .app-element").first().data("id")){var e=n.find(".left-div .app-element").data("id");n.find(".right-div .app-list").prepend(n.find('.right-div .app-element[data-id="'+e+'"]'))}}))},_toggle:function(){var e=this;if(e.isRendered()){var n=t("#apploader");n.hasClass("active")?e._hide(n):(e.show(n),n.find(".search-query").focus())}else e.render()},_currentApp:function(e){var n=this,r=t("#apploader"),i=r.find(".right-div .app-element.active"),s={};i.length?(s={id:i.data("id"),name:i.data("name")},e&&e(s)):n.getUserApps(function(t){s={id:t[0].id,name:t[0].name},e&&e(s)})},getFullAppList:function(e){var t=this,i={};n.each(r.apps.auth.installedApps,function(e){i[e.id]=function(n){e.icon=t.apiUrl+"accounts/"+t.accountId+"/apps_store/"+e.id+"/icon?auth_token="+t.authToken,n&&n(null,e)}}),r.parallel(i,function(t,n){e&&e(n)})},getUserApps:function(e){var t=this;t.callApi({resource:"appsStore.list",data:{accountId:t.accountId},success:function(i,s){var o={},u=r.config.whitelabel.language,a=u.substr(0,3).concat(u.substr(u.length-2,2).toUpperCase());n.each(i.data,function(e){var n=e.i18n.hasOwnProperty(a)?a:"en-US";e.description=e.i18n[n].description,e.label=e.i18n[n].label,o[e.id]=function(n){e.icon=t.apiUrl+"accounts/"+t.accountId+"/apps_store/"+e.id+"/icon?auth_token="+t.authToken,n&&n(null,e)}}),r.parallel(o,function(i,s){var o=s,u=r.apps.auth.currentUser,a=u.appList||[],f=!1,l=[],c=function(e){if(e){var t=n.map(e.users||[],function(e){return e.id});if(e&&e.allowed_users&&(e.allowed_users==="all"||e.allowed_users==="admins"&&u.priv_level==="admin"||e.allowed_users==="specific"&&t.indexOf(u.id)>=0))return!0}return!1};a=n.filter(a,function(e){var t=o[e];return c(t)?(l.push({id:t.id,name:t.name,icon:t.icon,label:t.label,description:t.description}),!0):(f=!0,!1)}),n.each(o,function(e){a.indexOf(e.id)===-1&&c(e)&&(l.push({id:e.id,name:e.name,icon:e.icon,label:e.label,description:e.description}),a.push(e.id),f=!0)}),f&&(r.apps.auth.currentUser.appList=a,t.userUpdate()),e&&e(l)})}})},appListUpdate:function(e,n,i){var s=this,o=t.map(e.find(".right-div .app-element"),function(e){return t(e).data("id")}),u=n.every(function(e,t){return e.id===o[t]}),a=e.find(".left-div .app-element").data("id"),f=n.length?n[0].id===a:a===undefined;if(f&&u)i(n);else{var l=[];o.unshift(o.splice(o.indexOf(a),1)[0]),n.forEach(function(e,t){l[o.indexOf(e.id)]=e}),r.apps.auth.currentUser.appList=o,r.apps.auth.defaultApp=l[0].name,s.userUpdate(i(l))}},userUpdate:function(e){var t=this;t.callApi({resource:"user.update",data:{accountId:t.accountId,userId:t.userId,data:r.apps.auth.currentUser},success:function(t,n){e&&e()}})}};return s});