define("apps/callflows/app",["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={name:"callflows",css:["app","icons"],i18n:{"en-US":{customCss:!1}},requests:{},subscribe:{"callflows.fetchActions":"define_callflow_nodes"},subModules:["misc","conference","device","directory","faxbox","groups","media","menu","resource","timeofday","user","vmbox","featurecodes"],appFlags:{flow:{},appData:{},showSmartPBXCallflows:r.config.hasOwnProperty("developerFlags")&&r.config.developerFlags.showSmartPBXCallflows||r.apps.auth.originalAccount.superduper_admin},actions:{},categories:{},flow:{},load:function(e){var t=this;t.initApp(function(){e&&e(t)})},initApp:function(e){var t=this;r.pub("auth.initApp",{app:t,callback:e})},render:function(e){var i=this,s=n.isEmpty(e)?t("#monster-content"):e;r.pub("callflows.fetchActions",{actions:i.actions}),i.renderEntityManager(s)},renderCallflows:function(e){var n=this,i=t(r.template(n,"callflow-manager"));n.bindCallflowsEvents(i),n.repaintList({template:i,callback:function(){e.empty().append(i),e.find(".search-query").focus(),n.hackResize(i)}})},bindCallflowsEvents:function(e){var n=this,i=e.find(".list-container .list"),s=!1,o=t('<li class="content-centered list-loader"> <i class="fa fa-spinner fa-spin"></i></li>'),u=t(r.template(n,"callflowList-searchLink"));e.find(".list-add").on("click",function(){e.find(".callflow-content").removeClass("listing-mode").addClass("edition-mode"),n.editCallflow()}),i.on("click",".list-element",function(){var r=t(this),i=r.data("id");e.find(".callflow-content").removeClass("listing-mode").addClass("edition-mode"),n.editCallflow({id:i})}),i.on("scroll",function(){!s&&i.data("next-key")&&i.scrollTop()>=i[0].scrollHeight-i.innerHeight()-100&&(s=!0,i.append(o),n.listData({callback:function(e){var t=r.template(n,"callflowList",{callflows:e.data});o.remove(),i.append(t).data("next-key",e.next_start_key||null),s=!1},nextStartKey:i.data("next-key"),searchValue:i.data("search-value")}))}),e.find(".search-query").on("keyup",function(){var n=t(this).val();u.find(".search-value").text(n),n?(t.each(e.find(".list-element"),function(){var e=t(this);e.data("search").toLowerCase().indexOf(n.toLowerCase())>=0?e.show():e.hide()}),i.prepend(u)):(e.find(".list-element").show(),u.remove())}),i.on("click",".search-link",function(){if(u.hasClass("active"))i.data("search-value",null),u.removeClass("active").remove(),e.find(".search-query").prop("disabled",!1).val(""),n.repaintList({template:e});else{var t=u.find(".search-value").text();u.addClass("active").remove(),i.data("search-value",t),e.find(".search-query").prop("disabled",!0),n.repaintList({template:e,searchValue:t,callback:function(){i.prepend(u)}})}})},renderEntityManager:function(e){var i=this,s=n.indexBy(n.filter(i.actions,function(e){return e.hasOwnProperty("listEntities")}),"module"),o=t(r.template(i,"layout",{actions:s}));i.bindEntityManagerEvents({parent:e,template:o,actions:s}),e.empty().append(o)},bindEntityManagerEvents:function(e){var n=this,i=e.parent,s=e.template,o=e.actions,u=function(e,i){r.pub(o[e].editEntity,{data:i?{id:i}:{},parent:s,target:s.find(".entity-edition .entity-content"),callbacks:{after_render:function(){t(window).trigger("resize"),s.find(".entity-edition .callflow-content").animate({scrollTop:0})},save_success:function(t){n.refreshEntityList({template:s,actions:o,entityType:e}),u(e,t.id)},delete_success:function(t){n.refreshEntityList({template:s,actions:o,entityType:e}),s.find(".entity-edition .entity-content").empty()}}})};n.hackResize(s.find(".entity-edition")),s.find(".entity-manager .entity-element").on("click",function(){var e=t(this);if(e.hasClass("callflow-element"))n.renderCallflows(s.find(".callflow-edition")),s.find(".callflow-app-section").hide(),s.find(".callflow-edition").show();else if(e.hasClass("account-element"))n.renderAccountSettings(s.find(".callflow-edition")),s.find(".callflow-app-section").hide(),s.find(".callflow-edition").show();else if(e.hasClass("feature-code-element"))r.pub("callflows.featurecode.render",s.find(".callflow-edition")),s.find(".callflow-app-section").hide(),s.find(".callflow-edition").show();else{var i=e.data("type");s.find(".entity-edition .entity-header .entity-title").text(o[i].name),n.refreshEntityList({template:s,actions:o,entityType:i})}}),s.on("click",".entity-header .back-button",function(){s.find(".entity-edition .entity-content").empty(),s.find(".entity-edition .list-container .list").empty(),s.find(".entity-edition .search-query").val(""),s.find(".callflow-edition").empty(),s.find(".callflow-app-section").hide(),s.find(".entity-manager").show()}),s.find(".entity-edition .list-add").on("click",function(){var e=s.find(".entity-edition .list-container .list").data("type");u(e)}),s.find(".entity-edition .list-container .list").on("click",".list-element",function(){var e=t(this),n=e.data("id"),r=e.parents(".list").data("type");u(r,n)}),s.find(".entity-edition .search-query").on("keyup",function(){var e=t(this).val();e?t.each(s.find(".entity-edition .list-element"),function(){var n=t(this);n.data("search").toLowerCase().indexOf(e.toLowerCase())>=0?n.show():n.hide()}):s.find(".entity-edition .list-element").show()})},refreshEntityList:function(e){var n=this,i=e.template,s=e.actions,o=e.entityType,u=e.callbacks;s[o].listEntities(function(e){n.formatEntityData(e,o);var s=r.template(n,"entity-list",{entities:e});i.find(".entity-edition .list-container .list").empty().append(s).data("type",o),i.find(".callflow-app-section").hide(),i.find(".entity-edition").show(),i.find(".search-query").focus(),t(window).trigger("resize"),u&&u()})},formatEntityData:function(e,t){var r=this;n.each(e,function(e){e.first_name&&e.last_name?e.displayName=e.first_name+" "+e.last_name:e.name?e.displayName=e.name:e.displayName=e.id;switch(t){case"play":e.media_source&&(e.additionalInfo=r.i18n.active().callflows.media.mediaSources[e.media_source])}})},renderAccountSettings:function(e){var n=this,i="silence_stream://300000";n.loadAccountSettingsData(function(s){var o=t(r.template(n,"accountSettings",t.extend(!0,{silenceMedia:i},s)));o.find(".cid-number-select").chosen({search_contains:!0,width:"220px"}),e.empty().append(o),n.bindAccountSettingsEvents(o,s)})},bindAccountSettingsEvents:function(e,n){var i=this,s,o=function(t){s=undefined,e.find(".upload-div input").val(""),e.find(".upload-div").slideUp(function(){e.find(".upload-toggle").removeClass("active")});if(t){var n=e.find(".media-dropdown");n.append('<option value="'+t.id+'">'+t.name+"</option>"),n.val(t.id)}};e.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:i.i18n.active().callflows.accountSettings.musicOnHold.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){s=e[0]},error:function(t){t.hasOwnProperty("size")&&t.size.length>0&&r.ui.alert(i.i18n.active().callflows.accountSettings.musicOnHold.fileTooBigAlert),e.find(".upload-div input").val(""),s=undefined}}),e.find(".upload-toggle").on("click",function(){t(this).hasClass("active")?e.find(".upload-div").stop(!0,!0).slideUp():e.find(".upload-div").stop(!0,!0).slideDown()}),e.find(".upload-cancel").on("click",function(){o()}),e.find(".upload-submit").on("click",function(){s?i.callApi({resource:"media.create",data:{accountId:i.accountId,data:{streamable:!0,name:s.name,media_source:"upload",description:s.name}},success:function(e,t){var n=e.data;i.callApi({resource:"media.upload",data:{accountId:i.accountId,mediaId:n.id,data:s.file},success:function(e,t){o(n)},error:function(e,t){i.callApi({resource:"media.delete",data:{accountId:i.accountId,mediaId:n.id,data:{}},success:function(e,t){}})}})}}):r.ui.alert(i.i18n.active().callflows.accountSettings.musicOnHold.emptyUploadAlert)}),e.find(".account-settings-update").on("click",function(){var e=r.ui.getFormData("account_settings_form"),s=t.extend(!0,{},n.account,e);e.music_on_hold.media_id===""&&delete s.music_on_hold.media_id,e.caller_id.external.name===""&&delete s.caller_id.external.name,e.caller_id.external.number===""&&delete s.caller_id.external.number,i.callApi({resource:"account.update",data:{accountId:s.id,data:s},success:function(e,t){i.render()}})})},loadAccountSettingsData:function(e){var t=this;r.parallel({account:function(e){t.callApi({resource:"account.get",data:{accountId:t.accountId},success:function(t,n){e&&e(null,t.data)}})},mediaList:function(e){t.callApi({resource:"media.list",data:{accountId:t.accountId},success:function(t,n){e&&e(null,t.data)}})},numberList:function(e){t.callApi({resource:"numbers.list",data:{accountId:t.accountId},success:function(t,n){e&&e(null,t.data.numbers)}})}},function(t,n){e&&e(n)})},hackResize:function(e){var n=this;t(window).resize(function(n){var r=e.find(".list-container"),i=e.find(".callflow-content"),s=e.find(".tools"),o=e.find(".flowchart"),u=window.innerHeight-t("#main_topbar").outerHeight(),a=u+"px",f=u-71+"px";r.css("height",window.innerHeight-r.position().top+"px"),i.css("height",a),s.css("height",f),o.css("height",f)}),t(window).resize()},repaintList:function(e){var n=this,e=e||{},i=e.template||t("#callflow_container"),s=e.callback;n.listData({callback:function(e){var t=r.template(n,"callflowList",{callflows:e.data});i.find(".list-container .list").empty().append(t).data("next-key",e.next_start_key||null),s&&s(e.data)},searchValue:e.searchValue})},listData:function(e){var n=this,r=e.nextStartKey,i=e.searchValue,s=e.callback,o="callflow.list",u={accountId:n.accountId};r&&t.extend(!0,u,{filters:{start_key:encodeURIComponent(r)}}),n.appFlags.showSmartPBXCallflows||t.extend(!0,u,{filters:{"filter_not_ui_metadata.origin":"voip"}}),i&&(o="callflow.searchByNameAndNumber",u.value=i),n.callApi({resource:o,data:u,success:function(e){var t=n.formatData(e);s&&s(t)}})},listNumbers:function(e){var t=this;t.callApi({resource:"numbers.list",data:{accountId:t.accountId},success:function(n){n=t.formatListSpareNumbers(n.data.numbers),e&&e(n)}})},formatListSpareNumbers:function(e){var t=this,r=[];return n.each(e,function(e,t){e.hasOwnProperty("used_by")&&e.used_by===""&&(e.phoneNumber=t,r.push(e))}),r},formatData:function(e){var t=[];return n.each(e.data,function(e){var r=(e.numbers||"-").toString(),i=e.featurecode!==!1&&!n.isEmpty(e.featurecode);i||(e.name?(e.description=r,e.title=e.name):e.title=r,t.push(e))}),t.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),e.data=t,e},editCallflow:function(e){var n=this;delete n.original_flow,t("#callflow-view .callflow_help").hide(),n.resetFlow(),e&&e.id?n.callApi({resource:"callflow.get",data:{accountId:n.accountId,callflowId:e.id},success:function(e){var e=e.data;n.dataCallflow=e,n.flow.id=e.id,n.flow.name=e.name,n.flow.contact_list={exclude:"contact_list"in e?e.contact_list.exclude||!1:!1},n.flow.caption_map=e.metadata,e.flow.module!=undefined&&(n.flow.root=n.buildFlow(e.flow,n.flow.root,0,"_")),n.flow.numbers=e.numbers||[],n.repaintFlow()}}):(n.resetFlow(),n.dataCallflow={},n.repaintFlow()),n.renderButtons(),n.renderTools()},renderButtons:function(){var e=this,n=t(r.template(e,"buttons"));t(".buttons").empty(),t(".save",n).click(function(){e.flow.numbers&&e.flow.numbers.length>0?e.save():r.ui.alert(e.i18n.active().oldCallflows.invalid_number+"<br/><br/>"+e.i18n.active().oldCallflows.please_select_valid_number)}),t(".delete",n).click(function(){e.flow.id?r.ui.confirm(e.i18n.active().oldCallflows.are_you_sure,function(){e.callApi({resource:"callflow.delete",data:{accountId:e.accountId,callflowId:e.flow.id},success:function(){t("#ws_cf_flow").empty(),t(".buttons").empty(),t("#ws_cf_tools").empty(),t("#smartpbx_warning").hide(),e.repaintList(),e.resetFlow()}}),e.show_pending_change(!1)}):r.ui.alert(e.i18n.active().oldCallflows.this_callflow_has_not_been_created)}),t(".buttons").append(n)},buildFlow:function(e,n,r,i){var s=this,o=s.branch(s.construct_action(e));return o.data.data="data"in e?e.data:{},o.id=++r,o.key=i,o.caption=s.actions.hasOwnProperty(o.actionName)?s.actions[o.actionName].caption(o,s.flow.caption_map):"",s.actions.hasOwnProperty(n.actionName)&&s.actions[n.actionName].hasOwnProperty("key_caption")&&(o.key_caption=s.actions[n.actionName].key_caption(o,s.flow.caption_map)),t.each(e.children,function(e,t){o=s.buildFlow(t,o,r,e)}),n.addChild(o),n},construct_action:function(e){var t="";return"data"in e&&("id"in e.data&&(t="id=*,"),"action"in e.data&&(t+="action="+e.data.action+",")),t!=""?t="["+t.replace(/,$/,"]"):t="[]",e.module+t},resetFlow:function(){var e=this;e.flow={},e.flow.root=e.branch("root"),e.flow.root.key="flow",e.flow.numbers=[],e.flow.caption_map={},e.formatFlow()},formatFlow:function(){var e=this;e.flow.root.index(0),e.flow.nodes=e.flow.root.nodes()},branch:function(e){function r(e){var r=this,i=n.actions[e]||{};this.id=-1,this.actionName=e,this.module=i.module,this.key="_",this.parent=null,this.children=[],this.data={data:t.extend(!0,{},i.data)},this.caption="",this.key_caption="",this.potentialChildren=function(){var e=[];for(var t in n.actions)n.actions[t].isUsable&&(e[t]=t);for(var t in i.rules){var r=i.rules[t];switch(r.type){case"quantity":this.children.length>=r.maxSize&&(e=[])}}return e},this.contains=function(e){var t=e;while(t.parent){if(this.id==t.id)return!0;t=t.parent}return!1},this.removeChild=function(e){t.each(this.children,function(t,n){if(n.id==e.id)return r.children.splice(t,1),!1})},this.addChild=function(e){return e.actionName in this.potentialChildren()?e.contains(this)?!1:(e.parent&&e.parent.removeChild(e),e.parent=this,this.children.push(e),!0):!1},this.getMetadata=function(e){var t;return"data"in this.data&&e in this.data.data?(t=this.data.data[e],t=="null"?null:t):!1},this.setMetadata=function(e,t){"data"in this.data||(this.data.data={}),this.data.data[e]=t==null?"null":t},this.deleteMetadata=function(e){"data"in this.data&&e in this.data.data&&delete this.data.data[e]},this.index=function(e){return this.id=e,t.each(this.children,function(){e=this.index(e+1)}),e},this.nodes=function(){var e={};return e[this.id]=this,t.each(this.children,function(){var n=this.nodes();t.each(n,function(){e[this.id]=this})}),e},this.serialize=function(){var e=t.extend(!0,{},this.data);return e.module=this.module,e.children={},t.each(this.children,function(){e.children[this.key]=this.serialize()}),e}}var n=this;return new r(e)},repaintFlow:function(){var e=this;e.flow.savable=!0;var n=t("#ws_cf_flow").empty();n.append(this.getUIFlow());var r=e.stringify_flow(e.flow);"original_flow"in e&&e.original_flow.split("|")[0]===r.split("|")[0]?e.show_pending_change(e.original_flow!==r):(e.original_flow=r,e.show_pending_change(!1));var i=e.dataCallflow.hasOwnProperty("ui_metadata")?e.dataCallflow.ui_metadata:!1,s=i&&i.hasOwnProperty("origin")&&i.origin==="voip";s?t("#smartpbx_warning").show():t("#smartpbx_warning").hide()},show_pending_change:function(e){var n=this;e?(t("#pending_change","#ws_callflow").show(),t(".save","#ws_callflow").addClass("pulse-box")):(t("#pending_change","#ws_callflow").hide(),t(".save","#ws_callflow").removeClass("pulse-box"))},stringify_flow:function(e){var n=e.id+"|"+(e.name?e.name:"undefined"),r;return n+="|NUMBERS",t.each(e.numbers,function(e,t){n+="|"+t}),n+="|NODES",t.each(e.nodes,function(e,i){n+="|"+e+"::",r=!0,t.each(i.data.data,function(e,t){r?r=!1:n+="//",n+=e+":"+t})}),n},getUIFlow:function(){var e=this;e.formatFlow();var i=e.renderBranch(e.flow.root);return t(".node",i).hover(function(){t(this).addClass("over")},function(){t(this).removeClass("over")}),t(".node",i).each(function(){var s=e.flow.nodes[t(this).attr("id")],o=t(this),u;if(s.actionName=="root"){o.removeClass("icons_black root"),u=t(r.template(e,"root",{name:e.flow.name||"Callflow"})),t(".edit_icon",u).click(function(){e.flow=t.extend(!0,{contact_list:{exclude:!1}},e.flow);var n=r.template(e,"editName",{name:e.flow.name,exclude:e.flow.contact_list.exclude,ui_is_main_number_cf:e.dataCallflow.hasOwnProperty("ui_is_main_number_cf")?e.dataCallflow.ui_is_main_number_cf:!1}),s=r.ui.dialog(n,{title:e.i18n.active().oldCallflows.popup_title});t("#add",s).click(function(){var n=t("#callflow_name",s);n.val()!=""?(e.flow.name=n.val(),t(".root .top_bar .name",i).html(e.flow.name)):(e.flow.name="",t(".root .top_bar .name",i).html("Callflow")),e.flow.contact_list={exclude:t("#callflow_exclude",s).prop("checked")},e.dataCallflow.ui_is_main_number_cf=t("#ui_is_main_number_cf",s).prop("checked"),e.repaintFlow(),s.dialog("close")})}),t(".tooltip",u).click(function(){r.ui.dialog(r.template(e,"help_callflow"))});for(var a,f=e.flow.numbers.length,l=Math.floor(f/2)+1,c=0;c<l;c++){a=c*2;var h=e.flow.numbers.slice(a,a+2<f?a+2:f),p=r.template(e,"rowNumber",{numbers:h});u.find(".content").append(p)}t(".number_column.empty",u).click(function(){e.listNumbers(function(i){var s=[];n.each(i,function(n){t.inArray(n.phoneNumber,e.flow.numbers)<0&&s.push(n)});var o=t(r.template(e,"addNumber",{phoneNumbers:s})),u=r.ui.dialog(o,{title:e.i18n.active().oldCallflows.add_number});s.length===0&&(t("#list_numbers",o).attr("disabled","disabled"),t('<option value="select_none">'+e.i18n.active().oldCallflows.no_phone_numbers+"</option>").appendTo(t("#list_numbers",o)));var a=function(){e.listNumbers(function(n){t("#list_numbers",u).empty(),n.length===0?(t("#list_numbers",u).attr("disabled","disabled"),t('<option value="select_none">'+e.i18n.active().oldCallflows.no_phone_numbers+"</option>").appendTo(t("#list_numbers",u))):(t("#list_numbers",u).removeAttr("disabled"),t.each(n,function(e,n){t('<option value="'+n+'">'+n+"</option>").appendTo(t("#list_numbers",u))}))})};t(".extensions_content",u).hide(),t('input[name="number_type"]',u).click(function(){t(this).val()==="your_numbers"?(t(".list_numbers_content",u).show(),t(".extensions_content",u).hide()):(t(".extensions_content",u).show(),t(".list_numbers_content",u).hide())}),u.find(".buy-link").on("click",function(e){e.preventDefault(),r.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){n.each(e,function(e,n){t('<option value="'+n+'">'+n+"</option>").appendTo(t("#list_numbers",u))})}}})}),t(".add_number",u).click(function(n){n.preventDefault();var i=t('input[name="number_type"]:checked',u).val()==="your_numbers"?t("#list_numbers option:selected",u).val():t("#add_number_text",u).val();i!=="select_none"&&i!==""?(e.flow.numbers.push(i),u.dialog("close"),e.repaintFlow()):r.ui.alert(e.i18n.active().oldCallflows.you_didnt_select)})})}),t(".number_column .delete",u).click(function(){var n=t(this).parent(".number_column").data("number")+"",r=t.inArray(n,e.flow.numbers);r>=0&&e.flow.numbers.splice(r,1),e.repaintFlow()})}else u=t(r.template(e,"node",{node:s,callflow:e.actions[s.actionName]})),t(".module",u).click(function(){e.actions[s.actionName].edit(s,function(){e.repaintFlow()})});t(this).append(u),t(this).droppable({drop:function(n,r){var i=e.flow.nodes[t(this).attr("id")],s;r.draggable.hasClass("action")&&(s=r.draggable.attr("name"),o=e.branch(s),o.caption=e.actions[s].caption(o,e.flow.caption_map),i.addChild(o)&&(o.parent&&"key_caption"in e.actions[o.parent.actionName]?(o.key_caption=e.actions[o.parent.actionName].key_caption(o,e.flow.caption_map),e.actions[o.parent.actionName].key_edit(o,function(){e.actions[s].edit(o,function(){e.repaintFlow()})})):e.actions[s].edit(o,function(){e.repaintFlow()}),e.repaintFlow()));if(r.draggable.hasClass("node")){var o=e.flow.nodes[r.draggable.attr("id")];i.addChild(o)&&(o.key="_",o.parent&&"key_caption"in e.actions[o.parent.actionName]&&(o.key_caption=e.actions[o.parent.actionName].key_caption(o,e.flow.caption_map)),r.draggable.remove(),e.repaintFlow())}}}),t(this).attr("name")!="root"&&t(this).draggable({start:function(){var n=t(this).next(),r=n.offset().top-t(this).offset().top,i=n.offset().left-t(this).offset().left;e.enableDestinations(t(this)),t(this).attr("t",r),t(this).attr("l",i)},drag:function(){var e=t(this).next(),n=t(this).offset().top+parseInt(t(this).attr("t")),r=t(this).offset().left+parseInt(t(this).attr("l"));e.offset({top:n,left:r})},stop:function(){e.disableDestinations(),e.repaintFlow()}})}),t(".node-options .delete",i).click(function(){var n=e.flow.nodes[t(this).attr("id")];n.parent&&(n.parent.removeChild(n),e.repaintFlow())}),i},renderBranch:function(e){var n=this,i=t(r.template(n,"branch",{node:e,display_key:e.parent&&"key_caption"in n.actions[e.parent.actionName]})),s;return e.parent&&"key_edit"in n.actions[e.parent.actionName]&&t(".div_option",i).click(function(){n.actions[e.parent.actionName].key_edit(e,function(){n.repaintFlow()})}),s=t(".children",i),t.each(e.children,function(){s.append(n.renderBranch(this))}),i},renderTools:function(){function l(n){n.draggable({start:function(){e.enableDestinations(t(this)),t(this).addClass("inactive")},drag:function(){t(".callflow_helpbox_wrapper","#callflow-view").hide()},stop:function(){e.disableDestinations(),t(this).removeClass("inactive")},containment:t("body"),helper:"clone"})}var e=this,n=e.i18n.active().oldCallflows.advanced_cat,i=e.i18n.active().oldCallflows.basic_cat,s={categories:[]},o={},u,a;o[i]=[],o[n]=[],t.each(e.actions,function(e,t){"category"in t&&(t.category in o?!0:o[t.category]=[],t.key=e,o[t.category].push(t))}),t.each(o,function(e,t){e!==i&&e!==n&&s.categories.push({key:e,actions:t})}),s.categories.sort(function(e,t){return e.key<t.key?1:-1}),s.categories.unshift({key:i,actions:o[i]},{key:n,actions:o[n]}),t.each(o,function(e,t){t.sort(function(e,t){if(e.hasOwnProperty("weight"))return e.weight>t.weight?1:-1})}),a=t(r.template(e,"tools",s)),t(".tooltip",a).click(function(){r.ui.dialog(r.template(e,"help_callflow"))}),t("#Basic",a).removeClass("inactive").addClass("active"),t(".category .open",a).click(function(){a.find(".category").removeClass("active").addClass("inactive"),t(this).parent(".category").removeClass("inactive").addClass("active")});var f=t(".callflow_helpbox_wrapper","#callflow-view").first();t(".tool",a).hover(function(){t(this).addClass("active"),t(".tool_name","#callflow-view").removeClass("active"),t(".tool_name",t(this)).addClass("active"),t(this).attr("help")&&(t("#help_box",f).html(t(this).attr("help")),t(".callflow_helpbox_wrapper","#callflow-view").css("top",t(this).offset().top-72).show())},function(){t(this).removeClass("active"),t(".callflow_helpbox_wrapper","#callflow-view").hide()}),t(".action",a).each(function(){l(t(this))}),u=t("#ws_cf_tools").empty(),u.append(a),t("#ws_cf_tools","#callflow-view").disableSelection()},enableDestinations:function(e){var n=this;t(".node").each(function(){var r=!0,i=n.flow.nodes[t(this).attr("id")];e.attr("name")in i.potentialChildren()?e.hasClass("node")&&n.flow.nodes[e.attr("id")].contains(i)&&(r=!1):r=!1,r?t(this).addClass("active"):(t(this).addClass("inactive"),t(this).droppable("disable"))})},disableDestinations:function(){t(".node").each(function(){t(this).removeClass("active"),t(this).removeClass("inactive"),t(this).droppable("enable")}),t(".tool").removeClass("active")},save:function(){var e=this;if(e.flow.numbers&&e.flow.numbers.length>0){var n={numbers:e.flow.numbers,flow:e.flow.root.children[0]==undefined?{}:e.flow.root.children[0].serialize()};e.flow.name!==""?n.name=e.flow.name:(delete n.name,delete e.dataCallflow.name),"contact_list"in e.flow&&(n.contact_list={exclude:e.flow.contact_list.exclude||!1}),e.dataCallflow.flow=n.flow,n=t.extend(!0,{},e.dataCallflow,n),delete n.metadata,e.flow.id?e.callApi({resource:"callflow.update",data:{accountId:e.accountId,callflowId:e.flow.id,data:n},success:function(t){e.repaintList(),e.editCallflow({id:t.data.id})}}):e.callApi({resource:"callflow.create",data:{accountId:e.accountId,data:n},success:function(t){e.repaintList(),e.editCallflow({id:t.data.id})}})}else r.ui.alert(e.i18n.active().oldCallflows.you_need_to_select_a_number)},winkstartTabs:function(e,n){var i=e.find(".view-buttons"),s=e.find(".tabs");n?(i.find(".btn").removeClass("activate"),i.find(".advanced").addClass("activate")):r.config.advancedView?(i.find(".btn").removeClass("activate"),i.find(".advanced").addClass("activate")):s.hide("blind"),s.find("li").length<2&&i.hide(),i.find(".basic").on("click",function(){var e=t(this);e.hasClass("activate")||(i.find(".btn").removeClass("activate"),e.addClass("activate"),s.find("li:first-child > a").trigger("click"),s.hide("blind"))}),i.find(".advanced").click(function(){var e=t(this);e.hasClass("activate")||(i.find(".btn").removeClass("activate"),e.addClass("activate"),s.show("blind"))}),s.find("li").on("click",function(n){n.preventDefault();var r=t(this),i=r.find("a").attr("href");s.find("li").removeClass("active"),e.find(".pill-content >").removeClass("active"),r.addClass("active"),e.find(i).addClass("active")})},winkstartLinkForm:function(e){t("input",e).bind("change.link keyup.link focus.link",function(){var n=t(this),r=n.attr("name"),i=n.attr("type"),s=n.val(),o=n.attr("id"),u=t('input[name="'+r+'"]',e);u.size()>1?i=="checkbox"?(u=u.filter("[value="+s+"]"),n.attr("checked")?u.attr("checked","checked"):u.removeAttr("checked")):t.each(u,function(e,n){var r=t(n);r.attr("id")!==o&&r.val(s)}):n.unbind(".link")})}};return i});