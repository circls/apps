define(["require","jquery","underscore","monster","monster-timezone"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("monster-timezone"),s={requests:{},subscribe:{"callflows.fetchActions":"userDefineActions","callflows.user.popupEdit":"userPopupEdit","callflows.user.edit":"userEdit"},random_id:!1,userDefineActions:function(e){var n=this,i=e.actions;t.extend(i,{"user[id=*]":{name:n.i18n.active().callflows.user.user,icon:"user",category:n.i18n.active().oldCallflows.basic_cat,module:"user",tip:n.i18n.active().callflows.user.user_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:40,caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,i){n.userList(function(s){var o,u;t.each(s,function(){this.name=this.first_name+" "+this.last_name}),u=t(r.template(n,"user-callflowEdit",{can_call_self:e.getMetadata("can_call_self")||!1,parameter:{name:"timeout (s)",value:e.getMetadata("timeout")||"20"},objects:{items:r.util.sort(s),selected:e.getMetadata("id")||""}})),t("#user_selector option:selected",u).val()==undefined&&t("#edit_link",u).hide(),t(".inline_action",u).click(function(r){var i=t(this).data("action")=="edit"?{id:t("#user_selector",u).val()}:{};r.preventDefault(),n.userPopupEdit({data:i,callback:function(n){e.setMetadata("id",n.id||"null"),e.setMetadata("timeout",t("#parameter_input",u).val()),e.setMetadata("can_call_self",t("#user_can_call_self",u).is(":checked")),e.caption=(n.first_name||"")+" "+(n.last_name||""),o.dialog("close")}})}),t("#add",u).click(function(){e.setMetadata("id",t("#user_selector",u).val()),e.setMetadata("timeout",t("#parameter_input",u).val()),e.setMetadata("can_call_self",t("#user_can_call_self",u).is(":checked")),e.caption=t("#user_selector option:selected",u).text(),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.user.select_user,beforeClose:function(){typeof i=="function"&&i()}})})},listEntities:function(e){n.callApi({resource:"user.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},editEntity:"callflows.user.edit"},"hotdesk[action=login]":{name:n.i18n.active().callflows.user.hot_desk_login,icon:"hotdesk_login",category:n.i18n.active().callflows.user.hotdesking_cat,module:"hotdesk",tip:n.i18n.active().callflows.user.hot_desk_login_tip,data:{action:"login"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"hotdesk[action=logout]":{name:n.i18n.active().callflows.user.hot_desk_logout,icon:"hotdesk_logout",category:n.i18n.active().callflows.user.hotdesking_cat,module:"hotdesk",tip:n.i18n.active().callflows.user.hot_desk_logout_tip,data:{action:"logout"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"hotdesk[action=toggle]":{name:n.i18n.active().callflows.user.hot_desk_toggle,icon:"hotdesk_toggle",category:n.i18n.active().callflows.user.hotdesking_cat,module:"hotdesk",tip:n.i18n.active().callflows.user.hot_desk_toggle_tip,data:{action:"toggle"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}}})},userPopupEdit:function(e){var n=this,i=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),s,o=e.data,u=e.callback,a=e.data_defaults;i.css({height:500,"overflow-y":"scroll"}),n.userEdit({data:o,parent:i,target:t(".inline_content",i),callbacks:{save_success:function(e){s.dialog("close"),typeof u=="function"&&u(e)},delete_success:function(){s.dialog("close"),typeof u=="function"&&u({data:{}})},after_render:function(){s=r.ui.dialog(i,{title:o.id?n.i18n.active().callflows.user.edit_user:n.i18n.active().callflows.user.create_user})}},data_defaults:a})},userEdit:function(e){var n=this,i=e.data,s=e.parent||t("#user-content"),o=e.target||t("#user-view",s),u=e.callbacks||{},a={save_success:u.save_success||function(e){n.userRenderList(s),n.userEdit({data:{id:e.data.id},parent:s,target:o,callbacks:a})},save_error:u.save_error,delete_success:u.delete_success||function(){o.empty(),n.userRenderList(s)},delete_error:u.delete_error,after_render:u.after_render},f={data:t.extend(!0,{apps:{},call_forward:{substitute:!0},call_restriction:{closed_groups:{action:"inherit"}},caller_id:{internal:{},external:{},emergency:{}},hotdesk:{},contact_list:{exclude:!1},priv_level:"user",music_on_hold:{},timezone:"inherit"},e.data_defaults||{}),field_data:{device_types:{sip_device:n.i18n.active().callflows.user.sip_device_type,cellphone:n.i18n.active().callflows.user.cell_phone_type,fax:n.i18n.active().callflows.user.fax_type,smartphone:n.i18n.active().callflows.user.smartphone_type,landline:n.i18n.active().callflows.user.landline_type,softphone:n.i18n.active().callflows.user.softphone_type,sip_uri:n.i18n.active().callflows.user.sip_uri_type},call_restriction:{}}};n.random_id=!1,r.parallel({list_classifiers:function(e){n.callApi({resource:"numbers.listClassifiers",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(n,r){"data"in n&&t.each(n.data,function(e,t){f.field_data.call_restriction[e]={friendly_name:t.friendly_name},f.data.call_restriction[e]={action:"inherit"}}),e(null,n)}})},media_list:function(e){n.callApi({resource:"media.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,r){t.data&&t.data.unshift({id:"",name:n.i18n.active().callflows.user.default_music},{id:"silence_stream://300000",name:n.i18n.active().callflows.user.silence}),f.field_data.media=t.data,e(null,t)}})},user_get:function(e){typeof i=="object"&&i.id?n.userGet(i.id,function(t,r){n.userMigrateData(t),e(null,t)}):(n.random_id=t.md5(r.util.randomString(10)+(new Date).toString()),f.field_data.new_user=n.random_id,e(null,f))},user_hotdesks:function(e){typeof i=="object"&&i.id?n.callApi({resource:"user.hotdesks",data:{accountId:n.accountId,userId:i.id},success:function(n){f.field_data.hotdesk_enabled=!0,f.field_data.device_list={},t.each(n.data,function(e,t){f.field_data.device_list[t.device_id]={name:t.device_name}}),t.isEmptyObject(f.field_data.device_list)&&delete f.field_data.device_list,e(null,n)},error:function(t,n){e(null,f)}}):e(null,f)}},function(e,r){var s=f;typeof i=="object"&&i.id&&(t.each(r.user_get.call_restriction,function(e,t){f.field_data.call_restriction.hasOwnProperty(e)&&(f.field_data.call_restriction[e].action=t.action)}),s=t.extend(!0,f,{data:r.user_get})),n.userRender(s,o,a),typeof a.after_render=="function"&&a.after_render()})},userRender:function(e,n,s){var o=this,u=t(r.template(o,"user-edit",e)),a=u.find("#user-form"),f,l=t(".hotdesk_pin",u),c=t("#hotdesk_require_pin",u);o.userRenderDeviceList(e,u),r.ui.validate(a,{rules:{username:{required:!0,minlength:3,regex:/^[0-9a-zA-Z+@._-]*$/},first_name:{required:!0,minlength:1,maxlength:256,regex:/^[0-9a-zA-Z\s\-\']+$/},last_name:{required:!0,minlength:1,maxlength:256,regex:/^[0-9a-zA-Z\s\-\']+$/},email:{required:!0,email:!0},pwd_mngt_pwd1:{required:!0,minlength:3},pwd_mngt_pwd2:{required:!0,minlength:3,equalTo:"#pwd_mngt_pwd1"},"hotdesk.pin":{regex:/^[0-9]*$/},"hotdesk.id":{regex:/^[0-9\+\#\*]*$/},call_forward_number:{regex:/^[\+]?[0-9]*$/},"caller_id.internal.name":{regex:/^[0-9A-Za-z ,]{0,30}$/},"caller_id.external.name":{regex:/^[0-9A-Za-z ,]{0,30}$/},"caller_id.internal.number":{regex:/^[\+]?[0-9\s\-\.\(\)]*$/},"caller_id.external.number":{regex:/^[\+]?[0-9\s\-\.\(\)]*$/},"caller_id.emergency.name":{regex:/^[0-9A-Za-z ,]{0,30}$/},"caller_id.emergency.number":{regex:/^[\+]?[0-9\s\-\.\(\)]*$/}},messages:{username:{regex:o.i18n.active().callflows.user.validation.username},first_name:{regex:o.i18n.active().callflows.user.validation.name},last_name:{regex:o.i18n.active().callflows.user.validation.name},"hotdesk.pin":{regex:o.i18n.active().callflows.user.validation.hotdesk.pin},"hotdesk.id":{regex:o.i18n.active().callflows.user.validation.hotdesk.id},"caller_id.internal.name":{regex:o.i18n.active().callflows.user.validation.caller_id.name},"caller_id.external.name":{regex:o.i18n.active().callflows.user.validation.caller_id.name},"caller_id.emergency.name":{regex:o.i18n.active().callflows.user.validation.caller_id.name},"caller_id.internal.number":{regex:o.i18n.active().callflows.user.validation.caller_id.number},"caller_id.external.number":{regex:o.i18n.active().callflows.user.validation.caller_id.number},"caller_id.emergency.number":{regex:o.i18n.active().callflows.user.validation.caller_id.number}}}),i.populateDropdown(t("#timezone",u),e.data.timezone||"inherit",{inherit:o.i18n.active().defaultTimezone}),e.data.id===r.apps.auth.userId&&t(".user-delete",u).hide(),t('*[rel=popover]:not([type="text"])',u).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',u).popover({trigger:"focus"}),o.winkstartTabs(u),o.winkstartLinkForm(u),c.is(":checked")?l.show():l.hide(),c.change(function(){t(this).is(":checked")?l.show("blind"):l.hide("blind")}),t(".user-save",u).click(function(n){n.preventDefault();if(r.ui.valid(a)){var i=r.ui.getFormData("user-form");i.enable_pin===!1&&(delete e.data.queue_pin,delete e.data.record_call),o.userCleanFormData(i),"field_data"in e&&delete e.field_data,o.callApi({resource:"account.get",data:{accountId:o.accountId},success:function(n,u){i.priv_level=="admin"?(i.apps=i.apps||{},!("voip"in i.apps)&&t.inArray("voip",n.data.available_apps||[])>-1&&(i.apps.voip={label:o.i18n.active().callflows.user.voip_services_label,icon:"device",api_url:r.config.api.default})):i.priv_level=="user"&&t.inArray("userportal",n.data.available_apps||[])>-1&&(i.apps=i.apps||{},"userportal"in i.apps||(i.apps.userportal={label:o.i18n.active().callflows.user.user_portal_label,icon:"userportal",api_url:r.config.api.default})),o.userSave(i,e,function(e,t,n){n=="create"?o.userAcquireDevice(e,function(){typeof s.save_success=="function"&&s.save_success(e,t,n)},function(){typeof s.save_error=="function"&&s.save_error(e,t,n)}):typeof s.save_success=="function"&&s.save_success(e,t,n)})}})}else r.ui.alert(o.i18n.active().callflows.user.there_were_errors_on_the_form)}),t(".user-delete",u).click(function(t){t.preventDefault(),r.ui.confirm(o.i18n.active().callflows.user.are_you_sure_you_want_to_delete,function(){o.userDelete(e.data.id,s.delete_success,s.delete_error)})}),t("#music_on_hold_media_id",u).val()||t("#edit_link_media",u).hide(),t("#music_on_hold_media_id",u).change(function(){t("#music_on_hold_media_id option:selected",u).val()?t("#edit_link_media",u).show():t("#edit_link_media",u).hide()}),t(".inline_action_media",u).click(function(e){var n=t(this).data("action")=="edit"?{id:t("#music_on_hold_media_id",u).val()}:{},i=n.id;e.preventDefault(),r.pub("callflows.media.editPopup",{data:n,callback:function(e){i?e.hasOwnProperty("id")?t("#music_on_hold_media_id #"+e.id,u).text(e.name):(t("#music_on_hold_media_id #"+i,u).remove(),t("#edit_link_media",u).hide()):(t("#music_on_hold_media_id",u).append('<option id="'+e.id+'" value="'+e.id+'">'+e.name+"</option>"),t("#music_on_hold_media_id",u).val(e.id),t("#edit_link_media",u).show())}})}),t(u).delegate(".enabled_checkbox","click",function(){o.userUpdateSingleDevice(t(this),u)}),t(u).delegate(".action_device.edit","click",function(){var n={id:t(this).data("id"),hide_owner:e.data.id?!1:!0},i={};e.data.id?i.owner_id=e.data.id:i.new_user=o.random_id,r.pub("callflows.device.popupEdit",{data:n,callback:function(t){f={data:{},field_data:{device_types:e.field_data.device_types}},f.data=t.data.new_user?{new_user:!0,id:o.random_id}:{id:e.data.id},o.userRenderDeviceList(f,u)},data_defaults:i})}),t(u).delegate(".action_device.delete","click",function(){var n=t(this).data("id");r.ui.confirm(o.i18n.active().callflows.user.do_you_really_want_to_delete,function(){o.userDeleteDevice(n,function(){f={data:{},field_data:{device_types:e.field_data.device_types}},f.data=o.random_id?{new_user:!0,id:o.random_id}:{id:e.data.id},o.userRenderDeviceList(f,u)})})}),t(".add_device",u).click(function(t){var n={hide_owner:!0},i={};t.preventDefault(),e.data.id?i.owner_id=e.data.id:i.new_user=o.random_id,r.pub("callflows.device.popupEdit",{data:n,callback:function(t){var n={data:{},field_data:{device_types:e.field_data.device_types}};n.data=o.random_id?{new_user:!0,id:o.random_id}:{id:e.data.id},o.userRenderDeviceList(n,u)},data_defaults:i})}),n.empty().append(u)},userRenderList:function(e,n){var r=this;r.userList(function(e,r){var i=function(e){var n=[];return e.length>0&&t.each(e,function(e,t){n.push({id:t.id,title:t.first_name&&t.last_name?t.last_name+", "+t.first_name:"(no name)"})}),n.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),n};n&&n()})},userRenderDeviceList:function(e,n){var i=this,n=t("#tab_devices",n);if(e.data.id){var s=e.data.new_user?{filter_new_user:e.data.id}:{filter_owner_id:e.data.id};i.userListDevice(s,function(s,o){t(".rows",n).empty(),s.length>0?(t.each(s,function(s,o){o.display_type=e.field_data.device_types[o.device_type],o.not_enabled=this.enabled===!1?!0:!1,t(".rows",n).append(t(r.template(i,"user-deviceRow",o)))}),i.callApi({resource:"device.getStatus",data:{accountId:i.accountId},success:function(e,r){t.each(e.data,function(e,r){t("#"+r.device_id+" .column.third",n).addClass("registered")})}})):t(".rows",n).append(t(r.template(i,"user-deviceRow")))})}else t(".rows",n).empty().append(t(r.template(i,"user-deviceRow")))},userMigrateData:function(e){return"priv_level"in e||("apps"in e&&"voip"in e.apps?e.priv_level="admin":e.priv_level="user"),e},userUpdateSingleDevice:function(e,n){e.attr("disabled","disabled");var r=this,i=e.data("device_id"),s=e.is(":checked");r.userGetDevice(i,function(o){t.inArray(o.device_type,["cellphone","smartphone","landline"])>-1&&(o.call_forward.enabled=s),o.enabled=s,r.userUpdateDevice(i,o,function(r){e.removeAttr("disabled"),r.enabled===!0?t("#"+r.id+" .column.third",n).removeClass("disabled"):t("#"+r.id+" .column.third",n).addClass("disabled")},function(){e.removeAttr("disabled"),s?e.removeAttr("checked"):e.attr("checked","checked")})},function(){e.removeAttr("disabled"),s?e.removeAttr("checked"):e.attr("checked","checked")})},userAcquireDevice:function(e,n,r){var i=this,s=e.id;i.random_id?i.userListDevice({filter_new_user:i.random_id},function(e,r){var o,u=e.length;u!=0?t.each(e,function(e,t){o=this.id,i.userGetDevice(o,function(t,r){t.owner_id=s,delete t.new_user,i.userUpdateDevice(o,t,function(t,r){e==u-1&&n({},r,"create")})})}):n({},r,"create")}):n({},status,"create")},userCleanFormData:function(e){return e.caller_id.internal.number=e.caller_id.internal.number.replace(/\s|\(|\)|\-|\./g,""),e.caller_id.external.number=e.caller_id.external.number.replace(/\s|\(|\)|\-|\./g,""),e.caller_id.emergency.number=e.caller_id.emergency.number.replace(/\s|\(|\)|\-|\./g,""),e.call_restriction.closed_groups={action:e.extra.closed_groups?"deny":"inherit"},e.hotdesk.require_pin||delete e.hotdesk.pin,e.pwd_mngt_pwd1!="fakePassword"&&(e.password=e.pwd_mngt_pwd1),delete e.pwd_mngt_pwd1,delete e.pwd_mngt_pwd2,delete e.extra,e},userSave:function(e,n,r,i){var s=this,o=s.userNormalizeData(t.extend(!0,{},n.data,e));typeof n.data=="object"&&n.data.id?s.userUpdate(o,function(e,t){typeof r=="function"&&r(e,t,"update")},function(e,t){typeof i=="function"&&i(e,t,"update")}):s.userCreate(o,function(e,t){typeof r=="function"&&r(e,t,"create")},function(e,t){typeof i=="function"&&i(e,t,"create")})},userNormalizeData:function(e){t.isArray(e.directories)&&(e.directories={}),t.each(e.caller_id,function(n,r){t.each(r,function(e,t){t==""&&delete r[e]}),t.isEmptyObject(r)&&delete e.caller_id[n]}),t.isEmptyObject(e.caller_id)&&delete e.caller_id,e.music_on_hold.media_id||delete e.music_on_hold.media_id,e.hotdesk.hasOwnProperty("enable")&&delete e.hotdesk.enable;if(e.hotdesk.hasOwnProperty("log_out")){var n=[];t.each(e.hotdesk.endpoint_ids,function(t,r){e.hotdesk.log_out.indexOf(r)<0&&n.push(r)}),e.hotdesk.endpoint_ids=n,delete e.hotdesk.log_out}return e.hotdesk.hasOwnProperty("endpoint_ids")&&e.hotdesk.endpoint_ids.length===0&&delete e.hotdesk.endpoint_ids,e.hasOwnProperty("call_forward")&&e.call_forward.number===""&&delete e.call_forward.number,e.hasOwnProperty("presence_id")&&e.presence_id===""&&delete e.presence_id,e.timezone&&e.timezone==="inherit"&&delete e.timezone,e},userList:function(e){var t=this;t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},userGet:function(e,t){var n=this;n.callApi({resource:"user.get",data:{accountId:n.accountId,userId:e},success:function(e){t&&t(e.data)}})},userCreate:function(e,t){var n=this;n.callApi({resource:"user.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},userUpdate:function(e,t){var n=this;n.callApi({resource:"user.update",data:{accountId:n.accountId,userId:e.id,data:e},success:function(e){t&&t(e.data)}})},userDelete:function(e,t,n){var r=this;r.callApi({resource:"user.delete",data:{accountId:r.accountId,userId:e},success:function(e){t&&t(e.data)},error:function(e){n&&n()}})},userListDevice:function(e,n){var r=this,i=t.extend(!0,e,{paginate:!1});r.callApi({resource:"device.list",data:{accountId:r.accountId,filters:i},success:function(e){n&&n(e.data)}})},userGetDevice:function(e,t,n){var r=this;r.callApi({resource:"device.get",data:{accountId:r.accountId,deviceId:e},success:function(e){t&&t(e.data)},error:function(e){n&&n()}})},userUpdateDevice:function(e,t,n,r){var i=this;i.callApi({resource:"device.update",data:{accountId:i.accountId,deviceId:e,data:t},success:function(e){n&&n(e.data)},error:function(){r&&r()}})},userDeleteDevice:function(e,t){var n=this;n.callApi({resource:"device.delete",data:{accountId:n.accountId,deviceId:e},success:function(){t&&t()}})}};return s});