define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"callflows.fetchActions":"groupsDefineActions"},groupsDefineActions:function(e){var n=this,r=e.actions;t.extend(r,{"ring_group[]":{name:n.i18n.active().oldCallflows.ring_group,icon:"ring_group",category:n.i18n.active().oldCallflows.basic_cat,module:"ring_group",tip:n.i18n.active().oldCallflows.ring_group_tip,data:{name:""},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return e.getMetadata("name")||""},edit:function(e,t){n.groupsEditRingGroup(e,t)}},"page_group[]":{name:n.i18n.active().oldCallflows.page_group,icon:"ring_group",category:n.i18n.active().oldCallflows.advanced_cat,module:"page_group",tip:n.i18n.active().oldCallflows.page_group_tip,data:{name:""},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return e.getMetadata("name")||""},edit:function(e,t){n.groupsEditPageGroup(e,t)}}})},groupsEditPageGroup:function(e,n){var i=this;i.groupsDeviceList(function(s){var o,u,a,f,l={},c=[],h=[],p=[],d=[];(f=e.getMetadata("endpoints"))&&t.each(t.extend(!0,{},f),function(e,t){t.name="Undefined Device",l[t.id]=t}),t.each(s,function(e,t){t.endpoint_type="device",t.id in l?(l[t.id].endpoint_type="device",l[t.id].owner_id=t.owner_id,l[t.id].name=t.name):p.push(t)}),p=r.util.sort(p),i.groupsGroupList(function(s){t.each(s,function(e,t){t.endpoint_type="group",t.id in l?(l[t.id].endpoint_type="group",l[t.id].name=t.name):h.push(t)}),h=r.util.sort(h),i.groupsUserList(function(s){t.each(s,function(e,t){t.name=t.first_name+" "+t.last_name,t.endpoint_type="user",t.id in l?(l[t.id].endpoint_type="user",l[t.id].name=t.name):d.push(t)}),d=r.util.sort(d),u=t(r.template(i,"groups-page_group_dialog",{form:{name:e.getMetadata("name")||""}})),t.each(h,function(){t("#groups_pane .connect.left",u).append(t(r.template(i,"groups-page_group_element",this)))}),t.each(p,function(){t("#devices_pane .connect.left",u).append(t(r.template(i,"groups-page_group_element",this)))}),t.each(d,function(){t("#users_pane .connect.left",u).append(t(r.template(i,"groups-page_group_element",this)))}),t.each(l,function(){this.endpoint_type&&t(".connect.right",u).append(t(r.template(i,"groups-page_group_element",this)))}),t("#name",u).bind("keyup blur change",function(){t(".column.right .title",u).html("Page Group - "+t(this).val())}),t("ul.settings1 > li > a",u).click(function(e){t(".pane_content",u).hide(),t(".searchfield",u).val(""),t(".column.left li",u).show(),t("ul.settings1 > li",u).removeClass("current");var n=t(this).attr("id");n==="users_tab_link"?t("#users_pane",u).show():n==="devices_tab_link"?t("#devices_pane",u).show():n==="groups_tab_link"&&t("#groups_pane",u).show(),t(this).parent().addClass("current")}),t(".searchsubmit2",u).click(function(){t(".searchfield",u).val(""),t(".column li",u).show()}),t("#devices_pane .searchfield",u).keyup(function(){t("#devices_pane .column.left li").each(function(){t(".item_name",t(this)).html().toLowerCase().indexOf(t("#devices_pane .searchfield",u).val().toLowerCase())==-1?t(this).hide():t(this).show()})}),t("#users_pane .searchfield",u).keyup(function(){t("#users_pane .column.left li").each(function(){t(".item_name",t(this)).html().toLowerCase().indexOf(t("#users_pane .searchfield",u).val().toLowerCase())==-1?t(this).hide():t(this).show()})}),t("#groups_pane .searchfield",u).keyup(function(){t("#groups_pane .column.left li").each(function(){t(".item_name",t(this)).html().toLowerCase().indexOf(t("#groups_pane .searchfield",u).val().toLowerCase())==-1?t(this).hide():t(this).show()})}),t.isEmptyObject(l)?t(".column.right .connect",u).addClass("no_element"):t(".column.right .connect",u).removeClass("no_element"),t(".column.left .options",u).hide(),t(".column.left .actions",u).hide(),t(".options .option.delay",u).bind("keyup",function(){t(this).parents("li").data("delay",t(this).val())}),t(".options .option.timeout",u).bind("keyup",function(){t(this).parents("li").data("timeout",t(this).val())}),t("#save_ring_group",u).click(function(){var n=t("#name",u).val();f=[],t(".right .connect li",u).each(function(){var e=this.data();delete e.owner_id,f.push(e)}),e.setMetadata("endpoints",f),e.setMetadata("name",n),e.caption=n,o.dialog("close")}),o=r.ui.dialog(u,{title:i.i18n.active().oldCallflows.page_group_title,beforeClose:function(){typeof n=="function"&&n()}}),t(".connect",o).sortable({connectWith:t(".connect.right",o),zIndex:2e3,helper:"clone",appendTo:t(".wrapper",o),scroll:!1,tolerance:"pointer",receive:function(e,n){var s=n.item[0].dataset,f=[],l;s.endpoint_type==="device"?(l=i.i18n.active().oldCallflows.the_owner_of_this_device_is_already,t(".connect.right li",u).each(function(){t(this).data("id")===s.owner_id&&f.push(t(this))})):s.endpoint_type==="user"&&(l=i.i18n.active().oldCallflows.this_user_has_already_some_devices,t(".connect.right li",u).each(function(){t(this).data("owner_id")===s.id&&f.push(t(this))})),f.length>0&&r.ui.confirm(l,function(){t.each(f,function(){a(this)})},function(){a(n.item)}),t(this).hasClass("right")&&(t(".options",n.item).show(),t(".actions",n.item).show(),t(".column.right .connect",o).removeClass("no_element"))}}),t(u).delegate(".trash","click",function(){var e=t(this).parents("li").first();a(e)}),t(".pane_content",u).hide(),t("#users_pane",u).show();var a=function(e){var n=e,s=n.data();s.name=jQuery.trim(t(".item_name",n).html()),t("#"+s.endpoint_type+"s_pane .connect.left",u).append(t(r.template(i,"groups-page_group_element",s))),n.remove(),t(".connect.right li",u).size()==0&&t(".column.right .connect",o).addClass("no_element"),s.name.toLowerCase().indexOf(t("#"+s.endpoint_type+"s_pane .searchfield",u).val().toLowerCase())==-1&&t("#"+s.id,u).hide()}})})})},groupsEditRingGroup:function(e,n){var i=this,s="20",o="0";i.groupsDeviceList(function(u){var a,f,l,c,h={},p=[],d=[],v=[],m=[];(c=e.getMetadata("endpoints"))&&t.each(t.extend(!0,{},c),function(e,t){t.name=i.i18n.active().oldCallflows.undefined_device,h[t.id]=t}),t.each(u,function(e,t){t.endpoint_type="device",t.id in h?(h[t.id].endpoint_type="device",h[t.id].owner_id=t.owner_id,h[t.id].name=t.name):(t.delay=o,t.timeout=s,v.push(t))}),v=r.util.sort(v),i.groupsGroupList(function(u){t.each(u,function(e,t){t.endpoint_type="group",t.id in h?(h[t.id].endpoint_type="group",h[t.id].name=t.name):(t.delay=o,t.timeout=s,d.push(t))}),d=r.util.sort(d),i.groupsUserList(function(u,l){t.each(u,function(e,t){t.name=t.first_name+" "+t.last_name,t.endpoint_type="user",t.id in h?(h[t.id].endpoint_type="user",h[t.id].name=t.name):(t.delay=o,t.timeout=s,m.push(t))}),m=r.util.sort(m),i.groupsMediaList(function(s){var o=s.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()?1:-1});f=t(r.template(i,"groups-ring_group_dialog",{form:{name:e.getMetadata("name")||"",strategy:{items:[{id:"simultaneous",name:i.i18n.active().oldCallflows.at_the_same_time},{id:"single",name:i.i18n.active().oldCallflows.in_order}],selected:e.getMetadata("strategy")||"simultaneous"},timeout:e.getMetadata("timeout")||"30",ringback:{items:t.merge([{id:"default",name:i.i18n.active().oldCallflows.default,"class":"uneditable"},{id:"silence_stream://300000",name:i.i18n.active().oldCallflows.silence,"class":"uneditable"}],o),selected:e.getMetadata("ringback")||"default"}}})),t.each(d,function(){t("#groups_pane .connect.left",f).append(t(r.template(i,"groups-ring_group_element",this)))}),t.each(v,function(){t("#devices_pane .connect.left",f).append(t(r.template(i,"groups-ring_group_element",this)))}),t.each(m,function(){t("#users_pane .connect.left",f).append(t(r.template(i,"groups-ring_group_element",this)))}),t.each(h,function(){this.endpoint_type&&t(".connect.right",f).append(t(r.template(i,"groups-ring_group_element",this)))}),t("#name",f).bind("keyup blur change",function(){t(".column.right .title",f).html(i.i18n.active().oldCallflows.ring_group_val+t(this).val())}),t("#ringback",f).change(function(e){t(this).find("option:selected").hasClass("uneditable")?t('.media_action[data-action="edit"]',f).hide():t('.media_action[data-action="edit"]',f).show()}),t(".media_action",f).click(function(e){var n=t(this).data("action")==="create",i=n?{}:{id:t("#ringback",f).val()};r.pub("callflows.media.editPopup",{data:i,callback:function(e){e.data&&e.data.id&&(n?t("#ringback",f).append('<option value="'+e.data.id+'">'+e.data.name+"</option>"):t('#ringback option[value="'+e.data.id+'"]',f).text(e.data.name),t("#ringback",f).val(e.data.id))}})}),t("ul.settings1 > li > a",f).click(function(e){t(".pane_content",f).hide(),t(".searchfield",f).val(""),t(".column.left li",f).show(),t("ul.settings1 > li",f).removeClass("current");var n=t(this).attr("id");n==="users_tab_link"?t("#users_pane",f).show():n==="devices_tab_link"?t("#devices_pane",f).show():n==="groups_tab_link"&&t("#groups_pane",f).show(),t(this).parent().addClass("current")}),t(".searchsubmit2",f).click(function(){t(".searchfield",f).val(""),t(".column li",f).show()}),t("#devices_pane .searchfield",f).keyup(function(){t("#devices_pane .column.left li").each(function(){t(".item_name",t(this)).html().toLowerCase().indexOf(t("#devices_pane .searchfield",f).val().toLowerCase())==-1?t(this).hide():t(this).show()})}),t("#users_pane .searchfield",f).keyup(function(){t("#users_pane .column.left li").each(function(){t(".item_name",t(this)).html().toLowerCase().indexOf(t("#users_pane .searchfield",f).val().toLowerCase())==-1?t(this).hide():t(this).show()})}),t("#groups_pane .searchfield",f).keyup(function(){t("#groups_pane .column.left li").each(function(){t(".item_name",t(this)).html().toLowerCase().indexOf(t("#groups_pane .searchfield",f).val().toLowerCase())==-1?t(this).hide():t(this).show()})}),t.isEmptyObject(h)?t(".column.right .connect",f).addClass("no_element"):t(".column.right .connect",f).removeClass("no_element"),t(".column.left .options",f).hide(),t(".column.left .actions",f).hide(),t(".options .option.delay",f).bind("keyup",function(){t(this).parents("li").data("delay",t(this).val())}),t(".options .option.timeout",f).bind("keyup",function(){t(this).parents("li").data("timeout",t(this).val())}),t("#save_ring_group",f).click(function(){var n=t("#name",f).val(),r=0,i=t("#strategy",f).val(),s=t("#ringback",f).val();c=[];if(i==="simultaneous")var o=function(e,t,n){var r=e+t;return r>n&&(n=r),n};else var o=function(e,t,n){return n+=e+t,n};t(".right .connect li",f).each(function(){var e=t(this).data();delete e.owner_id,c.push(e),r=o(parseFloat(e.delay),parseFloat(e.timeout),r)}),e.setMetadata("endpoints",c),e.setMetadata("name",n),e.setMetadata("strategy",i),e.setMetadata("timeout",r),s==="default"?e.deleteMetadata("ringback",s):e.setMetadata("ringback",s),e.caption=n,a.dialog("close")}),a=r.ui.dialog(f,{title:i.i18n.active().oldCallflows.ring_group,beforeClose:function(){typeof n=="function"&&n()}}),t(".connect",a).sortable({connectWith:t(".connect.right",a),zIndex:2e3,helper:"clone",appendTo:t(".wrapper",a),scroll:!1,tolerance:"pointer",receive:function(e,n){var s=n.item[0].dataset,o=[],l;s.endpoint_type==="device"?(l=i.i18n.active().oldCallflows.the_owner_of_this_device_is_already,t(".connect.right li",f).each(function(){t(this).data("id")===s.owner_id&&o.push(t(this))})):s.endpoint_type==="user"&&(l=i.i18n.active().oldCallflows.this_user_has_already_some_devices,t(".connect.right li",f).each(function(){t(this).data("owner_id")===s.id&&o.push(t(this))})),o.length>0&&r.ui.confirm(l,function(){t.each(o,function(){u(this)})},function(){u(n.item)}),t(this).hasClass("right")&&(t(".options",n.item).show(),t(".actions",n.item).show(),t(".column.right .connect",a).removeClass("no_element"))}}),t(f).delegate(".trash","click",function(){var e=t(this).parents("li").first();u(e)}),t(".pane_content",f).hide(),t("#users_pane",f).show(),t("#ringback option:selected").hasClass("uneditable")?t('.media_action[data-action="edit"]',f).hide():t('.media_action[data-action="edit"]',f).show();var u=function(e){var n=e,s=n.data();s.name=jQuery.trim(t(".item_name",n).html()),t("#"+s.endpoint_type+"s_pane .connect.left",f).append(t(r.template(i,"groups-ring_group_element",s))),n.remove(),t(".connect.right li",f).size()==0&&t(".column.right .connect",a).addClass("no_element"),s.name.toLowerCase().indexOf(t("#"+s.endpoint_type+"s_pane .searchfield",f).val().toLowerCase())==-1&&t("#"+s.id,f).hide()}})})})})},groupsDeviceList:function(e){var t=this;t.callApi({resource:"device.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},groupsGroupList:function(e){var t=this;t.callApi({resource:"group.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},groupsUserList:function(e){var t=this;t.callApi({resource:"user.list",data:{accountId:t.accountId},success:function(t,n){e&&e(t.data)}})},groupsMediaList:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})}};return i});