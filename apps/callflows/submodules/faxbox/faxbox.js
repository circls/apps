define(["require","jquery","underscore","monster","monster-timezone"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("monster-timezone"),s={requests:{},subscribe:{"callflows.fetchActions":"faxboxDefineActions","callflows.faxbox.edit":"_faxboxEdit"},faxboxDefineActions:function(e){var n=this,i=e.actions;t.extend(i,{"faxbox[id=*]":{name:n.i18n.active().callflows.faxbox.faxboxes_label,icon:"printer2",category:n.i18n.active().oldCallflows.advanced_cat,module:"faxbox",tip:n.i18n.active().callflows.faxbox.faxbox_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:130,caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,i){var s=this;n.faxboxList(function(s,o){var u=t(r.template(n,"faxbox-callflowEdit",{items:r.util.sort(s),selected:e.getMetadata("id")||""})),a;t("#faxbox_selector option:selected",u).val()==undefined&&t("#edit_link",u).hide(),t(".inline_action",u).click(function(r){var i=t(this).data("action")=="edit"?{id:t("#faxbox_selector",u).val()}:{};r.preventDefault(),n.faxboxPopupEdit({data:i,callback:function(t){e.setMetadata("id",t.id||"null"),e.caption=t.name||"",a.dialog("close")}})}),t("#add",u).click(function(){e.setMetadata("id",t("#faxbox_selector",u).val()),e.caption=t("#faxbox_selector option:selected",u).text(),a.dialog("close")}),a=r.ui.dialog(u,{title:n.i18n.active().callflows.faxbox.voicemail_title,minHeight:"0",beforeClose:function(){typeof i=="function"&&i()}})})},listEntities:function(e){n.callApi({resource:"faxbox.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},editEntity:"callflows.faxbox.edit"}})},faxboxPopupEdit:function(e){var n=this,i=i=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),s=e.data,o=e.callback,u=e.data_defaults||{},a;n.faxboxEdit(s,i,t(".inline_content",i),{save_success:function(e){a.dialog("close"),typeof o=="function"&&o(e)},delete_success:function(){a.dialog("close"),typeof o=="function"&&o({data:{}})},after_render:function(){a=r.ui.dialog(i,{title:n.i18n.active().callflows.faxbox[(s.id?"edit":"create").concat("_faxbox")]})}},u)},_faxboxEdit:function(e){var t=this;t.faxboxEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},faxboxEdit:function(e,n,i,s){var o=this,u=n||t("#faxbox-content"),a=i||t("#faxbox-view",u),s=s||{},f={save_success:s.save_success||function(e){o.faxboxRenderList(u),o.faxboxEdit({id:e.id},u,a,f)},save_error:s.save_error,delete_success:s.delete_success||function(){a.empty(),o.faxboxRenderList(u)},delete_error:s.delete_error,after_render:s.after_render};r.parallel({faxbox:function(t){typeof e=="object"&&e.id?o.faxboxGet(e.id,function(n,r){n.id=e.id,t(null,n)}):t(null,{})},user_list:function(e){o.callApi({resource:"user.list",data:{accountId:o.accountId,filters:{paginate:!1}},success:function(t,n){t.data.sort(function(e,t){return e.hasOwnProperty("first_name")&&e.hasOwnProperty("last_name")&&t.hasOwnProperty("first_name")&&t.hasOwnProperty("last_name")?e.first_name.concat(" ",e.last_name).toLowerCase()>t.first_name.concat(" ",t.last_name).toLowerCase()?1:-1:1}),t.data.unshift({id:"",first_name:o.i18n.active().callflows.faxbox.no,last_name:o.i18n.active().callflows.faxbox.owner}),e(null,t.data)}})},current_user:function(e){r.util.isMasquerading()?e(null,{}):o.faxboxGetUser(o.userId,function(t,n){e(null,t)})}},function(n,r){e.hasOwnProperty("id")||(Object.keys(r.current_user).length===0?r.faxbox=t.extend(!0,o.faxboxGetDefaultSettings(),r.faxbox):r.faxbox=t.extend(!0,o.faxboxGetDefaultSettings(r.current_user),r.faxbox)),delete r.current_user,o.faxboxRender(r,a,f),typeof f.after_render=="function"&&f.after_render()})},faxboxRender:function(e,n,s){var o=this,u=t(r.template(o,"faxbox-edit",{faxbox:o.faxboxNormalizedData(e.faxbox),users:e.user_list}));i.populateDropdown(t("#fax_timezone",u),e.faxbox.fax_timezone||"inherit",{inherit:o.i18n.active().defaultTimezone}),t('*[rel=popover]:not([type="text"])',u).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',u).popover({trigger:"focus"}),o.winkstartTabs(u),e.faxbox.hasOwnProperty("id")?t("#owner_id",u).change(function(i){var a=r.ui.getFormData("faxbox_form");t(this).val()?(t('[id$="bound_notification_email"]',u).each(function(e,n){t(n).attr("disabled",!0)}),o.faxboxGetUser(t(this).val(),function(r,i){e.faxbox=t.extend(!0,{},o.faxboxGetDefaultSettings(),e.faxbox,a,{cloud_connector_claim_url:u.find("#cloud_connector_claim_url").attr("href"),notifications:{inbound:{email:{send_to:r.email||r.username}},outbound:{email:{send_to:r.email||r.username}}}}),t("#edit_link",u).hide(),o.faxboxRender(e,n,s)})):t('[id$="bound_notification_email"]',u).each(function(e,n){t(n).attr("disabled",!1)})}):t("#owner_id",u).change(function(r){t(this).val()?o.faxboxGetUser(t(this).val(),function(r,i){e.faxbox=o.faxboxGetDefaultSettings(r),t("#edit_link",u).show(),o.faxboxRender(e,n,s)}):(e.faxbox=o.faxboxGetDefaultSettings(),t("#edit_link",u).hide(),o.faxboxRender(e,n,s))}),t("#owner_id",u).val()||t("#edit_link",u).hide(),t(".inline-action",u).click(function(e){var n=t(this).data("action")=="edit"?{id:t("#owner_id",u).val()}:{},i=n.id;r.pub("callflows.user.popupEdit",{data:n,callflow:function(e){i?"id"in e?t("#owner_id #"+e.id,u).text(e.first_name+" "+e.last_name):t("#owner_id #"+i,u).remove():(t("#owner_id",u).append('<option id="'+e.id+'" value="'+e.id+'">'+e.first_name+" "+e.last_name+"</option>"),t("#owner_id",u).val(e.id))}})}),t("#caller_id",u).change(function(e){var n=t(this).val(),r=t("#fax_identity",u);/^(\+1|1)([0-9]{10})$|^([0-9]{10})$/.test(n)?/^(\+1)/.test(n)?r.val(n.replace(/^\+1([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):/^1([0-9]{10})$/.test(n)?r.val(n.replace(/^1([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):r.val(n.replace(/^([0-9]{3})([0-9]{3})([0-9]{4})$/,"+1 ($1) $2-$3")):r.val("")}),t(".faxbox-save",u).click(function(n){n.preventDefault();var i=t("#faxbox_form",u),a=r.ui.getFormData("faxbox_form"),f=/^[\w\s'-]+/;r.ui.validate(i,{rules:{name:{required:!0},caller_name:{regex:f},fax_header:{regex:f},custom_smtp_email_address:{email:!0},retries:{regex:/^[0-4]/}},messages:{caller_name:{regex:o.i18n.active().callflows.faxbox.validation.words},fax_header:{regex:o.i18n.active().callflows.faxbox.validation.words},retries:{regex:"Please enter a numeric value between 0 and 4"}}}),r.ui.valid(i)&&o.faxboxSave(a,e.faxbox,s.save_success,s.save_error)}),t(".faxbox-delete",u).click(function(t){t.preventDefault(),r.ui.confirm(o.i18n.active().callflows.faxbox.are_you_sure_you_want_to_delete,function(){o.faxboxDelete(e.faxbox,s.delete_success,s.delete_error)})}),n.empty().append(u)},faxboxRenderList:function(e){var n=this;n.faxboxList(function(e,r){var i=function(e){var r=[];return e.length>0&&t.each(e,function(e,t){r.push({id:t.id,title:t.name||n.i18n.active().callflows.faxbox.no_name})}),r.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),r}})},faxboxGetDefaultSettings:function(e){var n=this,i={name:"",caller_name:"",fax_header:"",fax_timezone:"inherit",retries:1,notifications:{inbound:{email:{send_to:""}},outbound:{email:{send_to:""}}}};return typeof e=="undefined"?i:t.extend(!0,{},i,{name:e.first_name.concat(" ",e.last_name,n.i18n.active().callflows.faxbox.default_settings_name_extension),caller_name:e.first_name.concat(" ",e.last_name),fax_header:r.config.whitelabel.companyName.concat(n.i18n.active().callflows.faxbox.default_settings_header_extension),owner_id:e.id,notifications:{inbound:{email:{send_to:e.email||e.username}},outbound:{email:{send_to:e.email||e.username}}}})},faxboxSave:function(e,n,r,i){var s=this,o=s.faxboxNormalizedData(t.extend(!0,{},n,e));typeof n=="object"&&n.id?s.faxboxUpdate(o,function(e,t){typeof r=="function"&&r(e,t,"update")},function(e,t){typeof i=="function"&&i(e,t,"update")}):s.faxboxCreate(o,function(e,t){typeof r=="function"&&r(e,t,"create")},function(e,t){typeof i=="function"&&i(e,t,"create")})},faxboxNormalizedData:function(e){if(e.hasOwnProperty("notifications")){var t=e.notifications.inbound.email.send_to,n=e.notifications.outbound.email.send_to;e.notifications.inbound.email.send_to=t instanceof Array?t.join(","):t.split(","),e.notifications.outbound.email.send_to=n instanceof Array?n.join(","):n.split(",")}if(e.hasOwnProperty("smtp_permission_list"))if(e.smtp_permission_list==="")delete e.smtp_permission_list;else{var r=e.smtp_permission_list;e.smtp_permission_list=r instanceof Array?r.join(" "):r.split(" ")}return e.hasOwnProperty("custom_smtp_email_address")&&e.custom_smtp_email_address===""&&delete e.custom_smtp_email_address,e.hasOwnProperty("owner_id")&&e.owner_id===""&&delete e.owner_id,e.fax_timezone&&e.fax_timezone==="inherit"&&delete e.fax_timezone,e},faxboxList:function(e){var t=this;t.callApi({resource:"faxbox.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},faxboxGet:function(e,t){var n=this;n.callApi({resource:"faxbox.get",data:{accountId:n.accountId,faxboxId:e},success:function(e){t&&t(e.data)}})},faxboxCreate:function(e,t){var n=this;n.callApi({resource:"faxbox.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},faxboxUpdate:function(e,t){var n=this;n.callApi({resource:"faxbox.update",data:{accountId:n.accountId,faxboxId:e.id,data:e},success:function(e){t&&t(e.data)}})},faxboxDelete:function(e,t,n){var r=this;typeof e=="object"&&e.hasOwnProperty("id")&&r.callApi({resource:"faxbox.delete",data:{accountId:r.accountId,faxboxId:e.id},success:function(e){t&&t(e.data)},error:function(e){n&&n()}})},faxboxGetUser:function(e,t,n){var r=this;r.callApi({resource:"user.get",data:{accountId:r.accountId,userId:e},success:function(e,n){t&&t(e.data)},error:function(e,t){n&&n()}})}};return s});