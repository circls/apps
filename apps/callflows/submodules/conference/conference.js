define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"callflows.conference.popupEdit":"conferencePopupEdit","callflows.fetchActions":"conferenceDefineActions","callflows.conference.edit":"_conferenceEdit"},conferenceDefineActions:function(e){var n=this,i=e.actions;t.extend(i,{"conference[id=*]":{name:n.i18n.active().callflows.conference.conference,icon:"conference",category:n.i18n.active().oldCallflows.basic_cat,module:"conference",tip:n.i18n.active().callflows.conference.conference_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,i){n.conferenceList(function(s,o){var u=t(r.template(n,"conference-callflowEdit",{items:r.util.sort(s),selected:e.getMetadata("id")||""})),a;t("#conference_selector option:selected",u).val()==undefined&&t("#edit_link",u).hide(),t(".inline_action",u).click(function(r){var i=t(this).data("action")=="edit"?{id:t("#conference_selector",u).val()}:{};r.preventDefault(),n.conferencePopupEdit(i,function(t){e.setMetadata("id",t.id||"null"),e.caption=t.name||"",a.dialog("close")})}),t("#add",u).click(function(){e.setMetadata("id",t("#conference_selector",u).val()),e.caption=t("#conference_selector option:selected",u).text(),a.dialog("close")}),a=r.ui.dialog(u,{title:n.i18n.active().callflows.conference.conference,minHeight:"0",beforeClose:function(){typeof i=="function"&&i()}})})},listEntities:function(e){n.callApi({resource:"conference.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},editEntity:"callflows.conference.edit"},"conference[]":{name:n.i18n.active().callflows.conference.conference_service,icon:"conference",category:n.i18n.active().oldCallflows.advanced_cat,module:"conference",tip:n.i18n.active().callflows.conference.conference_service_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:110,caption:function(e){return""},edit:function(e,t){typeof t=="function"&&t()}}})},conferencePopupEdit:function(e,n,i){var s=this,o=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),u;s.conferenceEdit(e,o,t(".inline_content",o),{save_success:function(e){u.dialog("close"),typeof n=="function"&&n(e)},delete_success:function(){u.dialog("close"),typeof n=="function"&&n({data:{}})},after_render:function(){u=r.ui.dialog(o,{title:e.id?s.i18n.active().callflows.conference.edit_conference:s.i18n.active().callflows.conference.create_conference})}},i)},_conferenceEdit:function(e){var t=this;t.conferenceEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},conferenceEdit:function(e,n,i,s,o){var u=this,a=n||t("#conference-content"),f=i||t("#conference-view",a),s=s||{},l={save_success:s.save_success||function(e){u.conferenceRenderList(a),u.conferenceEdit({id:e.id},a,f,l)},save_error:s.save_error,delete_success:s.delete_success||function(){f.empty(),u.conferenceRenderList(a)},delete_error:s.delete_error,after_render:s.after_render},c={data:t.extend(!0,{member:{},play_entry_tone:!0,play_exit_tone:!0},o||{}),field_data:{users:[]}};r.parallel({user_list:function(e){u.callApi({resource:"user.list",data:{accountId:u.accountId,filters:{paginate:!1}},success:function(t,n){t.data.unshift({id:"",first_name:"- No",last_name:"owner -"}),c.field_data.users=t.data,e(null,t)}})},get_conference:function(t){typeof e=="object"&&e.id?u.conferenceGet(e.id,function(e,n){u.conferenceMigrateData(e),u.conferenceFormatData(e),t(null,e)}):t(null,{})}},function(n,r){var i=c;typeof e=="object"&&e.id&&(i=t.extend(!0,c,{data:r.get_conference})),u.conferenceRender(i,f,l),typeof l.after_render=="function"&&l.after_render()})},conferenceRender:function(e,n,i){var s=this,o=t(r.template(s,"conference-edit",e)),u=o.find("#conference_form");r.ui.validate(u,{rules:{name:{required:!0},"member.pins_string":{regex:/^[a-z0-9A-Z,\s]*$/},"member.numbers_string":{regex:/^[0-9,\s]*$/}},messages:{"member.pins_string":{regex:s.i18n.active().callflows.conference.validation.member_pins_string},"member.numbers_string":{regex:s.i18n.active().callflows.conference.validation.member_numbers_string}}}),t('*[rel=popover]:not([type="text"])',o).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',o).popover({trigger:"focus"}),s.winkstartTabs(o),t("#owner_id",o).val()||t("#edit_link",o).hide(),t("#owner_id",o).change(function(){t("#owner_id option:selected",o).val()?t("#edit_link",o).show():t("#edit_link",o).hide()}),t(".inline_action",o).click(function(e){var n=t(this).data("action")=="edit"?{id:t("#owner_id",o).val()}:{},i=n.id;e.preventDefault(),r.pub("callflows.user.popupEdit",{data:n,callback:function(e){i?"id"in e?t("#owner_id #"+e.id,o).text(e.first_name+" "+e.last_name):(t("#owner_id #"+i,o).remove(),t("#edit_link",o).hide()):(t("#owner_id",o).append('<option id="'+e.id+'" value="'+e.id+'">'+e.first_name+" "+e.last_name+"</option>"),t("#owner_id",o).val(e.id),t("#edit_link",o).show())}})}),t(".conference-save",o).click(function(t){t.preventDefault();if(r.ui.valid(u)){var n=r.ui.getFormData("conference_form");s.conferenceCleanFormData(n),e.data.member.pins=n.member.pins,"field_data"in e&&delete e.field_data,s.conferenceSave(n,e,i.save_success,i.save_error)}else r.ui.alert(s.i18n.active().callflows.conference.there_were_errors_on_the_form)}),t(".conference-delete",o).click(function(t){t.preventDefault(),r.ui.confirm(s.i18n.active().callflows.conference.are_you_sure_you_want_to_delete,function(){s.conferenceDelete(e.data.id,i.delete_success,i.delete_error)})}),n.empty().append(o)},conferenceRenderList:function(e){var n=this;n.conferenceList(function(e,r){var i=function(e){var r=[];return e.length>0&&t.each(e,function(e,t){r.push({id:t.id,title:t.name||n.i18n.active().callflows.conference.name})}),r.sort(function(e,t){return e.title.toLowerCase()<t.title.toLowerCase()?-1:1}),r}})},conferenceMigrateData:function(e){return t.isArray(e.conference_numbers)&&(e.member.numbers==undefined&&(e.member.numbers=e.conference_numbers),delete e.conference_numbers),e.member_play_name&&(e.play_name_on_join==undefined&&(e.play_name_on_join=e.member_play_name),delete e.member_play_name),e.member_join_muted&&(e.member.join_muted==undefined&&(e.member.join_muted=e.member_join_muted),delete e.member_join_muted),e.member_join_deaf&&(e.member.join_deaf==undefined&&(e.member.join_deaf=e.member_join_deaf),delete e.member_join_deaf),e},conferenceFormatData:function(e){return typeof e.member=="object"&&(t.isArray(e.member.pins)&&(e.member.pins_string=e.member.pins.join(", ")),t.isArray(e.member.numbers)&&(e.member.numbers_string=e.member.numbers.join(", "))),e},conferenceCleanFormData:function(e){var n=this;return e.member.pins_string=n.conferenceLettersToNumbers(e.member.pins_string),e.member.pins=t.map(e.member.pins_string.split(","),function(e){var n=t.trim(e);return n!=""?n:null}),e.member.numbers=t.map(e.member.numbers_string.split(","),function(e){var n=t.trim(e);return n!=""?n:null}),e},conferenceLettersToNumbers:function(e){var n="";return t.each(e.split(""),function(e,t){t.match(/^[aAbBcC]$/)?n+="2":t.match(/^[dDeEfF]$/)?n+="3":t.match(/^[gGhHiI]$/)?n+="4":t.match(/^[jJkKlL]$/)?n+="5":t.match(/^[mMnNoO]$/)?n+="6":t.match(/^[pPqQrRsS]$/)?n+="7":t.match(/^[tTuUvV]$/)?n+="8":t.match(/^[wWxXyYzZ]$/)?n+="9":n+=t}),n},conferenceSave:function(e,n,r,i){var s=this,o=s.conferenceFixArrays(s.conferenceNormalizeData(t.extend(!0,{},n.data,e)),e);typeof n.data=="object"&&n.data.id?s.conferenceUpdate(o,function(e,t){typeof r=="function"&&r(e,t,"update")},function(e,t){typeof i=="function"&&i(e,t,"update")}):s.conferenceCreate(o,function(e,t){typeof r=="function"&&r(e,t,"create")},function(e,t){typeof i=="function"&&i(e,t,"create")})},conferenceFixArrays:function(e,t){var n=this;return"member"in t&&"numbers"in t.member&&(e.member.numbers=t.member.numbers),e},conferenceNormalizeData:function(e){return e.member.pins.length||delete e.member.pins,e.member.numbers.length||delete e.member.numbers,e.owner_id||delete e.owner_id,delete e.member.pins_string,delete e.member.numbers_string,e},conferenceList:function(e){var t=this;t.callApi({resource:"conference.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},conferenceGet:function(e,t){var n=this;n.callApi({resource:"conference.get",data:{accountId:n.accountId,conferenceId:e},success:function(e){t&&t(e.data)}})},conferenceCreate:function(e,t){var n=this;n.callApi({resource:"conference.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},conferenceUpdate:function(e,t){var n=this;n.callApi({resource:"conference.update",data:{accountId:n.accountId,conferenceId:e.id,data:e},success:function(e){t&&t(e.data)}})},conferenceDelete:function(e,t){var n=this;n.callApi({resource:"conference.delete",data:{accountId:n.accountId,conferenceId:e},success:function(e){t&&t(e.data)}})}};return i});