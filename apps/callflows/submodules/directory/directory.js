define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"callflows.fetchActions":"directoryDefineActions","callflows.directory.edit":"_directoryEdit"},directoryRender:function(e,n,i){var s=this,o=t(r.template(s,"directory-edit",e)),u=o.find("#directory-form");s.directoryRenderUserList(e,o),r.ui.validate(u,{rules:{min_dtmf:{digits:!0},max_dtmf:{digits:!0}}}),t('*[rel=popover]:not([type="text"])',o).popover({trigger:"hover"}),t('*[rel=popover][type="text"]',o).popover({trigger:"focus"}),s.winkstartTabs(o),t(".directory-save",o).click(function(n){n.preventDefault();if(r.ui.valid(u)){var a=r.ui.getFormData("directory-form");s.directoryCleanFormData(a);var f={},l={};t(".rows .row:not(#row_no_data)",o).each(function(){l[t(this).data("id")]=t("#user_callflow_id",t(this)).val()}),e.field_data.user_list={old_list:e.field_data.old_list,new_list:l},s.directorySave(a,e,i.save_success)}else r.ui.alert(s.i18n.active().callflows.directory.there_were_errors_on_the_form)}),t(".directory-delete",o).click(function(t){t.preventDefault(),r.ui.confirm(s.i18n.active().callflows.directory.are_you_sure_you_want_to_delete,function(){s.directoryDelete(e.data.id,i.delete_success)})}),t(".add_user_div",o).click(function(){var n=t("#select_user_id",o),i=t("#callflow_id",o);if(n.val()!="empty_option_user"&&i.val()!="empty_option_callflow"){var u=n.val(),a={user_id:u,user_name:t("#option_user_"+u,o).text(),callflow_id:i.val(),field_data:{callflows:e.field_data.callflows},_t:function(e){return window.translate.directory[e]}};t("#row_no_data",o).size()>0&&t("#row_no_data",o).remove(),t(".rows",o).prepend(r.template(s,"directory-userRow",a)),t("#option_user_"+u,o).hide(),n.val("empty_option_user"),i.val("empty_option_callflow")}else r.ui.alert("warning",s.i18n.active().callflows.directory.noDataSelected)}),t(o).delegate(".action_user.delete","click",function(){var e=t(this).data("id");t("#row_user_"+e,o).remove(),t("#option_user_"+e,o).show(),t(".rows .row",o).size()==0&&t(".rows",o).append(r.template(s,"directory-userRow"))}),n.empty().append(o)},directoryRenderUserList:function(e,n){var i=this;if(e.data.id)if("users"in e.data&&e.data.users.length>0){var s;t.each(e.field_data.users,function(o,u){u.id in e.field_data.old_list&&(s={user_id:u.id,user_name:u.first_name+" "+u.last_name,callflow_id:e.field_data.old_list[u.id],field_data:{callflows:e.field_data.callflows}},t(".rows",n).append(r.template(i,"directory-userRow",s)),t("#option_user_"+u.id,n).hide())})}else t(".rows",n).empty().append(r.template(i,"directory-userRow"));else t(".rows",n).empty().append(r.template(i,"directory-userRow"))},_directoryEdit:function(e){var t=this;t.directoryEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},directoryEdit:function(e,n,i,s,o){var u=this,a=n||t("#directory-content"),f=i||t("#directory-view",a),s=s||{},l={save_success:s.save_success,save_error:s.save_error,delete_success:s.delete_success,delete_error:s.delete_error,after_render:s.after_render},c={data:t.extend(!0,{min_dtmf:"3",max_dtmf:"0",sort_by:"last_name",confirm_match:!1},o||{}),field_data:{sort_by:{first_name:u.i18n.active().callflows.directory.first_name,last_name:u.i18n.active().callflows.directory.last_name}}};r.parallel({callflow_list:function(e){u.callApi({resource:"callflow.list",data:{accountId:u.accountId,filters:{paginate:"false"}},success:function(n){var r=[];t.each(n.data,function(){this.featurecode==0&&r.push(this)}),r.sort(function(e,t){var n=(e.name||e.numbers[0]+"").toLowerCase(),r=(t.name||t.numbers[0]+"").toLowerCase();return n>r}),c.field_data.callflows=r,e(null,n)}})},user_list:function(e){u.callApi({resource:"user.list",data:{accountId:u.accountId,filters:{paginate:"false"}},success:function(t){t.data.sort(function(e,t){var n=(e.first_name+" "+e.last_name).toLowerCase(),r=(t.first_name+" "+t.last_name).toLowerCase();return n>r}),c.field_data.users=t.data,e(null,t)}})},directory_get:function(n){typeof e=="object"&&e.id?u.directoryGet(e.id,function(e,r){c.field_data.old_list={},"users"in e&&t.each(e.users,function(e,t){c.field_data.old_list[t.user_id]=t.callflow_id}),n(null,e)}):n(null,{})}},function(n,r){var i=c;typeof e=="object"&&e.id&&(i=t.extend(!0,c,{data:r.directory_get})),u.directoryRender(i,f,l),typeof l.after_render=="function"&&l.after_render()})},directoryPopupEdit:function(e){var n=this,i,s,o=e.data,u=e.callback,a=e.data_defaults;s=t('<div class="inline_popup callflows-port"><div class="inline_content main_content"/></div>'),n.directoryEdit(o,s,t(".inline_content",s),{save_success:function(e){i.dialog("close"),typeof u=="function"&&u(e)},delete_success:function(){i.dialog("close"),typeof u=="function"&&u({data:{}})},after_render:function(){i=r.ui.dialog(s,{title:o.id?n.i18n.active().callflows.directory.edit_directory:n.i18n.active().callflows.directory.create_directory})}},a)},directoryNormalizeData:function(e){return delete e.users,e},directoryCleanFormData:function(e){e.max_dtmf>0||delete e.max_dtmf,delete e.user_callflow_id,delete e.user_id,delete e.callflow_id},directorySave:function(e,n,r){var i=this,s=i.directoryNormalizeData(t.extend(!0,{},n.data,e));typeof n.data=="object"&&n.data.id?i.directoryUpdate(s,function(e,t){i.directoryUpdateUsers(n.field_data.user_list,e.id,function(){r&&r(e,t,"update")})}):i.directoryCreate(s,function(e,t){i.directoryUpdateUsers(n.field_data.user_list,e.id,function(){r&&r(e,t,"create")})})},directoryUpdateSingleUser:function(e,n,r,i){var s=this;s.callApi({resource:"user.get",data:{accountId:s.accountId,userId:e},success:function(o,u){if(r){if(!o.data.directories||t.isArray(o.data.directories))o.data.directories={};o.data.directories[n]=r}else delete o.data.directories[n];s.callApi({resource:"user.update",data:{accountId:s.accountId,userId:e,data:o.data},success:i})}})},directoryUpdateUsers:function(e,n,r){var i=e.old_list,s=e.new_list,o=this,u=0,a=0,f=function(){u++,u>=a&&r()};i?(t.each(i,function(e,t){e in s||(a++,o.directoryUpdateSingleUser(e,n,undefined,f))}),t.each(s,function(e,t){e in i?i[e]!=t&&(a++,o.directoryUpdateSingleUser(e,n,t,f)):(a++,o.directoryUpdateSingleUser(e,n,t,f))})):s&&t.each(s,function(e,t){a++,o.directoryUpdateSingleUser(e,n,t,f)}),a===0&&r()},directoryDefineActions:function(e){var n=this,i=e.actions;t.extend(i,{"directory[id=*]":{name:n.i18n.active().callflows.directory.directory,icon:"book",category:n.i18n.active().oldCallflows.advanced_cat,module:"directory",tip:n.i18n.active().callflows.directory.directory_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:160,caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(r=t[n].name),r},edit:function(e,i){var s=this;n.directoryList(function(s){var o,u;u=t(r.template(n,"directory-callflowEdit",{items:r.util.sort(s),selected:e.getMetadata("id")||""})),t("#directory_selector option:selected",u).val()==undefined&&t("#edit_link",u).hide(),t(".inline_action",u).click(function(r){var i=t(this).data("action")=="edit"?{id:t("#directory_selector",u).val()}:{};r.preventDefault(),n.directoryPopupEdit({data:i,callback:function(t){e.setMetadata("id",t.data.id||"null"),e.caption=t.data.name||"",o.dialog("close")}})}),t("#add",u).click(function(){e.setMetadata("id",t("#directory_selector",o).val()),e.caption=t("#directory_selector option:selected",o).text(),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.directory.directory_title,beforeClose:function(){typeof i=="function"&&i()}})})},listEntities:function(e){n.callApi({resource:"directory.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},editEntity:"callflows.directory.edit"}})},directoryList:function(e){var t=this;t.callApi({resource:"directory.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},directoryGet:function(e,t){var n=this;n.callApi({resource:"directory.get",data:{accountId:n.accountId,directoryId:e},success:function(e){t&&t(e.data)}})},directoryCreate:function(e,t){var n=this;n.callApi({resource:"directory.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},directoryUpdate:function(e,t){var n=this;n.callApi({resource:"directory.update",data:{accountId:n.accountId,directoryId:e.id,data:e},success:function(e){t&&t(e.data)}})},directoryDelete:function(e,t){var n=this;n.callApi({resource:"directory.delete",data:{accountId:n.accountId,directoryId:e},success:function(e){t&&t(e.data)}})}};return i});