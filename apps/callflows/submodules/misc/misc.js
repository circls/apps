define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"callflows.fetchActions":"miscDefineActions"},miscGetGroupPickupData:function(e){var t=this;r.parallel({groups:function(e){t.miscGroupList(function(t){e(null,t)})},users:function(e){t.miscUserList(function(t){n.each(t,function(e){e.name=e.first_name+" "+e.last_name}),e(null,t)})},devices:function(e){t.miscDeviceList(function(t){e(null,t)})}},function(t,n){e&&e(n)})},miscDefineActions:function(e){var n=this,i=e.actions;t.extend(i,{root:{name:"Root",rules:[{type:"quantity",maxSize:"1"}],isUsable:"false"},"callflow[id=*]":{name:n.i18n.active().oldCallflows.callflow,icon:"callflow",category:n.i18n.active().oldCallflows.advanced_cat,module:"callflow",tip:n.i18n.active().oldCallflows.callflow_tip,data:{id:"null"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){var n=e.getMetadata("id"),r="";return n in t&&(t[n].hasOwnProperty("name")?r=t[n].name:t[n].hasOwnProperty("numbers")&&(r=t[n].numbers.toString())),r},edit:function(e,i){n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(s,o){var u,a,f=[];t.each(s.data,function(){!this.featurecode&&this.id!==n.flow.id&&(this.name=this.name?this.name:this.numbers?this.numbers.toString():n.i18n.active().oldCallflows.no_numbers,f.push(this))}),a=t(r.template(n,"callflow-edit_dialog",{objects:{type:"callflow",items:r.util.sort(f),selected:e.getMetadata("id")||""}})),t("#add",a).click(function(){e.setMetadata("id",t("#object-selector",a).val()),e.caption=t("#object-selector option:selected",a).text(),u.dialog("close")}),u=r.ui.dialog(a,{title:n.i18n.active().oldCallflows.callflow_title,beforeClose:function(){typeof i=="function"&&i()}})}})}},"call_forward[action=activate]":{name:n.i18n.active().oldCallflows.enable_call_forwarding,icon:"rightarrow",category:n.i18n.active().oldCallflows.call_forwarding_cat,module:"call_forward",tip:n.i18n.active().oldCallflows.enable_call_forwarding_tip,data:{action:"activate"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"call_forward[action=deactivate]":{name:n.i18n.active().oldCallflows.disable_call_forwarding,icon:"rightarrow",category:n.i18n.active().oldCallflows.call_forwarding_cat,module:"call_forward",tip:n.i18n.active().oldCallflows.disable_call_forwarding_tip,data:{action:"deactivate"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"call_forward[action=update]":{name:n.i18n.active().oldCallflows.update_call_forwarding,icon:"rightarrow",category:n.i18n.active().oldCallflows.call_forwarding_cat,module:"call_forward",tip:n.i18n.active().oldCallflows.update_call_forwarding_tip,data:{action:"update"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"dynamic_cid[]":{name:n.i18n.active().oldCallflows.dynamic_cid,icon:"rightarrow",category:n.i18n.active().oldCallflows.caller_id_cat,module:"dynamic_cid",tip:n.i18n.active().oldCallflows.dynamic_cid_tip,isUsable:"true",weight:10,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"prepend_cid[action=prepend]":{name:n.i18n.active().oldCallflows.prepend,icon:"plus_circle",category:n.i18n.active().oldCallflows.caller_id_cat,module:"prepend_cid",tip:n.i18n.active().oldCallflows.prepend_tip,data:{action:"prepend",caller_id_name_prefix:"",caller_id_number_prefix:""},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return(e.getMetadata("caller_id_name_prefix")||"")+" "+(e.getMetadata("caller_id_number_prefix")||"")},edit:function(e,i){var s,o;o=t(r.template(n,"misc-prepend_cid_callflow",{data_cid:{caller_id_name_prefix:e.getMetadata("caller_id_name_prefix")||"",caller_id_number_prefix:e.getMetadata("caller_id_number_prefix")||""}})),t("#add",o).click(function(){var n=t("#cid_name_prefix",o).val(),r=t("#cid_number_prefix",o).val();e.setMetadata("caller_id_name_prefix",n),e.setMetadata("caller_id_number_prefix",r),e.caption=n+" "+r,s.dialog("close")}),s=r.ui.dialog(o,{title:n.i18n.active().oldCallflows.prepend_caller_id_title,beforeClose:function(){typeof i=="function"&&i()}}),typeof i=="function"&&i()}},"prepend_cid[action=reset]":{name:n.i18n.active().oldCallflows.reset_prepend,icon:"loop2",category:n.i18n.active().oldCallflows.caller_id_cat,module:"prepend_cid",tip:n.i18n.active().oldCallflows.reset_prepend_tip,data:{action:"reset"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,t){typeof t=="function"&&t()}},"manual_presence[]":{name:n.i18n.active().oldCallflows.manual_presence,icon:"lightbulb_on",category:n.i18n.active().oldCallflows.advanced_cat,module:"manual_presence",tip:n.i18n.active().oldCallflows.manual_presence_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:40,caption:function(e,t){return e.getMetadata("presence_id")||""},edit:function(e,i){var s=t(r.template(n,"presence-callflowEdit",{data_presence:{presence_id:e.getMetadata("presence_id")||"",status:e.getMetadata("status")||"busy"}})),o;t("#add",s).click(function(){var n=t("#presence_id_input",s).val();e.setMetadata("presence_id",n),e.setMetadata("status",t("#presence_status option:selected",s).val()),e.caption=n,o.dialog("close")}),o=r.ui.dialog(s,{title:n.i18n.active().oldCallflows.manual_presence_title,beforeClose:function(){typeof i=="function"&&i()}})}},"language[]":{name:n.i18n.active().oldCallflows.language,icon:"earth",category:n.i18n.active().oldCallflows.advanced_cat,module:"language",tip:n.i18n.active().oldCallflows.language_tip,data:{},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:50,caption:function(e,t){return e.getMetadata("language")||""},edit:function(e,i){var s,o;o=t(r.template(n,"misc-language",{data_language:{language:e.getMetadata("language")||""}})),t("#add",o).click(function(){var n=t("#language_id_input",o).val();e.setMetadata("language",n),e.caption=n,s.dialog("close")}),s=r.ui.dialog(o,{title:n.i18n.active().oldCallflows.language_title,beforeClose:function(){typeof i=="function"&&i()}})}},"group_pickup[]":{name:n.i18n.active().oldCallflows.group_pickup,icon:"sip",category:n.i18n.active().oldCallflows.advanced_cat,module:"group_pickup",tip:n.i18n.active().oldCallflows.group_pickup_tip,data:{},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:60,caption:function(e,t){return e.getMetadata("name")||""},edit:function(e,i){n.miscGetGroupPickupData(function(s){var o,u;u=t(r.template(n,"misc-group_pickup",{data:{items:s,selected:e.getMetadata("device_id")||e.getMetadata("group_id")||e.getMetadata("user_id")||""}})),t("#add",u).click(function(){var n=t("#endpoint_selector",u),r=n.val(),i=n.find("#"+r).html(),s=t("#"+r,u).parents("optgroup").data("type"),a=s.substring(s,s.length-1)+"_id";e.data.data={},e.setMetadata(a,r),e.setMetadata("name",i),e.caption=i,o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().oldCallflows.select_endpoint_title,beforeClose:function(){i&&i()}})})}},"receive_fax[]":{name:n.i18n.active().oldCallflows.receive_fax,icon:"sip",category:n.i18n.active().oldCallflows.advanced_cat,module:"receive_fax",tip:n.i18n.active().oldCallflows.receive_fax_tip,data:{owner_id:null},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:70,caption:function(e,t){return""},edit:function(e,i){n.miscUserList(function(s,o){var u,a;t.each(s,function(){this.name=this.first_name+" "+this.last_name}),a=t(r.template(n,"fax-callflowEdit",{objects:{items:s,selected:e.getMetadata("owner_id")||"",t_38:e.getMetadata("media")&&e.getMetadata("media").fax_option||!1}})),t("#user_selector option:selected",a).val()==undefined&&t("#edit_link",a).hide(),t(".inline_action",a).click(function(n){var i=t(this).data("action")=="edit"?{id:t("#user_selector",a).val()}:{};n.preventDefault(),r.pub("callflows.user.popupEdit",{data:i,callback:function(t){e.setMetadata("owner_id",t.id||"null"),u.dialog("close")}})}),t("#add",a).click(function(){e.setMetadata("owner_id",t("#user_selector",a).val()),e.setMetadata("media",{fax_option:t("#t_38_checkbox",a).is(":checked")}),u.dialog("close")}),u=r.ui.dialog(a,{title:n.i18n.active().oldCallflows.select_user_title,minHeight:"0",beforeClose:function(){typeof i=="function"&&i()}})})}},"record_call[action=start]":{name:n.i18n.active().oldCallflows.start_call_recording,icon:"conference",category:n.i18n.active().oldCallflows.call_recording_cat,module:"record_call",tip:n.i18n.active().oldCallflows.start_call_recording_tip,data:{action:"start"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:10,caption:function(e){return""},edit:function(e,i){var s=t(r.template(n,"recordCall-callflowEdit",{data_call_record:{format:e.getMetadata("format")||"mp3",url:e.getMetadata("url")||"",time_limit:e.getMetadata("time_limit")||"600"}})),o;t("#add",s).click(function(){e.setMetadata("url",t("#url",s).val()),e.setMetadata("format",t("#format",s).val()),e.setMetadata("time_limit",t("#time_limit",s).val()),o.dialog("close")}),o=r.ui.dialog(s,{title:n.i18n.active().oldCallflows.start_call_recording,minHeight:"0",beforeClose:function(){typeof i=="function"&&i()}})}},"record_call[action=stop]":{name:n.i18n.active().oldCallflows.stop_call_recording,icon:"conference",category:n.i18n.active().oldCallflows.call_recording_cat,module:"record_call",tip:n.i18n.active().oldCallflows.stop_call_recording_tip,data:{action:"stop"},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e){return""},edit:function(e,t){}},"pivot[]":{name:n.i18n.active().oldCallflows.pivot,icon:"conference",category:n.i18n.active().oldCallflows.advanced_cat,module:"pivot",tip:n.i18n.active().oldCallflows.pivot_tip,data:{method:"get",req_timeout:"5",req_format:"twiml",voice_url:""},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:80,caption:function(e){return""},edit:function(e,i){var s,o;o=t(r.template(n,"misc-pivot",{data_pivot:{method:e.getMetadata("method")||"get",voice_url:e.getMetadata("voice_url")||"",req_timeout:e.getMetadata("req_timeout")||"5",req_format:e.getMetadata("req_format")||"twiml"}})),t("#add",o).click(function(){e.setMetadata("voice_url",t("#pivot_voiceurl_input",o).val()),e.setMetadata("method",t("#pivot_method_input",o).val()),e.setMetadata("req_format",t("#pivot_format_input",o).val()),s.dialog("close")}),s=r.ui.dialog(o,{title:n.i18n.active().oldCallflows.pivot_title,minHeight:"0",beforeClose:function(){typeof i=="function"&&i()}})}},"disa[]":{name:n.i18n.active().oldCallflows.disa,icon:"conference",category:n.i18n.active().oldCallflows.advanced_cat,module:"disa",tip:n.i18n.active().oldCallflows.disa_tip,data:{pin:"",retries:"3"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:90,caption:function(e){return""},edit:function(e,i){var s,o;o=t(r.template(n,"misc-disa",{data_disa:{pin:e.getMetadata("pin")||"",retries:e.getMetadata("retries")||"3",use_account_caller_id:e.getMetadata("use_account_caller_id")||!1}})),t("#add",o).click(function(){var i=function(){e.setMetadata("pin",t("#disa_pin_input",o).val()),e.setMetadata("retries",t("#disa_retries_input",o).val()),e.setMetadata("use_account_caller_id",t("#disa_use_account_caller_id",o).is(":checked")),s.dialog("close")};t("#disa_pin_input",o).val()==""?r.ui.confirm(n.i18n.active().oldCallflows.not_setting_a_pin,function(){i()}):i()}),s=r.ui.dialog(o,{title:n.i18n.active().oldCallflows.disa_title,beforeClose:function(){typeof i=="function"&&i()}})}},"response[]":{name:n.i18n.active().oldCallflows.response,icon:"rightarrow",category:n.i18n.active().oldCallflows.advanced_cat,module:"response",tip:n.i18n.active().oldCallflows.response_tip,data:{code:"",message:"",media:"null"},rules:[{type:"quantity",maxSize:"0"}],isUsable:"true",weight:100,caption:function(e,t){return n.i18n.active().oldCallflows.sip_code_caption+e.getMetadata("code")},edit:function(e,i){n.miscMediaList(function(s){var o,u;u=t(r.template(n,"misc-response",{response_data:{items:s,media_enabled:e.getMetadata("media")?!0:!1,selected_media:e.getMetadata("media")||"",code:e.getMetadata("code")||"",message:e.getMetadata("message")||""}})),(t("#media_selector option:selected",u).val()==undefined||t("#media_selector option:selected",u).val()=="null")&&t("#edit_link",u).hide(),t("#media_selector",u).change(function(){t("#media_selector option:selected",u).val()==undefined||t("#media_selector option:selected",u).val()=="null"?t("#edit_link",u).hide():t("#edit_link",u).show()}),t(".inline_action",u).click(function(n){var i=t(this).data("action")=="edit"?{id:t("#media_selector",u).val()}:{};n.preventDefault(),r.pub("callflows.media.editPopup",{data:i,callback:function(t){e.setMetadata("media",t.data.id||"null"),o.dialog("close")}})}),t("#add",u).click(function(){t("#response_code_input",u).val().match(/^[1-6][0-9]{2}$/)?(e.setMetadata("code",t("#response_code_input",u).val()),e.setMetadata("message",t("#response_message_input",u).val()),t("#media_selector",u).val()&&t("#media_selector",u).val()!="null"?e.setMetadata("media",t("#media_selector",u).val()):e.deleteMetadata("media"),e.caption=n.i18n.active().oldCallflows.sip_code_caption+t("#response_code_input",u).val(),o.dialog("close")):r.ui.alert("error",n.i18n.active().oldCallflows.please_enter_a_valide_sip_code)}),o=r.ui.dialog(u,{title:n.i18n.active().oldCallflows.response_title,minHeight:"0",beforeClose:function(){typeof i=="function"&&i()}})})}}})},miscDeviceList:function(e){var t=this;t.callApi({resource:"device.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},miscGroupList:function(e){var t=this;t.callApi({resource:"group.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},miscUserList:function(e){var t=this;t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},miscMediaList:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})}};return i});