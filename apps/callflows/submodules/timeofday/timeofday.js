define(["require","jquery","underscore","monster","monster-timezone","slider"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("monster-timezone"),s=e("slider"),o={requests:{},subscribe:{"callflows.fetchActions":"timeofdayDefineActions","callflows.timeofday.edit":"_timeofdayEdit"},timeofdaySave:function(e,n,r,i){var s=this,o=s.timeofdayNormalizeData(t.extend(!0,{},n.data,e));typeof n.data=="object"&&n.data.id?s.temporalRuleUpdate(o,function(e,t){r&&r(e,t,"update")}):s.temporalRuleCreate(o,function(e,t){r&r(e,t,"create")})},timeofdayPopupEdit:function(e){var n=this,i,s,o=e.data,u=e.callback,a=e.data_defaults;s=t('<div class="inline_popup callflows-port"><div class="main_content inline_content"/></div>'),n.timeofdayEdit(o,s,t(".inline_content",s),{save_success:function(e){i.dialog("close"),typeof u=="function"&&u(e)},delete_success:function(){i.dialog("close"),typeof u=="function"&&u({data:{}})},after_render:function(){i=r.ui.dialog(s,{title:o.id?n.i18n.active().callflows.timeofday.edit_time_of_day:n.i18n.active().callflows.timeofday.create_time_of_day})}},a)},_timeofdayEdit:function(e){var t=this;t.timeofdayEdit(e.data,e.parent,e.target,e.callbacks,e.data_defaults)},timeofdayEdit:function(e,n,r,i,s){var o=this,u=n||t("#timeofday-content"),a=r||t("#timeofday-view",u);i=i||{},callbacks={save_success:i.save_success,save_error:i.save_error,delete_success:i.delete_success,delete_error:i.delete_error,after_render:i.after_render},defaults={data:t.extend(!0,{time_window_start:32400,time_window_stop:61200,wdays:[],days:[],interval:1,showSave:!0},s||{}),field_data:{wdays:{sunday:{friendlyName:o.i18n.active().callflows.timeofday.sunday.friendlyName,shortName:o.i18n.active().callflows.timeofday.sunday.shortName},monday:{friendlyName:o.i18n.active().callflows.timeofday.monday.friendlyName,shortName:o.i18n.active().callflows.timeofday.monday.shortName},tuesday:{friendlyName:o.i18n.active().callflows.timeofday.tuesday.friendlyName,shortName:o.i18n.active().callflows.timeofday.tuesday.shortName},wednesday:{friendlyName:o.i18n.active().callflows.timeofday.wednesday.friendlyName,shortName:o.i18n.active().callflows.timeofday.wednesday.shortName},thursday:{friendlyName:o.i18n.active().callflows.timeofday.thursday.friendlyName,shortName:o.i18n.active().callflows.timeofday.thursday.shortName},friday:{friendlyName:o.i18n.active().callflows.timeofday.friday.friendlyName,shortName:o.i18n.active().callflows.timeofday.friday.shortName},saturday:{friendlyName:o.i18n.active().callflows.timeofday.saturday.friendlyName,shortName:o.i18n.active().callflows.timeofday.saturday.shortName}},day:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"],cycle:[{id:"weekly",value:"Weekly"},{id:"monthly",value:"Monthly"},{id:"yearly",value:"Yearly"}],ordinals:[{id:"first",value:"First"},{id:"second",value:"Second"},{id:"third",value:"Third"},{id:"fourth",value:"Fourth"},{id:"fifth",value:"Fifth"},{id:"last",value:"Last"},{id:"every",value:"Day"}],months:[{id:1,value:"January"},{id:2,value:"February"},{id:3,value:"March"},{id:4,value:"April"},{id:5,value:"May"},{id:6,value:"June"},{id:7,value:"July"},{id:8,value:"August"},{id:9,value:"September"},{id:10,value:"October"},{id:11,value:"November"},{id:12,value:"December"}]}},typeof e=="object"&&e.id?o.temporalRuleGet(e.id,function(e,n){var r={data:e};o.timeofdayMigrateData(r),o.timeofdayFormatData(r),o.timeofdayRender(t.extend(!0,defaults,r),a,callbacks),typeof callbacks.after_render=="function"&&callbacks.after_render()}):(o.timeofdayRender(defaults,a,callbacks),typeof callbacks.after_render=="function"&&callbacks.after_render())},timeofdayRender:function(e,n,i){var s=this,o,u=t(r.template(s,"timeofday-callflowEdit",e)),a,f=u.find("#timeofday-form");r.ui.validate(f),t("*[rel=popover]",u).popover({trigger:"focus"}),s.winkstartTabs(u),r.ui.datepicker(u.find("#start_date")),t("#yearly_every",u).hide(),t("#monthly_every",u).hide(),t("#weekly_every",u).hide(),t("#ordinal",u).hide(),t("#days_checkboxes",u).hide(),t("#weekdays",u).hide(),t("#specific_day",u).hide();if(e.data.id==undefined)t("#weekly_every",u).show(),t("#days_checkboxes",u).show();else if(e.data.cycle=="monthly")t("#monthly_every",u).show(),t("#ordinal",u).show(),e.data.days!=undefined&&e.data.days[0]!=undefined?t("#specific_day",u).show():t("#weekdays",u).show();else if(e.data.cycle=="yearly")t("#yearly_every",u).show(),t("#ordinal",u).show(),e.data.days!=undefined&&e.data.days[0]!=undefined?t("#specific_day",u).show():t("#weekdays",u).show();else if(e.data.cycle="weekly")t("#weekly_every",u).show(),t("#days_checkboxes",u).show();t(".fake_checkbox",u).click(function(){t(this).toggleClass("checked")}),t("#ordinal",u).change(function(){t(this).val()=="every"?(t("#weekdays",u).hide(),t("#specific_day",u).show()):(t("#weekdays",u).show(),t("#specific_day",u).hide())}),t("#cycle",u).change(function(){t("#yearly_every",u).hide(),t("#monthly_every",u).hide(),t("#weekly_every",u).hide(),t("#ordinal",u).hide(),t("#days_checkboxes",u).hide(),t("#weekdays",u).hide(),t("#specific_day",u).hide();switch(t(this).val()){case"yearly":t("#yearly_every",u).show(),t("#ordinal",u).show(),t("#ordinal",u).val()=="every"?t("#specific_day",u).show():t("#weekdays",u).show();break;case"monthly":t("#monthly_every",u).show(),t("#ordinal",u).show(),t("#ordinal",u).val()=="every"?t("#specific_day",u).show():t("#weekdays",u).show();break;case"weekly":t("#weekly_every",u).show(),t("#days_checkboxes",u).show()}}),t(".timeofday-save",u).click(function(n){n.preventDefault();if(r.ui.valid(f)){var o=r.ui.getFormData("timeofday-form");o.wdays=[],e.data.wdays=[],t(".fake_checkbox.checked",u).each(function(){o.wdays.push(t(this).data("value"))}),o.interval=t("#cycle",u).val()=="monthly"?t("#interval_month",u).val():t("#interval_week",u).val(),o.start_date=u.find("#start_date").datepicker("getDate"),o=s.timeofdayCleanFormData(o),s.timeofdaySave(o,e,i.save_success)}else r.ui.alert("error",s.i18n.active().callflows.timeofday.there_were_errors_on_the_form)}),t(".timeofday-delete",u).click(function(t){t.preventDefault(),r.ui.confirm(s.i18n.active().callflows.timeofday.are_you_sure_you_want_to_delete,function(){s.temporalRuleDelete(e.data.id,i.delete_success)})}),a=i.after_render,i.after_render=function(){typeof a=="function"&&a(),t("#time",u).jslider({from:0,to:86400,step:900,dimension:"",scale:["12:00am","1:00am","2:00am","3:00am","4:00am","5:00am","6:00am","7:00am","8:00am","9:00am","10:00am","11:00am","12:00pm","1:00pm","2:00pm","3:00pm","4:00pm","5:00pm","6:00pm","7:00pm","8:00pm","9:00pm","10:00pm","11:00pm","12:00am"],limits:!1,calculate:function(e){var t=Math.floor(e/3600),n=(e-t*3600)/60,r=t<12?"am":"pm";return t%=12,t==0&&(t=12),t+":"+(n?n:"0"+n)+r},onstatechange:function(){}})},n.empty().append(u)},timeofdayCleanFormData:function(e){var n=[],i=e.time.split(";");return e.cycle!="weekly"&&e.weekday!=undefined&&(e.wdays=[],e.wdays.push(e.weekday)),t.each(e.wdays,function(e,t){t&&(t=="wednesday"&&(t="wensday"),n.push(t))}),n.length>0&&n[0]=="sunday"&&n.push(n.shift()),e.wdays=n,e.start_date===""?delete e.start_date:e.start_date=r.util.dateToGregorian(e.start_date),e.time_window_start=i[0],e.time_window_stop=i[1],e.month&&(e.month=parseInt(e.month)),e},timeofdayNormalizeData:function(e){return e.cycle=="weekly"?(delete e.ordinal,delete e.days,delete e.month):(e.cycle=="yearly"?delete e.interval:delete e.month,e.ordinal!="every"?delete e.days:delete e.wdays),delete e.time,delete e.weekday,e.enabled==="true"?e.enabled=!0:e.enabled==="false"?e.enabled=!1:delete e.enabled,e},timeofdayFormatData:function(e){return e.data.wdays!=undefined&&e.data.cycle!="weekly"&&(e.data.weekday=e.data.wdays[0]),e.data.showSave=!0,e.data.showDelete=e.data.id?!0:!1,e.data.hasOwnProperty("ui_metadata")&&e.data.ui_metadata.hasOwnProperty("origin")&&e.data.ui_metadata.origin==="voip"&&(e.data.showSave=!1,r.util.isSuperDuper()||(e.data.showDelete=!1)),e},timeofdayMigrateData:function(e){return"wdays"in e.data&&(wday=t.inArray("wensday",e.data.wdays))>-1&&(e.data.wdays[wday]="wednesday"),e},timeofdayDefineActions:function(e){var n=this,s=e.actions;t.extend(s,{"temporal_route[]":{name:n.i18n.active().callflows.timeofday.time_of_day,icon:"temporal_route",category:n.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{},rules:[{type:"quantity",maxSize:"12"}],isUsable:"true",weight:10,key_caption:function(e,t){var r=e.key;return r==="_"?caption=n.i18n.active().callflows.timeofday.all_other_times:t.hasOwnProperty(r)?caption=t[r].name:caption="",caption},key_edit:function(e,i){var s=this;n.temporalRuleList(function(s){var o,u;s.push({id:"_",name:n.i18n.active().callflows.timeofday.all_other_times}),u=t(r.template(n,"timeofday-callflowKey",{items:r.util.sort(s),selected:e.key})),t(".inline_action",u).click(function(r){var i=t(this).data("action")=="edit"?{id:t("#timeofday_selector",u).val()}:{};r.preventDefault(),n.timeofdayPopupEdit({data:i,callback:function(t){e.key=t.id||"null",e.key_caption=t.name||"",o.dialog("close")}})}),t("#timeofday_selector option:selected",u).val()=="_"&&t("#edit_link",u).hide(),t("#timeofday_selector",u).change(function(){t("#timeofday_selector option:selected",u).val()=="_"?t("#edit_link",u).hide():t("#edit_link",u).show()}),t("#add",u).click(function(){e.key=t("#timeofday_selector",u).val(),e.key_caption=t("#timeofday_selector option:selected",u).text(),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.timeofday.time_of_day,beforeClose:function(){typeof i=="function"&&i()}})})},caption:function(e,t){return e.getMetadata("timezone")||n.i18n.active().defaultTimezone},edit:function(e,s){var o,u;u=t(r.template(n,"timeofday-callflowTimezone",{items:{},selected:{}})),i.populateDropdown(t("#timezone_selector",u),e.getMetadata("timezone")||"inherit",{inherit:n.i18n.active().defaultTimezone}),t("#add",u).click(function(){var n=t("#timezone_selector",u).val();n&&n!=="inherit"&&e.setMetadata("timezone",n),e.caption=t("#timezone_selector option:selected",u).text(),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.timeofday.select_a_timezone_title,beforeClose:function(){typeof s=="function"&&s()}})},listEntities:function(e){n.callApi({resource:"temporalRule.list",data:{accountId:n.accountId,filters:{paginate:!1}},success:function(t,n){e&&e(t.data)}})},editEntity:"callflows.timeofday.edit"},"temporal_route[action=disable]":{name:n.i18n.active().callflows.timeofday.disable_time_of_day,icon:"temporal_route",category:n.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{action:"disable",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:20,caption:function(e,t){return""},edit:function(e,i){n.temporalRuleList(function(s){var o,u,a,f=[],l=[];(a=e.getMetadata("rules"))?t.each(s,function(e,n){t.inArray(n.id,a)!=-1?l.push(n):f.push(n)}):f=s,u=t(r.template(n,"timeofday-two_column",{left:{title:n.i18n.active().callflows.timeofday.unselected_time_of_day_rules,items:f},right:{title:n.i18n.active().callflows.timeofday.selected_time_of_day_rules,items:l}})),t("#add",u).click(function(){var n=[];t(".right .connect li",u).each(function(){n.push(t(this).data("id"))}),e.setMetadata("rules",n),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.timeofday.disable_time_of_day_rules_title,beforeClose:function(){typeof i=="function"&&i()}}),t(".connect",o).sortable({connectWith:t(".connect",o),zIndex:2e3,helper:"clone",appendTo:t(".wrapper",o),scroll:!1,tolerance:"pointer",receive:function(){},remove:function(){}})})}},"temporal_route[action=enable]":{name:n.i18n.active().callflows.timeofday.enable_time_of_day,icon:"temporal_route",category:n.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{action:"enable",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:30,caption:function(e,t){return""},edit:function(e,i){n.temporalRuleList(function(s){var o,u,a,f=[],l=[];(a=e.getMetadata("rules"))?t.each(s,function(e,n){t.inArray(n.id,a)!=-1?l.push(n):f.push(n)}):f=s,u=t(r.template(n,"timeofday-two_column",{left:{title:n.i18n.active().callflows.timeofday.unselected_time_of_day_rules,items:f},right:{title:n.i18n.active().callflows.timeofday.selected_time_of_day_rules,items:l}})),t("#add",u).click(function(){var n=[];t(".right .connect li",u).each(function(){n.push(t(this).data("id"))}),e.setMetadata("rules",n),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.timeofday.enable_time_of_day_rules,beforeClose:function(){typeof i=="function"&&i()}}),t(".connect",o).sortable({connectWith:t(".connect",o),zIndex:2e3,helper:"clone",appendTo:t(".wrapper",o),scroll:!1,tolerance:"pointer",receive:function(){},remove:function(){}})})}},"temporal_route[action=reset]":{name:n.i18n.active().callflows.timeofday.reset_time_of_day,icon:"temporal_route",category:n.i18n.active().callflows.timeofday.time_of_day_cat,module:"temporal_route",data:{action:"reset",rules:[]},rules:[{type:"quantity",maxSize:"1"}],isUsable:"true",weight:40,caption:function(e,t){return""},edit:function(e,i){n.temporalRuleList(function(s){var o,u,a,f=[],l=[];(a=e.getMetadata("rules"))?t.each(s,function(e,n){t.inArray(n.id,a)!=-1?l.push(n):f.push(n)}):f=s,u=t(r.template(n,"timeofday-two_column",{left:{title:n.i18n.active().callflows.timeofday.unselected_time_of_day_rules,items:f},right:{title:n.i18n.active().callflows.timeofday.selected_time_of_day_rules,items:l}})),t("#add",u).click(function(){var n=[];t(".right .connect li",u).each(function(){n.push(t(this).data("id"))}),e.setMetadata("rules",n),o.dialog("close")}),o=r.ui.dialog(u,{title:n.i18n.active().callflows.timeofday.reset_time_of_day_rules,beforeClose:function(){typeof i=="function"&&i()}}),t(".connect",o).sortable({connectWith:t(".connect",o),zIndex:2e3,helper:"clone",appendTo:t(".wrapper",o),scroll:!1,tolerance:"pointer",receive:function(){},remove:function(){}})})}}})},temporalRuleList:function(e){var t=this;t.callApi({resource:"temporalRule.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){e&&e(t.data)}})},temporalRuleGet:function(e,t){var n=this;n.callApi({resource:"temporalRule.get",data:{accountId:n.accountId,ruleId:e},success:function(e){t&&t(e.data)}})},temporalRuleCreate:function(e,t){var n=this;n.callApi({resource:"temporalRule.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},temporalRuleUpdate:function(e,t){var n=this;n.callApi({resource:"temporalRule.update",data:{accountId:n.accountId,ruleId:e.id,data:e},success:function(e){t&&t(e.data)}})},temporalRuleDelete:function(e,t){var n=this;n.callApi({resource:"temporalRule.delete",data:{accountId:n.accountId,ruleId:e},success:function(e){t&&t(e.data)}})}};return o});