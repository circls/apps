define(["require","jquery","underscore","chosen","monster","monster-timezone","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("chosen"),i=e("monster"),s=e("monster-timezone"),o=e("toastr"),u={requests:{},subscribe:{"voip.users.render":"usersRender"},deviceIcons:{cellphone:"fa fa-phone",smartphone:"icon-telicon-mobile-phone",landline:"icon-telicon-home",mobile:"icon-telicon-sprint-phone",softphone:"icon-telicon-soft-phone",sip_device:"icon-telicon-voip-phone",sip_uri:"icon-telicon-voip-phone",fax:"icon-telicon-fax",ata:"icon-telicon-fax"},usersRender:function(e){var r=this,e=e||{},s=e.parent||t(".right-content"),o=e.userId,u=e.openedTab,a=e.callback;r.usersRemoveOverlay(),r.usersGetData(function(e){var f=r.usersFormatListData(e),l=t(i.template(r,"users-layout",f)),c;n.each(f.users,function(e){c=i.template(r,"users-row",e),l.find(".user-rows").append(c)}),i.ui.tooltips(l,{options:{container:"body"}}),l.find('[data-toggle="popover"]').popover({container:"body"}),r.usersBindEvents(l,s,f),s.empty().append(l),r.usersCheckWalkthrough();if(o){var h=s.find(".grid-row[data-id="+o+"] .grid-cell");i.ui.highlight(h)}f.users.length==0?(s.find(".grid-row.title").css("display","none"),s.find(".no-users-row").css("display","block")):(s.find(".grid-row.title").css("display","block"),s.find(".no-users-row").css("display","none")),o&&u&&l.find('.grid-row[data-id="'+o+'"] .grid-cell[data-type="'+u+'"]').click(),a&&a()})},usersCheckWalkthrough:function(){var e=this;e.usersHasWalkthrough(function(){e.usersShowWalkthrough(function(){e.usersUpdateWalkthroughFlagUser()})})},usersHasWalkthrough:function(e){var t=this,n=t.uiFlags.user.get("showUsersWalkthrough");n!==!1&&e&&e()},usersUpdateWalkthroughFlagUser:function(e){var t=this,n=t.uiFlags.user.set("showUsersWalkthrough",!1);t.usersUpdateOriginalUser(n,function(t){e&&e(t)})},usersShowWalkthrough:function(e){var n=this,r=t("#voip_container"),s=r.find(".grid-row:not(.title):first"),o=[{element:r.find(".add-user")[0],intro:n.i18n.active().users.walkthrough.steps[1],position:"right"},{element:s.find(".name")[0],intro:n.i18n.active().users.walkthrough.steps[2],position:"right"},{element:s.find(".extension")[0],intro:n.i18n.active().users.walkthrough.steps[3],position:"bottom"},{element:s.find(".phone-number")[0],intro:n.i18n.active().users.walkthrough.steps[4],position:"bottom"},{element:s.find(".devices")[0],intro:n.i18n.active().users.walkthrough.steps[5],position:"left"},{element:s.find(".features")[0],intro:n.i18n.active().users.walkthrough.steps[6],position:"left"}];i.ui.stepByStep(o,function(){e&&e()})},usersFormatUserData:function(e,t,r,s,o){var u=this,a={additionalDevices:0,additionalExtensions:0,additionalNumbers:0,devices:[],extension:e.hasOwnProperty("presence_id")?e.presence_id:"",hasFeatures:!1,isAdmin:e.priv_level==="admin",listCallerId:[],listExtensions:[],listNumbers:[],phoneNumber:"",differentEmail:e.email!==e.username,mapFeatures:{caller_id:{icon:"fa fa-user",iconColor:"monster-blue",title:u.i18n.active().users.caller_id.title},call_forward:{icon:"fa fa-share",iconColor:"monster-yellow",title:u.i18n.active().users.call_forward.title},hotdesk:{icon:"fa fa-fire",iconColor:"monster-orange",title:u.i18n.active().users.hotdesk.title},vm_to_email:{icon:"icon-telicon-voicemail",iconColor:"monster-green",title:u.i18n.active().users.vm_to_email.title},faxing:{icon:"icon-telicon-fax",iconColor:"monster-red",title:u.i18n.active().users.faxing.title},conferencing:{icon:"fa fa-comments",iconColor:"monster-grey",title:u.i18n.active().users.conferencing.title},find_me_follow_me:{icon:"fa fa-sitemap",iconColor:"monster-purple",title:u.i18n.active().users.find_me_follow_me.title},music_on_hold:{icon:"fa fa-music",iconColor:"monster-pink",title:u.i18n.active().users.music_on_hold.title},call_recording:{icon:"fa fa-microphone",iconColor:"monster-blue",title:u.i18n.active().users.callRecording.title}}};"extra"in e||(e.extra=a),e.extra.countFeatures=0,n.each(e.features,function(t){t in e.extra.mapFeatures&&(e.extra.countFeatures++,e.extra.mapFeatures[t].active=!0)}),e.extra.countFeatures>0&&(e.extra.hasFeatures=!0),t&&(e.extra.mainDirectoryId=t.id,"directories"in e&&t.id in e.directories?e.extra.includeInDirectory=!0:e.extra.includeInDirectory=!1);if(r){e.extra.mainCallflowId=r.id;if("flow"in r){var f=r.flow,l="user";e.features.indexOf("find_me_follow_me")>=0&&(l="ring_group",e.extra.groupTimeout=!0);while(f.module!=l&&"_"in f.children)f=f.children._;e.extra.ringingTimeout=f.data.timeout}}s&&(e.extra.vmbox=s);if(!n.isEmpty(s)&&!n.isEmpty(o)){var c=o.indexOf(s.mailbox);o.splice(c,1),e.extra.existingVmboxes=o}e.extra.adminId=u.userId,e.extra.presenceIdOptions=[];var h,p=!1,d=function(t){h={key:t,value:i.util.formatPhoneNumber(t)},e.extra.presenceIdOptions.push(h)};return n.each(e.extra.listExtensions,function(t){e.hasOwnProperty("presence_id")&&e.presence_id===t&&(p=!0),d(t)}),e.extra.presenceIdOptions.sort(function(e,t){return e.key>t.key?1:-1}),p||e.extra.presenceIdOptions.unshift({key:"unset",value:u.i18n.active().users.editionForm.noPresenceID}),e},usersFormatListData:function(e){var t=this,r={existingExtensions:[],countUsers:e.users.length},s={};n.each(e.users,function(e){s[e.id]=t.usersFormatUserData(e)}),n.each(e.devices,function(e,t){if(e.device_type==="mobile"&&e.hasOwnProperty("owner_id")){var n=s[e.owner_id];n.extra.phoneNumber===""?n.extra.phoneNumber=e.mobile.mdn:n.extra.additionalNumbers++}}),n.each(e.callflows,function(e){if(e.type!=="faxing"){var t=e.owner_id;n.each(e.numbers,function(e){e&&e.length<7&&r.existingExtensions.push(e)});if(t in s){var i=s[t];n.each(e.numbers,function(e){e.length<7?i.extra.listExtensions.push(e):(i.extra.listCallerId.push(e),i.extra.listNumbers.push(e),i.extra.phoneNumber===""?i.extra.phoneNumber=e:i.extra.additionalNumbers++)}),i.extra.additionalExtensions=i.extra.listExtensions.length>=1?i.extra.listExtensions.length-1:0,i.extra.extension===""&&i.extra.listExtensions.length>0&&(i.extra.extension=i.extra.listExtensions[0])}}}),r.existingExtensions.sort(t.usersSortExtensions),n.each(e.devices,function(r){var i=r.owner_id;if(i in s){var o=n.find(e.deviceStatus,function(e){return e.device_id===r.id&&e.registered===!0})?!0:!1;s[i].extra.devices.length>=2&&(s[i].extra.additionalDevices===0&&(s[i].extra.additionalDevices={count:0,tooltip:""}),s[i].extra.additionalDevices.count++,s[i].extra.additionalDevices.tooltip+='<i class="device-popover-icon '+t.deviceIcons[r.device_type]+(o?" monster-green":" monster-red")+'"></i>'+r.name+" ("+r.device_type.replace("_"," ")+")<br>");var u={id:r.id,name:r.name+" ("+r.device_type.replace("_"," ")+")",type:r.device_type,registered:o,icon:t.deviceIcons[r.device_type]};r.device_type==="mobile"&&(u.mobile=r.mobile),s[i].extra.devices.push(u)}});var o=[];return n.each(s,function(e){o.push(e)}),o=i.util.sort(o,"last_name"),r.users=o,r},usersBindEvents:function(e,r,s){var u=this,a="",f,l,c=s.existingExtensions,h,p,d,v,m=u.i18n.active().users.toastrMessages,g,y,b=s,w=function(e){i.parallel({userDevices:function(e){u.usersListDeviceUser(f.id,function(t){e(null,t)})},userCallflow:function(e){u.usersGetMainCallflow(f.id,function(t){e(null,t)})}},function(n,r){u.usersRenderFindMeFollowMe(t.extend(!0,r,{currentUser:f,saveCallback:e}))})};setTimeout(function(){e.find(".search-query").focus()}),e.find(".grid-row:not(.title) .grid-cell").on("click",function(){var r=t(this),s=r.data("type"),o=r.parents(".grid-row"),a=o.data("id");e.find(".edit-user").slideUp("400",function(){t(this).empty()}),r.hasClass("active")?(e.find(".grid-cell").removeClass("active"),e.find(".grid-row").removeClass("active"),u.usersRemoveOverlay(),r.css({position:"initial","z-index":"0"}),r.parent().siblings(".edit-user").css({position:"initial","z-index":"0","border-top-color":"#a6a7a9"})):(e.find(".grid-cell").removeClass("active"),e.find(".grid-row").removeClass("active"),r.toggleClass("active"),o.toggleClass("active"),r.css({position:"relative","z-index":"2"}),r.parent().siblings(".edit-user").css({position:"relative","z-index":"2","border-top-color":"transparent"}),u.usersGetTemplate(s,a,b,function(e,r){s==="name"?(f=r,e.find("#user_timezone").chosen({search_contains:!0,width:"220px"}),r.extra.differentEmail?e.find(".email-group").show():e.find(".email-group").hide(),r.extra.mainDirectoryId&&(g=r.extra.mainDirectoryId),r.extra.mainCallflowId&&(y=r.extra.mainCallflowId)):s==="numbers"?(h=[],d=[],l=r.callflow,f=r.user,i.ui.tooltips(e),n.each(r.extensions,function(e){h.push(e)})):s==="extensions"?(c=r.allExtensions,l=r.callflow,f=r.user,p=[],n.each(r.assignedNumbers,function(e){p.push(e.phoneNumber)})):s==="features"?f=r:s==="devices"&&(setTimeout(function(){e.find(".search-query").focus()}),f=a,v={}),o.find(".edit-user").append(e).slideDown(400,function(){t("body").animate({scrollTop:o.offset().top-(window.innerHeight-o.height()-10)})}),t("body").append(t('<div id="users_container_overlay"></div>'))}))}),e.find(".users-header .search-query").on("keyup",function(){var r=t(this).val().toLowerCase(),i=e.find(".user-rows .grid-row:not(.title)"),s=e.find(".user-rows .empty-search-row");n.each(i,function(e){var e=t(e);e.data("search").toLowerCase().indexOf(r)<0?e.hide():e.show()}),i.size()>0&&(i.is(":visible")?s.hide():s.show())}),e.find(".users-header .add-user").on("click",function(){i.parallel({callflows:function(e){u.usersListCallflows(function(t){e(null,t)})},vmboxes:function(e){u.usersListVMBoxes(function(t){e(null,t)})}},function(e,n){var r=u.usersFormatAddUser(n),s=t(i.template(u,"users-creation",r));i.ui.validate(s.find("#form_user_creation"),{rules:{"callflow.extension":{checkList:r.listExtensions},"vmbox.number":{checkList:r.listVMBoxes},"user.password":{minlength:6}},messages:{"user.first_name":{required:u.i18n.active().validation.required},"user.last_name":{required:u.i18n.active().validation.required},"callflow.extension":{required:u.i18n.active().validation.required}}}),i.ui.showPasswordStrength(s.find("#password")),s.find("#create_user").on("click",function(){if(i.ui.valid(s.find("#form_user_creation"))){var e=i.ui.getFormData("form_user_creation"),t=u.usersFormatCreationData(e);u.usersCreate(t,function(e){o.dialog("close").remove(),u.usersRender({userId:e.user.id})})}}),s.find("#notification_email").on("change",function(){s.find(".email-group").toggleClass("hidden")});var o=i.ui.dialog(s,{title:u.i18n.active().users.dialogCreationUser.title})})}),e.on("click",".cancel-link",function(){e.find(".edit-user").slideUp("400",function(){t(this).empty(),e.find(".grid-cell.active").css({position:"inline-block","z-index":"0"}),e.find(".grid-row.active .edit-user").css({position:"block","z-index":"0"}),e.find(".grid-row.active").removeClass("active"),u.usersRemoveOverlay(),e.find(".grid-cell.active").removeClass("active")})}),e.on("click",".save-extensions",function(){var n=t(this),r=t.extend(!0,[],p),s=n.parents(".grid-row").find(".grid-cell.name").text(),a=n.parents(".grid-row").data("id"),c=[];e.find(".extensions .list-assigned-items .item-row").each(function(e,n){var n=t(n),i;i=(n.data("id")?n.data("id"):n.find(".input-extension").val())+"",r.push(i),c.push(i)});if(r.length>0){var h=function(){u.usersUpdateCallflowNumbers(a,(l||{}).id,r,function(e){o.success(i.template(u,"!"+m.numbersUpdated,{name:s})),u.usersRender({userId:e.owner_id})})};if(u.usersHasProperPresenceId(c,f))h();else{var d=f.presence_id;u.usersUpdatePresenceIDPopup(c,f,function(e){u.usersUpdateUser(e,function(){u.usersSmartUpdateVMBox({user:e,callback:function(){h()},oldPresenceId:d,userExtension:c[0]})})})}}else i.ui.alert("warning",u.i18n.active().users.noNumberCallflow)}),e.on("click","#add_extensions",function(){var n=parseInt(i.util.getNextExtension(c))+"",r={recommendedExtension:n},s=t(i.template(u,"users-newExtension",r)),o=e.find(".extensions .list-assigned-items");o.find(".empty-row").hide(),o.append(s),c.push(n)}),e.on("click",".remove-extension",function(){var n=t(this).parents(".item-row"),r=n.siblings(".empty-row");n.slideUp(function(){n.remove(),e.find(".list-assigned-items .item-row").is(":visible")||r.slideDown()})}),e.on("click",".cancel-extension-link",function(){var e=t(this).siblings("input").val(),n=c.indexOf(e);n>-1&&c.splice(n,1),t(this).parents(".item-row").remove()}),e.on("click","#delete_user",function(){var e=t(this).parents(".grid-row").data(),n=e.priv_level==="admin"?"confirmDeleteAdmin":"confirmDeleteUser";i.ui.confirm(u.i18n.active().users[n],function(){u.usersDelete(e.id,function(e){o.success(i.template(u,"!"+m.userDeleted))})})}),e.on("change","#notification_email",function(){e.find(".email-border").hasClass("open")?(e.find(".email-border").removeClass("open",400),e.find(".email-group").slideUp()):(e.find(".email-group").slideDown(),e.find(".email-border").addClass("open",400))}),e.on("click",".save-user",function(){var n=i.ui.getFormData("form-"+f.id),r=e.find("#form-"+f.id);i.util.checkVersion(f,function(){if(i.ui.valid(r)){f.extra.vmbox.timezone=n.timezone;var e=t.extend(!0,{},f,n),s=f.presence_id;i.parallel({vmbox:function(t){u.usersSmartUpdateVMBox({user:e,callback:function(e){t(null,e)},oldPresenceId:s})},user:function(t){u.usersUpdateUser(e,function(e){t(null,e.data)})},callflow:function(t){e.extra.ringingTimeout&&e.features.indexOf("find_me_follow_me")<0?u.usersGetMainCallflow(e.id,function(n){if("flow"in n){var r=n.flow;while(r.module!="user"&&"_"in r.children)r=r.children._;r.data.timeout=parseInt(e.extra.ringingTimeout),u.usersUpdateCallflow(n,function(e){t(null,e)})}else t(null,null)}):t(null,null)}},function(e,t){o.success(i.template(u,"!"+m.userUpdated,{name:t.user.first_name+" "+t.user.last_name})),u.usersRender({userId:t.user.id})})}})}),e.on("click","#change_pin",function(){var e=t(i.template(u,"users-changePin")),n=e.find("#form_new_pin");i.ui.validate(n,{rules:{pin:{number:!0,minlength:4,min:0}}}),e.find(".save-new-pin").on("click",function(){var e=i.ui.getFormData("form_new_pin"),s=t.extend(!0,f.extra.vmbox,e);i.ui.valid(n)&&u.usersUpdateVMBox(s,function(e){r.dialog("close").remove(),o.success(i.template(u,"!"+m.pinUpdated,{name:f.first_name+" "+f.last_name}))})}),e.find(".cancel-link").on("click",function(){r.dialog("close").remove()});var r=i.ui.dialog(e,{title:u.i18n.active().users.dialogChangePin.title})}),e.on("click","#change_username",function(){var n=t(i.template(u,"users-changePassword",f)),r=n.find("#form_new_username");i.ui.showPasswordStrength(n.find("#inputPassword")),i.ui.validate(r,{rules:{password:{minlength:6}}}),n.find(".save-new-username").on("click",function(){var n=i.ui.getFormData("form_new_username"),a=t.extend(!0,{},f,n);i.ui.valid(r)&&(f.extra.differentEmail||(a.email=a.username),u.usersUpdateUser(a,function(t){f.username=t.data.username,e.find("#username").html(t.data.username),f.extra.differentEmail||(e.find("#email").val(t.data.email),f.email=t.username),s.dialog("close").remove(),o.success(i.template(u,"!"+m.userUpdated,{name:t.data.first_name+" "+t.data.last_name}))}))}),n.find(".cancel-link").on("click",function(){s.dialog("close").remove()});var s=i.ui.dialog(n,{title:u.i18n.active().users.dialogChangePassword.title})}),e.on("click","#open_fmfm_link",function(){w(function(e){e.openedTab="name",u.usersRender(e)})}),e.on("focus",".ringing-timeout.disabled #ringing_timeout",function(){t(this).blur()}),e.on("click",".create-device",function(){var n=t(this),r=n.data("type"),s=n.parents(".grid-row").data("id");i.pub("voip.devices.renderAdd",{type:r,callback:function(t){var n=i.template(u,"users-rowSpareDevice",t),r=e.find(".list-assigned-items");r.find(".empty-row").hide(),r.append(n)}})}),e.on("click",".spare-devices:not(.disabled)",function(){var r=t.map(e.find(".device-list.list-assigned-items .item-row"),function(e){return t(e).data("id")});u.usersGetDevicesData(function(t){var s={};n.each(t,function(e){(!("owner_id"in e)||e.owner_id===""||e.owner_id===f)&&r.indexOf(e.id)===-1&&(s[e.id]=e)}),i.pub("common.monsterListing.render",{dataList:s,dataType:"devices",okCallback:function(t){n.each(t,function(t){var n=i.template(u,"users-rowSpareDevice",t),r=e.find(".list-assigned-items");r.find(".empty-row").hide(),r.append(n),t.owner_id&&delete v[t.id]})}})})}),e.on("click",".save-devices",function(){var n={"new":[],old:[]},r=t(this).parents(".grid-row").find(".grid-cell.name").text(),s=t(this).parents(".grid-row").data("id");e.find(".detail-devices .list-assigned-items .item-row:not(.assigned)").each(function(e,r){n.new.push(t(r).data("id"))}),n.old=Object.keys(v),u.usersUpdateDevices(n,s,function(){o.success(i.template(u,"!"+m.devicesUpdated,{name:r})),u.usersRender({userId:s})})}),e.on("click",".detail-devices .edit-device-link",function(){var e=t(this).parents(".item-row"),n=e.data("id");i.pub("voip.devices.editDevice",{data:{id:n},callbackSave:function(t){e.find(".edit-device").html(t.name)},callbackDelete:function(t){e.remove()}})}),e.on("click",".detail-devices .list-assigned-items .remove-device",function(){var r=t(this).parents(".item-row"),o=e.find(".grid-row.active").data("id"),a=r.data("id"),f=n.find(s.users,function(e,t){return e.id===o}),l=n.find(f.extra.devices,function(e,t){return e.id===a}),c=function(){r.hasClass("assigned")&&(v[r.data("id")]=!0),r.remove();var t=e.find(".detail-devices .list-assigned-items .item-row");t.is(":visible")===!1&&e.find(".detail-devices .list-assigned-items .empty-row").show()};l&&l.type==="mobile"?i.ui.confirm(u.i18n.active().users.confirmMobileUnAssignment.replace("{{variable}}",i.util.formatPhoneNumber(l.mobile.mdn)),c):c()}),e.on("click",".detail-numbers .list-assigned-items .remove-number",function(){var n=t(this),r=n.parents(".item-row");r.data("type")!=="mobile"&&(d.push(r.data("id")),r.slideUp(function(){r.remove(),e.find(".list-assigned-items .item-row").is(":visible")||e.find(".list-assigned-items .empty-row").slideDown(),e.find(".spare-link").removeClass("disabled")}))}),e.on("click",".actions .spare-link:not(.disabled)",function(r){r.preventDefault();var s=t(this),o={accountName:i.apps.auth.currentAccount.name,accountId:u.accountId,ignoreNumbers:t.map(e.find(".item-row"),function(e){return t(e).data("id")}),extraNumbers:d,callback:function(r,s){e.find(".empty-row").hide(),n.each(r,function(r,s){r.isLocal=r.features.indexOf("local")>-1,e.find(".list-assigned-items").append(t(i.template(u,"users-numbersItemRow",{isCnamEnabled:i.util.isNumberFeatureEnabled("cnam"),isE911Enabled:i.util.isNumberFeatureEnabled("e911"),number:r}))),d=n.without(d,r.phoneNumber)}),i.ui.tooltips(e),s==0&&e.find(".spare-link").addClass("disabled")}};i.pub("common.numbers.dialogSpare",o)}),e.on("click",".actions .buy-link",function(r){r.preventDefault(),i.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(r){i.pub("common.numbers.getListFeatures",function(s){n.each(r,function(n,r){n.viewFeatures=t.extend(!0,{},s),n.phoneNumber=n.id;var o=t(i.template(u,"users-numbersItemRow",{isCnamEnabled:i.util.isNumberFeatureEnabled("cnam"),isE911Enabled:i.util.isNumberFeatureEnabled("e911"),number:n}));i.ui.tooltips(o),e.find(".list-unassigned-items .empty-row").hide(),e.find(".list-unassigned-items").append(o)})})}}})}),e.on("click",".save-numbers",function(){var n=t(this),r=t.extend(!0,[],h),s=n.parents(".grid-row").find(".grid-cell.name").text(),a=n.parents(".grid-row").data("id");e.find(".item-row").each(function(e,n){var n=t(n),i=n.data("id");r.push(i)}),r.length>0?u.usersUpdateCallflowNumbers(a,(l||{}).id,r,function(e){var t=function(){o.success(i.template(u,"!"+m.numbersUpdated,{name:s})),u.usersRender({userId:e.owner_id})};f.caller_id.hasOwnProperty("external")&&f.caller_id.external.hasOwnProperty("number")&&e.numbers.indexOf(f.caller_id.external.number)<0?(delete f.caller_id.external.number,u.usersUpdateUser(f,function(){t(),o.info(m.callerIDDeleted)})):t()}):i.ui.alert("warning",u.i18n.active().users.noNumberCallflow)}),i.util.isNumberFeatureEnabled("cnam")&&e.on("click",".callerId-number",function(){var e=t(this).parents(".item-row").first(),n=e.data("id");if(n){var r={phoneNumber:n,callbacks:{success:function(t){"cnam"in t.data&&t.data.cnam.display_name?e.find(".features i.feature-outbound_cnam").addClass("active"):e.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in t.data&&t.data.cnam.inbound_lookup?e.find(".features i.feature-inbound_cnam").addClass("active"):e.find(".features i.feature-inbound_cnam").removeClass("active")}}};i.pub("common.callerId.renderPopup",r)}}),i.util.isNumberFeatureEnabled("e911")&&e.on("click",".e911-number",function(){var e=t(this).parents(".item-row").first(),n=e.data("id");if(n){var r={phoneNumber:n,callbacks:{success:function(n){t.isEmptyObject(n.data.dash_e911)?e.find(".features i.feature-dash_e911").removeClass("active"):e.find(".features i.feature-dash_e911").addClass("active")}}};i.pub("common.e911.renderPopup",r)}}),e.on("click",".prepend-number",function(){var e=t(this).parents(".item-row").first(),n=e.data("id");if(n){var r={phoneNumber:n,callbacks:{success:function(t){"prepend"in t.data&&t.data.prepend.enabled?e.find(".features i.feature-prepend").addClass("active"):e.find(".features i.feature-prepend").removeClass("active")}}};i.pub("common.numberPrepend.renderPopup",r)}}),e.on("click",'.feature[data-feature="caller_id"]',function(){u.usersRenderCallerId(f)}),e.on("click",'.feature[data-feature="call_forward"]',function(){if(f.features.indexOf("find_me_follow_me")<0){var e=t.extend(!0,{},f);u.usersGetMainCallflow(e.id,function(t){if(t&&"flow"in t){var n=t.flow;while(n.module!="user"&&"_"in n.children)n=n.children._;n.data.timeout<30&&(e.extra.timeoutTooShort=!0)}u.usersRenderCallForward(e)})}else u.usersRenderCallForward(f)}),e.on("click",'.feature[data-feature="hotdesk"]',function(){u.usersRenderHotdesk(f)}),e.on("click",'.feature[data-feature="find_me_follow_me"]',function(){w()}),e.on("click",'.feature[data-feature="call_recording"]',function(){u.usersGetMainCallflow(f.id,function(e){e?u.usersRenderCallRecording({userCallflow:e,currentUser:f}):i.ui.alert("error",u.i18n.active().users.callRecording.noNumber)})}),e.on("click",'.feature[data-feature="music_on_hold"]',function(){u.usersRenderMusicOnHold(f)}),e.on("click",'.feature[data-feature="vm_to_email"]',function(){u.usersListVMBoxesUser(f.id,function(e){f.extra.deleteAfterNotify=!0,e.length>0?u.usersGetVMBox(e[0].id,function(e){f.extra.deleteAfterNotify=e.delete_after_notify,u.usersRenderVMToEmail(f)}):u.usersRenderVMToEmail(f)})}),e.on("click",'.feature[data-feature="conferencing"]',function(){u.usersGetConferenceFeature(f.id,function(e){var t={listConferences:e.listConfNumbers,user:f,conference:e.conference};n.isEmpty(t.listConferences)?i.ui.alert("error",u.i18n.active().users.conferencing.noConfNumbers):u.usersRenderConferencing(t)})}),e.on("click",'.feature[data-feature="faxing"]',function(){i.util.isTrial()?i.ui.alert("warning",u.i18n.active().users.faxing.trialError):i.parallel({numbers:function(e){u.usersListNumbers(function(t){var r={};n.each(t.numbers,function(e,t){e.used_by===""&&(r[t]=e)}),e&&e(null,r)})},callflows:function(e){u.usersListCallflowsUser(f.id,function(t){var r;n.each(t,function(e){if(e.type==="faxing")return r=e,!1}),r?u.callApi({resource:"callflow.get",data:{accountId:u.accountId,callflowId:r.id},success:function(t,n){e&&e(null,t.data)}}):e&&e(null,r)})},account:function(e){u.callApi({resource:"account.get",data:{accountId:u.accountId},success:function(t,n){e(null,t.data)}})}},function(e,t){t.user=f;if(typeof t.callflows!="undefined"){var n=t.callflows.flow.data.hasOwnProperty("faxbox_id")?t.callflows.flow.data.faxbox_id:t.callflows.flow.data.id;u.callApi({resource:"faxbox.get",data:{accountId:u.accountId,faxboxId:n},success:function(e){t.faxbox=e.data,t.faxbox.id=n,u.usersRenderFaxboxes(t)},error:function(){u.usersRenderFaxboxes(t)}})}else u.usersRenderFaxboxes(t)})}),t("body").on("click","#users_container_overlay",function(){e.find(".edit-user").slideUp("400",function(){t(this).empty()}),u.usersRemoveOverlay(),e.find(".grid-cell.active").css({position:"inline-block","z-index":"0"}),e.find(".grid-row.active").parent().siblings(".edit-user").css({position:"block","z-index":"0"}),e.find(".grid-cell.active").removeClass("active"),e.find(".grid-row.active").removeClass("active")})},usersUpdatePresenceIDPopup:function(e,n,r){var s=this,o={numbers:e},u=t(i.template(s,"users-changePresenceIDPopup",o)),a=u.find(".presence-id-option");a.on("click",function(){a.removeClass("active"),t(this).addClass("active")}),u.find(".save-presence-id").on("click",function(){var e=u.find(".presence-id-option.active").data("number");e!=="none"?n.presence_id=e+"":delete n.presence_id,f.dialog("close").remove(),r&&r(n)}),u.find(".cancel-link").on("click",function(){f.dialog("close").remove()});var f=i.ui.dialog(u,{title:s.i18n.active().users.presenceIDPopup.title,position:["center",20]})},usersHasProperPresenceId:function(e,t){var r=this;if(t.presence_id){var i=!1,s=""+t.presence_id;return n.each(e,function(e){e===s&&(i=!0)}),i}return e.length?!1:!0},usersFormatAddUser:function(e){var t=this,r={sendToSameEmail:!0,nextExtension:"",listExtensions:{},listVMBoxes:{}},s=[],o=[],u=[];return n.each(e.callflows,function(e){n.each(e.numbers,function(t){t.length<7&&(r.listExtensions[t]=e,s.push(t))})}),n.each(e.vmboxes,function(e){r.listVMBoxes[e.mailbox]=e,o.push(e.mailbox)}),u=s.concat(o),r.nextExtension=parseInt(i.util.getNextExtension(u))+"",r},usersFormatFaxingData:function(e){var r=[],i={};return n.each(e.numbers,function(e,t){r.push(t)}),r.sort(function(e,t){return e<t?-1:1}),e.callflows&&e.callflows.numbers.length>0&&(i[e.callflows.numbers[0]]=e.callflows.numbers[0]),n.each(r,function(e,t){i[e]=e}),e.extra=t.extend(!0,{},e.extra,{listNumbers:i}),e},usersRenderConferencing:function(e){var n=this,e=n.usersFormatConferencingData(e),r=t(i.template(n,"users-feature-conferencing",e)),s=r.find(".switch-state"),o=r.find("#conferencing_form");i.ui.validate(o),r.find(".cancel-link").on("click",function(){u.dialog("close").remove()}),s.on("change",function(){t(this).prop("checked")?r.find(".content").slideDown():r.find(".content").slideUp()}),r.find(".save").on("click",function(){var t={openedTab:"features",callback:function(){u.dialog("close").remove()}};i.ui.valid(o)&&(e.conference=i.ui.getFormData("conferencing_form"),s.prop("checked")?n.usersUpdateConferencing(e,function(e){t.userId=e.user.id,n.usersRender(t)}):n.usersDeleteConferencing(e.user.id,function(e){t.userId=e.user.data.id,n.usersRender(t)}))});var u=i.ui.dialog(r,{title:e.user.extra.mapFeatures.conferencing.title,position:["center",20]})},usersFormatConferencingData:function(e){return e},usersRenderFaxboxes:function(e){var r=this,e=r.usersFormatFaxingData(e),s=t(i.template(r,"users-feature-faxing",e)),o=s.find(".number-mirror"),u=s.find(".switch-state"),a=i.ui.dialog(s,{title:e.user.extra.mapFeatures.faxing.title,position:["center",20]});u.on("change",function(){t(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),i.pub("common.numberSelector.render",{container:s.find(".number-select"),inputName:"caller_id",number:e.hasOwnProperty("faxbox")?e.faxbox.caller_id:undefined,removeCallback:function(){s.find(".number-mirror").text(r.i18n.active().users.faxing.emailToFax.default)},globalAddNumberCallback:function(e,t){var r=!1,i=n.isObject(e)?Object.keys(e)[0]:e;t&&t(i),s.find(".number-mirror").text(i)}}),s.find("#helper_content").on("shown",function(){t(this).siblings("a").find(".text").text(r.i18n.active().users.faxing.emailToFax.help.hideHelp),t(this).find("#destination_number").focus()}),s.find("#helper_content").on("hidden",function(){t(this).siblings("a").find(".text").text(r.i18n.active().users.faxing.emailToFax.help.showHelp)}),s.find(".cancel-link").on("click",function(){a.dialog("close").remove()}),s.find(".save").on("click",function(){var t=s.find('input[name="caller_id"]').val(),n={openedTab:"features",callback:function(){a.dialog("close").remove()}};u.prop("checked")?t!==""?r.usersUpdateFaxing(e,t,function(e){n.userId=e.callflow.owner_id,r.usersRender(n)}):i.ui.alert("error",r.i18n.active().users.faxing.toastr.error.numberMissing):r.usersDeleteFaxing(e.user.id,function(){n.userId=e.user.id,r.usersRender(n)})})},usersRenderHotdesk:function(e){var n=this,r=t(i.template(n,"users-feature-hotdesk",e)),s=r.find(".switch-state"),o=r.find('[name="require_pin"]'),u=r.find("#hotdesk_form");i.ui.validate(u),r.find(".cancel-link").on("click",function(){a.dialog("close").remove()}),s.on("change",function(){t(this).prop("checked")?r.find(".content").slideDown():r.find(".content").slideUp()}),o.on("change",function(){o.is(":checked")?r.find("#pin").removeAttr("disabled","disabled").focus():r.find("#pin").val("").attr("disabled","disabled")}),r.find(".save").on("click",function(){if(i.ui.valid(u)){var r=i.ui.getFormData("hotdesk_form"),o={openedTab:"features",callback:function(){a.dialog("close").remove()}};r.enabled=s.prop("checked"),r.require_pin===!1&&delete r.pin,delete e.hotdesk,userToSave=t.extend(!0,{},e,{hotdesk:r}),n.usersUpdateUser(userToSave,function(e){o.userId=e.data.id,n.usersRender(o)})}});var a=i.ui.dialog(r,{title:e.extra.mapFeatures.hotdesk.title,position:["center",20]})},usersRenderVMToEmail:function(e){var r=this,s=t(i.template(r,"users-feature-vm_to_email",e)),o=s.find(".switch-state"),u=s.find("#vm_to_email_form");i.ui.validate(u),s.find(".cancel-link").on("click",function(){a.dialog("close").remove()}),o.on("change",function(){t(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),s.find(".save").on("click",function(){var s=i.ui.getFormData("vm_to_email_form"),f=t.extend(!0,{},e),l=o.prop("checked"),c={callback:function(){a.dialog("close").remove()},openedTab:"features"},h=function(e){r.usersUpdateUser(e,function(e){c.userId=e.data.id,r.usersRender(c)})},p=function(e,t,s){r.usersListVMBoxesUser(t,function(t){var o=[];n.each(t,function(t){o.push(function(n){r.usersGetVMBox(t.id,function(t){t.delete_after_notify!==e?(t.delete_after_notify=e,r.usersUpdateVMBox(t,function(e){n(null,e)})):n(null,t)})})}),i.parallel(o,function(e,t){s&&s(t)})})};f.vm_to_email_enabled=l,l===!0?i.ui.valid(u)&&(f.email=s.email,p(s.delete_after_notify,f.id,function(){h(f)})):h(f)});var a=i.ui.dialog(s,{title:e.extra.mapFeatures.vm_to_email.title,position:["center",20]})},usersRenderCallerId:function(e){var n=this,r=t(i.template(n,"users-feature-caller_id",e)),s=r.find(".switch-state");r.find(".cancel-link").on("click",function(){o.dialog("close").remove()}),s.on("change",function(){t(this).prop("checked")?r.find(".content").slideDown():r.find(".content").slideUp()}),r.find(".save").on("click",function(){var i=r.find(".switch-state"),s=e,u=t.extend(!0,{},{caller_id:{external:{}}},e),a={openedTab:"features",callback:function(){o.dialog("close").remove()}};if(i.prop("checked")){var f=r.find(".caller-id-select").val();u.caller_id.external.number=f}else u.caller_id.hasOwnProperty("external")&&delete u.caller_id.external.number;n.usersUpdateUser(u,function(e){a.userId=e.data.id,n.usersRender(a)})});if(e.extra.listCallerId.length>0)var o=i.ui.dialog(r,{title:e.extra.mapFeatures.caller_id.title,position:["center",20]});else i.ui.alert("error",n.i18n.active().users.errorCallerId)},usersRenderCallForward:function(e){var n=this,r=t(i.template(n,"users-feature-call_forward",e)),s=r.find(".switch-state"),o=r.find("#call_forward_form"),u={callback:function(){f.dialog("close").remove()},openedTab:"features"},a=r.find(".help-box.red-box");e.hasOwnProperty("call_forward")&&e.call_forward.require_keypress&&a.hide(),i.ui.validate(o),r.find('input[name="require_keypress"]').on("change",function(){a.toggle()}),r.find(".cancel-link").on("click",function(){f.dialog("close").remove()}),s.on("change",function(){t(this).prop("checked")?r.find(".content").slideDown():r.find(".content").slideUp()}),r.find(".save").on("click",function(){if(i.ui.valid(o)){var r=i.ui.getFormData("call_forward_form");r.require_keypress=!r.require_keypress,r.enabled=s.prop("checked"),r.number=i.util.unformatPhoneNumber(r.number,"keepPlus"),delete r.phoneType;var f=t.extend(!0,{},e,{call_forward:r});a.is(":visible")&&(u.openedTab="name"),n.usersUpdateUser(f,function(e){u.userId=e.data.id,n.usersRender(u)})}}),e.hasOwnProperty("call_forward")&&e.call_forward.number&&/^(\+1)/.test(e.call_forward.number)?r.find("#phoneType").val("mobile"):r.find("#phoneType").val("deskphone");var f=i.ui.dialog(r,{title:e.extra.mapFeatures.call_forward.title,position:["center",20]})},usersRenderFindMeFollowMe:function(e){var r=this;if(!e.userCallflow)i.ui.alert("error",r.i18n.active().users.find_me_follow_me.noNumber);else if(!e.userDevices||e.userDevices.length===0)i.ui.alert("error",r.i18n.active().users.find_me_follow_me.noDevice);else{var s=e.currentUser,o=e.userCallflow,u=t(i.template(r,"users-feature-find_me_follow_me",{currentUser:s})),a=u.find(".switch-state"),f=u.find("#find_me_follow_me_form"),l={callback:function(){p.dialog("close").remove()},openedTab:"features"},c={},h=o.flow;while(h.hasOwnProperty("module")&&["ring_group","user"].indexOf(h.module)<0)h=h.children._;endpoints=h.module==="ring_group"?h.data.endpoints:[],n.each(e.userDevices,function(e){c[e.id]=e}),endpoints=t.map(endpoints,function(e){if(c[e.id]){var t=c[e.id];return delete c[e.id],{id:e.id,delay:e.delay,timeout:e.timeout,name:t.name,icon:r.deviceIcons[t.device_type],disabled:!1}}}),n.each(c,function(e){endpoints.push({id:e.id,delay:0,timeout:0,name:e.name,icon:r.deviceIcons[e.device_type],disabled:!0})}),i.pub("common.ringingDurationControl.render",{container:f,endpoints:endpoints,hasDisableColumn:!0}),u.find(".cancel-link").on("click",function(){p.dialog("close").remove()}),a.on("change",function(){t(this).prop("checked")?u.find(".content").slideDown():u.find(".content").slideUp()}),u.find(".save").on("click",function(){var t=a.prop("checked");i.pub("common.ringingDurationControl.getEndpoints",{container:f,callback:function(u){s.smartpbx=s.smartpbx||{},s.smartpbx.find_me_follow_me=s.smartpbx.find_me_follow_me||{},s.smartpbx.find_me_follow_me.enabled=t&&u.length>0;var a={};t&&u.length>0?(a.module="ring_group",a.data={strategy:"simultaneous",timeout:20,endpoints:[]},n.each(u,function(e){a.data.endpoints.push({id:e.id,endpoint_type:"device",delay:e.delay,timeout:e.timeout}),e.delay+e.timeout>a.data.timeout&&(a.data.timeout=e.delay+e.timeout)})):(a.module="user",a.data={can_call_self:!1,id:s.id,timeout:20});var f=o.flow;while(f.hasOwnProperty("module")&&["ring_group","user"].indexOf(f.module)<0)f=f.children._;f.module=a.module,f.data=a.data,i.parallel({callflow:function(e){r.usersUpdateCallflow(o,function(t){e&&e(null,t.data)})},user:function(e){r.usersUpdateUser(s,function(t){e&&e(null,t.data)})}},function(t,n){l.userId=n.user.id,typeof e.saveCallback=="function"?e.saveCallback(l):r.usersRender(l)})}})});var p=i.ui.dialog(u,{title:s.extra.mapFeatures.find_me_follow_me.title,position:["center",20]})}},usersRenderCallRecording:function(e){var n=this,r=t.extend(!0,{user:e.currentUser},e.currentUser.extra.mapFeatures.call_recording.active?{url:e.userCallflow.flow.data.url,format:e.userCallflow.flow.data.format,timeLimit:e.userCallflow.flow.data.time_limit}:{}),s=t(i.template(n,"users-feature-call_recording",r)),o=s.find(".switch-state"),u=s.find("#call_recording_form"),a;i.ui.validate(u,{rules:{time_limit:{digits:!0}}}),s.find(".cancel-link").on("click",function(){a.dialog("close").remove()}),o.on("change",function(){t(this).prop("checked")?s.find(".content").slideDown():s.find(".content").slideUp()}),s.find(".save").on("click",function(){if(i.ui.valid(u)){var r=i.ui.getFormData("call_recording_form"),s=o.prop("checked");"smartpbx"in e.currentUser||(e.currentUser.smartpbx={}),"call_recording"in e.currentUser.smartpbx||(e.currentUser.smartpbx.call_recording={enabled:!1});if(e.currentUser.smartpbx.call_recording.enabled||s){e.currentUser.smartpbx.call_recording.enabled=s;var f=t.extend(!0,{},e.userCallflow);if(s)if(f.flow.module==="record_call")f.flow.data=t.extend(!0,{action:"start"},r);else{f.flow={children:{_:t.extend(!0,{},e.userCallflow.flow)},module:"record_call",data:t.extend(!0,{action:"start"},r)};var l=f.flow;while(l.children&&"_"in l.children){if(l.children._.module==="record_call"&&l.children._.data.action==="stop")break;if(l.children._.module==="voicemail"){var c=t.extend(!0,{},l.children._);l.children._={module:"record_call",data:{action:"stop"},children:{_:c}};break}l=l.children._}}else{f.flow=t.extend(!0,{},e.userCallflow.flow.children._);var l=f.flow;while(l.children&&"_"in l.children){if(l.children._.module==="record_call"){l.children=l.children._.children;break}l=l.children._}}n.usersUpdateCallflow(f,function(t){n.usersUpdateUser(e.currentUser,function(t){a.dialog("close").remove(),n.usersRender({userId:e.currentUser.id,openedTab:"features"})})})}else a.dialog("close").remove(),n.usersRender({userId:e.currentUser.id,openedTab:"features"})}}),a=i.ui.dialog(s,{title:e.currentUser.extra.mapFeatures.call_recording.title,position:["center",20]})},usersRenderMusicOnHold:function(e){var n=this,r="silence_stream://300000",s=undefined;n.usersListMedias(function(o){var u={user:e,silenceMedia:r,mediaList:o,media:"music_on_hold"in e&&"media_id"in e.music_on_hold?e.music_on_hold.media_id:r},a=t(i.template(n,"users-feature-music_on_hold",u)),f=a.find(".switch-state"),l,c=function(e){s=undefined,a.find(".upload-div input").val(""),a.find(".upload-div").slideUp(function(){a.find(".upload-toggle").removeClass("active")});if(e){var t=a.find(".media-dropdown");t.append('<option value="'+e.id+'">'+e.name+"</option>"),t.val(e.id)}};a.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:n.i18n.active().users.music_on_hold.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){s=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&i.ui.alert(n.i18n.active().users.music_on_hold.fileTooBigAlert),a.find(".upload-div input").val(""),s=undefined}}),a.find(".cancel-link").on("click",function(){l.dialog("close").remove()}),f.on("change",function(){t(this).prop("checked")?a.find(".content").slideDown():a.find(".content").slideUp()}),a.find(".upload-toggle").on("click",function(){t(this).hasClass("active")?a.find(".upload-div").stop(!0,!0).slideUp():a.find(".upload-div").stop(!0,!0).slideDown()}),a.find(".upload-cancel").on("click",function(){c()}),a.find(".upload-submit").on("click",function(){s?n.callApi({resource:"media.create",data:{accountId:n.accountId,data:{streamable:!0,name:s.name,media_source:"upload",description:s.name}},success:function(e,t){var r=e.data;n.callApi({resource:"media.upload",data:{accountId:n.accountId,mediaId:r.id,data:s.file},success:function(e,t){c(r)},error:function(e,t){n.callApi({resource:"media.delete",data:{accountId:n.accountId,mediaId:r.id,data:{}},success:function(e,t){}})}})}}):i.ui.alert(n.i18n.active().users.music_on_hold.emptyUploadAlert)}),a.find(".save").on("click",function(){var t=a.find(".media-dropdown option:selected").val(),r=f.prop("checked");"music_on_hold"in e||(e.music_on_hold={}),"media_id"in e.music_on_hold||r?(r?e.music_on_hold={media_id:t}:e.music_on_hold={},n.usersUpdateUser(e,function(t){l.dialog("close").remove(),n.usersRender({userId:e.id,openedTab:"features"})})):(l.dialog("close").remove(),n.usersRender({userId:e.id,openedTab:"features"}))}),l=i.ui.dialog(a,{title:e.extra.mapFeatures.music_on_hold.title,position:["center",20]})})},usersCleanUserData:function(e){var e=t.extend(!0,{},e),n=e.first_name+" "+e.last_name,r=n.substring(0,15),i={caller_id:{internal:{name:r},external:{name:r}}};return e=t.extend(!0,e,i),e.extra&&(e.extra.includeInDirectory===!1?"directories"in e&&e.extra.mainDirectoryId&&e.extra.mainDirectoryId in e.directories&&delete e.directories[e.extra.mainDirectoryId]:(e.directories=e.directories||{},e.extra.mainCallflowId&&(e.directories[e.extra.mainDirectoryId]=e.extra.mainCallflowId)),"differentEmail"in e.extra&&e.extra.differentEmail?"email"in e.extra&&(e.email=e.extra.email):e.email=e.username,"language"in e.extra&&(e.extra.language!=="auto"?e.language=e.extra.language:delete e.language)),e.hasOwnProperty("call_forward")&&e.call_forward.number===""&&delete e.call_forward.number,!e.hasOwnProperty("presence_id")||e.presence_id==="unset"||!e.presence_id?(delete e.presence_id,e.caller_id.hasOwnProperty("internal")&&delete e.caller_id.internal.number):e.caller_id.internal.number=e.presence_id+"",e.timezone==="inherit"&&delete e.timezone,delete e.include_directory,delete e.features,delete e.extra,delete e[""],e},usersGetTemplate:function(e,t,n,r){var i=this,s;e==="name"?i.usersGetNameTemplate(t,n,r):e==="numbers"?i.usersGetNumbersTemplate(t,r):e==="extensions"?i.usersGetExtensionsTemplate(t,r):e==="features"?i.usersGetFeaturesTemplate(t,n,r):e==="devices"&&i.usersGetDevicesTemplate(t,r)},usersGetFeaturesTemplate:function(e,r,s){var o=this;o.usersGetUser(e,function(e){n.each(r.users,function(n){n.id===e.id&&(e=t.extend(!0,e,n))});var u=o.usersFormatUserData(e);template=t(i.template(o,"users-features",u)),s&&s(template,u)})},usersGetNameTemplate:function(e,r,o){var u=this;i.parallel({mainCallflow:function(t){u.usersGetMainCallflow(e,function(e){t(null,e)})},mainDirectory:function(e){u.usersGetMainDirectory(function(t){e(null,t)})},user:function(t){u.usersGetUser(e,function(e){t(null,e)})},vmboxes:function(t){u.usersListVMBoxes(function(r){var i,s={listExisting:[],userVM:{}};n.each(r,function(t){s.listExisting.push(t.mailbox),t.owner_id===e&&!i&&(i=t.id)}),i?u.usersGetVMBox(i,function(e){s.userVM=e,t(null,s)}):t(null,s)})}},function(e,a){var f=a.user;n.each(r.users,function(e){if(e.id===a.user.id)return f=t.extend(!0,e,f),!1});var l=u.usersFormatUserData(f,a.mainDirectory,a.mainCallflow,a.vmboxes.userVM,a.vmboxes.listExisting);template=t(i.template(u,"users-name",l)),i.ui.validate(template.find("form.user-fields"),{rules:{"extra.ringingTimeout":{digits:!0}},messages:{first_name:{required:u.i18n.active().validation.required},last_name:{required:u.i18n.active().validation.required}}}),s.populateDropdown(template.find("#user_timezone"),l.timezone||"inherit",{inherit:u.i18n.active().defaultTimezone}),i.ui.tooltips(template,{options:{container:"body"}}),o&&o(template,l)})},usersGetDevicesData:function(e){var t=this;t.callApi({resource:"device.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(t.data)}})},usersGetNumbersData:function(e,n,r){var s=this,o={user:function(t){s.usersGetUser(e,function(e){t&&t(null,e)})},callflow:function(n){var r={};s.usersListCallflows(function(i){r.list=i;var o;t.each(i,function(t,n){if(n.owner_id===e&&n.type!=="faxing")return o=n.id,!1}),o?s.callApi({resource:"callflow.get",data:{accountId:s.accountId,callflowId:o},success:function(e){r.userCallflow=e.data,n&&n(null,r)}}):n&&n(null,r)})},numbers:function(e){s.usersListNumbers(function(t){e&&e(null,t)})}};r&&(o.devices=function(t){s.usersListDeviceUser(e,function(e){t&&t(null,e)})}),i.parallel(o,function(e,t){n&&n(t)})},usersGetNumbersTemplate:function(e,n){var r=this;r.usersGetNumbersData(e,function(s){r.usersFormatNumbersData(e,s,function(e){template=t(i.template(r,"users-numbers",t.extend(!0,{},e,{isCnamEnabled:i.util.isNumberFeatureEnabled("cnam"),isE911Enabled:i.util.isNumberFeatureEnabled("e911")}))),n&&n(template,e)})},!0)},usersGetDevicesTemplate:function(e,n){var r=this;r.usersGetDevicesData(function(s){var s=r.usersFormatDevicesData(e,s);template=t(i.template(r,"users-devices",s)),n&&n(template,s)})},usersGetExtensionsTemplate:function(e,n){var r=this;r.usersGetNumbersData(e,function(s){r.usersFormatNumbersData(e,s,function(e){template=t(i.template(r,"users-extensions",e)),n&&n(template,e)})})},usersFormatDevicesData:function(e,t){var r=this,i={countSpare:0,assignedDevices:{},unassignedDevices:{}};return n.each(t,function(t){if(t.owner_id===e)i.assignedDevices[t.id]=t;else if(t.owner_id===""||!("owner_id"in t))i.countSpare++,i.unassignedDevices[t.id]=t}),i.emptyAssigned=n.isEmpty(i.assignedDevices),i.emptySpare=n.isEmpty(i.unassignedDevices),i},usersFormatNumbersData:function(e,r,s){var o=this,u={countSpare:0,assignedNumbers:[],unassignedNumbers:{},callflow:r.callflow.userCallflow,extensions:[],user:r.user||{}};r.hasOwnProperty("devices")&&r.devices.length&&n.each(r.devices,function(e,t){e.device_type==="mobile"&&(r.numbers.numbers[e.mobile.mdn]={assigned_to:u.user.id,features:["mobile"],isLocal:!1,phoneNumber:e.mobile.mdn,state:"in_service",used_by:"mobile"})}),i.pub("common.numbers.getListFeatures",function(e){"numbers"in r.numbers&&n.each(r.numbers.numbers,function(r,i){r.viewFeatures=t.extend(!0,{},e),r.localityEnabled="locality"in r?!0:!1,n.each(r.features,function(e){e in r.viewFeatures&&(r.viewFeatures[e].active="active")}),r.used_by===""?(u.countSpare++,u.unassignedNumbers[i]=r):r.used_by==="mobile"&&u.assignedNumbers.push(r)}),u.callflow&&n.each(u.callflow.numbers,function(e){if(e in r.numbers.numbers){var t=r.numbers.numbers[e];t.phoneNumber=e,t.isLocal=t.features.indexOf("local")>-1,u.assignedNumbers.push(t)}else u.extensions.push(e)}),u.assignedNumbers=i.util.sort(u.assignedNumbers,"phoneNumber"),u.allExtensions=[],n.each(r.callflow.list,function(e){n.each(e.numbers,function(e){!(e in r.numbers.numbers)&&!n.isNaN(parseInt(e))&&u.allExtensions.push(e)})}),u.allExtensions.sort(function(e,t){var n=parseInt(e),r=parseInt(t),i=-1;return n>0&&r>0&&(i=n>r),i}),u.emptyAssigned=n.isEmpty(u.assignedNumbers),u.emptySpare=n.isEmpty(u.unassignedNumbers),u.emptyExtensions=n.isEmpty(u.extensions),s&&s(u)})},usersFormatCreationData:function(e,n){var r=this,i=e.user.first_name+" "+e.user.last_name,s=i.substring(0,15),o={user:t.extend(!0,{},{caller_id:{internal:{name:s,number:e.callflow.extension},external:{name:s}},presence_id:e.callflow.extension,email:e.extra.differentEmail?e.extra.email:e.user.username,priv_level:"user"},e.user),vmbox:{mailbox:e.callflow.extension,name:i+"'s VMBox"},callflow:{contact_list:{exclude:!1},flow:{children:{_:{children:{},data:{},module:"voicemail"}},data:{can_call_self:!1,timeout:20},module:"user"},name:i+" SmartPBX's Callflow",numbers:[(e.callflow||{}).extension]},extra:e.extra};return o},usersDelete:function(e,t){var r=this;i.parallel({devices:function(t){r.usersListDeviceUser(e,function(e){t(null,e)})},vmbox:function(t){r.usersListVMBoxesUser(e,function(e){t(null,e)})},callflows:function(t){r.usersListCallflowsUser(e,function(e){t(null,e)})}},function(t,s){var u=[];n.each(s.devices,function(e){u.push(function(t){r.usersUnassignDevice(e.id,function(e){t(null,"")})})}),n.each(s.callflows,function(e){u.push(function(t){r.usersDeleteCallflow(e.id,function(e){t(null,"")})})}),n.each(s.vmbox,function(e){u.push(function(t){r.usersDeleteVMBox(e.id,function(e){t(null,"")})})}),i.parallel(u,function(t,n){r.usersDeleteUser(e,function(e){o.success(i.template(r,"!"+r.i18n.active().users.toastrMessages.userDelete,{name:e.first_name+" "+e.last_name})),r.usersRender()})})})},usersDeleteUser:function(e,t){var n=this;n.callApi({resource:"user.delete",data:{userId:e,accountId:n.accountId,data:{}},success:function(e){t(e.data)}})},usersDeleteVMBox:function(e,t){var n=this;n.callApi({resource:"voicemail.delete",data:{voicemailId:e,accountId:n.accountId,data:{}},success:function(e){t(e.data)}})},usersUnassignDevice:function(e,t){var n=this;n.usersGetDevice(e,function(e){delete e.owner_id,n.usersUpdateDevice(e,function(e){t&&t(e)})})},usersDeleteDevice:function(e,t){var n=this;n.callApi({resource:"device.delete",data:{deviceId:e,accountId:n.accountId,data:{}},success:function(e){t(e.data)}})},usersDeleteCallflow:function(e,t){var n=this;n.callApi({resource:"callflow.delete",data:{callflowId:e,accountId:n.accountId,data:{}},success:function(e){t(e.data)}})},usersCreate:function(e,t){var n=this;n.callApi({resource:"user.create",data:{accountId:n.accountId,data:e.user},success:function(r){var i=r.data.id;e.user.id=i,e.vmbox.owner_id=i,n.usersCreateVMBox(e.vmbox,function(s){e.callflow.owner_id=i,e.callflow.type="mainUserCallflow",e.callflow.flow.data.id=i,e.callflow.flow.children._.data.id=s.id,n.usersCreateCallflow(e.callflow,function(i){e.extra.includeInDirectory?n.usersAddUserToMainDirectory(r.data,i.id,function(n){t(e)}):t(e)})})}})},usersMigrateFromExtensions:function(e,t,n){var r=this;r.usersGetUser(e,function(e){e.extra={vmbox:{mailbox:t[0]}};var i=e.first_name+" "+e.last_name,s={contact_list:{exclude:!1},flow:{children:{_:{children:{},data:{},module:"voicemail"}},data:{id:e.id,can_call_self:!1,timeout:20},module:"user"},name:i+" SmartPBX's Callflow",numbers:t,owner_id:e.id,type:"mainUserCallflow"};r.usersSmartUpdateVMBox({user:e,needVMUpdate:!1,callback:function(e){s.flow.children._.data.id=e.id,r.usersCreateCallflow(s,function(e){n&&n(e)},function(e,t){var i=function(){t&&t(e,{generateError:!0})};e.error==="400"&&e.hasOwnProperty("data")&&e.data.hasOwnProperty("numbers")&&e.data.numbers.hasOwnProperty("unique")?r.usersHasKazooUICallflow(s,function(e){r.usersMigrateKazooUIUser(s,e,n)},i):i()},!1)}})})},usersGetCallflowFromNumber:function(e,t){var r=this,i=!1;r.callApi({resource:"callflow.searchByNumber",data:{accountId:r.accountId,value:e},success:function(s){s.data.length>0?(n.each(s.data,function(s){n.each(s.numbers,function(n){n===e&&i===!1&&(i=!0,r.callApi({resource:"callflow.get",data:{accountId:r.accountId,callflowId:s.id},success:function(e){t&&t(e.data)}}))})}),i===!1&&t&&t({})):t&&t({})}})},usersHasKazooUICallflow:function(e,t,r){var s=this,o={},u=0,a;n.each(e.numbers,function(e){o[e]=function(t){s.usersGetCallflowFromNumber(e,function(e){if(!e.hasOwnProperty("ui_metadata")||!e.ui_metadata.hasOwnProperty("ui")||e.ui_metadata.ui!=="monster-ui")typeof a!="undefined"?e.id!==a.id&&u++:(u++,a=e);t&&t(null,{})})}}),i.parallel(o,function(e,n){u===0?r&&r():u>1?i.ui.alert(s.i18n.active().users.migration.tooManyCallflows):t&&t(a)})},usersMigrateKazooUIUser:function(e,t,r){var s=this,o=[];e.numbers=t.numbers,n.each(t.numbers,function(e){o.push("old_"+e+"_r"+i.util.randomString(6))}),t.numbers=o,i.ui.confirm(s.i18n.active().users.migration.confirmMigration,function(){s.usersUpdateCallflow(t,function(t){s.usersCreateCallflow(e,function(e){r&&r(e)})})})},usersAddUserToMainDirectory:function(e,t,n){var r=this;r.usersGetMainDirectory(function(i){e.directories=e.directories||{},e.directories[i.id]=t,r.usersUpdateUser(e,function(e){n&&n(e)})})},usersGetMainCallflow:function(e,t){var r=this;r.usersListCallflowsUser(e,function(i){var s=-1;n.each(i,function(t,n){if(t.owner_id===e&&t.type==="mainUserCallflow"||!("type"in t))return s=n,!1}),s===-1?t(null):r.callApi({resource:"callflow.get",data:{accountId:r.accountId,callflowId:i[s].id},success:function(e){t(e.data)},error:function(){t(i[s])}})})},usersSearchMobileCallflowsByNumber:function(e,t,n){var r=this;r.callApi({resource:"callflow.searchByNumber",data:{accountId:r.accountId,value:encodeURIComponent("+1"+t),filter_owner_id:e,filter_type:"mobile"},success:function(e){n(e.data[0])}})},usersGetMainDirectory:function(e){var t=this;t.usersListDirectories(function(r){var i=-1;n.each(r,function(e,t){if(e.name==="SmartPBX Directory")return i=t,!1}),i===-1?t.usersCreateMainDirectory(function(t){e(t)}):e(r[i])})},usersListDirectories:function(e){var t=this;t.callApi({resource:"directory.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(t.data)}})},usersCreateMainDirectory:function(e){var t=this,n={confirm_match:!1,max_dtmf:0,min_dtmf:3,name:"SmartPBX Directory",sort_by:"last_name"};t.callApi({resource:"directory.create",data:{accountId:t.accountId,data:n},success:function(t){e&&e(t.data)}})},usersListCallflows:function(e){var t=this;t.callApi({resource:"callflow.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e(t.data)}})},usersListCallflowsUser:function(e,t){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){t(e.data)}})},usersListVMBoxes:function(e){var t=this;t.callApi({resource:"voicemail.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e(t.data)}})},usersListVMBoxesUser:function(e,t){var n=this;n.callApi({resource:"voicemail.list",data:{accountId:n.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){t(e.data)}})},usersGetVMBox:function(e,t){var n=this;n.callApi({resource:"voicemail.get",data:{accountId:n.accountId,voicemailId:e},success:function(e){t(e.data)}})},usersCreateVMBox:function(e,t){var n=this;n.callApi({resource:"voicemail.create",data:{accountId:n.accountId,data:e},success:function(e){t(e.data)}})},usersUpdateVMBox:function(e,t){var n=this;delete e.timezone,n.callApi({resource:"voicemail.update",data:{accountId:n.accountId,data:e,voicemailId:e.id},success:function(e){t(e.data)}})},usersGetUser:function(e,t){var n=this;n.callApi({resource:"user.get",data:{accountId:n.accountId,userId:e},success:function(e){t&&t(e.data)}})},usersUpdateOriginalUser:function(e,t){var n=this;n.usersUpdateUserAPI(e,t,i.apps.auth.originalAccount.id)},usersUpdateUser:function(e,t){var n=this;e=n.usersCleanUserData(e),n.usersUpdateUserAPI(e,t,n.accountId)},usersUpdateUserAPI:function(e,t,n){var r=this;r.callApi({resource:"user.update",data:{accountId:n,userId:e.id,data:e},success:function(e){t&&t(e)}})},usersGetConferenceFeature:function(e,t){var n=this,r={conference:{},listConfNumbers:[]};i.parallel({confNumbers:function(e){n.usersListConfNumbers(function(t){e&&e(null,t)})},listConferences:function(t){n.usersListConferences(e,function(e){e.length>0?n.usersGetConference(e[0].id,function(e){t&&t(null,e)}):t&&t(null,{})})}},function(e,n){r.conference=n.listConferences,r.listConfNumbers=n.confNumbers,t&&t(r)})},usersListConfNumbers:function(e){var t=this;t.callApi({resource:"callflow.list",data:{accountId:t.accountId,filters:{filter_type:"conference",paginate:"false"}},success:function(t){var r=[];n.each(t.data,function(e){e.name==="MainConference"&&e.numbers.length>0&&e.numbers[0]!=="undefinedconf"&&(r=r.concat(e.numbers))}),e&&e(r)}})},usersListConferences:function(e,t){var n=this;n.callApi({resource:"conference.list",data:{accountId:n.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){t(e.data)}})},usersGetConference:function(e,t){var n=this;n.callApi({resource:"conference.get",data:{accountId:n.accountId,conferenceId:e},success:function(e){t(e.data)}})},usersUpdateConference:function(e,t){var n=this;n.callApi({resource:"conference.update",data:{accountId:n.accountId,conferenceId:e.id,data:e},success:function(e){t(e.data)}})},usersCreateConference:function(e,t){var n=this;n.callApi({resource:"conference.create",data:{accountId:n.accountId,data:e},success:function(e){t(e.data)}})},usersDeleteConference:function(e,t){var n=this;n.callApi({resource:"conference.delete",data:{accountId:n.accountId,conferenceId:e,data:{}},success:function(e){t(e.data)}})},usersGetDevice:function(e,t){var n=this;n.callApi({resource:"device.get",data:{accountId:n.accountId,deviceId:e},success:function(e){t(e.data)}})},usersUpdateDevice:function(e,t){var n=this;n.callApi({resource:"device.update",data:{accountId:n.accountId,data:e,deviceId:e.id},success:function(e){t(e.data)}})},usersListDeviceUser:function(e,t){var n=this;n.callApi({resource:"device.list",data:{accountId:n.accountId,filters:{filter_owner_id:e,paginate:"false"}},success:function(e){t(e.data)}})},usersListMedias:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId},success:function(t){e(t.data)}})},usersGetData:function(e){var t=this;i.parallel({users:function(e){t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e(null,t.data)}})},callflows:function(e){t.usersListCallflows(function(t){e(null,t)})},devices:function(e){t.usersGetDevicesData(function(t){e(null,t)})},deviceStatus:function(e){t.callApi({resource:"device.getStatus",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t,n){e(null,t.data)}})}},function(t,n){e&&e(n)})},usersUpdateDevices:function(e,r,s){var o=this,u=function(u){var a=[],f=function(e,t){o.usersUpdateDevice(e,function(e){t(null,e)})};n.each(e.new,function(e){a.push(function(n){o.usersGetDevice(e,function(i){i.owner_id=r,i.device_type==="mobile"?o.usersSearchMobileCallflowsByNumber(r,i.mobile.mdn,function(s){o.callApi({resource:"callflow.get",data:{accountId:o.accountId,callflowId:s.id},success:function(s,a){var l=s.data;u?t.extend(!0,l,{owner_id:r,flow:{module:"callflow",data:{id:u.id}}}):t.extend(!0,l,{owner_id:r,flow:{module:"device",data:{id:e}}}),o.usersUpdateCallflow(l,function(){f(i,n)})}})}):f(i,n)})})}),n.each(e.old,function(e){a.push(function(n){o.usersGetDevice(e,function(i){delete i.owner_id,i.device_type==="mobile"?o.usersSearchMobileCallflowsByNumber(r,i.mobile.mdn,function(r){o.callApi({resource:"callflow.get",data:{accountId:o.accountId,callflowId:r.id},success:function(r,s){var u=r.data;delete u.owner_id,t.extend(!0,u,{flow:{module:"device",data:{id:e}}}),o.usersUpdateCallflow(u,function(){f(i,n)})}})}):f(i,n)})})});if(e.old.length>0&&u&&u.flow.module==="ring_group"){var l=u.flow.data.endpoints.length;u.flow.data.endpoints=n.filter(u.flow.data.endpoints,function(t){return e.old.indexOf(t.id)<0}),u.flow.data.endpoints.length<l&&(u.flow.data.endpoints.length===0&&(u.flow.module="user",u.flow.data={can_call_self:!1,id:r,timeout:"20"},a.push(function(e){o.usersGetUser(r,function(t){t.smartpbx.find_me_follow_me.enabled=!1,o.usersUpdateUser(t,function(t){e(null,t)})})})),a.push(function(e){o.usersUpdateCallflow(u,function(t){e(null,t)})}))}i.parallel(a,function(e,t){s&&s(t)})};o.usersGetMainCallflow(r,function(e){u(e)})},usersUpdateCallflowNumbers:function(e,t,n,r){var i=this;n.length>0?t?i.callApi({resource:"callflow.get",data:{accountId:i.accountId,callflowId:t},success:function(e){e.data.numbers=n,i.usersUpdateCallflow(e.data,function(e){r&&r(e)})}}):n[0].length<7?i.usersMigrateFromExtensions(e,n,function(e){r&&r(e)}):o.error(i.i18n.active().users.needExtensionFirst):o.error(i.i18n.active().users.noNumberCallflow)},usersListNumbers:function(e){var t=this;t.callApi({resource:"numbers.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(t.data)}})},usersUpdateCallflow:function(e,t){var n=this;n.callApi({resource:"callflow.update",data:{accountId:n.accountId,callflowId:e.id,data:e},success:function(e){t&&t(e.data)}})},usersCreateCallflow:function(e,t,n,r){var i=this;i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:e,generateError:r===!1?!1:!0},success:function(e){t&&t(e.data)},error:function(e,t,r){n&&n(e,r)}})},usersSmartUpdateVMBox:function(e){var t=this,n=e.user,r=e.needVMUpdate||!0,i=e.callback,s=e.oldPresenceId||undefined,o=e.userExtension;t.usersListVMBoxesUser(n.id,function(e){if(e.length>0)r?t.usersGetVMBox(e[0].id,function(e){e.name=n.first_name+" "+n.last_name+"'s VMBox",s===e.mailbox&&(e.mailbox=n.presence_id&&n.presence_id!=="unset"?n.presence_id+"":e.mailbox),t.usersUpdateVMBox(e,function(e){i&&i(e)})}):i&&i(e[0]);else{var u={owner_id:n.id,mailbox:n.presence_id||o||n.extra.vmbox.mailbox,name:n.first_name+" "+n.last_name+"'s VMBox"};t.usersCreateVMBox(u,function(e){i&&i(e)})}})},usersUpdateConferencing:function(e,n){var r=this;i.parallel({conference:function(n){var i={name:e.user.first_name+" "+e.user.last_name+" SmartPBX Conference",owner_id:e.user.id,play_name_on_join:!0,member:{numbers:[],join_muted:!1}};i=t.extend(!0,{},i,e.conference),r.usersListConferences(e.user.id,function(e){var s=i;e.length>0?(s=t.extend(!0,{},e[0],i),r.usersUpdateConference(s,function(e){n&&n(null,e)})):r.usersCreateConference(s,function(e){n&&n(null,e)})})},user:function(t){e.user.smartpbx&&e.user.smartpbx.conferencing&&e.user.smartpbx.conferencing.enabled===!0?t&&t(null,e.user):(e.user.smartpbx=e.user.smartpbx||{},e.user.smartpbx.conferencing=e.user.smartpbx.conferencing||{},e.user.smartpbx.conferencing.enabled=!0,r.usersUpdateUser(e.user,function(e){t&&t(null,e.data)}))}},function(e,t){n&&n(t)})},usersUpdateFaxing:function(e,t,r){var s=this;i.parallel({callflow:function(r){var i={};s.usersListCallflowsUser(e.user.id,function(o){n.each(o,function(e){if(e.type==="faxing")return i.id=e.id,!1}),s.usersUpdateCallflowFaxing(e,t,i,function(e){r&&r(null,e)})})},user:function(t){e.user.smartpbx&&e.user.smartpbx.faxing&&e.user.smartpbx.faxing.enabled===!0?t&&t(null,e.user):(e.user.smartpbx=e.user.smartpbx||{},e.user.smartpbx.faxing=e.user.smartpbx.faxing||{},e.user.smartpbx.faxing.enabled=!0,s.usersUpdateUser(e.user,function(e){t&&t(null,e.data)}))}},function(e,t){r&&r(t)})},usersUpdateCallflowFaxing:function(e,n,r,s){var o=this,u=e.user,a=e.faxbox,f={type:"faxing",owner_id:u.id,numbers:[n],flow:{module:"faxbox",children:{},data:{id:e.hasOwnProperty("faxbox")?a.id:""}}},l={caller_id:n,fax_identity:i.util.formatPhoneNumber(n)};r=t.extend(!0,{},f,r);if(r.hasOwnProperty("id"))a=t.extend(!0,{},a,l),o.callApi({resource:"faxbox.update",data:{accountId:o.accountId,faxboxId:a.id,data:a},success:function(e,t){o.usersUpdateCallflow(r,function(e){s&&s(e)})}});else{var c={name:u.first_name.concat(" ",u.last_name,o.i18n.active().users.faxing.defaultSettings.nameExtension),caller_name:u.first_name.concat(" ",u.last_name),fax_header:i.config.whitelabel.companyName.concat(o.i18n.active().users.faxing.defaultSettings.headerExtension),fax_timezone:u.timezone,owner_id:u.id,notifications:{inbound:{email:{send_to:u.email}},outbound:{email:{send_to:u.email}}}};a=t.extend(!0,{},c,l),o.callApi({resource:"faxbox.create",data:{accountId:o.accountId,userId:u.id,data:a},success:function(e,t){r.flow.data.id=e.data.id,o.usersCreateCallflow(r,function(e){s&&s(e)})}})}},usersDeleteConferencing:function(e,t){var r=this;i.parallel({conferences:function(t){r.usersListConferences(e,function(e){var s=[];n.each(e,function(e){s.push(function(t){r.usersDeleteConference(e.id,function(e){t(null,e)})})}),i.parallel(s,function(e,n){t&&t(n)})})},user:function(t){r.usersGetUser(e,function(e){e.smartpbx=e.smartpbx||{},e.smartpbx.conferencing=e.smartpbx.conferencing||{},e.smartpbx.conferencing.enabled=!1,r.usersUpdateUser(e,function(e){t(null,e)})})}},function(e,n){t&&t(n)})},usersDeleteFaxing:function(e,t){var r=this;i.parallel({callflows:function(t){r.usersListCallflowsUser(e,function(e){var s=[];n.each(e,function(e){e.type==="faxing"&&s.push(function(t){r.callApi({resource:"callflow.get",data:{accountId:r.accountId,callflowId:e.id},success:function(n,i){r.callApi({resource:"faxbox.delete",data:{accountId:r.accountId,faxboxId:n.data.flow.data.faxbox_id||n.data.flow.data.id,generateError:!1},success:function(n,i){r.usersDeleteCallflow(e.id,function(e){t(null,e)})},error:function(n,i){r.usersDeleteCallflow(e.id,function(e){t(null,e)})}})}})})}),i.parallel(s,function(e,n){t&&t(n)})})},user:function(t){r.usersGetUser(e,function(e){e.smartpbx=e.smartpbx||{},e.smartpbx.faxing=e.smartpbx.faxing||{},e.smartpbx.faxing.enabled=!1,r.usersUpdateUser(e,function(e){t(null,e)})})}},function(e,n){t&&t(n)})},usersSortExtensions:function(e,t){var n=parseInt(e),r=parseInt(t),i=-1;return n>0&&r>0&&(i=n>r),i},usersRemoveOverlay:function(){t("body").find("#users_container_overlay").remove()}};return u});