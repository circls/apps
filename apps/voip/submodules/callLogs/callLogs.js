define(["require","jquery","underscore","monster"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i={requests:{},subscribe:{"voip.callLogs.render":"callLogsRender"},callLogsRender:function(e){var t=this;t.callLogsRenderContent(e.parent,e.fromDate,e.toDate,e.type,e.callback)},callLogsRenderContent:function(e,n,i,s,o){var u=this,a,f=1,l=31;if(!i&&!n){var c=r.util.getDefaultRangeDates(f);n=c.from,i=c.to}var h={timezone:"GMT"+jstz.determine_timezone().offset(),type:s||"today",fromDate:n,toDate:i,showFilteredDates:["thisMonth","thisWeek"].indexOf(s)>=0,showReport:r.config.whitelabel.callReportEmail?!0:!1};delete u.lastALeg,delete u.loneBLegs,u.callLogsGetCdrs(n,i,function(s,f){s=u.callLogsFormatCdrs(s),h.cdrs=s,a=t(r.template(u,"callLogs-layout",h));if(s&&s.length){var c=t(r.template(u,"callLogs-cdrsList",{cdrs:s,showReport:r.config.whitelabel.callReportEmail?!0:!1}));a.find(".call-logs-grid .grid-row-container").append(c)}var p={container:a,range:l};r.ui.initRangeDatepicker(p),a.find("#startDate").datepicker("setDate",n),a.find("#endDate").datepicker("setDate",i),f||a.find(".call-logs-loader").hide(),u.callLogsBindEvents({template:a,cdrs:s,fromDate:n,toDate:i,nextStartKey:f}),r.ui.tooltips(a),e.empty().append(a),o&&o()})},callLogsBindEvents:function(e){function l(){var e=s.find(".call-logs-loader");f?(e.toggleClass("loading"),e.find(".loading-message > i").toggleClass("fa-spin"),i.callLogsGetCdrs(u,a,function(n,u){n=i.callLogsFormatCdrs(n),cdrsTemplate=t(r.template(i,"callLogs-cdrsList",{cdrs:n,showReport:r.config.whitelabel.callReportEmail?!0:!1})),f=u,f||s.find(".call-logs-loader").hide(),s.find(".call-logs-grid .grid-row-container").append(cdrsTemplate),o=o.concat(n);var a=s.find(".search-div input.search-query");a.val()&&a.keyup(),e.toggleClass("loading"),e.find(".loading-message > i").toggleClass("fa-spin")},f)):e.hide()}var i=this,s=e.template,o=e.cdrs,u=e.fromDate,a=e.toDate,f=e.nextStartKey;setTimeout(function(){s.find(".search-query").focus()}),s.find(".apply-filter").on("click",function(e){var t=s.find("input.filter-from").datepicker("getDate"),n=s.find("input.filter-to").datepicker("getDate");i.callLogsRenderContent(s.parents(".right-content"),t,n,"custom")}),s.find(".fixed-ranges button").on("click",function(e){var n=t(this),r=n.data("type");s.find(".fixed-ranges button").removeClass("active"),n.addClass("active");if(r!=="custom"){s.find(".call-logs-content").empty();var o=i.callLogsGetFixedDatesFromType(r);i.callLogsRenderContent(s.parents(".right-content"),o.from,o.to,r)}else s.find(".fixed-ranges-date").hide(),s.find(".custom-range").addClass("active")}),s.find(".download-csv").on("click",function(e){var t=r.util.dateToBeginningOfGregorianDay(u),n=r.util.dateToEndOfGregorianDay(a);window.location.href=i.apiUrl+"accounts/"+i.accountId+"/cdrs?created_from="+t+"&created_to="+n+"&accept=text/csv&auth_token="+i.authToken}),s.find(".search-div input.search-query").on("keyup",function(e){if(s.find(".grid-row-container .grid-row").length>0){var r=t(this).val().replace(/\|/g,"").toLowerCase(),i=!1;r.length<=0?(s.find(".grid-row-group").show(),i=!0):n.each(o,function(e){var o=(e.callId||e.id)+(e.bLegs.length>0?"|"+t.map(e.bLegs,function(e){return e.callId||e.id}).join("|"):""),u=(e.date+"|"+e.fromName+"|"+e.fromNumber+"|"+e.toName+"|"+e.toNumber+"|"+e.hangupCause+"|"+o).toLowerCase(),a=s.find('.grid-row.a-leg[data-id="'+e.id+'"]').parents(".grid-row-group");if(u.indexOf(r)>=0)i=!0,a.show();else{var f=n.find(e.bLegs,function(e){var t=(e.date+"|"+e.fromName+"|"+e.fromNumber+"|"+e.toName+"|"+e.toNumber+"|"+e.hangupCause).toLowerCase();return t.indexOf(r)>=0});f?(i=!0,a.show()):a.hide()}}),i?s.find(".grid-row.no-match").hide():s.find(".grid-row.no-match").show()}}),s.on("click",".a-leg.has-b-legs",function(e){var n=t(this).parents(".grid-row-group");n.hasClass("open")?(n.removeClass("open"),n.find(".b-leg").slideUp()):(s.find(".grid-row-group").removeClass("open"),s.find(".b-leg").slideUp(),n.addClass("open"),n.find(".b-leg").slideDown())}),s.on("click",".grid-cell.details i",function(e){e.stopPropagation();var n=t(this).parents(".grid-row").data("id");i.callLogsShowDetailsPopup(n)}),s.on("click",".grid-cell.report a",function(e){e.stopPropagation()}),s.find(".call-logs-grid").on("scroll",function(e){var n=t(this);n.scrollTop()===n[0].scrollHeight-n.innerHeight()&&l()}),s.find(".call-logs-loader:not(.loading) .loader-message").on("click",function(e){l()})},callLogsGetFixedDatesFromType:function(e){var t=this,n=new Date,r=new Date;switch(e){case"today":break;case"thisWeek":var i=n.getDay(),s=(i||7)-1;n.setDate(n.getDate()-s);break;case"thisMonth":n.setDate(1);break;default:}return{from:n,to:r}},callLogsGetCdrs:function(e,t,i,s){var o=this,u=r.util.dateToBeginningOfGregorianDay(e),a=r.util.dateToEndOfGregorianDay(t),f={created_from:u,created_to:a,page_size:50};s&&(f.start_key=s),o.callApi({resource:"cdrs.list",data:{accountId:o.accountId,filters:f},success:function(e,t){var r={},s=n.groupBy(e.data,function(e){return e.direction==="inbound"||!e.bridge_id?"aLegs":"bLegs"});o.lastALeg&&s.aLegs.splice(0,0,o.lastALeg),e.next_start_key&&(o.lastALeg=s.aLegs.pop()),n.each(s.aLegs,function(e){var t=e.call_id||e.id;r[t]={aLeg:e,bLegs:{}}}),o.loneBLegs&&o.loneBLegs.length>0&&n.each(o.loneBLegs,function(e){"other_leg_call_id"in e&&e.other_leg_call_id in r&&(r[e.other_leg_call_id].bLegs[e.id]=e)}),o.loneBLegs=[],n.each(s.bLegs,function(e){"other_leg_call_id"in e&&(e.other_leg_call_id in r?r[e.other_leg_call_id].bLegs[e.id]=e:o.loneBLegs.push(e))}),i(r,e.next_start_key)}})},callLogsFormatCdrs:function(e){var i=this,s=[],o=function(e){var t=r.util.gregorianToDate(e.timestamp),n=r.util.toFriendlyDate(t,"shortDate"),s=r.util.toFriendlyDate(t,"time"),o=parseInt(e.duration_seconds/60).toString(),u=(e.duration_seconds%60<10?"0":"")+e.duration_seconds%60,a=i.i18n.active().hangupCauses,f="",l="authorizing_id"in e&&e.authorizing_id.length>0;return a.hasOwnProperty(e.hangup_cause)&&(l&&a[e.hangup_cause].hasOwnProperty("outbound")?f+=a[e.hangup_cause].outbound:!l&&a[e.hangup_cause].hasOwnProperty("inbound")&&(f+=a[e.hangup_cause].inbound)),{id:e.id,callId:e.call_id,timestamp:e.timestamp,date:n,time:s,fromName:e.caller_id_name,fromNumber:e.caller_id_number||e.from.replace(/@.*/,""),toName:e.callee_id_name,toNumber:e.callee_id_number||"request"in e?e.request.replace(/@.*/,""):e.to.replace(/@.*/,""),duration:o+":"+u,hangupCause:e.hangup_cause,hangupHelp:f,isOutboundCall:l,mailtoLink:"mailto:"+r.config.whitelabel.callReportEmail+"?subject=Call Report: "+e.call_id+"&body=Please describe the details of the issue:%0D%0A%0D%0A"+"%0D%0A____________________________________________________________%0D%0A"+"%0D%0AAccount ID: "+i.accountId+"%0D%0AFrom (Name): "+(e.caller_id_name||"")+"%0D%0AFrom (Number): "+(e.caller_id_number||e.from.replace(/@.*/,""))+"%0D%0ATo (Name): "+(e.callee_id_name||"")+"%0D%0ATo (Number): "+(e.callee_id_number||"request"in e?e.request.replace(/@.*/,""):e.to.replace(/@.*/,""))+"%0D%0ADate: "+n+"%0D%0ADuration: "+o+":"+u+"%0D%0AHangup Cause: "+(e.hangup_cause||"")+"%0D%0ACall ID: "+e.call_id+"%0D%0AOther Leg Call ID: "+(e.other_leg_call_id||"")+"%0D%0AHandling Server: "+(e.handling_server||"")}};return n.each(e,function(e,r){if("aLeg"in e){var i=o(e.aLeg);i.bLegs=[],n.each(e.bLegs,function(e,t){i.bLegs.push(o(e))}),s.push(i)}else n.each(e.bLegs,function(e,n){s.push(t.extend({bLegs:[]},o(e)))})}),s.sort(function(e,t){return t.timestamp-e.timestamp}),s},callLogsShowDetailsPopup:function(e){var t=this;t.callApi({resource:"cdrs.get",data:{accountId:t.accountId,cdrId:e},success:function(e,i){function s(e,t){var t=t||"",r=[];return n.each(e,function(e,n){typeof e=="object"?r=r.concat(s(e,t+n+".")):r.push({key:t+n,value:e})}),r}var o=s(e.data);o.sort(function(e,t){return e.key<t.key?-1:e.key>t.key?1:0}),r.ui.dialog(r.template(t,"callLogs-detailsPopup",{details:o}),{title:t.i18n.active().callLogs.detailsPopupTitle})},error:function(e,n){r.ui.alert("error",t.i18n.active().callLogs.alertMessages.getDetailsError)}})}};return i});