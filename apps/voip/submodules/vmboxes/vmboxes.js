define(["require","jquery","underscore","monster","toastr","monster-timezone"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s=e("monster-timezone"),o={requests:{},subscribe:{"voip.vmboxes.render":"vmboxesRender"},vmboxesRender:function(e){var i=this,e=e||{},s=e.parent||t(".right-content"),o=e.voicemailId||"",u=e.callback;i.vmboxesGetData(function(e){var a=i.vmboxesFormatListData(e),f=t(r.template(i,"vmboxes-layout",a)),l;n.each(a.vmboxes,function(e){l=r.template(i,"vmboxes-row",e),f.find(".vmboxes-rows").append(l)}),i.vmboxesBindEvents(f,s,a),s.empty().append(f);if(o){var c=s.find(".grid-row[data-id="+o+"]");r.ui.highlight(c,{endColor:"#FCFCFC"})}a.vmboxes.length==0?s.find(".no-vmboxes-row").css("display","block"):s.find(".no-vmboxes-row").css("display","none"),u&&u()})},vmboxesBindEvents:function(e,r,i){var s=this,o=function(e){s.vmboxesRender({voicemailId:e.id})};setTimeout(function(){e.find(".search-query").focus()}),e.find(".settings").on("click",function(){s.vmboxesRenderEdit(t(this).parents(".grid-row").data("id"),o)}),e.find(".add-vmbox").on("click",function(){s.vmboxesRenderEdit(undefined,o)}),e.find(".vmboxes-header .search-query").on("keyup",function(){var r=t(this).val().toLowerCase(),i=e.find(".vmboxes-rows .grid-row:not(.title)"),s=e.find(".vmboxes-rows .empty-search-row");n.each(i,function(e){var e=t(e);e.data("search").toLowerCase().indexOf(r)<0?e.hide():e.show()}),i.size()>0&&(i.is(":visible")?s.hide():s.show())})},vmboxesRenderEdit:function(e,t){var n=this;n.vmboxesGetEditData(e,function(e){e=n.vmboxesMigrateData(e),n.vmboxesRenderVmbox(e,t)})},vmboxesMigrateData:function(e){var t=this;return e.hasOwnProperty("notify_email_address")&&(e.notify_email_addresses=e.notify_email_address),e},vmboxesRenderVmbox:function(e,i){var s=this,o=e.id?"edit":"add",u=o==="edit"?r.template(s,"!"+s.i18n.active().vmboxes.editTitle,{name:e.name}):s.i18n.active().vmboxes.addTitle,a=t(r.template(s,"vmboxes-edit",e)),f={afterSave:function(e){l.dialog("close").remove(),i&&i(e)},afterDelete:function(e){l.dialog("close").remove(),s.vmboxesRender()},afterCancel:function(){l.dialog("close").remove()}};console.log(e),n.each(e.notify_email_addresses,function(e){a.find(".saved-entities").append(r.template(s,"vmboxes-emailRow",{name:e}))}),s.vmboxesEditBindEvents(a,e,f);var l=r.ui.dialog(a,{position:["center",20],title:u})},vmboxesEditBindEvents:function(e,n,o){var u=this,a=e.find("#form_vmbox");r.ui.validate(a,{rules:{name:{required:!0}}}),r.ui.tabs(e),s.populateDropdown(e.find("#timezone"),n.timezone||"inherit",{inherit:u.i18n.active().defaultTimezone}),e.find("#timezone").chosen({search_contains:!0,width:"220px"}),r.ui.tooltips(e),e.find(".actions .save").on("click",function(){if(r.ui.valid(a)){var t=u.vmboxesMergeData(n,e);u.vmboxesSaveVmbox(t,function(e){o.afterSave&&o.afterSave(e)})}else e.find('.tabs-selector[data-section="basic"]').click()}),e.find("#delete_vmbox").on("click",function(){var e=t(this).parents(".edit-vmbox").data("id");r.ui.confirm(u.i18n.active().vmboxes.confirmDeleteVmbox,function(){u.vmboxesDeleteVmbox(e,function(e){i.success(r.template(u,"!"+u.i18n.active().vmboxes.deletedVmbox,{vmboxName:e.name})),o.afterDelete&&o.afterDelete(e)})})}),e.find(".actions .cancel-link").on("click",function(){o.afterCancel&&o.afterCancel()});var f=function(t){t.preventDefault();var n=e.find("#entity_name"),i=n.val();templateFlag=r.template(u,"vmboxes-emailRow",{name:i}),e.find(".saved-entities").prepend(templateFlag),n.val("").focus()};e.find(".entity-wrapper.placeholder:not(.active)").on("click",function(){t(this).addClass("active"),e.find("#entity_name").focus()}),e.find("#cancel_entity").on("click",function(n){n.stopPropagation(),t(this).siblings("input").val(""),e.find(".entity-wrapper.placeholder").removeClass("active")}),e.find("#add_entity").on("click",function(e){f(e)}),e.find("#entity_name").on("keypress",function(e){var t=e.keyCode||e.which;t===13&&f(e)}),e.find(".saved-entities").on("click",".delete-entity",function(){t(this).parents(".entity-wrapper").remove()});var l,c=e.find(".greeting-container"),h=function(e){l=undefined,c.find(".upload-div input").val(""),c.find(".upload-div").slideUp(function(){c.find(".upload-toggle").removeClass("active")});if(e){var t=c.find(".media-dropdown");t.append('<option value="'+e.id+'">'+e.name+"</option>"),t.val(e.id)}};c.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"file-upload input-append",btnText:u.i18n.active().vmboxes.popupSettings.greeting.audioUploadButton,btnClass:"monster-button",maxSize:5,success:function(e){l=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&r.ui.alert(u.i18n.active().vmboxes.popupSettings.greeting.fileTooBigAlert),c.find(".upload-div input").val(""),l=undefined}}),c.find(".upload-toggle").on("click",function(){t(this).hasClass("active")?c.find(".upload-div").stop(!0,!0).slideUp():c.find(".upload-div").stop(!0,!0).slideDown()}),c.find(".upload-cancel").on("click",function(){h()}),c.find(".upload-submit").on("click",function(){l?u.callApi({resource:"media.create",data:{accountId:u.accountId,data:{streamable:!0,name:l.name,media_source:"upload",description:l.name}},success:function(e,t){var n=e.data;u.callApi({resource:"media.upload",data:{accountId:u.accountId,mediaId:n.id,data:l.file},success:function(e,t){h(n)},error:function(e,t){u.callApi({resource:"media.delete",data:{accountId:u.accountId,mediaId:n.id,data:{}},success:function(e,t){}})}})}}):r.ui.alert(u.i18n.active().vmboxes.popupSettings.greeting.emptyUploadAlert)})},vmboxesMergeData:function(e,n){var i=this,s=r.ui.getFormData("form_vmbox"),o=t.extend(!0,{},e,s);return o.notify_email_addresses=[],n.find(".saved-entities .entity-wrapper").each(function(){o.notify_email_addresses.push(t(this).data("name"))}),o.not_configurable=!s.extra.configurable,o.pin===""&&delete o.pin,o.hasOwnProperty("notify_email_address")&&delete o.notify_email_address,o.timezone&&o.timezone==="inherit"&&delete o.timezone,o.media&&o.media.unavailable==="none"&&delete o.media.unavailable,delete o.extra,o},vmboxesFormatData:function(e){var n=this,r={require_pin:!0,check_if_owner:!0},i=t.extend(!0,{},r,e.vmbox);return i.extra={mediaList:e.mediaList},i},vmboxesFormatListData:function(e){var t=this,r={countVMBoxes:e.vmboxes.length,vmboxes:e.vmboxes},i={};return n.each(e.users,function(e){i[e.id]=e}),r.vmboxes.sort(function(e,t){return parseInt(e.mailbox)>parseInt(t.mailbox)?1:-1}),n.each(r.vmboxes,function(e){e.hasOwnProperty("owner_id")&&i.hasOwnProperty(e.owner_id)?e.friendlyOwnerName=i[e.owner_id].first_name+" "+i[e.owner_id].last_name:e.friendlyOwnerName="-"}),r},vmboxesDeleteVmbox:function(e,t){var n=this;n.callApi({resource:"voicemail.delete",data:{accountId:n.accountId,voicemailId:e,data:{}},success:function(e){t(e.data)}})},vmboxesGetEditData:function(e,t){var n=this;r.parallel({vmbox:function(t){e?n.vmboxesGetVmbox(e,function(e){t(null,e)}):t(null,{})},mediaList:function(e){n.callApi({resource:"media.list",data:{accountId:n.accountId},success:function(t){e(null,t.data)}})}},function(e,r){var i=n.vmboxesFormatData(r);t&&t(i)})},vmboxesGetVmbox:function(e,t,n){var r=this;r.callApi({resource:"voicemail.get",data:{accountId:r.accountId,voicemailId:e},success:function(e){t&&t(e.data)},error:function(e){n&&n(e)}})},vmboxesSaveVmbox:function(e,t){var n=this;e.id?n.vmboxesUpdateVmbox(e,t):n.vmboxesCreateVmbox(e,t)},vmboxesCreateVmbox:function(e,t){var n=this;n.callApi({resource:"voicemail.create",data:{accountId:n.accountId,data:e},success:function(e){t(e.data)}})},vmboxesUpdateVmbox:function(e,t,n){var r=this;r.callApi({resource:"voicemail.update",data:{accountId:r.accountId,data:e,voicemailId:e.id},success:function(e){t&&t(e.data)},error:function(e){n&&n(e)}})},vmboxesGetData:function(e){var t=this;r.parallel({users:function(e){t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(null,t.data)}})},vmboxes:function(e){t.callApi({resource:"voicemail.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e(null,t.data)}})}},function(n,r){t.vmboxesFormatListData(r),e&&e(r)})}};return o});