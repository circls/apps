define(["require","jquery","underscore","monster","monster-timezone","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("monster-timezone"),s=e("toastr"),o={requests:{},subscribe:{"voip.strategy.render":"strategyRender","auth.currentAccountUpdated":"_strategyOnCurrentAccountUpdated"},weekdays:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],weekdayLabels:["MainMonday","MainTuesday","MainWednesday","MainThursday","MainFriday","MainSaturday","MainSunday"],subCallflowsLabel:["MainOpenHours","MainAfterHours","MainLunchHours","MainHolidays"],featureCodes:[{name:"call_forward[action=deactivate]",number:"73",callflowNumber:"*73",moduleName:"call_forward",actionName:"deactivate"},{name:"call_forward[action=activate]",number:"72",callflowNumber:"*72",moduleName:"call_forward",actionName:"activate"},{name:"call_forward[action=toggle]",number:"74",pattern:"^\\*74([0-9]*)$",moduleName:"call_forward",actionName:"toggle"},{name:"call_forward[action=update]",number:"56",callflowNumber:"*56",moduleName:"call_forward",actionName:"update"},{name:"hotdesk[action=login]",number:"11",callflowNumber:"*11",moduleName:"hotdesk",actionName:"login"},{name:"hotdesk[action=logout]",number:"12",callflowNumber:"*12",moduleName:"hotdesk",actionName:"logout"},{name:"hotdesk[action=toggle]",number:"13",callflowNumber:"*13",moduleName:"hotdesk",actionName:"toggle"},{name:"voicemail[action=check]",number:"97",callflowNumber:"*97",moduleName:"voicemail",actionName:"check"},{name:"voicemail[single_mailbox_login]",number:"98",callflowNumber:"*98",moduleName:"voicemail",actionName:"check",extraData:{single_mailbox_login:!0}},{name:'voicemail[action="direct"]',number:"*",pattern:"^\\*\\*([0-9]*)$",moduleName:"voicemail",actionName:"compose"},{name:"intercom",number:"0",pattern:"^\\*0([0-9]*)$",moduleName:"intercom",actionName:"compose"},{name:"privacy[mode=full]",number:"67",pattern:"^\\*67([0-9]*)$",moduleName:"privacy",actionName:"full"},{name:"park_and_retrieve",number:"3",pattern:"^\\*3([0-9]*)$",moduleName:"park",actionName:"auto"},{name:"valet",number:"4",callflowNumber:"*4",moduleName:"park",actionName:"park"},{name:"retrieve",number:"5",pattern:"^\\*5([0-9]*)$",moduleName:"park",actionName:"retrieve"}],strategyRender:function(e){var n=this,e=e||{},i=e.parent||t(".right-content"),s=e.openElement,o=e.callback,u={},a;r.parallel({temporalRules:function(e){n.strategyGetTemporalRules(function(t){e(null,t)})},callflows:function(e){n.strategyGetMainCallflows(function(t){e(null,t)})},callEntities:function(e){n.strategyGetCallEntities(function(t){e(null,t)})},voicemails:function(e){n.strategyGetVoicesmailBoxes(function(t){e(null,t)})},numberFeatures:function(e){r.pub("common.numbers.getListFeatures",function(t){e(null,t)})},directories:function(e){n.strategyListDirectories(function(t){e(null,t)})}},function(e,u){var f=u.callflows.MainCallflow.numbers.length>1,l=u.callflows.MainConference.numbers.length>0&&u.callflows.MainConference.numbers[0]!=="undefinedconf",c=u.callflows.MainFaxing.numbers.length>0&&u.callflows.MainFaxing.numbers[0]!=="undefinedfaxing",h={mainNumbers:f?u.callflows.MainCallflow.numbers.slice(1):[n.i18n.active().strategy.noNumberTitle],confNumbers:l?u.callflows.MainConference.numbers:[n.i18n.active().strategy.noNumberTitle],customConfGreeting:u.callflows.MainConference&&"welcome_prompt"in u.callflows.MainConference.flow.data?!0:!1,faxingNumbers:c?u.callflows.MainFaxing.numbers:[n.i18n.active().strategy.noNumberTitle]};a=t(r.template(n,"strategy-layout",h)),n.strategyBindEvents(a,u),i.empty().append(a),r.ui.tooltips(a),f?(a.find(".element-container.helper").css("display","none"),a.find(".element-container.main-number").css("margin-top","0px"),n.strategyCheckSecondWalkthrough()):(a.find(".element-container.strategy-hours,.element-container.strategy-holidays,.element-container.strategy-calls").hide(),a.find(".element-container.helper").css("display","block"),a.find(".element-container.main-number").css("margin-top","10px"),n.strategyCheckFirstWalkthrough());if(s){var p=a.find(".element-container."+s+":visible");p.length>0&&n.strategyRefreshTemplate(p,u,function(){p.addClass("open"),p.find(".element-content").show()})}o&&o()}),n.strategyCreateFeatureCodes()},strategyCheckFirstWalkthrough:function(){var e=this,t="showStrategyFirstWalkthrough";e.strategyHasWalkthrough(t,function(){e.strategyShowFirstWalkthrough(function(){e.strategyUpdateWalkthroughFlagUser(t)})})},strategyCheckSecondWalkthrough:function(){var e=this,t="showStrategySecondWalkthrough";e.strategyHasWalkthrough(t,function(){e.strategyShowSecondWalkthrough(function(){e.strategyUpdateWalkthroughFlagUser(t)})})},strategyHasWalkthrough:function(e,t){var n=this,r=n.uiFlags.user.get(e);r!==!1&&t&&t()},strategyUpdateWalkthroughFlagUser:function(e,t){var n=this,r=n.uiFlags.user.set(e,!1);n.strategyUpdateOriginalUser(r,function(e){t&&t(e)})},strategyShowFirstWalkthrough:function(e){var n=this,i=t("#strategy_container"),s=[{element:i.find(".element-container.main-number")[0],intro:n.i18n.active().strategy.walkthrough.first.steps[1],position:"bottom"}];r.ui.stepByStep(s,function(){e&&e()})},strategyShowSecondWalkthrough:function(e){var n=this,i=t("#strategy_container"),s=[{element:i.find(".element-container.strategy-hours")[0],intro:n.i18n.active().strategy.walkthrough.second.steps[1],position:"bottom"},{element:i.find(".element-container.strategy-holidays")[0],intro:n.i18n.active().strategy.walkthrough.second.steps[2],position:"bottom"},{element:i.find(".element-container.strategy-calls")[0],intro:n.i18n.active().strategy.walkthrough.second.steps[3],position:"top"},{element:i.find(".element-container.strategy-confnum")[0],intro:n.i18n.active().strategy.walkthrough.second.steps[4],position:"top"},{element:i.find(".element-container.strategy-faxingnum")[0],intro:n.i18n.active().strategy.walkthrough.second.steps[5],position:"top"}];r.ui.stepByStep(s,function(){e&&e()})},strategyBindEvents:function(e,n){var r=this,i=e.find(".element-container"),s=e.find(".element-container.main-number .element-content"),o=e.find(".element-container.strategy-confnum .element-content"),u=e.find(".element-container.strategy-faxingnum .element-content"),a=e.find(".element-container.strategy-hours .element-content"),f=e.find(".element-container.strategy-holidays .element-content"),l=e.find(".element-container.strategy-calls .element-content");e.find(".element-header-inner").on("click",function(e){var s=t(this).parents(".element-container");s.hasClass("open")?s.find(".element-content").slideUp(function(){s.removeClass("open")}):(t.each(i,function(){var e=t(this);e.hasClass("open")&&e.find(".element-content").slideUp(function(){e.removeClass("open")})}),r.strategyRefreshTemplate(s,n,function(){s.addClass("open"),s.find(".element-content").slideDown()}))}),e.find(".element-container").on("click",".cancel-link",function(e){e.preventDefault();var n=t(this).parents(".element-container");n.find(".element-content").slideUp(function(){n.removeClass("open")})}),r.strategyNumbersBindEvents(s,n),r.strategyConfNumBindEvents(o,n),r.strategyFaxingNumBindEvents(u,n),r.strategyHoursBindEvents(a,n),r.strategyHolidaysBindEvents(f,n),r.strategyCallsBindEvents(l,n)},strategyRefreshTemplate:function(e,s,o){var u=this,a=e.data("template");switch(a){case"numbers":u.strategyListAccountNumbers(function(i){var f=s.callflows.MainCallflow,l=f.numbers,c={numbers:t.map(l,function(e,r){if(e!=="0"){var o={number:e,features:t.extend(!0,{},s.numberFeatures)};return n.each(i[e].features,function(e){o.features[e].active="active"}),o.isLocal=i[e].features.indexOf("local")>-1,o}}),isCnamEnabled:r.util.isNumberFeatureEnabled("cnam"),isE911Enabled:r.util.isNumberFeatureEnabled("e911"),spareLinkEnabled:n.countBy(i,function(e){return e.used_by?"assigned":"spare"}).spare>0},h=t(r.template(u,"strategy-"+a,c));r.ui.tooltips(h),e.find(".element-content").empty().append(h),o&&o()});break;case"confnum":u.strategyListAccountNumbers(function(i){var f=s.callflows.MainConference,l=f.numbers,c={numbers:t.map(l,function(e,t){if(e!=="undefinedconf")return{number:e}}),spareLinkEnabled:n.countBy(i,function(e){return e.used_by?"assigned":"spare"}).spare>0},h=r.template(u,"strategy-"+a,c);e.find(".element-content").empty().append(h),o&&o()});break;case"faxingnum":u.strategyListAccountNumbers(function(i){var f=s.callflows.MainFaxing,l=f.numbers,c={numbers:t.map(l,function(e,t){if(e!=="undefinedfaxing")return{number:e}}),actionLinksEnabled:n.isEmpty(f.flow.data),spareLinkEnabled:n.countBy(i,function(e){return e.used_by?"assigned":"spare"}).spare>0},h=r.template(u,"strategy-"+a,c);e.find(".element-content").empty().append(h),o&&o()});break;case"hours":var f=r.apps.auth.currentUser.ui_flags&&r.apps.auth.currentUser.ui_flags.twelve_hours_mode?!0:!1,l=function(e){var t=parseInt(e/3600)%24,n=(parseInt(e/60)%60).toString(),r="";return f&&(r=t>=12?"PM":"AM",t=t>12?t-12:t===0?12:t),t.toString()+":"+(n.length<2?"0"+n:n)+r},c=s.temporalRules.weekdays,h={alwaysOpen:!0,companyTimezone:i.formatTimezone(s.callflows.MainCallflow.flow.data.timezone||r.apps.auth.currentAccount.timezone),days:[],lunchbreak:{enabled:s.temporalRules.lunchbreak.id in s.callflows.MainCallflow.flow.children,from:l(parseInt(s.temporalRules.lunchbreak.time_window_start,10)),to:l(parseInt(s.temporalRules.lunchbreak.time_window_stop,10))}},p;n.each(u.weekdayLabels,function(e){var t=c[e].id in s.callflows.MainCallflow.flow.children;h.days.push({name:e,label:u.i18n.active().strategy.weekdays[e.substring(4).toLowerCase()],open:t,from:l(parseInt(c[e].time_window_start,10)),to:l(parseInt(c[e].time_window_stop,10))}),t&&(h.alwaysOpen=!1)}),h.alwaysOpen&&n.each(h.days,function(e){e.name!=="MainSaturday"&&e.name!=="MainSunday"&&(e.open=!0,e.from=f?"9:00AM":"9:00",e.to=f?"5:00PM":"17:00")}),p=t(r.template(u,"strategy-"+a,h));var d={rules:{"lunchbreak.from":{},"lunchbreak.to":{greaterDate:p.find('input[name="lunchbreak.from"]')}},groups:{lunchbreak:"lunchbreak.from lunchbreak.to"},errorPlacement:function(e,t){e.appendTo(t.parent())}};f?(d.rules["lunchbreak.from"].time12h=!0,d.rules["lunchbreak.to"].time12h=!0):(d.rules["lunchbreak.from"].time24h=!0,d.rules["lunchbreak.to"].time24h=!0),n.each(u.weekdayLabels,function(e){d.rules["weekdays."+e+".from"]={},d.rules["weekdays."+e+".to"]={greaterDate:p.find('input[name="weekdays.'+e+'.from"]')},f?(d.rules["weekdays."+e+".from"].time12h=!0,d.rules["weekdays."+e+".to"].time12h=!0):(d.rules["weekdays."+e+".from"].time24h=!0,d.rules["weekdays."+e+".to"].time24h=!0),d.groups[e]="weekdays."+e+".from weekdays."+e+".to"}),r.ui.validate(p.find("#strategy_custom_hours_form"),d),e.find(".element-content").empty().append(p),r.ui.timepicker(p.find(".timepicker")),o&&o();break;case"holidays":var h={enabled:!t.isEmptyObject(s.temporalRules.holidays)},p=t(r.template(u,"strategy-"+a,h)),v=p.find(".holidays-list");e.find(".element-content").empty().append(p),v.empty(),n.each(s.temporalRules.holidays,function(e,t){if(e.id in s.callflows.MainCallflow.flow.children){var n,r={id:e.id,name:e.name,fromMonth:e.month};e.hasOwnProperty("ordinal")?(n="advanced",r.ordinal=e.ordinal,r.wday=e.wdays[0]):e.hasOwnProperty("viewData")?(n="range",r.fromDay=e.viewData.fromDay,r.fromMonth=e.viewData.fromMonth,r.toDay=e.viewData.toDay,r.toMonth=e.viewData.toMonth,r.set=!0):(r.fromDay=e.days[0],e.days.length>1?(n="range",r.toDay=e.days[e.days.length-1],r.toMonth=e.month):n="single"),u.strategyRenderHolidayLine(v,n,r)}}),o&&o();break;case"calls":var h={lunchbreak:s.temporalRules.lunchbreak.id in s.callflows.MainCallflow.flow.children,holidays:!t.isEmptyObject(s.temporalRules.holidays),afterhours:!1},p;n.each(u.weekdayLabels,function(e){s.temporalRules.weekdays[e].id in s.callflows.MainCallflow.flow.children&&(h.afterhours=!0)}),p=t(r.template(u,"strategy-"+a,h)),e.find(".element-content").empty().append(p),t.each(p.find(".callflow-tab"),function(){var e=t(this),i=e.data("callflow"),o=i+"Menu",a={callOption:{type:"default"},hideAdvancedCallflows:n.isEmpty(s.callEntities.advancedCallflows),callflow:i,callEntities:u.strategyGetCallEntitiesDropdownData(s.callEntities,!0,!0),voicemails:s.voicemails,tabMessage:u.i18n.active().strategy.calls.callTabsMessages[i]};s.callflows[i].flow.hasOwnProperty("is_main_number_cf")?(a.callOption.callEntityId=s.callflows[i].flow.data.id,a.callOption.type="advanced-callflow"):s.callflows[i].flow.module==="voicemail"?(a.callOption.callEntityId="none",a.callOption.voicemailId=s.callflows[i].flow.data.id,a.callOption.type="user-voicemail"):n.isEmpty(s.callflows[i].flow.children)||(a.callOption.callEntityId=s.callflows[i].flow.data.id,"_"in s.callflows[i].flow.children&&s.callflows[i].flow.children._.module==="voicemail"?(a.callOption.type="user-voicemail",a.callOption.voicemailId=s.callflows[i].flow.children._.data.id):a.callOption.type="user-menu"),o in s.callflows&&(a.menu=o),t(this).empty().append(r.template(u,"strategy-callsTab",a))}),t.each(p.find(".user-select select"),function(){var e=t(this);e.chosen({search_contains:!0,width:"160px"}),e.siblings(".title").text(e.find("option:selected").closest("optgroup").prop("label"))}),p.find(".voicemail-select select").chosen({search_contains:!0,width:"160px"}),p.find(".advancedCallflows-select select").chosen({search_contains:!0,width:"160px"}),o&&o();break;default:o&&o()}},strategyNumbersBindEvents:function(e,i){var o=this,u=function(t){if(t.length){var n=i.callflows.MainCallflow;n.numbers=n.numbers.concat(t),o.strategyUpdateCallflow(n,function(t){var n=e.parents(".element-container");i.callflows.MainCallflow=t,a(n),o.strategyRefreshTemplate(n,i)})}},a=function(t){var n=i.callflows.MainCallflow,s=t.find(".element-header-inner .summary > span");n.numbers.length>1?(s.html(r.util.formatPhoneNumber(n.numbers[1])),n.numbers.length>3?s.append('<i class="icon-telicon-multiple-items icon-small"></i>'):n.numbers.length===3&&s.append(", "+r.util.formatPhoneNumber(n.numbers[2])),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-confnum)").show(),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-faxingnum)").show(),e.parents("#strategy_container").find(".element-container.helper").hide(),e.parents("#strategy_container").find(".element-container.main-number").css("margin-top","0px"),o.strategyCheckSecondWalkthrough()):(s.html(o.i18n.active().strategy.noNumberTitle),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-confnum)").hide(),e.parents("#strategy_container").find(".element-container:not(.main-number,.strategy-faxingnum)").hide(),e.parents("#strategy_container").find(".element-container.helper").show(),e.parents("#strategy_container").find(".element-container.main-number").css("margin-top","10px"))};e.on("click",".action-links .spare-link:not(.disabled)",function(e){e.preventDefault();var n={accountName:r.apps.auth.currentAccount.name,accountId:o.accountId,callback:function(e){var n=t.map(e,function(e){return e.phoneNumber});u(n)}};r.pub("common.numbers.dialogSpare",n)}),e.on("click",".action-links .buy-link",function(e){e.preventDefault(),r.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){u(Object.keys(e)),s.success(o.i18n.active().strategy.toastrMessages.buyNumbersSuccess)},error:function(e){s.error(o.i18n.active().strategy.toastrMessages.buyNumbersError)}}})}),e.on("click",".action-links .port-link",function(e){e.preventDefault()}),e.on("click",".number-element .remove-number",function(u){u.preventDefault();var f=t(this),l=f.data("number"),c=f.data("e911"),h=r.util.isNumberFeatureEnabled("e911"),p=i.callflows.MainCallflow.numbers.indexOf(l.toString());c==="active"&&e.find('.number-element .remove-number[data-e911="active"]').length===1&&h?r.ui.alert("error",o.i18n.active().strategy.alertMessages.lastE911Error):p>=0&&o.strategyGetNumber(l,function(u){var f={phoneNumber:l},c=[],h,d,v=function(){i.callflows.MainCallflow.numbers.splice(p,1),o.strategyUpdateCallflow(i.callflows.MainCallflow,function(t){var n=e.parents(".element-container");s.success(o.i18n.active().strategy.toastrMessages.removeNumberSuccess),i.callflows.MainCallflow=t,a(n),o.strategyRefreshTemplate(n,i),o.callApi({resource:"account.get",data:{accountId:o.accountId},success:function(e){var t=!1;"caller_id"in e.data&&"external"in e.data.caller_id&&e.data.caller_id.external.number===l&&(delete e.data.caller_id.external,t=!0),"caller_id"in e.data&&"emergency"in e.data.caller_id&&e.data.caller_id.emergency.number===l&&(delete e.data.caller_id.emergency,t=!0),t&&o.callApi({resource:"account.update",data:{accountId:o.accountId,data:e.data},success:function(e){}})}})})};n.each(u,function(e,t){(t==="cnam"||t==="dash_e911")&&c.push({name:t,friendlyName:o.i18n.active().strategy.popupRemoveFeatures.features[t]})}),c.length>0?(f.featureList=c,h=t(r.template(o,"strategy-popupRemoveFeatures",f)),d=r.ui.dialog(h,{title:o.i18n.active().strategy.popupRemoveFeatures.title,width:"540px"}),d.find(".cancel-link").on("click",function(){d.dialog("close")}),d.find("#remove_features").on("click",function(){d.find(".table td").each(function(e,n){t(n).find("input").is(":checked")&&delete u[t(n).data("name")]}),o.strategyUpdateNumber(l,u,function(){d.dialog("close"),v()})})):v()})}),r.util.isNumberFeatureEnabled("cnam")&&e.on("click",".number-element .callerId-number",function(){var e=t(this).parents(".number-element").first(),n=e.find(".remove-number").data("number");if(n){var i={phoneNumber:n,callbacks:{success:function(t){"cnam"in t.data&&t.data.cnam.display_name?e.find(".features i.feature-outbound_cnam").addClass("active"):e.find(".features i.feature-outbound_cnam").removeClass("active"),"cnam"in t.data&&t.data.cnam.inbound_lookup?e.find(".features i.feature-inbound_cnam").addClass("active"):e.find(".features i.feature-inbound_cnam").removeClass("active")}}};r.pub("common.callerId.renderPopup",i)}}),r.util.isNumberFeatureEnabled("e911")&&e.on("click",".number-element .e911-number",function(){var e=t(this).parents(".number-element").first(),n=e.find(".remove-number").data("number");if(n){var i={phoneNumber:n,callbacks:{success:function(n){t.isEmptyObject(n.data.dash_e911)?e.find(".features i.feature-dash_e911").removeClass("active"):e.find(".features i.feature-dash_e911").addClass("active")}}};r.pub("common.e911.renderPopup",i)}}),e.on("click",".number-element .prepend-number",function(){var e=t(this).parents(".number-element").first(),n=e.find(".remove-number").data("number");if(n){var i={phoneNumber:n,callbacks:{success:function(t){"prepend"in t.data&&t.data.prepend.enabled?e.find(".features i.feature-prepend").addClass("active"):e.find(".features i.feature-prepend").removeClass("active")}}};r.pub("common.numberPrepend.renderPopup",i)}})},strategyConfNumBindEvents:function(e,n){var i=this,o=function(t){if(t.length){var r=n.callflows.MainConference;r.numbers.length<=1&&r.numbers[0]==="undefinedconf"&&(r.numbers=[]),r.numbers=r.numbers.concat(t),i.strategyUpdateCallflow(r,function(t){var r=e.parents(".element-container");n.callflows.MainConference=t,u(r),i.strategyRefreshTemplate(r,n)})}},u=function(e){var t=n.callflows.MainConference,s=e.find(".element-header-inner .summary > span");t.numbers.length>0&&t.numbers[0]!=="undefinedconf"?(s.html(r.util.formatPhoneNumber(t.numbers[0])),t.numbers.length>2?s.append('<i class="icon-telicon-multiple-items icon-small"></i>'):t.numbers.length===2&&s.append(", "+r.util.formatPhoneNumber(t.numbers[1]))):s.html(i.i18n.active().strategy.noNumberTitle)};e.on("click",".action-links .spare-link:not(.disabled)",function(e){e.preventDefault();var n={accountName:r.apps.auth.currentAccount.name,accountId:i.accountId,callback:function(e){var n=t.map(e,function(e){return e.phoneNumber});o(n)}};r.pub("common.numbers.dialogSpare",n)}),e.on("click",".action-links .greeting-link",function(e){e.preventDefault();var s=n.callflows.MainConference;s?i.getMainConferenceGreetingMedia(function(e){var o=t(r.template(i,"strategy-customConferenceGreeting",{enabled:"welcome_prompt"in s.flow.data,greeting:e&&e.tts?e.tts.text:""})),u=r.ui.dialog(o,{title:i.i18n.active().strategy.customConferenceGreeting.title,position:["center",20]});o.find(".switch-state").on("change",function(){t(this).prop("checked")?o.find(".content").slideDown():o.find(".content").slideUp()}),o.find(".cancel").on("click",function(){u.dialog("close").remove()}),o.find(".save").on("click",function(){if(o.find(".switch-state").prop("checked")){var r=function(t){e?(e.description="<Text to Speech>",e.media_source="tts",e.tts={text:o.find(".custom-greeting-text").val(),voice:"female/en-US"},i.callApi({resource:"media.update",data:{accountId:i.accountId,mediaId:e.id,data:e},success:function(e,n){t&&t(e.data)}})):i.callApi({resource:"media.create",data:{accountId:i.accountId,data:{description:"<Text to Speech>",media_source:"tts",name:"MainConferenceGreeting",streamable:!0,type:"mainConfGreeting",tts:{text:o.find(".custom-greeting-text").val(),voice:"female/en-US"}}},success:function(e,n){t&&t(e.data)}})};r(function(e){s.flow.data.welcome_prompt={media_id:e.id},i.strategyUpdateCallflow(s,function(e){n.callflows.MainConference=e,u.dialog("close").remove(),t("#strategy_container .custom-greeting-icon").show()})})}else"welcome_prompt"in s.flow.data?(delete s.flow.data.welcome_prompt,i.strategyUpdateCallflow(s,function(e){n.callflows.MainConference=e,u.dialog("close").remove(),t("#strategy_container .custom-greeting-icon").hide()})):u.dialog("close").remove()})}):r.ui.alert("error",i.i18n.active().strategy.customConferenceGreeting.mainConfMissing)}),e.on("click",".action-links .buy-link",function(e){e.preventDefault(),r.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){o(Object.keys(e)),s.success(i.i18n.active().strategy.toastrMessages.buyNumbersSuccess)},error:function(e){s.error(i.i18n.active().strategy.toastrMessages.buyNumbersError)}}})}),e.on("click",".number-element .remove-number",function(r){r.preventDefault();var o=t(this).data("number").toString(),a=n.callflows.MainConference.numbers.indexOf(o);a>=0&&(n.callflows.MainConference.numbers.splice(a,1),n.callflows.MainConference.numbers.length===0&&(n.callflows.MainConference.numbers=["undefinedconf"]),i.strategyUpdateCallflow(n.callflows.MainConference,function(t){var r=e.parents(".element-container");s.success(i.i18n.active().strategy.toastrMessages.removeNumberSuccess),n.callflows.MainConference=t,u(r),i.strategyRefreshTemplate(r,n)}))})},getMainConferenceGreetingMedia:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId,filters:{filter_type:"mainConfGreeting"}},success:function(n,r){n.data&&n.data.length>0?t.callApi({resource:"media.get",data:{accountId:t.accountId,mediaId:n.data[0].id},success:function(t,n){e&&e(t.data)},error:function(t,n){e&&e(null)}}):e&&e(null)},error:function(t,n){e&&e(null)}})},strategyFaxingNumBindEvents:function(e,n){var i=this,o=function(t){if(t.length){var r=n.callflows.MainFaxing,s=function(){i.strategyUpdateCallflow(r,function(t){var r=e.parents(".element-container");n.callflows.MainFaxing=t,u(r),i.strategyRefreshTemplate(r,n)})};r.numbers.length<=1&&r.numbers[0]==="undefinedfaxing"&&(r.numbers=[]),r.numbers=r.numbers.concat(t),r.flow.data.hasOwnProperty("id")?s():i.strategyBuildFaxbox({data:{number:r.numbers[0]},success:function(e){r.flow.data.id=e.id,s()}})}},u=function(e){var t=n.callflows.MainFaxing,s=e.find(".element-header-inner .summary > span");t.numbers.length>0&&t.numbers[0]!=="undefinedfaxing"?(s.html(r.util.formatPhoneNumber(t.numbers[0])),t.numbers.length>2?s.append('<i class="icon-telicon-multiple-items icon-small"></i>'):t.numbers.length===2&&s.append(", "+r.util.formatPhoneNumber(t.numbers[1]))):s.html(i.i18n.active().strategy.noNumberTitle)};e.on("click",".action-links .spare-link:not(.disabled)",function(e){e.preventDefault();var n={accountName:r.apps.auth.currentAccount.name,accountId:i.accountId,singleSelect:!0,callback:function(e){var n=t.map(e,function(e){return e.phoneNumber});o(n)}};r.pub("common.numbers.dialogSpare",n)}),e.on("click",".action-links .buy-link",function(e){e.preventDefault(),r.pub("common.buyNumbers",{searchType:t(this).data("type"),singleSelect:!0,callbacks:{success:function(e){o(Object.keys(e)),s.success(i.i18n.active().strategy.toastrMessages.buyNumbersSuccess)},error:function(e){s.error(i.i18n.active().strategy.toastrMessages.buyNumbersError)}}})}),e.on("click",".number-element .remove-number",function(r){r.preventDefault();var o=t(this).data("number"),a=n.callflows.MainFaxing,f=a.numbers.indexOf(o);f>=0&&(a.numbers.splice(f,1),a.numbers.length===0&&(a.numbers=["undefinedfaxing"]),i.strategyDeleteFaxbox({data:{id:a.flow.data.id},success:function(t){delete a.flow.data.id,i.strategyUpdateCallflow(a,function(t){var r=e.parents(".element-container");s.success(i.i18n.active().strategy.toastrMessages.removeNumberSuccess),n.callflows.MainFaxing=t,u(r),i.strategyRefreshTemplate(r,n)})}}))})},strategyHoursBindEvents:function(e,i){var s=this;e.on("change",'.custom-hours-toggler input[type="radio"]',function(n){var r=e.find(".custom-hours-div");t(this).val()=="true"?r.slideDown():r.slideUp()}),e.on("change",'.custom-days input[type="checkbox"]',function(e){var n=t(this).parents(".custom-day"),r=n.find(".timepickers"),i=n.find(".status");t(this).prop("checked")?(r.fadeIn(200),i.fadeOut(100,function(){i.html(s.i18n.active().strategy.open),i.fadeIn(100)})):(r.fadeOut(200),i.fadeOut(100,function(){i.html(s.i18n.active().strategy.closed),i.fadeIn(100)}))}),e.on("change",'.custom-hours-lunchbreak input[type="checkbox"]',function(e){t(this).prop("checked")?t(this).parents(".custom-hours-lunchbreak").find(".timepickers").fadeIn(200):t(this).parents(".custom-hours-lunchbreak").find(".timepickers").fadeOut(200)}),e.on("click",".save-button",function(o){o.preventDefault();if(r.ui.valid(e.find("#strategy_custom_hours_form"))){var u=t(this).parents(".element-container"),a=r.ui.getFormData("strategy_custom_hours_form"),f=i.callflows.MainCallflow,l=function(e){return{children:{},data:{id:e},module:"callflow"}};n.each(i.temporalRules.weekdays,function(e,t){delete f.flow.children[e.id]}),delete f.flow.children[i.temporalRules.lunchbreak.id];if(a.enabled==="false"||!a.opendays||a.opendays.length===0)f.flow.children._=l(i.callflows.MainOpenHours.id);else{var c={};f.flow.children._=l(i.callflows.MainAfterHours.id);if(a.lunchbreak.enabled){var h=i.temporalRules.lunchbreak;h.time_window_start=r.util.timeToSeconds(a.lunchbreak.from),h.time_window_stop=r.util.timeToSeconds(a.lunchbreak.to),c.lunchbreak=function(e){s.callApi({resource:"temporalRule.update",data:{accountId:s.accountId,ruleId:h.id,data:h},success:function(t,n){e(null,t.data)}})},f.flow.children[h.id]=l(i.callflows.MainLunchHours.id)}n.each(a.opendays,function(e){var t=i.temporalRules.weekdays[e];t.time_window_start=r.util.timeToSeconds(a.weekdays[e].from),t.time_window_stop=r.util.timeToSeconds(a.weekdays[e].to),c[e]=function(e){s.callApi({resource:"temporalRule.update",data:{accountId:s.accountId,ruleId:t.id,data:t},success:function(t,n){e(null,t.data)}})},f.flow.children[t.id]=l(i.callflows.MainOpenHours.id)}),r.parallel(c,function(e,t){})}s.strategyRebuildMainCallflowRuleArray(i),s.strategyUpdateCallflow(f,function(e){i.callflows.MainCallflow=e,u.find(".element-content").hide(),u.removeClass("open")})}})},strategyHolidaysBindEvents:function(e,i){var o=this;e.on("change",'.holidays-toggler input[type="checkbox"]',function(n){t(this).prop("checked")?e.find(".holidays-div").slideDown():e.find(".holidays-div").slideUp()}),e.on("click",".add-holidays-link",function(n){n.preventDefault(),o.strategyRenderHolidayLine(e.find(".holidays-list"),t(this).data("type"))}),e.on("click",".delete-holiday",function(e){var n=t(this).parents(".holidays-element"),s=n.data("id"),u=n.data("type");s?r.ui.confirm(o.i18n.active().strategy.confirmMessages.deleteHoliday,function(){var e=i.callflows.MainCallflow;delete e.flow.children[s],o.strategyRebuildMainCallflowRuleArray(i),o.strategyUpdateCallflow(e,function(e){i.callflows.MainCallflow=e;var t=function(e){delete i.temporalRules.holidays[e.name],n.remove()};u==="set"?o.strategyDeleteRuleSetAndRules(s,t):o.strategyDeleteHoliday(s,t)})}):n.remove()}),e.on("click",".save-button",function(u){u.preventDefault();var a=t(this).parents(".element-container"),f=i.callflows.MainCallflow,l=a.find('.holidays-toggler input[type="checkbox"]')[0].checked,c={},h=!1;l?(t.each(e.find(".holidays-element"),function(){var e=o.strategyBuildHolidayRule(t(this),c);if(!e)return h=!0,!1;c[e.name]=function(t){e.hasOwnProperty("isRange")?o.strategyBuildMultiMonthRangeHoliday(e,function(n){n.viewData=e,t&&t(null,n)}):o.strategyCleanUpdateHoliday(e,function(e){t&&t(null,e)})}}),h?r.ui.alert(o.i18n.active().strategy.alertMessages.uniqueHoliday):r.parallel(c,function(e,t){var r=[],u=n.pluck(c,"id");n.each(f.flow.children,function(e,t){t!=="_"&&e.data.id===i.callflows.MainHolidays.id&&r.push(t)}),n.each(r,function(e){u.indexOf(e)<0&&delete f.flow.children[e]}),n.each(t,function(e,t){f.flow.children[e.id]={children:{},data:{id:i.callflows.MainHolidays.id},module:"callflow"},i.temporalRules.holidays[e.name]=e}),o.strategyRebuildMainCallflowRuleArray(i),o.strategyUpdateCallflow(f,function(e){i.callflows.MainCallflow=e,a.find(".element-content").hide(),a.removeClass("open"),s.success(o.i18n.active().strategy.toastrMessages.updateHolidaySuccess)})})):r.ui.confirm(o.i18n.active().strategy.confirmMessages.disableHolidays,function(){n.each(i.temporalRules.holidays,function(e,t){c[t]=function(t){e.hasOwnProperty("temporal_rules")?o.strategyDeleteRuleSetAndRules(e.id,function(){delete f.flow.children[e.id],t(null,{})}):o.strategyDeleteHoliday(e.id,function(){delete f.flow.children[e.id],t(null,{})})}}),r.parallel(c,function(e,t){i.temporalRules.holidays={},o.strategyRebuildMainCallflowRuleArray(i),o.strategyUpdateCallflow(f,function(e){i.callflows.MainCallflow=e,a.find(".element-content").hide(),a.removeClass("open"),s.success(o.i18n.active().strategy.toastrMessages.updateHolidaySuccess)})})})})},strategyCleanUpdateHoliday:function(e,t){var n=this,r=function(){delete e.extra,n.strategyUpdateHoliday(e,function(e){t&&t(e)})};e.extra.oldType==="set"?n.strategyDeleteRuleSetAndRules(e.id,function(){delete e.id,r()}):r()},strategyBuildMultiMonthRangeHoliday:function(e,t){var i=this,s=parseInt(e.fromDay),o=parseInt(e.fromMonth),u=parseInt(e.toDay),a=parseInt(e.toMonth),f=e.name,l=function(e,t,n,r){var i=parseInt(t),s=n||1,o=r||31,u=[];for(var a=s;a<=o;a++)u.push(a);return{name:e+"_"+i,cycle:"yearly",days:u,interval:1,month:i}},c=[],h={name:f,temporal_rules:[],type:"main_holidays"},p={},d=f+"_"+r.util.randomString(6);if(o!==a){c.push(l(d,o,s,31));var v=o===12?1:o+1;for(var m=v;m!==a&&m-12!==a;m++)m===13&&(m=1),c.push(l(d,m,1,31));c.push(l(d,a,1,u))}else c.push(l(d,o,s,u));n.each(c,function(e){p[e.name]=function(t){i.strategyUpdateHoliday(e,function(e){t&&t(null,e)})}});var g=function(){r.parallel(p,function(e,r){n.each(c,function(e){h.temporal_rules.push(r[e.name].id)}),i.strategyCreateRuleSet(h,function(e){t(e)})})};e.hasOwnProperty("id")?e.extra.oldType==="rule"?i.strategyDeleteHoliday(e.id,function(){g()}):i.strategyDeleteRuleSetAndRules(e.id,function(){g()}):g()},strategyGetDetailRuleSet:function(e,t){var i=this;i.strategyGetRuleSet(e,function(e){var s={};n.each(e.temporal_rules,function(e){s[e]=function(t){i.strategyGetRule(e,function(e){e.hasOwnProperty("message")&&e.message==="bad identifier"&&(e={}),t&&t(null,e)})}}),r.parallel(s,function(r,s){var o=[],u=[],a={};n.each(e.temporal_rules,function(e){n.isEmpty(s[e])||(u.push(e),o.push(s[e]))}),o.length&&(a.fromDay=o[0].days[0],a.toDay=o[o.length-1].days[o[o.length-1].days.length-1],a.fromMonth=o[0].month,a.toMonth=o[o.length-1].month),n.isEqual(u,e.temporal_rules)?(e.viewData=a,t&&t(e)):u.length>0?(e.temporal_rules=u,i.strategyUpdateRuleSet(e,function(e){e.viewData=a,t&&t(e)})):i.strategyDeleteRuleSet(e.id,function(){t&&t({})})})})},strategyGetRuleSet:function(e,t){var n=this;n.callApi({resource:"temporalSet.get",data:{accountId:n.accountId,setId:e},success:function(e,n){t(e.data)}})},strategyUpdateRuleSet:function(e,t){var n=this;n.callApi({resource:"temporalSet.update",data:{accountId:n.accountId,setId:e.id,data:e},success:function(e,n){t(e.data)}})},strategyCreateRuleSet:function(e,t){var n=this;n.callApi({resource:"temporalSet.create",data:{accountId:n.accountId,data:e},success:function(e,n){t(e.data)}})},strategyDeleteRuleSetAndRules:function(e,t){var i=this;i.strategyGetRuleSet(e,function(s){var o={};n.each(s.temporal_rules,function(e){o[e]=function(t){i.strategyDeleteHoliday(e,function(){t&&t(null,{})})}}),r.parallel(o,function(n,r){i.strategyDeleteRuleSet(e,function(e){t&&t(e)})})})},strategyDeleteRuleSet:function(e,t){var n=this;n.callApi({resource:"temporalSet.delete",data:{accountId:n.accountId,setId:e},success:function(e,n){t&&t(e.data)}})},strategyBuildHolidayRule:function(e,n){var r=this,i=t(e),s=i.find(".name").val().trim(),o=parseInt(i.find(".month.from :selected").val()),u=parseInt(i.find(".month.to :selected").val()),a=parseInt(i.find(".day.from :selected").val()),f=parseInt(i.find(".day.to :selected").val()),l=i.find(".ordinal :selected").val(),c=i.find(".wday :selected").val(),h=i.data("id"),p=i.data("type"),d={};if(!s||Object.keys(n).indexOf(s)>=0)d=!1;else if(u&&o!==u)d={isRange:!0,name:s,fromDay:a,fromMonth:o,toDay:f,toMonth:u};else{d={name:s,cycle:"yearly",interval:1,month:o,type:"main_holidays"};if(a){var v=a;d.days=[v];if(f)for(var m=v+1;m<=f;m++)d.days.push(m)}else d.ordinal=l,d.wdays=[c]}return h&&(d.id=h),d.extra={oldType:p},d},strategyUpdateHoliday:function(e,t){var n=this;e.id?n.callApi({resource:"temporalRule.update",data:{accountId:n.accountId,ruleId:e.id,data:e},success:function(e,n){t(e.data)}}):n.callApi({resource:"temporalRule.create",data:{accountId:n.accountId,data:e},success:function(e,n){t(e.data)}})},strategyDeleteHoliday:function(e,t){var n=this;n.callApi({resource:"temporalRule.delete",data:{accountId:n.accountId,ruleId:e,generateError:!1},success:function(e,n){t(e.data)},error:function(e,n){t(e.data)}})},strategyCallsBindEvents:function(e,i){function u(e){e.siblings().removeClass("active"),e.addClass("active")}var o=this;e.on("click",".calls-tabs a",function(e){e.preventDefault(),t(this).tab("show")}),e.on("click",".call-option",function(e){var n=t(this);u(n),n.find('.radio-div input[type="radio"]').prop("checked",!0)}),e.on("change",'input[type="radio"]',function(e){t(this).prop("checked")&&u(t(this).parents(".call-option"))}),e.on("click",".menu-div a",function(n){n.preventDefault();var r=t(this).parents(".callflow-tab");o.strategyShowMenuPopup({strategyData:i,name:r.data("callflow")+"Menu",label:e.find('a[href="#'+r.prop("id")+'"]').text()})}),e.on("change",".user-select select",function(e){var n=t(this);n.siblings(".title").text(n.find("option:selected").closest("optgroup").prop("label"))}),e.on("click",".save-button",function(u){u.preventDefault();var a=null,f={};t.each(e.find(".callflow-tab"),function(){var e=t(this),n=e.data("callflow"),r=e.find(".call-option.active"),s=r.find(".menu-div"),o=r.find(".user-select"),u=r.find(".voicemail-select"),l=r.find(".advancedCallflows-select"),c={};if(o.length){var h=o.find("option:selected"),p={children:{},module:h.data("type"),data:{}};switch(p.module){case"user":case"device":case"callflow":case"media":p.data.id=h.val();break;case"ring_group":p.data.endpoints=[{endpoint_type:"group",id:h.val()}];break;case"none":p={}}c=p}if(u.length){var d=u.find("option:selected"),p={children:{},module:"voicemail",data:{id:d.val()}};"children"in c?c.children._=p:c=p}if(s.length){var v=s.data("callflow");if(!v)return a=this.id,!1;var p={children:{},module:"callflow",data:{id:i.callflows[v].id}};"children"in c?c.children._=p:c=p}l.length&&(c={children:{},module:"callflow",data:{id:l.find("option:selected").val()},is_main_number_cf:!0}),f[n]=c});if(a)r.ui.alert(o.i18n.active().strategy.alertMessages.undefinedMenu),e.find('a[href="#'+a+'"]').tab("show");else{var l={};n.each(f,function(e,t){i.callflows[t].flow=e,l[t]=function(e){o.strategyUpdateCallflow(i.callflows[t],function(n){i.callflows[t]=n,e(null,n)})}}),r.parallel(l,function(t,n){e.hide(),e.parents(".element-container").removeClass("open"),s.success(o.i18n.active().strategy.toastrMessages.updateCallSuccess)})}})},strategyRenderHolidayLine:function(e,n,i,s){var o=this,u=t.extend(!0,{resources:{months:[{value:1,label:o.i18n.active().strategy.monthsShort.january},{value:2,label:o.i18n.active().strategy.monthsShort.february},{value:3,label:o.i18n.active().strategy.monthsShort.march},{value:4,label:o.i18n.active().strategy.monthsShort.april},{value:5,label:o.i18n.active().strategy.monthsShort.may},{value:6,label:o.i18n.active().strategy.monthsShort.june},{value:7,label:o.i18n.active().strategy.monthsShort.july},{value:8,label:o.i18n.active().strategy.monthsShort.august},{value:9,label:o.i18n.active().strategy.monthsShort.september},{value:10,label:o.i18n.active().strategy.monthsShort.october},{value:11,label:o.i18n.active().strategy.monthsShort.november},{value:12,label:o.i18n.active().strategy.monthsShort.december}],days:[],wdays:t.map(o.weekdays,function(e){return{value:e,label:o.i18n.active().strategy.weekdays[e].substring(0,3)}}),ordinals:[{value:"first",label:o.i18n.active().strategy.ordinals.first},{value:"second",label:o.i18n.active().strategy.ordinals.second},{value:"third",label:o.i18n.active().strategy.ordinals.third},{value:"fourth",label:o.i18n.active().strategy.ordinals.fourth},{value:"fifth",label:o.i18n.active().strategy.ordinals.fifth},{value:"last",label:o.i18n.active().strategy.ordinals.last}]}},i,{holidayType:n});for(var a=1;a<=31;a++)u.resources.days.push({value:a});e.append(r.template(o,"strategy-holidayLine",u))},strategyShowMenuPopup:function(e,i){var s=this,o=e.strategyData,u=e.name,a=e.label,f,l,c,h=function(){f=t(r.template(s,"strategy-menuPopup",{menu:l,greeting:c})),popup=r.ui.dialog(f,{title:s.i18n.active().strategy.popup.title+" - "+a,dialogClass:"overflow-visible"});var i=f.find(".menu-block .left .content"),h=t.extend(!0,{},o.callEntities,{voicemail:o.voicemails},{directory:o.directories}),p=s.strategyGetCallEntitiesDropdownData(h);n.each(o.callflows[u].flow.children,function(e,t){i.append(r.template(s,"strategy-menuLine",{number:t,callEntities:p,selectedId:e.data.id||e.data.endpoints[0].id}))}),t.each(i.find(".target-input"),function(){var e=t(this),n=e.find(".target-select option:selected").parents("optgroup").data("icon");e.find(".target-icon").addClass(n)}),s.strategyBindMenuPopupEvents(popup,t.extend({menu:l,greeting:c},e))};u in o.callflows?s.callApi({resource:"menu.get",data:{accountId:s.accountId,menuId:o.callflows[u].flow.data.id},success:function(e,t){l=e.data,l.media.greeting?s.callApi({resource:"media.get",data:{accountId:s.accountId,mediaId:l.media.greeting},success:function(e,t){c=e.data,h()}}):h()}}):s.callApi({resource:"menu.create",data:{accountId:s.accountId,data:{name:u,record_pin:r.util.randomString(4,"1234567890"),media:{exit_media:!0,invalid_media:!0,transfer_media:!0},retries:3,max_extension_length:4,type:"main"}},success:function(e,n){l=e.data,s.callApi({resource:"callflow.create",data:{accountId:s.accountId,data:{contact_list:{exclude:!1},numbers:[u],type:"main",flow:{children:{},data:{id:l.id},module:"menu"}}},success:function(e,n){o.callflows[u]=e.data,t(".callflow-tab.active .menu-div").data("callflow",u),t(".callflow-tab.active .menu-div").addClass("has-menu"),h()}})}})},strategyBindMenuPopupEvents:function(e,n){var i=this,s=n.strategyData,o=n.name,u=n.menu,a=n.greeting,f=e.find("#strategy_menu_popup"),l=f.find("#strategy_menu_popup_tts_greeting"),c=f.find("#strategy_menu_popup_upload_greeting"),h;f.find(".target-select").chosen({search_contains:!0,width:"150px"}),f.find(".upload-input").fileUpload({inputOnly:!0,wrapperClass:"upload-container",btnText:i.i18n.active().strategy.popup.fileUploadButton,btnClass:"monster-button-secondary",maxSize:5,success:function(e){h=e[0]},error:function(e){e.hasOwnProperty("size")&&e.size.length>0&&r.ui.alert(i.i18n.active().strategy.alertMessages.fileTooBigAlert),f.find(".upload-container input").val(""),h=undefined}}),f.on("change",".target-select",function(e){var n=t(this),r=n.parents(".target-input").find(".target-icon"),i=n.find("option:selected").parents("optgroup").data("icon");r.attr("class","target-icon "+i)}),f.on("click",".remove-btn",function(e){t(this).parents(".menu-line").remove()}),f.find(".add-menu-line a").on("click",function(e){e.preventDefault();var n=t.extend(!0,{},s.callEntities,{voicemail:s.voicemails},{directory:s.directories}),o=t(r.template(i,"strategy-menuLine",{callEntities:i.strategyGetCallEntitiesDropdownData(n)})),u=o.find(".target-select option:selected").parents("optgroup").data("icon");f.find(".menu-block .left .content").append(o),o.find(".target-icon").addClass(u),o.find(".number-input").focus()}),l.find(".update-greeting").on("click",function(e){var t=l.find("textarea").val();t?a&&a.id?(a.type="virtual_receptionist",a.description="<Text to Speech>",a.media_source="tts",a.tts={voice:"female/en-US",text:t},i.callApi({resource:"media.update",data:{accountId:i.accountId,mediaId:a.id,data:a},success:function(e,t){a=e.data,f.find(".greeting-option").removeClass("active"),l.parents(".greeting-option").addClass("active"),l.collapse("hide")}})):i.callApi({resource:"media.create",data:{accountId:i.accountId,data:{streamable:!0,name:o,type:"virtual_receptionist",media_source:"tts",description:"<Text to Speech>",tts:{voice:"female/en-US",text:t}}},success:function(e,t){a=e.data,u.media.greeting=e.data.id,i.callApi({resource:"menu.update",data:{accountId:i.accountId,menuId:u.id,data:u},success:function(e,t){u=e.data}}),f.find(".greeting-option").removeClass("active"),l.parents(".greeting-option").addClass("active"),l.collapse("hide")}}):r.ui.alert(i.i18n.active().strategy.alertMessages.emptyTtsGreeting)}),c.find(".update-greeting").on("click",function(e){var t=function(e,t,n){i.callApi({resource:"media.upload",data:{accountId:i.accountId,mediaId:t,data:e},success:function(e,t){n&&n()}})};h?a&&a.id?(a.type="virtual_receptionist",a.description=h.name,a.media_source="upload",delete a.tts,i.callApi({resource:"media.update",data:{accountId:i.accountId,mediaId:a.id,data:a},success:function(e,n){a=e.data,t(h.file,a.id,function(){f.find(".greeting-option").removeClass("active"),c.parents(".greeting-option").addClass("active"),c.collapse("hide")})}})):i.callApi({resource:"media.create",data:{accountId:i.accountId,data:{streamable:!0,name:o,type:"virtual_receptionist",media_source:"upload",description:h.name}},success:function(e,n){a=e.data,u.media.greeting=a.id,i.callApi({resource:"menu.update",data:{accountId:i.accountId,menuId:u.id,data:u},success:function(e,t){u=e.data}}),t(h.file,a.id,function(){f.find(".greeting-option").removeClass("active"),c.parents(".greeting-option").addClass("active"),c.collapse("hide")})}}):r.ui.alert(i.i18n.active().strategy.alertMessages.emptyUploadGreeting)}),f.find(".cancel-greeting").on("click",function(e){t(this).parents(".collapse").collapse("hide")}),f.find(".cancel-link").on("click",function(t){t.preventDefault(),e.dialog("close")}),f.find(".save-button").on("click",function(n){var u={},a=!1;t.each(f.find(".menu-line"),function(){var e=t(this),n=e.find(".target-select option:selected"),r=e.find(".number-input").val(),i=n.data("type"),s=n.val();if(!r||r in u)return a=!0,!1;u[r]={children:{},module:i,data:{}};switch(i){case"ring_group":u[r].data.endpoints=[{endpoint_type:"group",id:s}];break;default:u[r].data.id=s}}),a?r.ui.alert(i.i18n.active().strategy.alertMessages.uniqueMenuNumbers):(s.callflows[o].flow.children=u,i.strategyUpdateCallflow(s.callflows[o],function(e){s.callflows[o]=e}),e.dialog("close"))})},strategyGetCallEntitiesDropdownData:function(e,r,i){var s=this,r=r===!0||!1,i=i===!0||!1,o=t.extend(!0,{},e),u=[];return r||(o.user=o.userCallflows),delete o.userCallflows,i||(o.ring_group=o.userGroups),delete o.userGroups,n.each(o,function(e,n){var r={groupName:s.i18n.active().strategy.callEntities[n],groupType:n,entities:t.map(e,function(e){var t=e.name;return t||(e.hasOwnProperty("first_name")?t=e.first_name+" "+e.last_name:e.hasOwnProperty("numbers")&&(t=e.numbers.toString())),{id:e.id,name:t,module:e.module||n}})};switch(r.groupType){case"directory":r.groupIcon="fa fa-book";break;case"user":r.groupIcon="fa fa-user";break;case"device":r.groupIcon="icon-telicon-voip-phone";break;case"ring_group":r.groupIcon="fa fa-users";break;case"media":r.groupIcon="fa fa-music";break;case"voicemail":r.groupIcon="icon-telicon-voicemail"}r.entities.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()}),r.groupType==="directory"?u.unshift(r):r.groupType==="user"?u[0].groupType==="directory"?u.splice(1,0,r):u.unshift(r):u.push(r)}),u},strategyBuildFaxbox:function(e){var t=this;t.strategyGetAccount({success:function(n){var i=n.contact&&n.contact.technical&&n.contact.technical.hasOwnProperty("email")?n.contact.technical.email:undefined;e.data={name:n.name+t.i18n.active().strategy.faxing.nameExtension,caller_name:n.name,caller_id:e.data.number,fax_header:r.config.whitelabel.companyName+t.i18n.active().strategy.faxing.headerExtension,fax_timezone:n.timezone,fax_identity:r.util.formatPhoneNumber(e.data.number),owner_id:n.id,notifications:{inbound:{email:{send_to:i}},outbound:{email:{send_to:i}}}},i||delete e.data.notifications,t.strategyCreateFaxbox(e)}})},strategyGetMainCallflows:function(e){var i=this;i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_value:"type",key_missing:["owner_id","group_id"]}},success:function(s,o){var u={},a={};n.each(s.data,function(e,t){if(e.type==="main"||e.type==="conference"||e.type==="faxing"){var n=e.name||e.numbers[0];e.type==="conference"?n="MainConference":e.type==="faxing"&&(n="MainFaxing"),u[n]=function(t){i.callApi({resource:"callflow.get",data:{accountId:i.accountId,callflowId:e.id},success:function(e,n){t(null,e.data)}})}}}),u.MainConference||(u.MainConference=function(e){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:["undefinedconf"],name:"MainConference",type:"conference",flow:{children:{},data:{},module:"conference"}}},success:function(t,n){e(null,t.data)}})}),u.MainFaxing||(u.MainFaxing=function(e){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:["undefinedfaxing"],name:"MainFaxing",type:"faxing",flow:{children:{},data:{},module:"faxbox"}}},success:function(t,n){e(null,t.data)}})}),n.each(i.subCallflowsLabel,function(e){var t=e+"Menu";u[t]?u[e]||(a[t]=u[t],delete u[t]):a[t]=function(e){i.callApi({resource:"menu.create",data:{accountId:i.accountId,data:{name:t,record_pin:r.util.randomString(4,"1234567890"),media:{exit_media:!0,invalid_media:!0,transfer_media:!0},retries:3,max_extension_length:4,type:"main"}},success:function(n,r){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:[t],type:"main",flow:{children:{},data:{id:n.data.id},module:"menu"}}},success:function(t,n){e&&e(null,t.data)}})}})}}),r.parallel(a,function(s,o){var a=o;n.each(i.subCallflowsLabel,function(e){u[e]||(u[e]=function(t){i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:[e],type:"main",flow:{children:{},data:{id:a[e+"Menu"].id},module:"callflow"}}},success:function(e,n){t(null,e.data)}})})}),r.parallel(u,function(n,r){u.MainCallflow?(delete r.MainCallflow.flow.data.timezone,r.MainCallflow.numbers[0]!=="0"?(r.MainCallflow.numbers[0]==="undefined"?r.MainCallflow.numbers[0]="0":r.MainCallflow.numbers.splice(0,0,"0"),i.strategyUpdateCallflow(r.MainCallflow,function(n){r.MainCallflow=n,e(t.extend(!0,a,r))})):e(t.extend(!0,a,r))):i.callApi({resource:"callflow.create",data:{accountId:i.accountId,data:{contact_list:{exclude:!1},numbers:["0"],name:"MainCallflow",type:"main",flow:{children:{_:{children:{},data:{id:r.MainOpenHours.id},module:"callflow"}},data:{},module:"temporal_route"}}},success:function(n,i){r.MainCallflow=n.data,e(t.extend(!0,a,r))}})})})}})},strategyCreateFeatureCodes:function(e){var i=this;i.strategyGetFeatureCodes(function(s){var o=t.map(s,function(e){return e.featurecode.name}),u=[];n.each(i.featureCodes,function(e){if(o.indexOf(e.name)==-1){var n={flow:{children:{},data:t.extend(!0,e.extraData||{},{action:e.actionName}),module:e.moduleName},featurecode:{name:e.name,number:e.number}};"pattern"in e?n.patterns=[e.pattern]:n.numbers=[e.callflowNumber],u.push(function(e){i.strategyCreateCallflow(n,function(t){e&&e(null,t)})})}}),u.length>0?r.parallel(u,function(t,n){e&&e()}):e&&e()})},strategyGetFeatureCodes:function(e){var t=this,n={paginate:"false",has_key:"featurecode"};t.strategyGetCallflows(function(t){e&&e(t)},n)},strategyGetAllRules:function(e){var t=this;r.parallel({rules:function(e){t.callApi({resource:"temporalRule.list",data:{accountId:t.accountId,filters:{has_key:"type"}},success:function(t,n){e&&e(null,t.data)}})},sets:function(e){t.callApi({resource:"temporalSet.list",data:{accountId:t.accountId,filters:{has_key:"type",filter_type:"main_holidays"}},success:function(i,s){var o={};n.each(i.data,function(e){o[e.id]=function(n){t.strategyGetDetailRuleSet(e.id,function(e){n&&n(null,e)})}}),r.parallel(o,function(t,n){e&&e(null,n)})}})}},function(t,n){e&&e(n)})},strategyGetRule:function(e,t){var n=this;n.callApi({resource:"temporalRule.get",data:{accountId:n.accountId,ruleId:e,generateError:!1},success:function(e,n){t&&t(e.data)},error:function(e,n){t&&t(e.data)}})},strategyGetTemporalRules:function(e){var t=this;t.strategyGetAllRules(function(i){var s={};n.each(i.rules,function(e,n){s[e.name]=function(n){t.strategyGetRule(e.id,function(e){n(null,e)})}}),n.each(t.weekdayLabels,function(e){e in s||(s[e]=function(n){t.callApi({resource:"temporalRule.create",data:{accountId:t.accountId,data:{cycle:"weekly",interval:1,name:e,type:"main_weekdays",time_window_start:32400,time_window_stop:61200,wdays:[e.substring(4).toLowerCase()]}},success:function(e,t){n(null,e.data)}})})}),"MainLunchHours"in s||(s.MainLunchHours=function(e){t.callApi({resource:"temporalRule.create",data:{accountId:t.accountId,data:{cycle:"weekly",interval:1,name:"MainLunchHours",type:"main_lunchbreak",time_window_start:43200,time_window_stop:46800,wdays:t.weekdays}},success:function(t,n){e(null,t.data)}})}),r.parallel(s,function(t,r){var s={weekdays:{},lunchbreak:{},holidays:{}};n.each(r,function(e,t){switch(e.type){case"main_weekdays":s.weekdays[t]=e;break;case"main_lunchbreak":s.lunchbreak=e;break;case"main_holidays":s.holidays[t]=e}}),n.each(i.sets,function(e){n.isEmpty(e)||(s.holidays[e.name]=e)}),e(s)})})},strategyGetCallEntities:function(e){var i=this;r.parallel({users:function(e){i.callApi({resource:"user.list",data:{accountId:i.accountId,filters:{paginate:"false"}},success:function(t,n){e(null,t.data)}})},media:function(e){i.strategyListMedia(function(t){e(null,t)})},userCallflows:function(e){i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_key:"owner_id"}},success:function(t,r){var i=n.filter(t.data,function(e){return e.type==="mainUserCallflow"||!("type"in e)});e(null,i)}})},groups:function(e){i.callApi({resource:"group.list",data:{accountId:i.accountId,filters:{paginate:"false"}},success:function(t,n){e(null,t.data)}})},ringGroups:function(e){i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_key:"group_id",filter_type:"baseGroup"}},success:function(t,n){e(null,t.data)}})},userGroups:function(e){i.callApi({resource:"callflow.list",data:{accountId:i.accountId,filters:{has_key:"group_id",filter_type:"userGroup"}},success:function(t,n){e(null,t.data)}})},devices:function(e){i.callApi({resource:"device.list",data:{accountId:i.accountId,filters:{paginate:"false"}},success:function(t,n){e(null,t.data)}})},advancedCallflows:function(e){i.strategyGetCallflows(function(t){e(null,t)},{filter_ui_is_main_number_cf:!0})}},function(r,i){var s={device:i.devices,user:t.extend(!0,[],i.users),media:i.media,userCallflows:[],ring_group:[],userGroups:t.map(i.userGroups,function(e){var t=n.find(i.groups,function(t){return e.group_id===t.id});return e.name=t&&t.name||e.name,e.module="callflow",e}),advancedCallflows:i.advancedCallflows};n.each(s.media,function(e){e.module="media"}),n.each(s.device,function(e){e.module="device"}),n.each(i.users,function(e){var t=n.find(i.userCallflows,function(t){return t.owner_id===e.id});t?(e.id=t.id,e.module="callflow"):e.module="user",s.userCallflows.push(e)}),n.each(i.groups,function(e){var t=n.find(i.ringGroups,function(t){return t.group_id===e.id});t?(e.id=t.id,e.module="callflow"):e.module="ring_group",s.ring_group.push(e)}),n.each(i.advancedCallflows,function(e){e.module="callflow"}),e(s)})},strategyGetVoicesmailBoxes:function(e){var t=this;t.callApi({resource:"voicemail.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t,n){t.data.sort(function(e,t){return e.name.toLowerCase()>t.name.toLowerCase()}),e(t.data)}})},strategyListAccountNumbers:function(e){var t=this;t.callApi({resource:"numbers.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t,n){e(t.data.numbers)}})},strategyGetNumber:function(e,t){var n=this;n.callApi({resource:"numbers.get",data:{accountId:n.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){t(e.data)}})},strategyUpdateNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.update",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e),data:t},success:function(e,t){n()}})},strategyRebuildMainCallflowRuleArray:function(e){var t=this,r=e.callflows.MainCallflow,i=e.temporalRules,s=[];n.each(i.holidays,function(e,t){e.id in r.flow.children&&s.push(e.id)}),i.lunchbreak.id in r.flow.children&&s.push(i.lunchbreak.id),n.each(i.weekdays,function(e,t){e.id in r.flow.children&&s.push(e.id)}),r.flow.data.rules=s},strategyGetCallflows:function(e,t){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:t||{}},success:function(t){e&&e(t.data)}})},strategyCreateCallflow:function(e,t){var n=this;n.callApi({resource:"callflow.create",data:{accountId:n.accountId,data:e},success:function(e){t&&t(e.data)}})},strategyUpdateCallflow:function(e,t){var n=this,r=e.id;delete e.metadata,delete e.id,n.callApi({resource:"callflow.update",data:{accountId:n.accountId,callflowId:r,data:e},success:function(e,n){t(e.data)}})},strategyListDirectories:function(e,t){var n=this;n.callApi({resource:"directory.list",data:{accountId:n.accountId},success:function(t,n){e&&e(t.data)},error:function(e,n){t&&t()}})},strategyListMedia:function(e){var t=this;t.callApi({resource:"media.list",data:{accountId:t.accountId},success:function(t,n){e&&e(t.data)}})},_strategyOnCurrentAccountUpdated:function(e){var n=this;t("#strategy_custom_hours_timezone").text(i.formatTimezone(e.timezone))},strategyUpdateOriginalUser:function(e,t){var n=this;n.callApi({resource:"user.update",data:{userId:e.id,accountId:r.apps.auth.originalAccount.id,data:e},success:function(e){t&&t(e.data)}})},strategyGetAccount:function(e){var t=this;t.callApi({resource:"account.get",data:{accountId:t.accountId},success:function(t,n){e.hasOwnProperty("success")&&e.success(t.data)},error:function(t,n){e.hasOwnProperty("error")&&e.error()}})},strategyCreateFaxbox:function(e){var t=this;t.callApi({resource:"faxbox.create",data:{accountId:t.accountId,data:e.data},success:function(t,n){e.hasOwnProperty("success")&&e.success(t.data)},error:function(t,n){e.hasOwnProperty("error")&&e.error()}})},strategyDeleteFaxbox:function(e){var t=this;t.callApi({resource:"faxbox.delete",data:{accountId:t.accountId,faxboxId:e.data.id},success:function(t,n){e.hasOwnProperty("success")&&e.success(t.data)},error:function(t,n){e.hasOwnProperty("error")&&e.error()}})}};return o});