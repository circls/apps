define(["require","jquery","underscore","mask","monster","toastr"],function(e){var t=e("jquery"),n=e("underscore"),r=e("mask"),i=e("monster"),s=e("toastr"),o={requests:{"provisioner.ui.getModel":{apiRoot:i.config.api.provisioner,url:"ui/{brand}/{family}/{model}",verb:"GET",generateError:!1}},subscribe:{"voip.devices.render":"devicesRender","voip.devices.renderAdd":"devicesRenderAdd","voip.devices.editDevice":"devicesRenderEdit"},devicesRender:function(e){var r=this,s=e||{},o=s.parent||t(".right-content"),u=s.deviceId||"",a=s.callback;r.devicesGetData(function(e){var s=r.devicesFormatListData(e),f=t(i.template(r,"devices-layout",s)),l;n.each(s.devices,function(e){l=i.template(r,"devices-row",e),f.find(".devices-rows").append(l)}),r.devicesBindEvents(f,o,s),o.empty().append(f);if(u){var c=o.find(".grid-row[data-id="+u+"]");i.ui.highlight(c,{endColor:"#FCFCFC"})}s.devices.length===0?o.find(".no-devices-row").css("display","block"):o.find(".no-devices-row").css("display","none"),a&&a()})},devicesBindEvents:function(e,r,i){var s=this;setTimeout(function(){e.find(".search-query").focus()}),e.find(".devices-header .search-query").on("keyup",function(){var r=t(this).val().toLowerCase(),i=e.find(".devices-rows .grid-row:not(.title)"),s=e.find(".devices-rows .empty-search-row");n.each(i,function(e){var n=t(e);n.data("search").toLowerCase().indexOf(r)<0?n.hide():n.show()}),i.size()>0&&(i.is(":visible")?s.hide():s.show())}),e.find(".switch-state").on("change",function(){var e=t(this),r=e.parents(".grid-row"),o=r.data("id"),u=e.prop("checked");s.devicesGetDevice(o,function(t){t.enabled=u,s.devicesUpdateDevice(t,function(e){r.find(".type").removeClass("unregistered registered disabled");var t="disabled";e.enabled===!0&&(t="unregistered",n.each(i.devices,function(n){if(n.id===e.id)return n.registered===!0&&(t="registered"),!1})),r.find(".type").addClass(t)},function(){e.prop("checked",!u)})},function(){e.prop("checked",!u)})}),e.find(".settings").on("click",function(){var e=t(this),n={id:e.parents(".grid-row").data("id"),isRegistered:e.parents(".grid-row").data("registered")===!0};s.devicesRenderEdit({data:n,callbackSave:function(e){s.devicesRender({deviceId:e.id})}})}),e.find(".create-device").on("click",function(){var e=t(this).data("type");s.devicesRenderAdd({type:e,callback:function(e){s.devicesRender({deviceId:e.id})}})})},devicesRenderEdit:function(e){var n=this,r=e.data,i=e.callbackSave,s=e.callbackDelete||function(e){n.devicesRender()};n.devicesGetEditData(r,function(e){e.hasOwnProperty("provision")?n.devicesGetIterator(e.provision,function(r){if(r.hasOwnProperty("feature_keys")&&r.feature_keys.iterate>0){e.provision.hasOwnProperty("feature_keys")||(e.provision.feature_keys={});for(var o=0,u=r.feature_keys.iterate;o<u;o++)e.provision.feature_keys.hasOwnProperty(o)||(e.provision.feature_keys[o]={type:"none"});n.callApi({resource:"user.list",data:{accountId:n.accountId},success:function(r,o){var u=["none","presence","parking","personal_parking","speed_dial"],a=[],f;r.data.sort(function(e,t){return e.last_name.toLowerCase()>t.last_name.toLowerCase()?1:-1});for(var l=0;l<10;l++)a[l]=l+1;u.forEach(function(e,t,r){r[t]={id:e,text:n.i18n.active().devices.popupSettings.featureKeys.types[e]},e!=="none"&&(r[t].info=n.i18n.active().devices.popupSettings.featureKeys.info.types[e])}),f={users:r.data,featureKeys:{parkingSpots:a,types:u}},e.extra=e.hasOwnProperty(f)?t.extend(!0,{},e.extra,f):f,n.devicesRenderDevice(e,i,s)}})}else n.devicesRenderDevice(e,i,s)},function(){n.devicesRenderDevice(e,i,s)}):n.devicesRenderDevice(e,i,s)})},devicesRenderAdd:function(e){var t=this,n=e.type,r=e.callback,s={device_type:n};n==="sip_device"&&i.config.api.provisioner?i.pub("common.chooseModel.render",{callback:function(e,n){t.callApi({resource:"device.create",data:{accountId:t.accountId,data:e},success:function(e,t){r(e.data),n&&n()}})},callbackMissingBrand:function(){t.devicesRenderEdit({data:s,callbackSave:function(e){r&&r(e)}})}}):t.devicesRenderEdit({data:s,callbackSave:function(e){r&&r(e)}})},devicesRenderDevice:function(e,r,o){var u=this,a=e.id?"edit":"add",f=e.device_type,l=a==="edit"?i.template(u,"!"+u.i18n.active().devices[f].editTitle,{name:e.name}):u.i18n.active().devices[f].addTitle,c=t(i.template(u,"devices-"+f,t.extend(!0,{},e,{showEmergencyCnam:i.util.isNumberFeatureEnabled("cnam")&&i.util.isNumberFeatureEnabled("e911")}))),h=c.find("#form_device");if(e.hasOwnProperty("provision")&&e.provision.hasOwnProperty("feature_keys")){var p='.tabs-section[data-section="featureKeys"] ';n.each(e.provision.feature_keys,function(e,t){var n='.control-group[data-id="'+t+'"] ',r='.feature-key-value[data-type="'+e.type+'"]';c.find(p.concat(n,r)).addClass("active").find('[name="provision.feature_keys['+t+'].value"]').val(e.value)}),t.each(c.find(".feature-key-index"),function(e,n){t(n).text(parseInt(t(n).text(),10)+1)})}if(e.extra.hasE911Numbers){var d;e.caller_id&&e.caller_id.emergency&&e.caller_id.emergency.number&&(d=e.caller_id.emergency.number,u.devicesGetE911NumberAddress(e.caller_id.emergency.number,function(e){c.find(".number-address").show().find("p").html(e)})),i.pub("common.numberSelector.render",{container:c.find(".emergency-number"),inputName:"caller_id.emergency.number",number:d,customNumbers:e.extra.e911Numbers,noBuy:!0,labels:{empty:u.i18n.active().devices.popupSettings.callerId.notSet,remove:u.i18n.active().devices.popupSettings.callerId.useDefault,spare:u.i18n.active().devices.popupSettings.callerId.selectNumber,hideNumber:!0}})}i.ui.validate(h,{rules:{name:{required:!0},mac_address:{required:!0,mac:!0},"mobile.mdn":{number:!0},"sip.username":{required:!0},"sip.password":{required:!0},"call_forward.number":{required:!0}},ignore:""});if(t.inArray(f,["sip_device","smartphone","mobile","softphone","fax","ata"])>-1)var v=i.ui.codecSelector("audio",c.find("#audio_codec_selector"),e.media.audio.codecs);if(t.inArray(f,["sip_device","smartphone","mobile","softphone"])>-1)var m=i.ui.codecSelector("video",c.find("#video_codec_selector"),e.media.video.codecs);i.ui.tabs(c),i.ui.protectField(c.find("#sip_password"),c),i.ui.tooltips(c),c.find("#mac_address").mask("hh:hh:hh:hh:hh:hh",{placeholder:" "}),c.find(".chosen-feature-key-user").chosen({search_contains:!0,width:"inherit"}),e.media.encryption.enforce_security||c.find("#rtp_method").hide(),c.find("#secure_rtp").on("change",function(){c.find("#rtp_method").toggle()}),c.find("#restart_device").on("click",function(){t(this).hasClass("disabled")||u.devicesRestart(e.id,function(){s.success(u.i18n.active().devices.popupSettings.miscellaneous.restart.success)})}),c.find(".actions .save").on("click",function(){if(i.ui.valid(h)){c.find(".feature-key-value:not(.active)").remove();var t=u.devicesMergeData(e,c,v,m);u.devicesSaveDevice(t,function(e){g.dialog("close").remove(),r&&r(e)})}else c.find('.tabs-selector[data-section="basic"]').click()}),f!=="mobile"&&c.find("#delete_device").on("click",function(){var e=t(this).parents(".edit-device").data("id");i.ui.confirm(u.i18n.active().devices.confirmDeleteDevice,function(){u.devicesDeleteDevice(e,function(e){g.dialog("close").remove(),s.success(i.template(u,"!"+u.i18n.active().devices.deletedDevice,{deviceName:e.name})),o&&o(e)})})}),c.find(".actions .cancel-link").on("click",function(){g.dialog("close").remove()}),c.on("change",".caller-id-select",function(){var e=this.value,t=c.find(".number-address");t.find("p").empty(),e!==""?(u.devicesGetE911NumberAddress(e,function(e){t.find("p").html(e)}),t.slideDown()):t.slideUp()}),c.find(".restrictions-switch").on("change",function(){c.find(".restriction-matcher-sign").hide(),c.find(".restriction-message").hide()}),c.find(".restriction-matcher-button").on("click",function(e){e.preventDefault();var t=c.find(".restriction-matcher-input").val(),n=!1;t?u.callApi({resource:"numbers.matchClassifier",data:{accountId:u.accountId,phoneNumber:encodeURIComponent(t)},success:function(e,n){var r=c.find('.restriction-line[data-restriction="'+e.data.name+'"]'),s=r.find(".restriction-matcher-sign"),o=c.find(".restriction-message");c.find(".restriction-matcher-sign").hide(),r.find(".restrictions-switch").prop("checked")?(s.removeClass("monster-red fa-times").addClass("monster-green fa-check").css("display","inline-block"),o.removeClass("red-box").addClass("green-box").css("display","inline-block").empty().text(i.template(u,"!"+u.i18n.active().devices.popupSettings.restrictions.matcher.allowMessage,{phoneNumber:i.util.formatPhoneNumber(t)}))):(s.removeClass("monster-green fa-check").addClass("monster-red fa-times").css("display","inline-block"),o.removeClass("green-box").addClass("red-box").css("display","inline-block").empty().text(i.template(u,"!"+u.i18n.active().devices.popupSettings.restrictions.matcher.denyMessage,{phoneNumber:i.util.formatPhoneNumber(t)})))}}):(c.find(".restriction-matcher-sign").hide(),c.find(".restriction-message").hide())}),c.find(".feature-key-type").on("change",function(){var e=t(this).val();t(this).siblings(".feature-key-value.active").removeClass("active"),t(this).siblings('.feature-key-value[data-type="'+e+'"]').addClass("active")}),c.find('.tabs-section[data-section="featureKeys"] .type-info a').on("click",function(){var e=t(this);setTimeout(function(){var t=(e.hasClass("collapsed")?"show":"hide").concat("Info");e.find(".text").text(u.i18n.active().devices.popupSettings.featureKeys.info.link[t])})});var g=i.ui.dialog(c,{position:["center",20],title:l,dialogClass:"voip-edit-device-popup overflow-visible"})},devicesRestart:function(e,t){var n=this;n.callApi({resource:"device.restart",data:{accountId:n.accountId,deviceId:e},success:function(e){t&&t(e.data)}})},devicesMergeData:function(e,r,s,o){var u=this,a=t.inArray(e.device_type,["sip_device","landline","fax","ata","softphone","smartphone","mobile","sip_uri"])>-1,f=t.inArray(e.device_type,["fax","ata","softphone","smartphone","mobile"])>-1,l=t.inArray(e.device_type,["landline","cellphone","smartphone"])>-1,c=t.inArray(e.device_type,["sip_device","mobile","softphone"])>-1,h=i.ui.getFormData("form_device");"mac_address"in h&&(h.mac_address=i.util.formatMacAddress(h.mac_address)),l&&(h.call_forward=t.extend(!0,{enabled:!0,require_keypress:!0,keep_caller_id:!0},h.call_forward),e.device_type==="smartphone"&&(h.call_forward.failover=!0)),a&&(h.media=t.extend(!0,{audio:{codecs:[]},video:{codecs:[]}},h.media)),f&&(h.sip=t.extend(!0,{expire_seconds:360,invite_format:"username",method:"password"},h.sip)),"call_restriction"in h&&n.each(h.call_restriction,function(t,n){n in e.extra.restrictions&&e.extra.restrictions[n].disabled?t.action=e.extra.restrictions[n].action:t.action=t.action===!0?"inherit":"deny"});if(h.hasOwnProperty("provision")&&h.provision.hasOwnProperty("feature_keys")){var p={};h.provision.feature_keys.forEach(function(e,t){p[t]=e}),h.provision.feature_keys=p}var d=t.extend(!0,{},e,h);c&&(d.media.encryption.methods=[],d.media.encryption.enforce_security&&d.media.encryption.methods.push(h.extra.rtpMethod)),d.extra.hasOwnProperty("notify_unregister")&&(d.suppress_unregister_notifications=!d.extra.notify_unregister),a&&(s&&(d.media.audio.codecs=s.getSelectedItems()),o&&(d.media.video.codecs=o.getSelectedItems())),d.hasOwnProperty("media")&&d.media.hasOwnProperty("fax_option")&&d.media.fax_option==="auto"&&delete d.media.fax_option,d.hasOwnProperty("media")&&d.media.hasOwnProperty("fax")&&d.media.fax.hasOwnProperty("option")&&delete d.media.fax.option;if(d.hasOwnProperty("provision")&&d.provision.hasOwnProperty("feature_keys")){for(var v in d.provision.feature_keys)d.provision.feature_keys[v].type==="none"&&delete d.provision.feature_keys[v];n.isEmpty(d.provision.feature_keys)&&delete d.provision.feature_keys}return delete d.media.secure_rtp,delete d.extra,d},devicesFormatData:function(e,r){var s=this,o={extra:{hasE911Numbers:!n.isEmpty(e.e911Numbers),e911Numbers:e.e911Numbers,restrictions:e.listClassifiers,rtpMethod:e.device.media&&e.device.media.encryption&&e.device.media.encryption.enforce_security?e.device.media.encryption.methods[0]:"",selectedCodecs:{audio:[],video:[]},availableCodecs:{audio:[],video:[]}},call_restriction:{},device_type:"sip_device",enabled:!0,media:{encryption:{enforce_security:!1},audio:{codecs:["PCMU","PCMA"]},video:{codecs:[]}},suppress_unregister_notifications:!0},u={sip_device:{sip:{password:i.util.randomString(12),realm:i.apps.auth.currentAccount.realm,username:"user_"+i.util.randomString(10)}},landline:{call_forward:{require_keypress:!0,keep_caller_id:!0},contact_list:{exclude:!0}},cellphone:{call_forward:{require_keypress:!0,keep_caller_id:!0},contact_list:{exclude:!0}},ata:{sip:{password:i.util.randomString(12),realm:i.apps.auth.currentAccount.realm,username:"user_"+i.util.randomString(10)}},fax:{media:{fax_option:"false"},outbound_flags:["fax"],sip:{password:i.util.randomString(12),realm:i.apps.auth.currentAccount.realm,username:"user_"+i.util.randomString(10)}},softphone:{sip:{password:i.util.randomString(12),realm:i.apps.auth.currentAccount.realm,username:"user_"+i.util.randomString(10)}},mobile:{sip:{password:i.util.randomString(12),realm:i.apps.auth.currentAccount.realm,username:"user_"+i.util.randomString(10)}},smartphone:{call_forward:{require_keypress:!0,keep_caller_id:!0},contact_list:{exclude:!0},sip:{password:i.util.randomString(12),realm:i.apps.auth.currentAccount.realm,username:"user_"+i.util.randomString(10)}},sip_uri:{sip:{password:i.util.randomString(12),username:"user_"+i.util.randomString(10),expire_seconds:360,invite_format:"route",method:"password"}}};n.each(e.listClassifiers,function(t,n){n in s.i18n.active().devices.classifiers&&(o.extra.restrictions[n].friendly_name=s.i18n.active().devices.classifiers[n].name,"help"in s.i18n.active().devices.classifiers[n]&&(o.extra.restrictions[n].help=s.i18n.active().devices.classifiers[n].help)),"call_restriction"in e.accountLimits&&n in e.accountLimits.call_restriction&&e.accountLimits.call_restriction[n].action==="deny"&&(o.extra.restrictions[n].disabled=!0,o.extra.hasDisabledRestrictions=!0),"call_restriction"in e.device&&n in e.device.call_restriction?o.extra.restrictions[n].action=e.device.call_restriction[n].action:o.extra.restrictions[n].action="inherit"});var a=t.extend(!0,{},u[e.device.device_type],o,e.device);return e.device.media&&e.device.media.audio&&e.device.media.audio.codecs&&(a.media.audio.codecs=e.device.media.audio.codecs),e.device.media&&e.device.media.video&&e.device.media.video.codecs&&(a.media.video.codecs=e.device.media.video.codecs),a.extra.isRegistered=r.isRegistered,a},devicesFormatListData:function(e){var t=this,r={countDevices:0,devices:{}},i={},s=t.i18n.active().devices.unassignedDevice,o={cellphone:"fa fa-phone",smartphone:"icon-telicon-mobile-phone",landline:"icon-telicon-home",mobile:"icon-telicon-sprint-phone",softphone:"icon-telicon-soft-phone",sip_device:"icon-telicon-voip-phone",sip_uri:"icon-telicon-voip-phone",fax:"icon-telicon-fax",ata:"icon-telicon-fax"};n.each(e.users,function(e){i[e.id]=e}),n.each(e.devices,function(e){var n=e.owner_id?!0:!1;r.countDevices++,r.devices[e.id]={id:e.id,isAssigned:n+"",friendlyIconClass:o[e.device_type],macAddress:e.mac_address,name:e.name,userName:e.owner_id&&e.owner_id in i?i[e.owner_id].first_name+" "+i[e.owner_id].last_name:s,sortableUserName:e.owner_id&&e.owner_id in i?i[e.owner_id].last_name+" "+i[e.owner_id].first_name:s,enabled:e.enabled,type:e.device_type,friendlyType:t.i18n.active().devices.types[e.device_type],registered:!1,classStatus:e.enabled?"unregistered":"disabled",isRegistered:!1}}),n.each(e.status,function(e){if(e.registered===!0&&e.device_id in r.devices){var t=r.devices[e.device_id];t.registered=!0,t.enabled&&(t.classStatus="registered",t.isRegistered=!0)}});var u=[];return n.each(r.devices,function(e){u.push(e)}),u.sort(function(e,t){if(e.userName===t.userName){var n=e.name.toLowerCase(),r=t.name.toLowerCase();return n>r?1:n<r?-1:0}if(e.userName===s)return 1;if(t.userName===s)return-1;var i=e.sortableUserName.toLowerCase(),o=t.sortableUserName.toLowerCase();return i>o?1:i<o?-1:0}),r.devices=u,r},devicesDeleteDevice:function(e,t){var n=this;n.callApi({resource:"device.delete",data:{accountId:n.accountId,deviceId:e,data:{}},success:function(e){t(e.data)}})},devicesListClassifiers:function(e){var t=this;t.callApi({resource:"numbers.listClassifiers",data:{accountId:t.accountId},success:function(t){e(t.data)}})},devicesGetE911Numbers:function(e){var t=this;t.callApi({resource:"numbers.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(r){i.pub("common.numbers.getListFeatures",function(i){var s={};n.each(r.data.numbers,function(e,n){e.features.indexOf("dash_e911")>=0&&(s[n]=t.devicesFormatNumber(e,i))}),e(s)})}})},devicesFormatNumber:function(e,r){var i=this;return e.viewFeatures=t.extend(!0,{},r),"locality"in e&&(e.isoCountry=e.locality.country||"",e.friendlyLocality="city"in e.locality?e.locality.city+("state"in e.locality?", "+e.locality.state:""):""),n.each(e.features,function(t){t in e.viewFeatures&&(e.viewFeatures[t].active="active")}),e},devicesGetEditData:function(e,t){var n=this;i.parallel({listClassifiers:function(e){n.devicesListClassifiers(function(t){e(null,t)})},device:function(t){e.id?n.devicesGetDevice(e.id,function(e){t(null,e)}):t(null,e)},e911Numbers:function(e){n.devicesGetE911Numbers(function(t){e(null,t)})},accountLimits:function(e){n.callApi({resource:"limits.get",data:{accountId:n.accountId},success:function(t,n){e(null,t.data)}})}},function(r,i){var s=n.devicesFormatData(i,e);t&&t(s)})},devicesGetDevice:function(e,t,n){var r=this;r.callApi({resource:"device.get",data:{accountId:r.accountId,deviceId:e},success:function(e){t&&t(e.data)},error:function(e){n&&n(e)}})},devicesSaveDevice:function(e,t){var n=this;e.id?n.devicesUpdateDevice(e,t):n.devicesCreateDevice(e,t)},devicesCreateDevice:function(e,t){var n=this;n.callApi({resource:"device.create",data:{accountId:n.accountId,data:e},success:function(e){t(e.data)}})},devicesUpdateDevice:function(e,t,n){var r=this;r.callApi({resource:"device.update",data:{accountId:r.accountId,data:e,deviceId:e.id},success:function(e){t&&t(e.data)},error:function(e){n&&n(e)}})},devicesGetData:function(e){var t=this;i.parallel({users:function(e){t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(null,t.data)}})},status:function(e){t.callApi({resource:"device.getStatus",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e&&e(null,t.data)}})},devices:function(e){t.callApi({resource:"device.list",data:{accountId:t.accountId,filters:{paginate:"false"}},success:function(t){e(null,t.data)}})}},function(t,n){e&&e(n)})},devicesGetE911NumberAddress:function(e,t){var n=this;n.callApi({resource:"numbers.get",data:{accountId:n.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){var r=e.data.dash_e911.street_address,i=e.data.dash_e911.locality,s=e.data.dash_e911.postal_code,o=e.data.dash_e911.region;typeof e.data.dash_e911.extended_address!="undefined"?t(r+", "+e.data.dash_e911.extended_address+"<br>"+i+", "+o+" "+s):t(r+", "+"<br>"+i+", "+o+" "+s)}})},devicesGetIterator:function(e,t,n){var r=this;i.request({resource:"provisioner.ui.getModel",data:{brand:e.endpoint_brand,family:e.endpoint_family,model:e.endpoint_model},success:function(e,n){t&&t(e.data.template)},error:function(e,t){n&&n()}})}};return o});