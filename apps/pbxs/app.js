define(["require","jquery","underscore","monster","toastr","nicescroll"],function(e){var t=e("jquery"),n=e("underscore"),r=e("monster"),i=e("toastr"),s=e("nicescroll"),o={name:"pbxs",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1},"ru-RU":{customCss:!1},"es-ES":{customCss:!1}},requests:{},subscribe:{"pbxsManager.activate":"_render","pbxsManager.edit":"editServer"},load:function(e){var t=this;t.initApp(function(){e&&e(t)})},initApp:function(e){var t=this;r.pub("auth.initApp",{app:t,callback:e})},render:function(e){var t=this;t._render(e)},_render:function(e){var i=this,s=t(r.template(i,"pbxsManager")),o=n.isEmpty(e)?t("#monster-content"):e;o.empty().append(s),i.renderList(-1,o,function(e){i.refreshUnassignedList(function(){i.bindEvents(s),e.length===0?r.pub("pbxsManager.edit",{}):e.length>=1&&(r.pub("pbxsManager.edit",{id:0}),s.find('.pbx-wrapper[data-id="0"]').addClass("selected"))})}),s.find("#pbxs_manager_listpanel").niceScroll({cursorcolor:"#333",autohidemode:!1,cursorborder:"1px solid #666"}).railh.addClass("pbx-fixed-hscroll"),s.find("#unassigned_numbers_wrapper").niceScroll({cursorcolor:"#333",cursoropacitymin:.5,hidecursordelay:1e3}).rail.addClass("unassigned-number-fixed-vscroll")},editServer:function(e){var n=this;r.parallel({realm:function(e){n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(t,n){e(null,t.data.realm)}})},account:function(e){n.getAccount(function(t){e(null,t)})},numbers:function(e){n.listAllNumbers(function(t){e(null,t)})}},function(i,s){var o=e.parent||t("#monster-content"),u=e.target||o.find("#pbxs_manager_view"),a=e.callbacks||{},f={saveSuccess:a.saveSuccess||function(r){var i=e.id===0||e.id?e.id:r.data.servers.length-1;n.renderList(i,o,function(){var e=t.extend(!0,{},l),s=t.extend(!0,e,r.data.servers[i]);n.renderPbxsManager(r,s,u,f)},r.data.servers)},saveError:a.saveError,deleteSuccess:a.deleteSuccess||function(){u.empty(),n.renderList()},cancelSuccess:a.cancelSuccess||function(){r.pub("pbxsManager.edit",{id:e.id,parent:o,target:u,callbacks:f})},deleteError:a.deleteError,afterRender:a.afterRender},l={auth:{auth_user:"user_"+r.util.randomString(8),auth_password:r.util.randomString(12),auth_method:"IP"},options:{e911_info:{}},cfg:{register_time:"360",opening_pings:!0,caller_id_header:"p-asserted",supported_codecs:"g722",signaling_type:"rfc_2833",allow_refer:!0,use_t38:!0},extra:{support_email:r.config.support_email||"support@2600hz.com",pbx_help_link:r.config.pbx_help_link||"https://2600hz.atlassian.net/wiki/display/docs/Trunking.io",pbx_help_configuration_link:r.config.pbx_help_configuration_link||"https://2600hz.atlassian.net/wiki/display/docs/Trunking_config.io",configure:"manually",realm:s.realm,id:e.id||(e.id===0?0:"new")}};s.account.data.servers&&t.each(s.account.data.servers,function(e,n){t.each(n.DIDs,function(t,n){if(t in s.numbers.data.numbers){var r=s.numbers.data.numbers[t];s.account.data.servers[e].DIDs[t].features=r.features,"locality"in r&&(s.account.data.servers[e].DIDs[t].isoCountry=r.locality.country||"")}})}),typeof e!="object"||!e.id&&e.id!==0?n.renderEndpoint(s.accounts,l,u,f,o):n.renderPbxsManager(s.account,t.extend(!0,l,s.account.data.servers[e.id]),u,f)})},listAvailablePbxs:function(){return["allworks","altigen","asterisk","avaya","bluebox","cisco","digium","epygi","freepbx","freeswitch","mitel","objectworld","other","pingtel","responsepoint","samsung","shoretel","sutus","talkswitch","threecom","taridium"]},listAllNumbers:function(e,t){var n=this;n.callApi({resource:"numbers.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(t,n){typeof e=="function"&&e(t,n)},error:function(e,n){typeof t=="function"&&t(e,n)}})},listCallflows:function(e,t){var n=this;n.callApi({resource:"callflow.list",data:{accountId:n.accountId,filters:{paginate:"false"}},success:function(t,n){typeof e=="function"&&e(t,n)},error:function(e,n){typeof t=="function"&&t(e,n)}})},createAccount:function(e,t){var n=this;n.callApi({resource:"account.get",data:{accountId:n.accountId},success:function(r,i){var s={account:{credits:{prepay:"0.00"},trunks:0,inbound_trunks:0,auth_realm:r.data.realm},billing_account_id:n.accountId,DIDs_Unassigned:{},servers:[]};n.callApi({resource:"connectivity.create",data:{accountId:n.accountId,data:s},success:function(t,n){typeof e=="function"&&e(t,n)},error:function(e,n){typeof t=="function"&&t(e,n)}})}})},listAccounts:function(e,t){var n=this;n.callApi({resource:"connectivity.list",data:{accountId:n.accountId},success:function(t,n){typeof e=="function"&&e(t,n)},error:function(e,n){typeof t=="function"&&t(e,n)}})},getAccount:function(e,t){var n=this;n.callApi({resource:"connectivity.get",data:{accountId:n.accountId,connectivityId:n.connectivityId},success:function(t,n){typeof e=="function"&&e(t,n)},error:function(e,n){typeof t=="function"&&t(e,n)}})},listServers:function(e,t){var n=this,i=function(){n.getAccount(function(t,n){e(t.data.servers,n)})};n.listAccounts(function(e,t){e.data.length?(n.connectivityId=e.data[0],i()):n.createAccount(function(e){n.listAccounts(function(e,t){n.connectivityId=e.data[0],i()})},function(e,t){var i=r.template(n,"!"+n.i18n.active().error_signup,{status:t});r.ui.alert(i)})})},getNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.get",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){typeof t=="function"&&t(e)},error:function(e,t){typeof n=="function"&&n(e)}})},updateNumber:function(e,t,n,r){var i=this;i.callApi({resource:"numbers.update",data:{accountId:i.accountId,phoneNumber:encodeURIComponent(e),data:t},success:function(e,t){typeof n=="function"&&n(e)},error:function(e,t){typeof r=="function"&&r(e)}})},createNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.create",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e),data:{}},success:function(e,n){typeof t=="function"&&t(e,n)},error:function(e,t){typeof n=="function"&&n(e,t)}})},activateNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.activate",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e),data:{}},success:function(e,n){typeof t=="function"&&t(e,n)},error:function(e,t){typeof n=="function"&&n(e,t)}})},deleteNumber:function(e,t,n){var r=this;r.callApi({resource:"numbers.delete",data:{accountId:r.accountId,phoneNumber:encodeURIComponent(e)},success:function(e,n){typeof t=="function"&&t(e,n)},error:function(e,t){typeof n=="function"&&n(e,t)}})},cleanPhoneNumberData:function(e){var t=this;return e},cleanFormData:function(e){var t=this;if(e.server_name===""||!("server_name"in e))e.server_name="PBX "+e.extra.serverid;return e.hasOwnProperty("extra")&&e.extra.hasOwnProperty("compatibilityMode")&&(e.options.media_handling=e.extra.compatibilityMode===!0?"process":"bypass"),delete e.extra,e},saveEndpoint:function(e,n,i,s){var o=this,u=e.extra.serverid,a=t.extend(!0,{},n.data);o.cleanFormData(e),e.server_name?(!u&&u!==0||u==="new"?a.servers.push(t.extend(!0,{DIDs:{},options:{enabled:!0,inbound_format:"e.164",international:!1,caller_id:{},e911_info:{},failover:{}},permissions:{users:[]},monitor:{monitor_enabled:!1}},e)):(t.extend(!0,a.servers[u],e),(e.options.media_handling==="bypass"||!e.options.hasOwnProperty("codecs")||e.options.codecs.length===0)&&delete a.servers[u].options.codecs),o.updateOldTrunkstore(a,i,s)):r.ui.alert("formatting_error")},normalizeData:function(e){var n=this;return t.each(e.servers,function(n,r){delete e.servers[n][""],t.each(r.DIDs,function(r,i){t.each(i,function(t,i){i===!1&&delete e.servers[n].DIDs[r][t]})})}),e},updateOldTrunkstore:function(e,t,n){var r=this;r.normalizeData(e),r.callApi({resource:"connectivity.update",data:{accountId:r.accountId,connectivityId:r.connectivityId,data:e},success:function(e,n){i.success(r.i18n.active().changesSaved),typeof t=="function"&&t(e,n)},error:function(e,t){typeof n=="function"&&n(e,t)}})},loadSpecificStep:function(e,n,r){t(".wizard-top-bar",r).hide(),t(".wizard-content-step",r).hide(),t('.wizard-content-step[data-step="'+e+'"]',r).show(),t(".wizard-buttons button",r).hide(),t(".cancel",r).show(),t(".submit-btn",r).show(),t("#list_pbxs_navbar").hide(),t(".cancel",r).off().on("click",function(e){e.preventDefault(),typeof n.cancelSuccess=="function"&&n.cancelSuccess()})},initializeWizard:function(e,n){var i=this,s=parseInt(t(".wizard-top-bar",e).attr("data-max_step"));t(".wizard-top-bar",e).attr("data-active_step","1"),t(".wizard-content-step",e).hide(),t('.wizard-content-step[data-step="1"]',e).show(),t(".wizard-top-bar",e).attr("data-active_step","1"),s!==1?t(".submit-btn",e).hide():t(".next-step",e).hide(),t(".prev-step",e).hide(),t(".step",e).on("click",function(){var n=t(this).data("step");t(this).hasClass("completed")&&i.validate_step(t(".wizard-top-bar",e).attr("data-active_step"),e,function(){i.change_step(n,s,e)})}),t(".next-step",e).on("click",function(n){n.preventDefault(),current_step=parseInt(t(".wizard-top-bar",e).attr("data-active_step")),i.validate_step(current_step,e,function(){i.change_step(++current_step,s,e)})}),t(".prev-step",e).on("click",function(n){n.preventDefault(),current_step=parseInt(t(".wizard-top-bar",e).attr("data-active_step")),i.change_step(--current_step,s,e)}),t(".cancel",e).on("click",function(e){e.preventDefault(),r.pub("pbxsManager.activate")}),t(".submit-btn",e).on("click",function(r){r.preventDefault(),current_step=parseInt(t(".wizard-top-bar",e).attr("data-active_step")),i.validate_step(current_step,e,function(){typeof n=="function"&&n()})})},change_step:function(e,n,r){var i=this;t(".step",r).removeClass("active"),t('.step[data-step="'+e+'"]',r).addClass("active");for(var s=e;s>=1;--s)t('.step[data-step="'+s+'"]',r).addClass("completed");t(".wizard-content-step",r).hide(),t('.wizard-content-step[data-step="'+e+'"]',r).show(),t(".cancel",r).hide(),t(".prev-step",r).show(),t(".next-step",r).show(),t(".submit-btn",r).hide(),e===n&&(t(".next-step",r).hide(),t(".submit-btn",r).show()),e===1&&(t(".prev-step",r).hide(),t(".cancel",r).show()),t(".wizard-top-bar",r).attr("data-active_step",e)},validate_step:function(e,n,i){var s=this,o=r.ui.valid(t("#endpoint")),e=parseInt(e),u=s.i18n.active().please_correct,a=r.ui.getFormData("endpoint");o&&(e===1?t(".pbx-brand-list .pbx.selected",n).size()===0&&(u+="<br/>- "+s.i18n.active().no_pbx_selected,o=!1):e===2?t('input[type="radio"][name="auth.auth_method"]:checked',n).val()==="IP"&&t("#auth_ip",n).val().match(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/)===null&&(o=!1,u+="<br/>- "+s.i18n.active().not_valid_ip):e===3,o===!0?typeof i=="function"&&i():r.ui.alert(u))},renderEndpoint:function(e,n,i,s,o){n.server_name||(n.server_name=null);var u=this,a,f,l=1,c=!1,h=function(){var e=r.ui.getFormData("endpoint");e.auth.auth_method=t('input[type="radio"][name="auth.auth_method"]:checked',v).val(),e.server_type=t(".pbx-brand-list .pbx.selected",v).data("pbx_name"),e.cfg=t.extend(!0,p,e.cfg);if(e.extra.compatibilityMode){var n=m.getSelectedItems();n.length&&(e.options.codecs=n)}u.getAccount(function(t){u.saveEndpoint(e,t,function(e){typeof s.saveSuccess=="function"&&s.saveSuccess(e)})})},p={},d=n,v=t(r.template(u,"endpoint",d));r.ui.tooltips(v);var m=r.ui.codecSelector("audio",v.find("#compatibility_codec_selector"),n.options.codecs||[]);t.each(n.cfg,function(e,n){typeof n=="object"?t.each(n,function(n,r){t('button[data-value="'+r+'"]',t('.btn-group[data-type="'+e+'"]',v)).addClass("btn-primary")}):t('button[data-value="'+n+'"]',t('.btn-group[data-type="'+e+'"]',v)).addClass("btn-primary")}),u.initializeWizard(v,h),t(".static-ip-block",v).hide(),t('.static-ip-block[data-value="'+n.auth.auth_method+'"]',v).show(),v.find('[name="extra.compatibilityMode"]').on("change",function(e){var n=v.find("#compatibility_codec_selector");t(this).is(":checked")?n.addClass("active"):n.removeClass("active")}),t(".btn-group .btn",v).on("click",function(e){e.preventDefault();var n=t(this).parent(".btn-group");n.data("select")==="multi"?(t(this).toggleClass("btn-primary"),p[n.data("type")]=[],t(".btn",n).each(function(e,r){t(r).hasClass("btn-primary")&&p[n.data("type")].push(t(r).data("value"))})):(t(this).hasClass("btn-primary")||(t(".btn",t(this).parent()).removeClass("btn-primary"),t(this).addClass("btn-primary")),p[n.data("type")]=t(this).data("value"))}),t("#submit_settings",v).on("click",function(e){e.preventDefault(),h()}),t('input[type="radio"][name="auth.auth_method"]',v).on("click",function(){t(".static-ip-block",v).hide(),t('.static-ip-block[data-value="'+t(this).val()+'"]',v).slideDown()}),t(".pbx-brand-list .pbx",v).each(function(){if(t(this).data("pbx_name")===n.server_type)return t(this).addClass("selected"),t(".pbx-brand-list .pbx:not(.selected)",v).css("opacity","0.2"),!1}),n.server_type&&t(".pbx-brand-list .pbx.selected",v).size()===0&&(t(".pbx-brand-list .pbx.other",v).addClass("selected"),t(".pbx-brand-list .pbx:not(.selected)",v).css("opacity","0.2")),n.server_type||t(".info_pbx",v).hide(),t(".pbx-brand-list .pbx",v).click(function(){t(".pbx-brand-list .pbx",v).removeClass("selected").css("opacity","0.2"),t(this).addClass("selected"),t(".selected-pbx",v).html(t(".pbx-brand-list .selected",v).data("pbx_name")),t(".info_pbx",v).slideDown()}),n.load_step&&n.load_step>0?u.loadSpecificStep(n.load_step,s,v):t("#list_pbxs_navbar",o).hide(),r.ui.protectField(v.find("#auth_password"),v),r.ui.validate(v.find("#endpoint"),{rules:{"auth.ip":{ipv4:!0}}}),i.empty().append(v)},refreshListNumbers:function(e,i){var s=i||t("#pbx_connector_container"),o=this,u=s.find("#numbers_wrapper");u.empty();var a=[];n.each(e,function(e,t){e.phoneNumber=t,a.push(e)}),a=r.util.sort(a,"phoneNumber"),t.isEmptyObject(e)?u.append(r.template(o,"noNumbers")):u.append(r.template(o,"listNumbers",{isCnamEnabled:r.util.isNumberFeatureEnabled("cnam"),isE911Enabled:r.util.isNumberFeatureEnabled("e911"),DIDs:a})),t("#count_phones",s).html(a.length),t("#trigger_links",s).hide()},renderPbxsManager:function(e,i,s,o){var u=this,a=i.extra.id,f=i.server_type?i.server_type.replace(".","").toLowerCase():"other";t.inArray(f,u.listAvailablePbxs())<0?f="other":!0,i.img_link=f,i.servers_list=[],i.hidePort=r.config.whitelabel.hasOwnProperty("hide_port")?r.config.whitelabel.hide_port:!1,t.each(e.data.servers,function(e,n){if(e!==a){var r=n.server_type?n.server_type.replace(".","").toLowerCase():"other";t.inArray(r,u.listAvailablePbxs())<0?r="other":!0,i.servers_list.push({index:e,server_name:n.server_name,img_link:r})}});var l=t(r.template(u,"endpointNumbers",i)),c=function(e){u.refreshListNumbers(e,l)};u.refreshListNumbers(i.DIDs,l),t("#list_pbxs_navbar").show();var h=l.find("#search_results"),p=l.find("#numbers_wrapper");h.hide(),setTimeout(function(){l.find(".search-query").focus()}),l.find(".search-query").on("keyup",function(){var e=t(this),n=p.find(".number-wrapper"),i=t.trim(e.val().toLowerCase().replace(/[^0-9]/g,"")),s=[],o={};t.each(n,function(e,n){var r=t(this).data(),i=r.phone_number;o[i]=t(this)}),i?(h.show().empty(),t.each(o,function(e,n){e.indexOf(i)>-1&&s.push({phone_number:e,selected:t(n).hasClass("selected")})}),s.length>0?h.append(r.template(u,"searchResults",{isCnamEnabled:r.util.isNumberFeatureEnabled("cnam"),isE911Enabled:r.util.isNumberFeatureEnabled("e911"),matches:s,i18n:{amountNumbers:s.length}})):h.append(r.template(u,"noResults")),p.hide()):(p.show(),h.empty().hide())}),l.on("click",".number-wrapper",function(e){if(t(e.target).closest(".number-options").size()<1){var n=function(e,t){var n=e.find('input[type="checkbox"]'),r=n.prop("checked");t&&n.prop("checked",!r),e.toggleClass("selected")},r=t(this);n(r,!t(e.target).is("input:checkbox"));if(r.parents("#search_results").size()>0){var i=l.find('#numbers_wrapper .number-wrapper[data-phone_number="'+r.data("phone_number")+'"]');n(i,!0)}var s=l.find("#trigger_links");l.find(".number-wrapper.selected").size()>0?s.show("fast"):s.hide()}}),l.find("#delete_pbx").on("click",function(){r.ui.confirm(u.i18n.active().delete_pbx_confirmation,function(){u.getAccount(function(e){e.data.servers.splice(i.extra.id,1),u.updateOldTrunkstore(e.data,o.deleteSuccess)})})}),l.find(".settings-pbx-link").on("click",function(){i.load_step=parseInt(t(this).data("step")),u.renderEndpoint(e,i,s,o,l)}),l.find(".buy-numbers-link").on("click",function(e){e.preventDefault(),r.pub("common.buyNumbers",{searchType:t(this).data("type"),callbacks:{success:function(e){u.getAccount(function(t){n.each(e,function(e,n){t.data.servers[a].DIDs[n]={failover:!1,cnam:!1,dash_e911:!1}}),u.updateOldTrunkstore(t.data,function(e){u.renderList(a,undefined,undefined,e.data.servers),u.listNumbersByPbx(a,c)})})}}})}),l.find(".pbx-dropdown:not(.empty)").on("click",function(e){e.preventDefault();var n=[];l.find(".number-wrapper.selected").each(function(){n.push(t(this).data("phone_number"))});if(n.length>0){var i=t(this).data("index");u.getAccount(function(e){var s=e.data.servers[i].server_name,o=r.template(u,"!"+u.i18n.active().confirm_move,{serverName:s});r.ui.confirm(o,function(){t.each(n,function(t,n){e.data.servers[i].DIDs[n]=e.data.servers[a].DIDs[n],delete e.data.servers[a].DIDs[n]}),u.updateOldTrunkstore(e.data,function(e){u.listNumbersByPbx(a,c,e.data),u.renderList(a)})})})}else r.ui.alert(u.i18n.active().no_number_selected)}),l.find("#port_numbers").on("click",function(e){e.preventDefault(),r.pub("common.port.render",{accountId:u.accountId,callbacks:{}})}),l.on("click",".failover-number",function(){var e=t(this).parents(".number-wrapper").first(),n=e.data("phone_number");if(n){var i={phoneNumber:n,callbacks:{success:function(t){"failover"in t.data?e.find(".features i.fa-thumbs-down").size()===0&&e.find(".features").append('<i class="fa fa-thumbs-down monster-green"></i>'):e.find(".features i.fa-thumbs-down").remove()}}};r.pub("common.failover.renderPopup",i)}}),r.util.isNumberFeatureEnabled("cnam")&&l.on("click",".cnam-number",function(){var e=t(this).parents(".number-wrapper").first(),n=e.data("phone_number");if(n){var i={phoneNumber:n,callbacks:{success:function(n){t.isEmptyObject(n.data.cnam)?e.find(".features i.fa-user").remove():e.find(".features i.fa-user").size()===0&&e.find(".features").append('<i class=fa fa-user "monster-green"></i>')}}};r.pub("common.callerId.renderPopup",i)}}),r.util.isNumberFeatureEnabled("e911")&&l.on("click",".e911-number",function(){var e=t(this).parents(".number-wrapper").first(),n=e.data("phone_number");if(n){var i={phoneNumber:n,callbacks:{success:function(n){t.isEmptyObject(n.data.dash_e911)?e.find(".features i.fa-ambulance").remove():e.find(".features i.fa-ambulance").size()===0&&e.find(".features").append('<i class="fa fa-ambulance monster-green"></i>')}}};r.pub("common.e911.renderPopup",i)}}),l.find("#remove_numbers").on("click",function(){var e,n,i=l.find(".number-wrapper.selected"),s=i.size();s>0?r.ui.confirm(u.i18n.active().remove_number_confirmation,function(){var e=[];i.each(function(){e.push(t(this).data("phone_number"))}),u.getAccount(function(n){t.each(e,function(e,t){t in n.data.servers[a].DIDs&&delete n.data.servers[a].DIDs[t]}),u.updateOldTrunkstore(n.data,function(e){u.refreshUnassignedList(function(){u.listNumbersByPbx(a,c,e.data),u.renderList(a,undefined,undefined,e.data.servers)})},function(){u.listNumbersByPbx(a,c)})})},function(){}):r.ui.alert(u.i18n.active().no_number_selected)}),(s||t("#monster-content")).empty().append(l)},refreshUnassignedList:function(e){var n=this;n.listAvailableNumbers(function(i){i=r.util.sort(i,"phoneNumber");var s={unassignedNumbers:i};t("#unassigned_numbers_wrapper").empty().append(r.template(n,"pbxsUnassignedNumbers",s)),t("#unassigned_numbers_count").empty().html(i.length),typeof e=="function"&&e()})},bindEvents:function(e){var n=this,i;r.ui.tooltips(e),e.find(".link-box.assign").on("click",function(){var s=[];e.find("#unassigned_numbers .unassigned-number.selected").each(function(e,n){t(n).data("phone_number")&&s.push(t(this).data("phone_number"))}),i=parseInt(e.find("#pbx_connector_container").data("id")),i>=0?n.getAccount(function(r){t.each(s,function(e,t){r.data.servers[i].DIDs[t]={}}),n.updateOldTrunkstore(r.data,function(t){n.refreshUnassignedList(function(){n.listNumbersByPbx(i,function(r){n.refreshListNumbers(r,e),n.renderList(i,undefined,undefined,t.data.servers)},t.data)})})}):r.ui.alert(n.i18n.active().no_pbx_selected)}),e.find("#unassigned_numbers_header").on("click",function(){var n=t(this),r=e.find("#unassigned_numbers .content"),i=t("#unassigned_numbers_wrapper",e).getNiceScroll()[0];n.hasClass("open")?(n.removeClass("open"),r.hide(),i.resize()):(n.addClass("open"),r.slideDown(i.resize))}),e.on("click",".unassigned-number",function(e){var n=t(this);n.toggleClass("selected");if(!t(e.target).is("input:checkbox")){var r=n.find('input[type="checkbox"]'),i=r.prop("checked");r.prop("checked",!i)}}),e.on("click","#pbxs_manager_listpanel .pbx-wrapper",function(){t("#pbxs_manager_listpanel .pbx-wrapper",e).removeClass("selected"),i=t(this).data("id"),r.pub("pbxsManager.edit",{id:i}),t(this).addClass("selected")}),e.find("#add_pbx").on("click",function(){r.pub("pbxsManager.edit",{})}),e.find(".link-box.delete").on("click",function(){var i,s,o=t(".unassigned-number.selected",e),u=o.size(),a=function(){u--,u===0&&n.refreshUnassignedList()};u>0?r.ui.confirm(n.i18n.active().delete_numbers_confirmation,function(){o.each(function(){i=t(this).data("phone_number"),i&&n.deleteNumber(i,function(){a()},function(){a()})})},function(){}):r.ui.alert(n.i18n.active().no_number_selected)}),e.find("#unassigned_numbers .search-query").on("keyup",function(){var n=t(this),r=t("#unassigned_numbers .content .unassigned-number",e),i=t.trim(n.val().toLowerCase().replace(/[^0-9]/g,"")),s=[],o={};t.each(r,function(e,n){var r=t(this).data(),i=r.phone_number;o[i]=t(this)}),t("#empty_search",e).hide(),i?(r.hide(),t.each(o,function(e,t){e.indexOf(i)>-1&&s.push(t)}),s.length>0?t.each(s,function(e,n){t(n).show()}):t("#empty_search",e).show()):r.show()})},renderList:function(e,n,i,s){var o=this,u=i,a=n||t("#monster-content"),f=e||0,l=function(e){t("#list_pbxs_navbar",a).show(),t("#unassigned_numbers",a).show();var n=function(e){var n=[];if(e.length>0){var r=0;t.each(e,function(e,i){var s=0;t.each(i.DIDs,function(e,t){s++}),n.push({id:r,name:i.server_name||"(no name)",count:s}),r++})}return n},i={numbers:n(e)};t("#list_pbxs_navbar #pbxs_manager_listpanel",a).empty().append(r.template(o,"pbxsListElement",i)).show(),t("#list_pbxs_navbar #pbxs_manager_listpanel .pbx-wrapper[data-id="+f+"]",a).addClass("selected"),t.each(e,function(e,n){var r=n.server_type?n.server_type.replace(".","").toLowerCase():"other";t.inArray(r,o.listAvailablePbxs())<0?r="other":!0,t('#pbxs_manager_listpanel .pbx-wrapper[data-id="'+e+'"] .img-wrapper',a).append('<img class="img_style" src="'+o.appPath+"/style/static/images/endpoints/"+r+'.png" height="49" width=72"/>')}),u&&u(e)};s?l(s):o.listServers(function(e,t){l(e)})},listNumbersByPbx:function(e,n,i){var s=this;(e||e>-1)&&r.parallel({list_numbers:function(e){s.listAllNumbers(function(t){e(null,t.data.numbers)})},account:function(e){i?e(null,i):s.getAccount(function(t){e(null,t.data)})}},function(r,i){var s={};t.each(i.account.servers[e].DIDs,function(e,t){e in i.list_numbers&&(s[e]=i.list_numbers[e])}),n&&n(s)})},listAvailableNumbers:function(e){var n=this;r.parallel({listNumbers:function(e){n.listAllNumbers(function(t){e(null,t.data)})}},function(n,r){var i=[];"numbers"in r.listNumbers&&t.each(r.listNumbers.numbers,function(e,t){t.used_by||i.push({phoneNumber:e,isoCountry:"locality"in t?t.locality.country||"":""})}),e&&e(i)})}};return o});