(function(e,t){"object"==typeof module&&module.exports?module.exports=function(e){return e=e||require("underscore"),t(e)}:"function"==typeof define&&define.amd?define(["underscore"],function(r){return t(r,e)}):e.postal=t(e._,e)})(this,function(e){var t="/",n="postal",r=function(){var t;return function(n){var r=!1;return e.isString(n)?(r=n===t,t=n):(r=e.isEqual(n,t),t=e.clone(n)),!r}},i=function(){var t=[];return function(n){var r=!e.any(t,function(t){return e.isObject(n)||e.isArray(n)?e.isEqual(n,t):n===t});return r&&t.push(n),r}},s=function(e){this.channel=e||t};s.prototype.subscribe=function(){return 1===arguments.length?new o(this.channel,arguments[0].topic,arguments[0].callback):new o(this.channel,arguments[0],arguments[1])},s.prototype.publish=function(){var e=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};return e.channel=this.channel,l.configuration.bus.publish(e)};var o=function(e,t,r){this.channel=e,this.topic=t,this.callback=r,this.constraints=[],this.context=null,l.configuration.bus.publish({channel:n,topic:"subscription.created",data:{event:"subscription.created",channel:e,topic:t}}),l.configuration.bus.subscribe(this)};o.prototype={unsubscribe:function(){l.configuration.bus.unsubscribe(this),l.configuration.bus.publish({channel:n,topic:"subscription.removed",data:{event:"subscription.removed",channel:this.channel,topic:this.topic}})},defer:function(){var e=this.callback;return this.callback=function(t){setTimeout(function(){e(t)},0)},this},disposeAfter:function(t){if(e.isNaN(t)||0>=t)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var n=this.callback,r=e.after(t,e.bind(function(){this.unsubscribe()},this));return this.callback=function(){n.apply(this.context,arguments),r()},this},distinctUntilChanged:function(){return this.withConstraint(new r),this},distinct:function(){return this.withConstraint(new i),this},once:function(){this.disposeAfter(1)},withConstraint:function(t){if(!e.isFunction(t))throw"Predicate constraint must be a function";return this.constraints.push(t),this},withConstraints:function(t){var n=this;return e.isArray(t)&&e.each(t,function(e){n.withConstraint(e)}),n},withContext:function(e){return this.context=e,this},withDebounce:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=e.debounce(n,t),this},withDelay:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=function(e){setTimeout(function(){n(e)},t)},this},withThrottle:function(t){if(e.isNaN(t))throw"Milliseconds must be a number";var n=this.callback;return this.callback=e.throttle(n,t),this},subscribe:function(e){return this.callback=e,this}};var u={cache:{},regex:{},compare:function(t,n){var r,i,s,o=this.cache[n]&&this.cache[n][t];return o!==undefined?o:((i=this.regex[t])||(r="^"+e.map(t.split("."),function(e){var t=s&&"#"!==s?"\\.\\b":"\\b";return t+="#"===e?"[A-Z,a-z,0-9,\\.]*":"*"===e?"[A-Z,a-z,0-9]+":e,s=e,t}).join("")+"$",i=this.regex[t]=RegExp(r)),this.cache[n]=this.cache[n]||{},this.cache[n][t]=o=i.test(n),o)},reset:function(){this.cache={},this.regex={}}},a=function(t,n){l.configuration.resolver.compare(t.topic,n.topic)&&e.all(t.constraints,function(e){return e.call(t.context,n.data,n)})&&"function"==typeof t.callback&&t.callback.call(t.context,n.data,n)},f={addWireTap:function(e){var t=this;return t.wireTaps.push(e),function(){var n=t.wireTaps.indexOf(e);-1!==n&&t.wireTaps.splice(n,1)}},publish:function(t){return t.timeStamp=new Date,e.each(this.wireTaps,function(e){e(t.data,t)}),this.subscriptions[t.channel]&&e.each(this.subscriptions[t.channel],function(e){for(var n,r=0,i=e.length;i>r;)(n=e[r++])&&a(n,t)}),t},reset:function(){this.subscriptions&&(e.each(this.subscriptions,function(t){e.each(t,function(e){for(;e.length;)e.pop().unsubscribe()})}),this.subscriptions={})},subscribe:function(e){var t,n=this.subscriptions[e.channel];return n||(n=this.subscriptions[e.channel]={}),t=this.subscriptions[e.channel][e.topic],t||(t=this.subscriptions[e.channel][e.topic]=[]),t.push(e),e},subscriptions:{},wireTaps:[],unsubscribe:function(e){if(this.subscriptions[e.channel][e.topic])for(var t=this.subscriptions[e.channel][e.topic].length,n=0;t>n;n++)if(this.subscriptions[e.channel][e.topic][n]===e){this.subscriptions[e.channel][e.topic].splice(n,1);break}}};f.subscriptions[n]={};var l={configuration:{bus:f,resolver:u,DEFAULT_CHANNEL:t,SYSTEM_CHANNEL:n},ChannelDefinition:s,SubscriptionDefinition:o,channel:function(e){return new s(e)},subscribe:function(e){return new o(e.channel||t,e.topic,e.callback)},publish:function(e){return e.channel=e.channel||t,l.configuration.bus.publish(e)},addWireTap:function(e){return this.configuration.bus.addWireTap(e)},linkChannels:function(n,r){var i=[];return n=e.isArray(n)?n:[n],r=e.isArray(r)?r:[r],e.each(n,function(n){n.topic||"#",e.each(r,function(r){var s=r.channel||t;i.push(l.subscribe({channel:n.channel||t,topic:n.topic||"#",callback:function(t,n){var i=e.clone(n);i.topic=e.isFunction(r.topic)?r.topic(n.topic):r.topic||n.topic,i.channel=s,i.data=t,l.publish(i)}}))})}),i},utils:{getSubscribersFor:function(){var e=arguments[0],t=arguments[1];return 1===arguments.length&&(e=arguments[0].channel||l.configuration.DEFAULT_CHANNEL,t=arguments[0].topic),l.configuration.bus.subscriptions[e]&&l.configuration.bus.subscriptions[e].hasOwnProperty(t)?l.configuration.bus.subscriptions[e][t]:[]},reset:function(){l.configuration.bus.reset(),l.configuration.resolver.reset()}}};return l});